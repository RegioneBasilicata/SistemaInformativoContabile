<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>POP3</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="POP3.html">Details</a></div></div>
<div class="tab"><div><a href="POP3_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="POP3_References.html">References</a></div></div>
<div class="tab"><div><a href="POP3_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="POP3_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
FUNCTION pop3 (
   username   VARCHAR2,
   PASSWORD   VARCHAR2,
   msgnum     NUMBER,
   canc_sn    VARCHAR2
)
   RETURN tstrings PIPELINED
IS
   --POP3_SERVER             constant varchar2(19) := '127.0.0.1';
   pop3_server   CONSTANT VARCHAR2 (100)     := '172.18.17.48';
   pop3_port     CONSTANT NUMBER             := 110;
   --POP3_TIMEOUT            constant number := 10;
   pop3_ok       CONSTANT VARCHAR2 (10)      := '+OK';
   e_pop3_error           EXCEPTION;
   --E_READ_TIMEOUT  exception;
   --pragma exception_init( E_READ_TIMEOUT, -29276 );
   socket                 UTL_TCP.connection;
   line                   VARCHAR2 (30000);
   BYTES                  INTEGER;

   -- send a POP3 command
   -- (we expect each command to respond with a +OK)
   FUNCTION writetopop (command VARCHAR2)
      RETURN VARCHAR2
   IS
      len    INTEGER;
      resp   VARCHAR2 (30000);
   BEGIN
      len := UTL_TCP.write_line (socket, command);
      UTL_TCP.FLUSH (socket);
      -- using a hack to check the popd response
      len := UTL_TCP.read_line (socket, resp);

      IF SUBSTR (resp, 1, 3) != pop3_ok
      THEN
         RAISE e_pop3_error;
      END IF;

      RETURN (resp);
   END;
BEGIN
   PIPE ROW ('pop3:' || pop3_server || ' port:' || pop3_port);
   -- Just to make sure there are no previously opened connections
   --UTL_TCP.close_all_connections;

   -- open a socket connection to the POP3 server
   socket :=
      UTL_TCP.open_connection (remote_host      => pop3_server,
                               remote_port      => pop3_port,
                               --tx_timeout => POP3_TIMEOUT,
                               CHARSET          => 'US7ASCII'
                              );
   -- read the server banner/response from the pop3 daemon
   PIPE ROW (UTL_TCP.get_line (socket));
   -- authenticate with the POP3 server using the USER and PASS commands
   PIPE ROW ('USER ' || username);
   PIPE ROW (writetopop ('USER ' || username));
   PIPE ROW ('PASS ' || PASSWORD);
   PIPE ROW (writetopop ('PASS ' || PASSWORD));
   -- numero mail presenti
   PIPE ROW ('STAT ');
   PIPE ROW (writetopop ('STAT '));
   -- list mail
   PIPE ROW ('LIST ' || msgnum);
   PIPE ROW (writetopop ('LIST '  || msgnum));
   -- retrieve the specific message
   PIPE ROW ('RETR ' || msgnum);
   PIPE ROW (writetopop ('RETR ' || msgnum));
   --PIPE ROW( 'LIST '||msgNum ); PIPE ROW( WriteToPop('LIST '||msgNum) );
   PIPE ROW ('*** START OF INTERNET MESSAGE BODY ***');

   LOOP
      BYTES := UTL_TCP.available (socket);

      IF BYTES > 0
      THEN
         BYTES := UTL_TCP.read_line (socket, line);
         line := REPLACE (line, CHR (13) || CHR (10), '');
         
         -- WILL HAVE TO USE PLSQL FUNCTIONS (HAVE BOOKMARKED) TO GET THE MAIL 
         -- IN THE PREFERRED FORMAT. CAN USE "REPLACE()"

         IF LENGTH (line) = 1 AND line = '.'
         THEN
            PIPE ROW ('*** END OF INTERNET MESSAGE BODY ***');
         ELSE
            PIPE ROW (line);
         END IF;
      END IF;

      EXIT WHEN LENGTH (line) = 1 AND line = '.';
   END LOOP;

   --PIPE ROW( '*** END OF INTERNET MESSAGE BODY ***' );

   -- Cancella messaggio
   IF canc_sn='S' THEN
      PIPE ROW ('DELE ' || msgnum);
      PIPE ROW (writetopop ('DELE ' || msgnum));
   END IF;
   -- close connection
   PIPE ROW ('QUIT');
   PIPE ROW (writetopop ('QUIT'));
   UTL_TCP.close_connection (socket);
EXCEPTION
   WHEN e_pop3_error
   THEN
      PIPE ROW ('There are no mails !');
END;</pre>	</td></tr>
</table></div>