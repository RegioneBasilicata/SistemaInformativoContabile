<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>ACCERTAMENTI_RESIDUI</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="ACCERTAMENTI_RESIDUI.html">Details</a></div></div>
<div class="tab"><div><a href="ACCERTAMENTI_RESIDUI_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="ACCERTAMENTI_RESIDUI_References.html">References</a></div></div>
<div class="tab"><div><a href="ACCERTAMENTI_RESIDUI_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="ACCERTAMENTI_RESIDUI_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
PROCEDURE ACCERTAMENTI_RESIDUI (w_anno in out number, w_doc_id in out varchar, 
w_residuo_consuntivo in out number, w_man_rev_residui in out number,w_variazioni_residui in out number) is

doc_id_accertamento number;
doc_id_storno_accertamento number;
doc_id_reversale number;
incassi_competenza number(15,2);
incassi_residui number(15,2);

appoggio_residuo_accertamento number(15,2);
appoggio_maggiori_incassi number(15,2);

totale_storno_reversale number(15,2);
totale_correzione_storno_acc number(15,2);
totale_storno_accertamenti number(15,2);
totale_insussistenza number(15,2);


cursor accertamenti is
select 	distinct
nvl(jugd.document_amount,0) importo_accertamento,
to_number(to_char(jugd.date_created,'yyyy')) anno_accertamento,
jugd.doc_id doc_id_accertamento
from
fina_documenti 	jugd
where                                                                                                                              
jugd.doc_type = 'ACC'                  and                                                
upper(nvl(jugd.deletion_status_flag,'N')) &lt;> 'Y'          and                        
upper(nvl(jugd.proposal_status_flag,'Z'))||upper(nvl(jugd.auditing_status_flag,'Z'))='PI' and
jugd.gl_date is not null                  and
jugd.period_name is not null                  and        
jugd.date_created is not null                  and  
jugd.doc_id = w_doc_id;


cursor storno_accertamenti is
select    
nvl(jugd.document_amount,0)                                            importo_storno_accertamento,
to_number(to_char(jugd.date_created,'yyyy'))         anno_storno_accertamento,
jugd.doc_id                                                                            doc_id_storno_accertamento,
jugd.doc_type                                                                        tipo_storno_accertamento,
jugd.previous_doc_id                                                        previous_doc_id_acc
from    
fina_documenti  jugd
where    
jugd.doc_type  in ('ST-ACC','INSUS')                  and                                                
upper(nvl(jugd.deletion_status_flag,'N')) &lt;> 'Y'         and                        
upper(nvl(jugd.proposal_status_flag,'Z'))||upper(nvl(jugd.auditing_status_flag,'Z'))='PI' and
jugd.gl_date is not null                 and
jugd.period_name is not null                 and        
jugd.date_created is not null                 and        
to_number(to_char(jugd.date_created,'yyyy')) &lt;= w_anno and
jugd.previous_doc_id = doc_id_accertamento;

cursor corr_storno_accertamenti is
select    
nvl(jugd.document_amount,0)                                         importo_corr_accertamento,
to_number(to_char(jugd.date_created,'yyyy'))         anno_corr_accertamento,
jugd.previous_doc_id                                                        previous_doc_id_corr_acc
from    
fina_documenti         jugd
where    
jugd.doc_type = 'CORR_AC'                          and                                                
upper(nvl(jugd.deletion_status_flag,'N')) &lt;> 'Y'              and                        
upper(nvl(jugd.proposal_status_flag,'Z'))||upper(nvl(jugd.auditing_status_flag,'Z'))='PI' and
jugd.gl_date is not null                        and
jugd.period_name is not null                     and        
jugd.date_created is not null                     and        
to_number(to_char(jugd.date_created,'yyyy')) &lt;= w_anno and
jugd.previous_doc_id = doc_id_storno_accertamento;

cursor reversali is
select     
nvl(jugd1.document_amount,0)                                         importo_reversale,
jugd1.doc_id                                                                        doc_id_reversale,
to_number(to_char(jugd1.date_created,'yyyy'))      anno_reversale,
jugd1.previous_doc_id                                                        previous_doc_id_reversale
from    
fina_documenti         jugd1
where     
jugd1.doc_type = 'REV' and
jugd1.date_created is not null and
upper(nvl(jugd1.proposal_status_flag,'Z'))||upper(nvl(jugd1.auditing_status_flag,'Z'))='PI' and
upper(nvl(jugd1.deletion_status_flag,'N')) &lt;> 'Y' and
to_number(to_char(jugd1.date_created,'yyyy')) &lt;= w_anno and
jugd1.previous_doc_id    = doc_id_accertamento;

cursor storno_reversali is
select    
nvl(jugd1.document_amount,0)                                     importo_storno_reversale,
jugd1.previous_doc_id                                                 previous_doc_id_storno_rev
from    
fina_documenti         jugd1
where    
jugd1.doc_type = 'ST-REV' and
upper(nvl(jugd1.proposal_status_flag,'Z'))||upper(nvl(jugd1.auditing_status_flag,'Z'))='PI' and
upper(nvl(jugd1.deletion_status_flag,'N')) &lt;> 'Y' and
to_number(to_char(jugd1.date_created,'yyyy')) &lt;= w_anno and
jugd1.previous_doc_id = doc_id_reversale;

BEGIN

for a in accertamenti loop
 doc_id_accertamento := a.doc_id_accertamento;
 incassi_competenza := 0;
 incassi_residui := 0;
 
-- calcolo reversali 
 for r in reversali loop

  totale_storno_reversale := 0;
     doc_id_reversale := r.doc_id_reversale;

  for sr in storno_reversali loop
   totale_storno_reversale := totale_storno_reversale + nvl(sr.importo_storno_reversale,0);    
  end loop;

  if r.anno_reversale &lt; w_anno
       then incassi_residui := incassi_residui + (nvl(r.importo_reversale,0) - nvl(totale_storno_reversale,0));
       else incassi_competenza := incassi_competenza + (nvl(r.importo_reversale,0) - nvl(totale_storno_reversale,0));
  end if;

 end loop;
-- fine calcolo reversali

-- calcolo storno_accertamenti 
 totale_storno_accertamenti := 0;
 totale_insussistenza := 0;
 for sa in storno_accertamenti loop

  totale_correzione_storno_acc := 0;
     doc_id_storno_accertamento := sa.doc_id_storno_accertamento;

  for csa in corr_storno_accertamenti loop
   totale_correzione_storno_acc := totale_correzione_storno_acc + nvl(csa.importo_corr_accertamento,0);    
  end loop;

  if sa.anno_storno_accertamento &lt; w_anno
       then   totale_storno_accertamenti := totale_storno_accertamenti + (nvl(sa.importo_storno_accertamento,0) - nvl(totale_correzione_storno_acc,0));
       elsif sa.tipo_storno_accertamento = 'INSUS'
             then totale_insussistenza := totale_insussistenza + (nvl(sa.importo_storno_accertamento,0) - nvl(totale_correzione_storno_acc,0));
  end if;

 end loop;

-- fine calcolo storno accertamenti
  
  appoggio_maggiori_incassi := 0;
   
  appoggio_residuo_accertamento := (nvl(a.importo_accertamento,0) - nvl(totale_storno_accertamenti,0) - nvl(incassi_residui,0));
  
  if appoggio_residuo_accertamento  &lt;= 0                       
       then appoggio_residuo_accertamento := 0;
  end if;
  
  if nvl(incassi_competenza,0) > appoggio_residuo_accertamento
       then appoggio_maggiori_incassi := incassi_competenza - appoggio_residuo_accertamento;
--            incassi_competenza := appoggio_residuo_accertamento;
  end if;
                        
    w_residuo_consuntivo := w_residuo_consuntivo + appoggio_residuo_accertamento;

  w_man_rev_residui := w_man_rev_residui + nvl(incassi_competenza,0);
   
  w_variazioni_residui := w_variazioni_residui + appoggio_maggiori_incassi + (nvl(totale_insussistenza,0)* -1); 

end loop;

END; 
</pre>	</td></tr>
</table></div>