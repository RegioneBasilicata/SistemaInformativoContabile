<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>AGGIORNA_UTENTI</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="AGGIORNA_UTENTI.html">Details</a></div></div>
<div class="tab"><div><a href="AGGIORNA_UTENTI_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="AGGIORNA_UTENTI_References.html">References</a></div></div>
<div class="tab"><div><a href="AGGIORNA_UTENTI_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="AGGIORNA_UTENTI_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
procedure      aggiorna_utenti is
matricola_si number := 0;
-- prendo tutti i record diversi tra Pianta Organica e Utenti, quindi sia i nuovi che i modificati
cursor inserimenti is
select distinct to_number(MATRICOLA) MATRICOLA,
COGNOME
,NOME
,CODFISC COD_FISCALE
,LIVELLO
,SUBSTR (codarea,4,2)||SUBSTR (coduff,4,2) UFFICIO
,DATAASS DATA_ASS
,replace(nvl(numtel,''),' ') TEL_UFFICIO
,replace(nvl(EMAIL,''),' ') E_MAIL
,decode(livello,'00DIR','S','00RCP','S','N') dirigente_SN
,decode(posizioneorg,'Nessuna','N',null,'N','S') posizione_org_SN
,decode(livello,'000DG','S','N') dg_SN
,nvl(to_number(ccodpresidio),0) codice_presidio
,codposorg tipo_pos_org
FROM FIN_T_PIANTA_ORGANICA
where trunc(data) >= to_date('01072014','ddmmyyyy')
and nvl(codserv,'X') = 'I'
and coduff is not null
and to_number(MATRICOLA) not in (select matricola from ap_utenti);

cursor modificati is
select to_number(MATRICOLA) MATRICOLA,
COGNOME
,NOME
,CODFISC COD_FISCALE
,LIVELLO
,SUBSTR (codarea,4,2)||SUBSTR (coduff,4,2) UFFICIO
,DATAASS DATA_ASS
,replace(nvl(numtel,''),' ') TEL_UFFICIO
,replace(nvl(EMAIL,''),' ') E_MAIL
,decode(livello,'00DIR','S','00RCP','S','N') dirigente_SN
,decode(posizioneorg,'Nessuna','N',null,'N','S') posizione_org_SN
,decode(livello,'000DG','S','N') dg_SN
,nvl(to_number(ccodpresidio),0) codice_presidio
,codposorg tipo_pos_org
FROM FIN_T_PIANTA_ORGANICA
where trunc(data) >= to_date('01072014','ddmmyyyy')
and coduff is not null
and nvl(codserv,'X') = 'M'
order by data;

begin
for d in inserimenti loop
    insert into AP_UTENTI(MATRICOLA,COGNOME,NOME,COD_FISCALE,LIVELLO,UFFICIO,DATA_ASS,GUIDA_SN,
    AUTISTA_SN,
    ATTIVO_SN,TEL_UFFICIO,E_MAIL,dirigente_SN
    ,posizione_org_SN,dg_sn,codice_presidio,tipo_pos_org,utente_aggiornamento,data_aggiornamento) values (d.MATRICOLA,d.COGNOME,d.NOME,d.COD_FISCALE,d.LIVELLO,d.UFFICIO,d.DATA_ASS,'N','N','S',d.TEL_UFFICIO,d.E_MAIL,d.dirigente_SN
    ,d.posizione_org_SN,d.dg_sn,d.codice_presidio,d.tipo_pos_org,'PIANTA_ORGANICA',sysdate);
     commit;
END LOOP;
for m in modificati loop
 select count(*) into matricola_si
 from ap_utenti
 where matricola = nvl(m.matricola,0);
 
 if matricola_si = 0
  then 
    insert into AP_UTENTI(MATRICOLA,COGNOME,NOME,COD_FISCALE,LIVELLO,UFFICIO,DATA_ASS,GUIDA_SN,
    AUTISTA_SN,
    ATTIVO_SN,TEL_UFFICIO,E_MAIL,dirigente_SN
    ,posizione_org_SN,dg_sn,codice_presidio,tipo_pos_org,utente_aggiornamento,data_aggiornamento) values (m.MATRICOLA,m.COGNOME,m.NOME,m.COD_FISCALE,m.LIVELLO,m.UFFICIO,m.DATA_ASS,'N','N','S',m.TEL_UFFICIO,m.E_MAIL,m.dirigente_SN
    ,m.posizione_org_SN,m.dg_sn,m.codice_presidio,m.tipo_pos_org,'PIANTA_ORGANICA',sysdate);
     commit;
  else
    update ap_utenti set COGNOME=m.cognome,NOME=m.nome,COD_FISCALE=m.cod_fiscale,LIVELLO=m.livello,UFFICIO=m.ufficio,DATA_ASS=m.data_ass,TEL_UFFICIO=m.tel_ufficio,E_MAIL=m.e_mail,dirigente_SN=m.dirigente_SN
    ,posizione_org_SN=m.posizione_org_SN,dg_sn=m.dg_sn,codice_presidio=m.codice_presidio,tipo_pos_org=m.tipo_pos_org,utente_aggiornamento='PIANTA_ORGANICA',data_aggiornamento=sysdate
     WHERE MATRICOLA = m.MATRICOLA;
     commit;
  end if;
END LOOP;
  delete ap_utenti where matricola in (select distinct MATRICOLA
  from ap_utenti
  where matricola &lt;= 200000
  intersect
  select distinct to_number(MATRICOLA)
  FROM FIN_T_PIANTA_ORGANICA
  where data >= sysdate
  and (nvl(codserv,'X') = 'C' or trunc(datacess) &lt;= trunc(sysdate)));
  commit;
delete personale_uffici
commit;
insert into personale_uffici
select ufficio,count(*)
from ap_utenti
where ufficio is not null
group by ufficio
order by ufficio;
commit;
insert into personale_uffici values ('118',28);
commit;
-- inserisco in mon_personale inquadramenti le matricole non presenti
/*insert into mon_personale_inquadramenti select distinct a.matricola
,trunc(sysdate,'dd')
,substr(replace(decode(a.livello,'00CPS','00R','00RED','00R',a.livello),'.'),3,1)
,substr(replace(decode(a.livello,'00CPS','','00RED','',a.livello),'.'),4,1)
,decode(a.livello,'00CPS','00RED',a.livello) livello
,'TRACCIA'
,sysdate
,null
,null
,substr(a.tipo_pos_org,1,3)
from ap_utenti a
where a.ufficio is not null
and substr(a.ufficio,1,2) &lt;> 78
and a.matricola &lt; 200000
and ((substr(a.livello,3,1) in ('A','B','C','D','E')
and substr(a.livello,5,1) in ('1','2','3','4','5','6','7','8','9')) or substr(a.livello,3,3) in ('CPS','RED')) 
and a.matricola not in (select i.matricola
from mon_personale_inquadramenti i);
commit;
-- aggiorno le matricole già presenti in mon_personale_inquadramenti
insert into mon_personale_inquadramenti select distinct i.matricola
,trunc(sysdate,'dd')
,substr(replace(decode(a.livello,'00CPS','00R','00RED','00R',a.livello),'.'),3,1)
,substr(replace(decode(a.livello,'00CPS','','00RED','',a.livello),'.'),4,1)
,decode(a.livello,'00CPS','00RED',a.livello) livello
,'TRACCIA'
,sysdate
,null
,null
,substr(a.tipo_pos_org,1,3)
from mon_personale_inquadramenti i
,ap_utenti a
where a.matricola = i.matricola(+)
and decode(a.livello,'00CPS','00RED',a.livello) &lt;> decode(i.livello,'00CPS','00RED',i.livello)
and i.data_dal = (select max(m.data_dal) from mon_personale_inquadramenti m where m.matricola = a.matricola);
commit;*/
-- AGGIORNO LA FND_USER
UPDATE FND_USER U SET (U.UFFICIO,u.email_address) = 
(SELECT
  A.UFFICIO,
  NVL(A.E_MAIL,u.email_address)
FROM ap_utenti A
  WHERE U.MATRICOLA = A.MATRICOLA
  AND (U.UFFICIO &lt;> A.UFFICIO OR u.email_address &lt;> NVL(a.e_mail,u.email_address)))
 WHERE U.MATRICOLA IN 
 (SELECT
  A.MATRICOLA
  FROM ap_utenti A
  ,FND_USER F
  WHERE F.MATRICOLA = A.MATRICOLA
  AND (F.UFFICIO &lt;> A.UFFICIO OR F.email_address &lt;> NVL(a.e_mail,F.email_address)));
  COMMIT;
-- ELIMINO dalla FND_USER le matricole cessate
update fnd_user set end_date = trunc(sysdate,'dd')where matricola in 
(select distinct to_number(MATRICOLA)
  FROM FIN_T_PIANTA_ORGANICA
  where data >= to_date('01072014','ddmmyyyy')
  and (nvl(codserv,'X') = 'C' or trunc(datacess) &lt;= trunc(sysdate)));
commit;
end;</pre>	</td></tr>
</table></div>