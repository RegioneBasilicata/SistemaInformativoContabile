<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>AGG_BENI2</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="AGG_BENI2.html">Details</a></div></div>
<div class="tab"><div><a href="AGG_BENI2_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="AGG_BENI2_References.html">References</a></div></div>
<div class="tab"><div><a href="AGG_BENI2_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="AGG_BENI2_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
procedure AGG_BENI2 is
 a_cod_inv varchar2(50);
 a_cat number;
 a_scat number;
 a_dett number;
 a_crea varchar2(1);
 a_progr_inv number;
 a_ctr_es number;
 a_fat_progr number;
 a_fat_qta number;
begin
for b in (select * from imp_fat_hw f
where f.p_fode_riferimento is null
order by p_fofa_id) loop


-- controllo esistenza rigo generico in fattura
begin
select progr
  into  a_fat_progr
  from tb_righi_doc
  where tbdi_tbtd_chiave=b.p_fofa_id+200000 and
        tipo='CO' and
        cat=b.p_cate_idcategoria and
        scat=b.p_prod_idproduttori and
        tba_id=b.p_hwcd_idprodotto;
update tb_righi_doc
 set qta=qta+1
 where tbdi_tbtd_chiave=b.p_fofa_id+200000 and
       progr=a_fat_progr; 
exception
 when no_data_found then
 select count(*)
  into a_fat_progr
  from tb_righi_doc
  where tbdi_tbtd_chiave=b.p_fofa_id+200000;
 a_fat_progr:=a_fat_progr+1; 
 insert into tb_righi_doc
  (tbdi_tbtd_chiave,progr,tipo,cat,scat,tba_id,descrizione,qta,pr_unit,val_tot,tbi_cod_iva) values
  (b.p_fofa_id+200000,a_fat_progr,'CO',b.p_cate_idcategoria,b.p_prod_idproduttori,b.p_hwcd_idprodotto,
   b.p_cate_descrizione||' '||b.p_prod_produttore||' '||b.p_hwcd_modello,
   1,b.P_FODE_IMPORTO_DETT,b.P_FODE_IMPORTO_DETT,'20');
end; 
end loop;
commit;
end;</pre>	</td></tr>
</table></div>