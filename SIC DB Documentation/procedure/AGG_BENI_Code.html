<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>AGG_BENI</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="AGG_BENI.html">Details</a></div></div>
<div class="tab"><div><a href="AGG_BENI_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="AGG_BENI_References.html">References</a></div></div>
<div class="tab"><div><a href="AGG_BENI_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="AGG_BENI_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
procedure AGG_BENI is
 a_cod_inv varchar2(50);
 a_cat number;
 a_scat number;
 a_dett number;
 a_crea varchar2(1);
 a_progr_inv number;
 a_ctr_es number;
 a_fat_progr number;
 a_fat_qta number;
begin
for b in (select * from imp_fat_hw f
where f.p_fode_riferimento is not null
order by p_fofa_id) loop

a_cod_inv:=null;
begin
select min(cod_inv)
into a_cod_inv
from tb_beni_mobili m
where m.num_serie=b.p_fode_riferimento and
bf_tipo is null;
exception WHEN
no_data_found then null;
end;
if a_cod_inv is null then
--crea articolo
  select tsp_progr,progr
   into a_scat,a_dett
   from tb_dett_scat
   where descrizione=b.p_hwcd_modello;
 begin
  select max(nvl(progr_inv,0)) 
   into a_progr_inv
   from tb_beni_mobili m
   where m.categoria = 2 and
         m.sotto_cat = a_scat and
         m.dettaglio_cat = a_dett;
 exception when no_data_found then a_progr_inv := 0;
 end;
 a_ctr_es:=1;
 while a_ctr_es>0 loop
   a_progr_inv := nvl(a_progr_inv,0) + 1;
   a_cod_inv:='INF.'||substr(b.p_cate_codice,1,5)||'.'||a_dett||'.'||a_progr_inv;
   select count(*)
    into a_ctr_es
    from tb_beni_mobili
    where cod_inv=a_cod_inv;
 end loop;	  
 insert into tb_beni_mobili 
 (cod_inv,descr_agg,categoria, sotto_cat, dettaglio_cat, num_serie, note) values
 (a_cod_inv,b.p_cate_descrizione||' '||b.p_prod_produttore||' '||b.p_hwcd_modello,
  2,a_scat,a_dett,b.p_fode_riferimento,'Inseriti da import fatture');
end if;

select m.categoria,m.sotto_cat,m.dettaglio_cat
into a_cat,a_scat,a_dett
from tb_beni_mobili m
where m.cod_inv=a_cod_inv;

-- controllo esistenza rigo generico in fattura
begin
select progr
  into  a_fat_progr
  from tb_righi_doc
  where tbdi_tbtd_chiave=b.p_fofa_id+200000 and
        cat=a_cat and
        scat=a_scat and
        tba_id=a_dett;
update tb_righi_doc
 set qta=qta+1
 where tbdi_tbtd_chiave=b.p_fofa_id+200000 and
       progr=a_fat_progr; 
exception
 when no_data_found then
 select count(*)
  into a_fat_progr
  from tb_righi_doc
  where tbdi_tbtd_chiave=b.p_fofa_id+200000;
 a_fat_progr:=a_fat_progr+1; 
 insert into tb_righi_doc
  (tbdi_tbtd_chiave,progr,tipo,cat,scat,tba_id,descrizione,qta,pr_unit,val_tot,tbi_cod_iva) values
  (b.p_fofa_id+200000,a_fat_progr,'IN',a_cat,a_scat,a_dett,
   b.p_cate_descrizione||' '||b.p_prod_produttore||' '||b.p_hwcd_modello,
   1,b.P_FODE_IMPORTO_DETT,b.P_FODE_IMPORTO_DETT,'20');
end; 

update tb_beni_mobili m
set bf_tipo='F',
 bf_numero=b.p_fofa_id+200000,
 bf_progr_rigo=a_fat_progr
 where m.cod_inv=a_cod_inv;
end loop;
commit;
end;</pre>	</td></tr>
</table></div>