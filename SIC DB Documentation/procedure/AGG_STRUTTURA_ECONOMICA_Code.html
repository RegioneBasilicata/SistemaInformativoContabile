<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>AGG_STRUTTURA_ECONOMICA</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="AGG_STRUTTURA_ECONOMICA.html">Details</a></div></div>
<div class="tab"><div><a href="AGG_STRUTTURA_ECONOMICA_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="AGG_STRUTTURA_ECONOMICA_References.html">References</a></div></div>
<div class="tab"><div><a href="AGG_STRUTTURA_ECONOMICA_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="AGG_STRUTTURA_ECONOMICA_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
procedure AGG_STRUTTURA_ECONOMICA (p_anno number, p_strutture varchar2) is

	p_progr number := 0;

cursor CE_G_dare is
select distinct e_u 
,PCF
,PCE_D conto
from GAT2.tmp_matrice_transizione
where anno = p_anno
and livello = 'V'
and pcf not in (select distinct t.pcf from nb_matrice_transizione t where t.anno = p_anno and t.e_u = e_u and t.G_L = 'G' and t.D_A = 'D' and t.CE is not null)
and PCE_D is not null
and length(PCE_D) = 15
order by 1,3;

cursor CE_G_avere is
select distinct e_u
,PCF
,PCE_A conto
from GAT2.tmp_matrice_transizione
where anno = p_anno
and livello = 'V'
and pcf not in (select distinct t.pcf from nb_matrice_transizione t where t.anno = p_anno and t.e_u = e_u and t.G_L = 'G' and t.D_A = 'A' and t.CE is not null)
and PCE_A is not null
and length(PCE_A) = 15
order by 1,3;

cursor SP_G_dare is
select distinct e_u 
,PCF
,decode(PSP_D,'1.3.4','1.3.4.01.01.01.001',PSP_D) conto
from GAT2.tmp_matrice_transizione
where anno = p_anno
and livello = 'V'
and pcf not in (select distinct t.pcf from nb_matrice_transizione t where t.anno = p_anno and t.e_u = e_u and t.G_L = 'G' and t.D_A = 'D' and t.SP is not null)
and PSP_D is not null
and length(decode(PSP_D,'1.3.4','1.3.4.01.01.01.001',PSP_D)) = 18
order by 1,3;

cursor SP_G_avere is
select distinct e_u
,PCF
,decode(PSP_A,'1.3.4','1.3.4.01.01.01.001',PSP_A) conto
from GAT2.tmp_matrice_transizione
where anno = p_anno
and livello = 'V'
and pcf not in (select distinct t.pcf from nb_matrice_transizione t where t.anno = p_anno and t.e_u = e_u and t.G_L = 'G' and t.D_A = 'A' and t.SP is not null)
and PSP_A is not null
and length(decode(PSP_A,'1.3.4','1.3.4.01.01.01.001',PSP_A)) = 18
order by 1,3;

cursor SP_L_dare is
select distinct e_u 
,PCF
,decode(PSP_LIQ_D,'1.3.4','1.3.4.01.01.01.001',PSP_LIQ_D) conto
from GAT2.tmp_matrice_transizione
where anno = p_anno
and livello = 'V'
and pcf not in (select distinct t.pcf from nb_matrice_transizione t where t.anno = p_anno and t.e_u = e_u and t.G_L = 'L' and t.D_A = 'D' and t.SP is not null)
and PSP_LIQ_D is not null
and length(decode(PSP_LIQ_D,'1.3.4','1.3.4.01.01.01.001',PSP_LIQ_D)) = 18
order by 1,3;

cursor SP_L_avere is
select distinct e_u 
,PCF
,decode(PSP_LIQ_A,'1.3.4','1.3.4.01.01.01.001',PSP_LIQ_A) conto
from GAT2.tmp_matrice_transizione
where anno = p_anno
and livello = 'V'
and pcf not in (select distinct t.pcf from nb_matrice_transizione t where t.anno = p_anno and t.e_u = e_u and t.G_L = 'L' and t.D_A = 'A' and t.SP is not null)
and PSP_LIQ_A is not null
and length(decode(PSP_LIQ_A,'1.3.4','1.3.4.01.01.01.001',PSP_LIQ_A)) = 18
order by 1,3;


begin

	if nvl(p_strutture,'N') = 'S' and USER &lt;> 'GAT2'
		then
		-- aggiorno tabelle PCE
		delete nb_pce_06 where anno = p_anno; commit;
			delete nb_pce_05 where anno = p_anno; commit;
				delete nb_pce_04 where anno = p_anno; commit;
					delete nb_pce_03 where anno = p_anno; commit;
						delete nb_pce_02 where anno = p_anno; commit;
							delete nb_pce_01 where anno = p_anno; commit;
	    commit;
	    insert into nb_pce_01 select * from GAT2.nb_pce_01 where anno = p_anno; commit;
	    	insert into nb_pce_02 select * from GAT2.nb_pce_02 where anno = p_anno; commit;
	    		insert into nb_pce_03 select * from GAT2.nb_pce_03 where anno = p_anno; commit;
	    			insert into nb_pce_04 select * from GAT2.nb_pce_04 where anno = p_anno; commit;
	    				insert into nb_pce_05 select * from GAT2.nb_pce_05 where anno = p_anno; commit;
	    					insert into nb_pce_06 select * from GAT2.nb_pce_06 where anno = p_anno; commit;
	    -- aggiorno tabelle PSP						
	    delete nb_psp_07 where anno = p_anno; commit;
	    	 delete nb_psp_06 where anno = p_anno; commit;
		    	delete nb_psp_05 where anno = p_anno; commit;
					delete nb_psp_04 where anno = p_anno; commit;
						delete nb_psp_03 where anno = p_anno; commit;
							delete nb_psp_02 where anno = p_anno; commit;
								delete nb_psp_01 where anno = p_anno; commit;
	    commit;
	    insert into nb_psp_01 select * from GAT2.nb_psp_01 where anno = p_anno; commit;
	    	insert into nb_psp_02 select * from GAT2.nb_psp_02 where anno = p_anno; commit;
	    		insert into nb_psp_03 select * from GAT2.nb_psp_03 where anno = p_anno; commit;
	    			insert into nb_psp_04 select * from GAT2.nb_psp_04 where anno = p_anno; commit;
	    				insert into nb_psp_05 select * from GAT2.nb_psp_05 where anno = p_anno; commit;
	    					insert into nb_psp_06 select * from GAT2.nb_psp_06 where anno = p_anno; commit;
	    						insert into nb_psp_07 select * from GAT2.nb_psp_07 where anno = p_anno; commit;
	end if;

-- inserisco le righe per i conti CE Dare della scrittura Generica = 'G'
	for C in CE_G_dare loop

	    select count(*) + 1 into p_progr
		from nb_matrice_transizione
		where anno = p_anno
		and pcf = C.PCF
		and G_L = 'G';
	
    insert into nb_matrice_transizione(ANNO,E_U,PCF,G_L,PROGR,D_A,CE)
    	values (p_anno,C.E_U,C.PCF,'G',p_progr,'D',C.CONTO);

    end loop;
    commit;

-- inserisco le righe per i conti CE Avere della scrittura Generica = 'G'
	for C in CE_G_avere loop

	    select count(*) + 1 into p_progr
		from nb_matrice_transizione
		where anno = p_anno
		and pcf = C.PCF
		and G_L = 'G';
		

    insert into nb_matrice_transizione(ANNO,E_U,PCF,G_L,PROGR,D_A,CE)
    	values (p_anno,C.E_U,C.PCF,'G',p_progr,'A',C.CONTO);

    end loop;
    commit;

-- inserisco le righe per i conti SP Dare della scrittura Generica = 'G'
	for C in SP_G_dare loop

	    select count(*) + 1 into p_progr
		from nb_matrice_transizione
		where anno = p_anno
		and pcf = C.PCF
		and G_L = 'G';

    insert into nb_matrice_transizione(ANNO,E_U,PCF,G_L,PROGR,D_A,SP)
    	values (p_anno,C.E_U,C.PCF,'G',p_progr,'D',C.CONTO);

    end loop;
    commit;

-- inserisco le righe per i conti SP Avere della scrittura Generica = 'G'
	for C in SP_G_avere loop

	select count(*) + 1 into p_progr
		from nb_matrice_transizione
		where anno = p_anno
		and pcf = C.PCF
		and G_L = 'G';
    insert into nb_matrice_transizione(ANNO,E_U,PCF,G_L,PROGR,D_A,SP)
    	values (p_anno,C.E_U,C.PCF,'G',p_progr,'A',C.CONTO);

    end loop;
    commit;

-- inserisco le righe per i conti SP Dare della scrittura Liquidità = 'L'
	for C in SP_L_dare loop

	select count(*) + 1 into p_progr
		from nb_matrice_transizione
		where anno = p_anno
		and pcf = C.PCF
		and G_L = 'L';

    insert into nb_matrice_transizione(ANNO,E_U,PCF,G_L,PROGR,D_A,SP)
    	values (p_anno,C.E_U,C.PCF,'L',p_progr,'D',C.CONTO);

    end loop;
    commit;

-- inserisco le righe per i conti SP Avere della scrittura Liquidità = 'L'
	for C in SP_L_avere loop

		select count(*) + 1 into p_progr
		from nb_matrice_transizione
		where anno = p_anno
		and pcf = C.PCF
		and G_L = 'L';
		

    insert into nb_matrice_transizione(ANNO,E_U,PCF,G_L,PROGR,D_A,SP)
    	values (p_anno,C.E_U,C.PCF,'L',p_progr,'A',C.CONTO);

    end loop;
    commit;

end;</pre>	</td></tr>
</table></div>