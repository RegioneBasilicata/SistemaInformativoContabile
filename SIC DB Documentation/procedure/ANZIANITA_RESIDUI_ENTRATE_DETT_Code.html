<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>ANZIANITA_RESIDUI_ENTRATE_DETT</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="ANZIANITA_RESIDUI_ENTRATE_DETT.html">Details</a></div></div>
<div class="tab"><div><a href="ANZIANITA_RESIDUI_ENTRATE_DETT_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="ANZIANITA_RESIDUI_ENTRATE_DETT_References.html">References</a></div></div>
<div class="tab"><div><a href="ANZIANITA_RESIDUI_ENTRATE_DETT_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="ANZIANITA_RESIDUI_ENTRATE_DETT_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
procedure ANZIANITA_RESIDUI_ENTRATE_DETT(p_anno in number,p_codice_meccanografico in varchar2) as

v_compe number := 0;
v_cassa number := 0;
cod_mecc varchar2(10) := nvl(substr(p_codice_meccanografico,1,3),'XXX');



capitolo_e varchar2(6);
data_generazione date := to_date('3112'||p_anno,'ddmmyyyy');
anno_corr number := p_anno;
dip varchar2(2);
p_capitoli_vincolati varchar2(2000);

cursor capitoli is 
select 
    nvl(nb1.codice,'Da Def.') nb_titolo,
    nb1.descrizione nb_desc_titolo,
    bc.TITOLO                 titolo,
    bd.DESCRIZIONE_TITOLO            desc_titolo,
    bd.categoria                fo,
    bd.descrizione_categoria        desc_fo,
    bd.UPB    upb,
    bd.DESCRIZIONE_UPB            desc_upb,
    bc.CODICE                 codice_capitolo,
    bc.DESCRIZIONE                 desc_capitolo,
    bc.CODICE_MECCANOGRAFICO        codice_meccanografico,
    bc.CODICE_BILANCIO_SIOPE                 siope_bil,
    bc.CODICE_GESTIONALE_SIOPE               siope_gest,
    nvl(ftb.previsto_attuale,0)  previsione_competenza_capitoli, 
    nvl(ftb.cassa,0)  previsione_cassa_capitoli
    ,nvl(cd.motivazione_esclusione,'') motivazione_esclusione
    ,bc.NB_PIANO_CONTI_FINA
    ,pcf04.descrizione descr_pcf
from    fin_t_articoli bc,
        fin_v_bilancio_determine bd,
        fin_t_bilancio ftb
        ,fin_t_capitoli_dipartimenti cd
        ,nb_livello1 nb1
        ,nb_livello2 nb2
        ,nb_livello3 nb3
        ,nb_pcf_04 pcf04
where    bc.anno = p_anno and
    bc.eu= 'E' and
        ftb.eu||ftb.articolo = bc.eu||bc.codice  and
    ftb.anno = p_anno  and
    bd.anno = bc.anno and
        bd.EU = 'E' and 
        bd.CAPITOLO = bc.CODICE        
and (
substr(cod_mecc,1,1)=substr(bc.codice_meccanografico,1,1) or
substr(cod_mecc,1,1)='X' )
and (
substr(cod_mecc,2,1)=substr(bc.codice_meccanografico,2,1) or
substr(cod_mecc,2,1)='X' )
and (
substr(cod_mecc,3,1)=substr(bc.codice_meccanografico,3,1) or
substr(cod_mecc,3,1)='X' )
and nb1.id(+) = nb2.id_livello1
and   nb2.id(+) = nb3.id_livello2
and  bc.nb_id_padre = nb3.id(+)
and pcf04.anno(+) = bc.anno
and pcf04.eu(+) = bc.eu
and pcf04.codice_finale(+) = bc.NB_PIANO_CONTI_FINA
and cd.anno(+) = bc.anno
and cd.capitolo(+) = bc.eu||bc.codice
order by bc.eu||bc.codice;

cursor vincoli is
select capitolo_uscita
from fin_t_capitoli_vincolati
where anno = p_anno
and capitolo_entrata = capitolo_e
order by capitolo_uscita;

begin
delete tmp_anzianita_residui_dett where anno = p_anno and substr(capitolo,1,1) = 'E' and nvl(cod_mecc_utilizzato,'XXX') = cod_mecc;
commit;


for cap in capitoli loop
capitolo_e := 'E'||cap.codice_capitolo;
  begin
    select nvl(max(dipartimento),'NA') into dip
    from fin_t_capitoli_vincolati
    where anno = anno_corr 
    and capitolo_entrata = capitolo_e;
  end;
  if dip = 'NA'
    then 
    begin
      select dipartimento_principale into dip
      from fin_t_capitoli_dipartimenti
      where anno = anno_corr 
      and capitolo = capitolo_e;
      exception when others then dip := 'NA';
     end;
    end if;
E_MOVIMENTI_RESIDUI_DETT (anno_corr,capitolo_e);
E_MOVIMENTI_COMPETENZA_DETT (anno_corr,capitolo_e,data_generazione);

p_capitoli_vincolati := '';
 for v in vincoli loop
  p_capitoli_vincolati := p_capitoli_vincolati||v.capitolo_uscita||'-';
 end loop;
  p_capitoli_vincolati := trim(trailing '-' from p_capitoli_vincolati);

update tmp_anzianita_residui_DETT set 
     oggetto_capitolo = cap.desc_capitolo,
     cod_mecc_utilizzato = cod_mecc,
     dipartimento = dip,
     motivazione_esclusione = nvl(cap.motivazione_esclusione,''),
     capitoli_vincolati = p_capitoli_vincolati,
     NB_TITOLO        = cap.nb_titolo,
     NB_TITOLO_DESC = cap.nb_desc_titolo,
     NB_PCF         = cap.NB_PIANO_CONTI_FINA,
     NB_PCF_DESC    = cap.descr_pcf
     where anno = p_anno
     and capitolo = capitolo_e;
     commit;
capitolo_e := '';

end loop;
end;</pre>	</td></tr>
</table></div>