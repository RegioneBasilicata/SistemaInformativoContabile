<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>CALCOLO_RESIDUI_INIZIALI</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="CALCOLO_RESIDUI_INIZIALI.html">Details</a></div></div>
<div class="tab"><div><a href="CALCOLO_RESIDUI_INIZIALI_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="CALCOLO_RESIDUI_INIZIALI_References.html">References</a></div></div>
<div class="tab"><div><a href="CALCOLO_RESIDUI_INIZIALI_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="CALCOLO_RESIDUI_INIZIALI_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
procedure calcolo_residui_iniziali (p_anno in number, wutente in varchar2, risultato out number) is

p_risultato number := 0; 
-- se p_risultato = 0 tutte le procedure sono andate a buon fine
-- se = 1 non è andata a buon fine quella delle Entrate
-- se = 2 non è andata a buon fine quella delle UScite NON perenti
-- se = 3 non è andata a buon fine quella delle UScite PERENTI




BEGIN

  delete tmp_risposte_procedure where funzione='Calcolo Residui Iniziali' and utente = nvl(wutente,'TRACCIA');
  commit;

  risposte_procedure ('Calcolo Residui Iniziali',nvl(wutente,'TRACCIA'),'Anno '||p_anno||' - Inizio Elaborazione');


 -- ripulisco la fin_t_accertamenti_residui per l'anno di calcolo
 delete fin_t_accertamenti_residui where ANNO_FINANZIARIO = p_anno;
 commit;

-- inserisco i residui Attivi iniziali ricalcolati per l'anno di calcolo
	begin
	insert into fin_t_accertamenti_residui
		(
		ANNO_FINANZIARIO
		,DOC_ID_ACCERTAMENTO
		,NUMERO_ACCERTAMENTO
		,DATA_ACCERTAMENTO
		,OGGETTO_ACCERTAMENTO
		,TIPO_ACCERTAMENTO
		,IMPORTO_ORIGINARIO
		,RESIDUO_INIZIALE
		,CAPITOLO_SPESA_ORIGINARIO
		,CAPITOLO_SPESA_CORRENTE
		,DIPARTIMENTO
        ,PCF
		)
		select 	distinct
		p_anno,
		jugd.doc_id doc_id_accertamento,
		jugd.doc_SEQUENCE_VALUE NUMERO_accertamento,
		jugd.date_created DATA_accertamento,
		jugd.DESCRIPTION OGGETTO_accertamento,
		jugd.DOC_TYPE TIPO_accertamento,
		nvl(jugd.document_amount,0) importo_accertamento,
		residuo_acc_data(jugd.doc_id,to_date('3112'||p_anno -1,'ddmmyyyy')) residuo_iniziale,
		jugd.SEGMENT2 capitolo_acc_ORIGINARIO,
		substr(bi.ind_cap,1,6) capitolo_acc_CORRENTE,
		jugd.SEGMENT3 DIPARTIMENTO_ACCERTAMENTO,
        jugd.attribute16 PCF
		from
		fina_documenti 	jugd,                                                               
		bas_ind bi
		where                                                                                                                              
		jugd.doc_type = 'ACC'  				and                                                
		upper(nvl(jugd.deletion_status_flag,'N')) &lt;> 'Y' 	 	and                        
		upper(nvl(jugd.proposal_status_flag,'Z'))||upper(nvl(jugd.auditing_status_flag,'Z'))='PI' and
		bi.doc_id = jugd.doc_id      and
		bi.ind_anno = p_anno          and
		jugd.segment8 &lt; p_anno and
		residuo_acc_data(jugd.doc_id,to_date('3112'||p_anno -1,'ddmmyyyy')) > 0;
		commit;
	exception when dup_val_on_index then p_risultato := 1;
	end;

    risposte_procedure ('Calcolo Residui Iniziali',nvl(wutente,'TRACCIA'),'Anno '||p_anno||' - Risultato Residui Attivi:'||p_risultato);



 -- ripulisco la fin_t_impegni_residui per l'anno di calcolo

delete fin_t_impegni_residui where ANNO_FINANZIARIO = p_anno;
commit;

-- inserisco i Residui PAssivi iniziali NON in perenzione per l'anno di calcolo
begin
insert into fin_t_impegni_residui
			(
		 ANNO_FINANZIARIO
		,DOC_ID_IMPEGNO
		,NUMERO_IMPEGNO
		,DATA_IMPEGNO
		,OGGETTO_IMPEGNO
		,TIPO_IMPEGNO
		,IMPORTO_ORIGINARIO
		,RESIDUO_INIZIALE
		,CAPITOLO_SPESA_ORIGINARIO
		,CAPITOLO_SPESA_CORRENTE
		,DIPARTIMENTO
		,PERENZIONE
		,DATA_PERENZIONE
		,PRESCRIZIONE
		,DATA_PRESCRIZIONE
        ,PCF)
		(select  distinct
		 p_anno,
		 jugd.doc_id r_doc_id_impegno,
		 jugd.doc_sequence_value r_numero_impegno,
		 jugd.date_created	r_data_impegno,
		 jugd.description r_oggetto_impegno,
		 jugd.doc_type r_tipo_impegno,
		 nvl(jugd.document_amount,0) r_importo_impegno,
		res_ini_imp_data(jugd.doc_id,to_date('3112'||p_anno -1,'ddmmyyyy')) r_residuo_iniziale,	
		jugd.segment2 r_capitolo_spesa_originario,
		bi.ind_cap r_capitolo_spesa_corrente,
		jugd.segment3 r_dipartimento_impegno,
		'N' r_perenzione,
		null r_data_perenzione,
		'N' r_prescrizione,
		null r_DATA_PRESCRIZIONE,
        jugd.attribute16 PCF
		from	
		fina_documenti 		jugd,                                                               
		bas_ind 					bi
		where	
		jugd.doc_type in ('IMP','IMP-PER','IMP-DEF')  and   
		upper(nvl(jugd.deletion_status_flag,'N')) &lt;> 'Y' and                        
		upper(nvl(jugd.proposal_status_flag,'Z'))||upper(nvl(jugd.auditing_status_flag,'Z'))='PI' and
		jugd.segment8 &lt; p_anno and
		bi.doc_id = jugd.doc_id      and
		bi.ind_anno = p_anno and
		res_ini_imp_data(jugd.doc_id,to_date('3112'||p_anno -1,'ddmmyyyy')) > 0)
		UNION
		--PRENDO GLI IMPEGNI IN PERENZIONE DOPO L'ANNO DI INTERROGAZIONE 
		(select  distinct
		 p_anno,
		 jugd.doc_id r_doc_id_impegno,
		 jugd.doc_sequence_value r_numero_impegno,
		 jugd.date_created	r_data_impegno,
		 jugd.description r_oggetto_impegno,
		 jugd.doc_type r_tipo_impegno,
		 nvl(jugd.document_amount,0) r_importo_impegno,
		res_ini_imp_data(jugd.doc_id,to_date('3112'||p_anno -1,'ddmmyyyy')) r_residuo_iniziale,	
		jugd.segment2 r_capitolo_spesa_originario,
		bi.ind_cap r_capitolo_spesa_corrente,
		jugd.segment3 r_dipartimento_impegno,
		'N' r_perenzione,
		null r_data_perenzione,
		'N' r_prescrizione,
		null r_DATA_PRESCRIZIONE,
        jugd.attribute16 PCF 
		from	fin_t_documenti 		jugd,                                                               
		bas_ind     bi
		where	jugd.doc_type in ('IMP','IMP-DEF')  and   
		upper(nvl(jugd.proposal_status_flag,'B'))	&lt;> 'B' and
		upper(nvl(jugd.deletion_status_flag,'N')) &lt;> 'Y' and                        
		jugd.auditing_status_flag in ('T','B') 	and 
		jugd.segment8 &lt; p_anno and
		bi.doc_id = jugd.doc_id    and
		bi.ind_anno = p_anno    and
		to_number(to_char(jugd.data_perenzione,'yyyy')) >= p_anno + 1 and 
		res_ini_imp_data(jugd.doc_id,to_date('3112'||p_anno -1,'ddmmyyyy')) > 0
		);
		commit;
	exception when dup_val_on_index then p_risultato := 2;
	end;
    risposte_procedure ('Calcolo Residui Iniziali',nvl(wutente,'TRACCIA'),'Anno '||p_anno||' - Risultato Residui Passivi:'||p_risultato);

 -- inserisco i Residui Passivi iniziali IN perenzione
 begin
 insert into fin_t_impegni_residui
		(
		 ANNO_FINANZIARIO
		,DOC_ID_IMPEGNO
		,NUMERO_IMPEGNO
		,DATA_IMPEGNO
		,OGGETTO_IMPEGNO
		,TIPO_IMPEGNO
		,IMPORTO_ORIGINARIO
		,RESIDUO_INIZIALE
		,CAPITOLO_SPESA_ORIGINARIO
		,CAPITOLO_SPESA_CORRENTE
		,DIPARTIMENTO
		,PERENZIONE
		,DATA_PERENZIONE
		,PRESCRIZIONE
		,DATA_PRESCRIZIONE
        ,PCF)
		(

		 select	distinct 
		 p_anno,
		 jugd.doc_id r_doc_id_impegno,
		 jugd.doc_sequence_value r_numero_impegno,
		 jugd.date_created	r_data_impegno,
		 jugd.description r_oggetto_impegno,
		 jugd.doc_type r_tipo_impegno,
		 nvl(jugd.document_amount,0) r_importo_impegno,
		 residuo_impper_data(jugd.doc_id,to_date('3112'||p_anno -1,'ddmmyyyy')) r_residuo_iniziale,	
		 jugd.segment2 r_capitolo_spesa_originario,
		 bi.ind_cap r_capitolo_spesa_corrente,
		 jugd.segment3 r_dipartimento_impegno,
		 'S' r_perenzione,
		 jugd.DATA_PERENZIONE r_data_perenzione,
		 'N' r_prescrizione,
		 null r_DATA_PRESCRIZIONE,
         jugd.attribute16 PCF
		 from	fina_documenti 		jugd,                                                               
			bas_ind   bi
		 where	jugd.doc_type in ('IMP','IMP-PER','IMP-DEF')  and   
		    upper(nvl(jugd.proposal_status_flag,'B'))	&lt;> 'B' and
		 	upper(nvl(jugd.deletion_status_flag,'N')) &lt;> 'Y' and                        
		 	jugd.auditing_status_flag = 'T' 	and 
		 	jugd.segment8 &lt; p_anno and
			to_number(to_char(jugd.data_perenzione,'yyyy')) &lt; p_anno + 1   and
			bi.doc_id = jugd.doc_id       and
			bi.ind_anno = p_anno and
      residuo_impper_data(jugd.doc_id,to_date('3112'||p_anno -1,'ddmmyyyy')) > 0
		union
		--PRENDO TUTTI GLI IMPEGNI PRESCRITTI DOPO L'ANNO DI INTERROGAZIONE
		select	distinct 
		p_anno,
		 jugd.doc_id r_doc_id_impegno,
		 jugd.doc_sequence_value r_numero_impegno,
		 jugd.date_created	r_data_impegno,
		 jugd.description r_oggetto_impegno,
		 jugd.doc_type r_tipo_impegno,
		 nvl(jugd.document_amount,0) r_importo_impegno,
		 residuo_impper_data(jugd.doc_id,to_date('3112'||p_anno -1,'ddmmyyyy')) r_residuo_iniziale,	
		 jugd.segment2 r_capitolo_spesa_originario,
		 bi.ind_cap r_capitolo_spesa_corrente,
		 jugd.segment3 r_dipartimento_impegno,
		 'S' r_perenzione,
		 jugd.DATA_PERENZIONE r_data_perenzione,
		 'S' r_prescrizione,
		 jugd.DATA_PRESCRIZIONE r_DATA_PRESCRIZIONE,
         jugd.attribute16 PCF
		from	fina_documenti 		jugd,                                                               
		bas_ind   bi
		where	jugd.doc_type in ('IMP','IMP-PER','IMP-DEF')  and   
		upper(nvl(jugd.proposal_status_flag,'B'))	&lt;> 'B' and
		upper(nvl(jugd.deletion_status_flag,'N')) &lt;> 'Y' and                        
		jugd.auditing_status_flag = 'B' 	and 
		jugd.segment8 &lt; p_anno and
		to_number(to_char(jugd.data_prescrizione,'yyyy')) >= p_anno + 1  and
		bi.doc_id = jugd.doc_id       and
		bi.ind_anno = p_anno and
    	residuo_impper_data(jugd.doc_id,to_date('3112'||p_anno -1,'ddmmyyyy')) > 0 
		minus
		--TOLGO GLI IMPEGNI PRESCRITTI CHE SONO ANDATI IN PERENZIONE DOPO L'ANNO DI INTERROGAZIONE + 2
		select	distinct 
		p_anno,
		 jugd.doc_id r_doc_id_impegno,
		 jugd.doc_sequence_value r_numero_impegno,
		 jugd.date_created	r_data_impegno,
		 jugd.description r_oggetto_impegno,
		 jugd.doc_type r_tipo_impegno,
		 nvl(jugd.document_amount,0) r_importo_impegno,
		 residuo_impper_data(jugd.doc_id,to_date('3112'||p_anno - 1,'ddmmyyyy')) r_residuo_iniziale,	
		 jugd.segment2 r_capitolo_spesa_originario,
		 bi.ind_cap r_capitolo_spesa_corrente,
		 jugd.segment3 r_dipartimento_impegno,
		 'S' r_perenzione,
		 jugd.DATA_PERENZIONE r_data_perenzione,
		 'S' r_prescrizione,
		 jugd.DATA_PRESCRIZIONE r_DATA_PRESCRIZIONE,
         jugd.attribute16 PCF
		from	fina_documenti 		jugd,                                                               
		bas_ind    bi
		where	jugd.doc_type in ('IMP','IMP-PER','IMP-DEF')  and   
		upper(nvl(jugd.proposal_status_flag,'B'))	&lt;> 'B' and
		upper(nvl(jugd.deletion_status_flag,'N')) &lt;> 'Y' and                        
		jugd.auditing_status_flag = 'B' 	and 
		jugd.segment8 &lt; p_anno and
		to_number(to_char(jugd.data_perenzione,'yyyy')) >= p_anno + 1   and
		bi.doc_id = jugd.doc_id       and
		bi.ind_anno = p_anno and
    	residuo_impper_data(jugd.doc_id,to_date('3112'||p_anno -1,'ddmmyyyy')) > 0);
		commit;
		exception when dup_val_on_index then p_risultato := 3;
	end;
    risposte_procedure ('Calcolo Residui Iniziali',nvl(wutente,'TRACCIA'),'Anno '||p_anno||' - Risultato Residui in Perenzione:'||p_risultato);

    risposte_procedure ('Calcolo Residui Iniziali',nvl(wutente,'TRACCIA'),'Anno '||p_anno||' - Fine Elaborazione');

END calcolo_residui_iniziali;</pre>	</td></tr>
</table></div>