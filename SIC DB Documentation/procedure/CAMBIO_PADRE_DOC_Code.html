<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>CAMBIO_PADRE_DOC</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="CAMBIO_PADRE_DOC.html">Details</a></div></div>
<div class="tab"><div><a href="CAMBIO_PADRE_DOC_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="CAMBIO_PADRE_DOC_References.html">References</a></div></div>
<div class="tab"><div><a href="CAMBIO_PADRE_DOC_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="CAMBIO_PADRE_DOC_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
procedure cambio_padre_doc (p_numero_new in number,p_tipo_doc in varchar2,p_numero_doc in number) is
	
    
	-- p_numero_new numero del NUOVO documento padre
	-- p_tipo_doc tipo documento a cui cambiare il padre
    -- p_numero_doc numero del documento di cui si vuole cambiare la gerarchia
    
p_tipo_doc_padre varchar2(10); --tipo vecchio documento padre
p_numero_old number := 0; -- p_numero_old numero del VECCHIO documento padre
p_docid_old number := 0;--doc_id del VECCHIO documento padre
p_anno_old number; -- contiene l'anno del vecchio documento padre

p_docid_new number := 0;--doc_id del NUOVO documento padre
p_expedient_id number := 0; -- contiene il nuovo expedient_id da inserire sul doc p_numero_doc
p_open_balance_new number := 0; -- contiene residuo del nuovo doc padre
p_capitolo_new varchar2(6); -- contiene il capitolo del nuovo documento padre


p_docid_doc number := 0;--doc_id del documento di cui si vuole cambiare la gerarchia
p_document_amount_doc number := 0; -- contiene importo del doc da cambiare padre


p_anno_new number; -- contiene l'anno del nuovo documento padre

p_capitolo varchar2(6); -- contiene il capitolo del documento da aggiornare
p_anno number; -- contiene l'anno del documento da aggiornare

cursor figli is
select doc_id
from fin_t_documenti 
where previous_doc_id = p_docid_doc;


begin

-- delete tmp_risposte_procedure where funzione='Cambio padre documento' and utente = 'TRACCIA';
-- commit;

  begin
  	select p.doc_type,p.doc_id,p.doc_sequence_value,p.segment8
    ,f.doc_id,f.segment2,f.segment8,f.document_amount
  	into p_tipo_doc_padre,p_docid_old,p_numero_old,p_anno_old
    ,p_docid_doc,p_capitolo,p_anno,p_document_amount_doc
  	from fin_t_documenti p
    ,fin_t_documenti f
  	where f.doc_type = p_tipo_doc
    and f.doc_sequence_value = p_numero_doc
    and case 
        when nvl(f.OPEN_BALANCE_PROPOSED,0) > 0 and f.doc_type in ('MAND','REV') then 1
        when nvl(f.DELETION_STATUS_FLAG,'N') = 'N' and f.doc_type not in ('MAND','REV') then 1
        else 0
        end = 1
    and p.doc_id = f.previous_doc_id
  	and nvl(p.deletion_status_flag,'N') = 'N';
  	exception when no_data_found then p_docid_old := 0;
  end;

  if p_docid_old = 0
  then 
  risposte_procedure ('Cambio padre documento','TRACCIA',p_tipo_doc_padre||' - '||p_numero_old||' inesistente');
  return; --esco de il doc_id old non esiste
  end if;

  begin
  	select doc_id,expedient_id,segment8,open_balance_proposed,segment2
  	into p_docid_new,p_expedient_id,p_anno_new,p_open_balance_new,p_capitolo_new
  	from fin_t_documenti
  	where doc_type = p_tipo_doc_padre
  	and doc_sequence_value = p_numero_new
  	and nvl(deletion_status_flag,'N') = 'N';
  	exception when no_data_found then p_docid_new := 0;
  end;

  if p_docid_new = 0
  then 
  risposte_procedure ('Cambio padre documento','TRACCIA',p_tipo_doc_padre||' - '||p_numero_new||' inesistente');
  return; --esco de il doc_id new non esiste
  end if;

  
  if ( nvl(p_document_amount_doc,0) &lt;= nvl(p_open_balance_new,0) AND p_capitolo_new = p_capitolo )

  	then
    if p_tipo_doc_padre in ('ACC','IMP','IMP-DEF','IMP-PER')
    then
  	-- aggiorno i dati del DOC a cui cambiare padre in caso 2 livello gerarchia
	update fin_t_documenti set previous_doc_id = p_docid_new, expedient_id = p_expedient_id, doc_id_capo_filiera = p_docid_new 
		where doc_id = p_docid_doc;
	commit;
	risposte_procedure ('Cambio padre documento','TRACCIA','il Nuovo documento padre di '||p_tipo_doc||' - '||p_numero_doc||' e'' '||p_tipo_doc_padre||' - '||p_numero_new||' expedient_id = '||p_expedient_id||' previous_doc_id = '||p_docid_new);
    else 
    -- aggiorno i dati del DOC a cui cambiare padre in caso di 3 livello gerarchia
	update fin_t_documenti set previous_doc_id = p_docid_new 
		where doc_id = p_docid_doc;
	commit;
	risposte_procedure ('Cambio padre documento','TRACCIA','il Nuovo documento padre di '||p_tipo_doc||' - '||p_numero_doc||' e'' '||p_tipo_doc_padre||' - '||p_numero_new);
    end if;
	
    -- aggiorno expedient_id e doc_id_capo_filiera di tutti i figli (se esistono) del documento a cui si è cambiata la gerarchia
   for f in figli loop
    update fin_t_documenti set expedient_id = p_expedient_id, doc_id_capo_filiera = p_docid_new 
		where doc_id = f.doc_id
        and expedient_id &lt;> p_expedient_id
        and doc_id_capo_filiera &lt;> p_docid_new ;
	commit;
	risposte_procedure ('Cambio padre documento','TRACCIA','aggiornato expedient_id = '||p_expedient_id||' e previous_doc_id = '||p_docid_new||' a doc_id '||f.doc_id);
    end loop;
    commit;
    -- aggiorno i dati nuovo documeno padre
	update fin_t_documenti set open_balance_proposed = (open_balance_proposed - nvl(p_document_amount_doc,0))
		where doc_id = p_docid_new;
	commit;
	risposte_procedure ('Cambio padre documento','TRACCIA','il nuovo residuo di '||p_tipo_doc_padre||' - '||p_numero_new||' e'''||(nvl(p_open_balance_new,0)-nvl(p_document_amount_doc,0)));


    -- aggiorno i dati vecchio documeno padre
	update fin_t_documenti set open_balance_proposed = (open_balance_proposed + nvl(p_document_amount_doc,0))
		where doc_id = p_docid_old;
	commit;
	risposte_procedure ('Cambio padre documento','TRACCIA','aggiornato il residuo di '||p_tipo_doc_padre||' - '||p_numero_old);

    -- allineo bilancio nuovo
	allinea_bilancio_capitolo(p_anno,null,p_capitolo);

	if p_anno_old &lt;> p_anno
	 then allinea_bilancio_capitolo(p_anno_old,null,p_capitolo);
	end if;

	if p_anno_new &lt;> p_anno
	 then allinea_bilancio_capitolo(p_anno_new,null,p_capitolo);
	end if;

	risposte_procedure ('Cambio padre documento','TRACCIA','Procedura Allinea Bilancio Capitolo eseguita');
	else risposte_procedure ('Cambio padre documento','TRACCIA','Disponibilità nuovo documento padre non sufficiente');

  end if;

end;</pre>	</td></tr>
</table></div>