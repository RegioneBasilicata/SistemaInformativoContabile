<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>CREA_CONTO</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="CREA_CONTO.html">Details</a></div></div>
<div class="tab"><div><a href="CREA_CONTO_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="CREA_CONTO_References.html">References</a></div></div>
<div class="tab"><div><a href="CREA_CONTO_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="CREA_CONTO_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
PROCEDURE crea_conto(
    PI_ID_ANAGRAFICA IN NUMBER,
    PI_ID_SEDE IN NUMBER,                                                                                                                  
    PI_CONTO_CORRENTE IN VARCHAR2,                                                                                                             
    PI_MODALITA_PRINCIPALE_SN IN VARCHAR2,                                                                                                     
    PI_NOME_BANCA IN VARCHAR2,                                                                                                                 
    PI_SEDE_AGENZIA IN VARCHAR2,                                                                                                               
    PI_INDIRIZZO_AGENZIA IN VARCHAR2,                                                                                                                  
    PI_CITTA IN VARCHAR2,                                                                                                                      
    PI_CAP_AGENZIA IN VARCHAR2,                                                                                                                
    PI_PROVINCIA_AGENZIA IN VARCHAR2,                                                                                                          
    PI_ABI IN VARCHAR2,                                                                                                                        
    PI_CAB IN VARCHAR2,                                                                                                                        
    PI_CIN IN VARCHAR2,                                                                                                                        
    PI_IBAN IN VARCHAR2,                                                                                                                       
    PI_COD_FISC_UTENTE IN VARCHAR2,
    PO_ID_ANAGRAFICA IN OUT NUMBER,                                                                                                               
    PO_ID_SEDE IN OUT NUMBER,                                                                                                                     
    PO_ID_TIPO_PAGAMENTO IN OUT NUMBER,                                                                                                           
    PO_ID_CONTO_CORRENTE IN OUT NUMBER,                                                                                                           
    PO_CODICE_RISPOSTA IN OUT NUMBER,                                                                                                             
    PO_DESCRIZIONE_RISPOSTA IN OUT VARCHAR2)                                                                                                      
IS                                                                                                                                             
                                                                                                                                               
	conta number := 0;                                                                                                                           
	id_com_sede number;                                                                                                                          
	appoggio number := 0;                                                                                                                        
  ana_id number := 0;	    
  sede_id number := 0;	
  conta_iban	number := 0;                                                                                                                       
	err varchar2(1);                                                                                                                             
	num number;                                                                                                                                                                                                                                                               
  cc_si_no number := 0;                                                                                                                        
  abi_si_no number := 0;                                                                                                                       
  cab_si_no number := 0; 
  conto_corrente varchar2(20);-- cc da IBAN
  id_agenzia number := 0;
  id_conto_corrente number := 0;
  nome_utente varchar2(240) := 'XX' ;  
  id_tipo_pagamento number := 0;
  val_iban varchar2(1) := '0';
  modalita_principale varchar(2) :='N';
  v_banca_id number;
  comune_sede number(10,0);
  provincia_sede varchar2(2);
  cod_vers_bonifici varchar2(10);

                                                                                                                                               
BEGIN                                                                                                                                          
PO_ID_ANAGRAFICA := PI_ID_ANAGRAFICA;                                                                                                                         
PO_ID_SEDE := 0;                                                                                                                               
PO_ID_TIPO_PAGAMENTO := 0;                                                                                                                     
PO_ID_CONTO_CORRENTE := 0;                                                                                                                     
PO_CODICE_RISPOSTA := 1;                                                                                                                       
PO_DESCRIZIONE_RISPOSTA := 'Operazione terminata con successo!';                                                                               
  -- ****************** VERIFICA UTENTE ************************                                                                               
  begin                                                                                                                                        
    select user_name into nome_utente                                                                                                              
    from fnd_user                                                                                                                              
    where upper(nvl(cod_fiscale,'')) = upper(PI_COD_FISC_UTENTE);                                                                                          
    exception when others then nome_utente := 'XX';                                                                                                 
  end;                                                                                                                                         
  if nome_utente = 'XX'                                                                                                                            
    then PO_CODICE_RISPOSTA := 0;                                                                                                              
    PO_DESCRIZIONE_RISPOSTA := 'Utente non presente o non autorizzato ad operare nel SIC!';                                                    
    return;                                                                                                                                      
  end if;    
  
  -- ************ Verifico che esiste l'ID_ANAGRAFICA ******************
  BEGIN
    select count(*) into ana_id
    from fin_t_anagrafica
    where id = PI_ID_ANAGRAFICA;
    exception when no_data_found then ana_id := 0;
   END;
    if ana_id = 0
      then PO_CODICE_RISPOSTA := 0;                                                                                                              
      PO_DESCRIZIONE_RISPOSTA := 'Anagrafica non presente! Impossibile creare il conto!';                                                    
      return;                                                                                                                                      
    end if; 
  -- ************** FINE verifica ID_ANAGRAFICA ************************
   -- ************ Verifico che esiste l'ID_SEDE ******************
   BEGIN
    select count(*) into sede_id
    from fin_t_ana_sedi
    where id_ana = PI_ID_ANAGRAFICA
    and id_sede = pi_id_sede;
    exception when no_data_found then sede_id :=0;
    END;
    if sede_id = 0
      then PO_CODICE_RISPOSTA := 0;                                                                                                              
      PO_DESCRIZIONE_RISPOSTA := 'Sede non presente! Impossibile creare il conto corrente!';                                                    
      return;                                                                                                                                      
    end if; 
  -- ************** FINE verifica ID_SEDE ************************
 
  -- ******** Controlli GENERALI *******************
      
        -- Controlli per il conto corrente  
        
    if PI_CONTO_CORRENTE is null
     then conto_corrente := substr(PI_IBAN,16);
     else conto_corrente := PI_CONTO_CORRENTE; 
    end if;
                                                                                                                                              
         if PI_MODALITA_PRINCIPALE_SN is null                                                                                              
            or (PI_IBAN is null and nvl(upper(PI_NOME_BANCA),'XXX') not in ('UFFICIO POSTALE','BANCA D''ITALIA'))
            or (conto_corrente is null and nvl(upper(PI_NOME_BANCA),'XXX') in ('UFFICIO POSTALE','BANCA D''ITALIA'))                                                                                                        
         then PO_CODICE_RISPOSTA := 0;                                                                                                    
         PO_DESCRIZIONE_RISPOSTA := 'Mancano informazioni necessarie (IBAN, modalità principale o numero conto) alla creazione del conto corrente.';                                 
			  	return;                                                                                                                            
         end if;    
         
    -- ****** eliminato il 01/08/2016 su richiesta di MPomarici per la gestione fatture elettroniche     
     --    if translate(PI_CONTO_CORRENTE,'$0123456789','$') is not null
     --    then PO_CODICE_RISPOSTA := 0;                                                                                                    
     --    PO_DESCRIZIONE_RISPOSTA := 'Il numero del conto deve essere numerico.';                                 
		--	  	return;                                                                                                                            
    --     end if;
    -- ****** FINE **************************************************     
    
  -- ************** verifico se l'IBAN è già presente per lo stesso id_anagrafica **********
        if PI_IBAN is not null
        then
         BEGIN
             select count(*) into conta_iban
             from fin_t_ana_conti_bancari
             where id_ana = PI_ID_ANAGRAFICA
             and id_sede = PI_ID_SEDE  
             and iban = PI_IBAN;
             exception when no_data_found then conta_iban := 0;
          END;
            if nvl(conta_iban,0) > 0
               then PO_CODICE_RISPOSTA := 0;                                                                                                              
               PO_DESCRIZIONE_RISPOSTA := 'IBAN già presente sulla sede dell''anagrafica!';                                                    
               return;                                                                                                                                      
            end if; 
        val_iban := valida_iban(UPPER(PI_IBAN),'N');
        if val_iban &lt;> '0'
          then --PO_CODICE_RISPOSTA := 0;                                                                                                                       
          PO_DESCRIZIONE_RISPOSTA := PO_DESCRIZIONE_RISPOSTA||' Non è stato possibile validare l''IBAN!';
          return;
        end if;
        PO_DESCRIZIONE_RISPOSTA := PO_DESCRIZIONE_RISPOSTA||' c/c BANCARIO';
        end if;
        -- verifica la modalità principale su altri conti
        conta := 0;
        select count(*) into conta
        from fin_t_ana_conti_bancari
        where id_ana = pi_id_anagrafica
        and id_sede = pi_id_sede
        and nvl(modalita_principale_sn,'N') = 'S';
        
        if conta > 0 and nvl(PI_MODALITA_PRINCIPALE_SN,'N') = 'S'
          then update fin_t_ana_conti_bancari set modalita_principale_sn = 'N'
                where id_ana = pi_id_anagrafica
                and id_sede = pi_id_sede
                and nvl(modalita_principale_sn,'N') = 'S';
                commit;
        end if;
         if conta = 0 and nvl(PI_MODALITA_PRINCIPALE_SN,'N') &lt;> 'S'
          then modalita_principale := 'S';
        end if;
        -- FINE VERIFICA MOD_PRINC
            if nvl(upper(PI_NOME_BANCA),'XXX') = 'UFFICIO POSTALE'
                then v_banca_id := 34003;
                PO_DESCRIZIONE_RISPOSTA := PO_DESCRIZIONE_RISPOSTA||' c/c POSTALE';
            elsif nvl(upper(PI_NOME_BANCA),'XXX') = 'BANCA D''ITALIA'
                then
                begin
                select upper(c.provincia) into provincia_sede
                from fin_t_comuni c,
                fin_t_ana_sedi s
                where s.id_ana =  PI_ID_ANAGRAFICA
                and s.id_sede =     PI_ID_SEDE
                and c.id = s.id_comune_sede;
                exception when no_data_found then provincia_sede :='';
                end;                
                v_banca_id := 5015;
                cod_vers_bonifici := 'VERSAMENTO';
                PO_DESCRIZIONE_RISPOSTA := PO_DESCRIZIONE_RISPOSTA||' MOD. F24';
            else v_banca_id := null;
             end if;
             
     
  
       select (nvl(max(id),0) + 1) into id_conto_corrente                                                                                   
               from fin_t_ana_conti_bancari;   
        insert into fin_t_ana_conti_bancari (
        ID                     
        ,ID_ANA                
        ,ID_SEDE               
        ,BANCA_ID								
        ,CONTO_CORRENTE        
        ,MODALITA_PRINCIPALE_SN
        ,DATA_CREAZIONE        
        ,CIN                   
        ,IBAN                  
        ,DATA_AGGIORNAMENTO    
        ,UTENTE_CREAZIONE      
        ,UTENTE_AGGIORNAMENTO
        ,PROVINCIA_TESORERIA
        ,CODICE_VERSAMENTO_BONIFICI) 
        values (
        id_conto_corrente         
        ,PI_ID_ANAGRAFICA                    
        ,PI_ID_SEDE                        
        ,v_banca_id               
        ,nvl(conto_corrente,substr(UPPER(PI_IBAN),16))        
        ,modalita_principale
        ,sysdate                  
        ,nvl(PI_CIN,substr(UPPER(PI_IBAN),5,1))                   
        ,UPPER(PI_IBAN)                  
        ,null                     
        ,nome_utente                
        ,null
        ,nvl(provincia_sede,'')
        ,nvl(cod_vers_bonifici,''));
        commit;
        PO_ID_CONTO_CORRENTE := id_conto_corrente;
              -- **** FINE CONTO CORRENTE *******
  
END;</pre>	</td></tr>
</table></div>