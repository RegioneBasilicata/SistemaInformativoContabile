<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>EQUILIBRI_BILANCIO_RENDICONTO</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="EQUILIBRI_BILANCIO_RENDICONTO.html">Details</a></div></div>
<div class="tab"><div><a href="EQUILIBRI_BILANCIO_RENDICONTO_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="EQUILIBRI_BILANCIO_RENDICONTO_References.html">References</a></div></div>
<div class="tab"><div><a href="EQUILIBRI_BILANCIO_RENDICONTO_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="EQUILIBRI_BILANCIO_RENDICONTO_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
procedure      EQUILIBRI_BILANCIO_RENDICONTO(p_anno in number,p_utente in varchar2,p_id_report in number, p_data in date) as
 
 riga number :=0;
 c1 VARCHAR2(1000); --descrizione voce
 c2 VARCHAR2(100); -- desc 1 colonna importi
 c3 VARCHAR2(100); -- desc 2 colonna importi
 c4 VARCHAR2(100); -- desc 3 colonna importi

 n1 NUMBER := 0; -- per colonna "Previsioni"
 n2 NUMBER := 0; -- per colonna "Accertamenti/Impegni"
 n3 NUMBER := 0; -- per colonna "Reversali/Mandati"

 v1 NUMBER := 0; -- utilizzato come appoggio
 v2 NUMBER := 0; -- utilizzato come appoggio
 v3 NUMBER := 0; -- utilizzato come appoggio
 v4 NUMBER := 0; -- utilizzato come appoggio
 v5 NUMBER := 0; -- utilizzato come appoggio
 v6 NUMBER := 0; -- utilizzato come appoggio

 fpv_u_corrente number := 0; --utilizzato per inserire la quota di FPV uscite di parte corrente
 fpv_u_capitale number := 0; --utilizzato per inserire la quota di FPV uscite di parte capitale

 vdata_elaborazione date;
 p_anno1 number(4);
 p_anno2 number(4);

-- Vale a partire dal rendiconto 2016.

BEGIN

 DELETE tmp_tabulati 
 WHERE utente = p_utente;
 COMMIT;

 consuntivo_entrate(p_anno,null,p_data,p_utente);
 consuntivo_uscite(p_anno,null,p_data,p_utente);

 -- riga 1 intestazione principale 

 riga := 1;
 c1 := 'EQUILIBRIO ENTRATE FINALI - SPESE FINALI (ART. 1, comma 711, Legge di stabilità 2016)';
 c2 := 'PREVISIONI DI COMPETENZA al '||p_data;
 c3 := 'ACCERTAMENTI/IMPEGNI al '||p_data;
 c4 := 'CASSA al '||p_data;


  INSERT INTO tmp_tabulati (car01,car02,car03,car04,utente,num_ord_riga) 
  VALUES (c1,c2,c3,c4,p_utente,riga);  

-- riga 2 FPV E spese correnti
 riga := 2;
 c1 := 'A) Fondo pluriennale vincolato di entrata per spese correnti';
 n1 := 0;

      select nvl(sum(nvl(FPV_FONTE,0)),0)
      into n1
      from fin_t_consuntivo_excel
      where ANNO_CONSUNTIVO = p_anno
      and TIPO_CAPITOLO = 'U'
      and UTENTE = p_utente
      and NB_TITOLO &lt;> '2';

 INSERT INTO tmp_tabulati (car01,num01,num02,utente,num_ord_riga) 
 VALUES (c1,n1,n1,p_utente,riga);   

-- riga 3 FPV E capitale
 riga := 3;
 c1 := 'B) Fondo pluriennale vincolato di entrata in conto capitale  al netto delle quote finanziate da debito';
 n1 := 0;

      select nvl(sum(nvl(FPV_FONTE,0)),0)
      into n1
      from fin_t_consuntivo_excel
      where ANNO_CONSUNTIVO = p_anno
      and TIPO_CAPITOLO = 'U'
      and UTENTE = p_utente
      and NB_TITOLO = '2';

 INSERT INTO tmp_tabulati (car01,num01,num02,utente,num_ord_riga) 
 VALUES (c1,n1,n1,p_utente,riga); 

-- riga 4 Titolo1 Entrate correnti
 riga := 4;
 c1 := 'C) Titolo 1 - Entrate correnti di natura tributaria, contributiva e perequativa';
 n1 := 0;
 n2 := 0;
 n3 := 0;

    select 
    NVL(SUM(nvl(previsioni_definitive_compe,0)),0)
    ,NVL(SUM(nvl(ACCERTAMENTI_IMPEGNI_COMPE,0)),0)
    ,NVL(SUM(nvl(RISCOSSIONI_PAGAMENTI_TOTALE,0)),0)
    into n1,n2,n3
    from fin_t_consuntivo_excel
    where ANNO_CONSUNTIVO = p_anno
      and TIPO_CAPITOLO = 'E'
      and UTENTE = p_utente
      and substr(NB_LIVELLO1,1,1) = '1';

 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,n1,n2,n3,p_utente,riga); 

-- riga 5 Titolo2 Trasferimenti correnti
 riga := 5;
 c1 := 'D1) Titolo 2 - Trasferimenti correnti';
 n1 := 0;
 n2 := 0;
 n3 := 0;
 v1 := 0; -- per appoggiare il risultato di n1 per poter sottrare il valore n1 della riga successiva per la riga 7
 v2 := 0; -- per appoggiare il risultato di n2 per poter sottrare il valore n2 della riga successiva per la riga 7
 v3 := 0; -- per appoggiare il risultato di n3 per poter sottrare il valore n3 della riga successiva per la riga 7

    select 
    NVL(SUM(nvl(previsioni_definitive_compe,0)),0)
    ,NVL(SUM(nvl(ACCERTAMENTI_IMPEGNI_COMPE,0)),0)
    ,NVL(SUM(nvl(RISCOSSIONI_PAGAMENTI_TOTALE,0)),0)
    into n1,n2,n3
    from fin_t_consuntivo_excel
    where ANNO_CONSUNTIVO = p_anno
      and TIPO_CAPITOLO = 'E'
      and UTENTE = p_utente
      and substr(NB_LIVELLO1,1,1) = '2';

 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,n1,n2,n3,p_utente,riga); 
 commit;

  v1 := n1;
  v2 := n2;
  v3 := n3;

-- riga 6 Titolo2 Contributo di cui all''art. 1, comma 683, legge di stabilità 2016
 riga := 6;
 c1 := 'D2) Contributo di cui all''art. 1, comma 683, legge di stabilità 2016';
 n1 := 0;
 n2 := 0;
 n3 := 0;

 -- ricavo n1 previsione da fnd_reports_importi_man
  begin 
   select nvl(importo,0)
   into n1
   from fnd_reports_importi_man
   where nome_campo_report = 'D2_n1'
   and valore_parametro_anno = p_anno
   and id_report = p_id_report;
   exception when no_data_found then n1 := 0;
  end;

 -- ricavo n2 accertamenti da fnd_reports_importi_man
  begin 
   select nvl(importo,0)
   into n2
   from fnd_reports_importi_man
   where nome_campo_report = 'D2_n2'
   and valore_parametro_anno = p_anno
   and id_report = p_id_report;  
   exception when no_data_found then n2 := 0;
  end;

 -- ricavo n3 accertamenti da fnd_reports_importi_man
  begin
   select nvl(importo,0)
   into n3
   from fnd_reports_importi_man
   where nome_campo_report = 'D2_n3'
   and valore_parametro_anno = p_anno
   and id_report = p_id_report;   
   exception when no_data_found then n3 := 0;
  end; 

 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,n1,n2,n3,p_utente,riga); 
 commit;

-- riga 7 Titolo2 Trasferimenti correnti
 riga := 7;
 c1 := 'D) Titolo 2 - Trasferimenti correnti validi ai fini dei saldi finanza pubblica (D=D1-D2)';

 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,(v1-n1),(v2-n2),(v3-n3),p_utente,riga); 
 commit;

-- riga 8 E) Titolo 3 - Entrate extratributarie
 riga := 8;
 c1 := 'E) Titolo 3 - Entrate extratributarie';
 n1 := 0;
 n2 := 0;
 n3 := 0;

  select 
    NVL(SUM(nvl(previsioni_definitive_compe,0)),0)
    ,NVL(SUM(nvl(ACCERTAMENTI_IMPEGNI_COMPE,0)),0)
    ,NVL(SUM(nvl(RISCOSSIONI_PAGAMENTI_TOTALE,0)),0)
    into n1,n2,n3
    from fin_t_consuntivo_excel
    where ANNO_CONSUNTIVO = p_anno
      and TIPO_CAPITOLO = 'E'
      and UTENTE = p_utente
      and substr(NB_LIVELLO1,1,1) = '3';

 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,n1,n2,n3,p_utente,riga); 
 commit;


-- riga 9 F) Titolo 4 - Entrate in c/capitale
 riga := 9;
 c1 := 'F) Titolo 4 - Entrate in c/capitale';
 n1 := 0;
 n2 := 0;
 n3 := 0;

 select 
    NVL(SUM(nvl(previsioni_definitive_compe,0)),0)
    ,NVL(SUM(nvl(ACCERTAMENTI_IMPEGNI_COMPE,0)),0)
    ,NVL(SUM(nvl(RISCOSSIONI_PAGAMENTI_TOTALE,0)),0)
    into n1,n2,n3
    from fin_t_consuntivo_excel
    where ANNO_CONSUNTIVO = p_anno
      and TIPO_CAPITOLO = 'E'
      and UTENTE = p_utente
      and substr(NB_LIVELLO1,1,1) = '4';

 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,n1,n2,n3,p_utente,riga); 
 commit;

-- riga 10 G) Titolo 5 - Entrate da riduzione di attività finanziarie
 riga := 10;
 c1 := 'G) Titolo 5 - Entrate da riduzione di attività finanziarie';
 n1 := 0;
 n2 := 0;
 n3 := 0;

  select 
    NVL(SUM(nvl(previsioni_definitive_compe,0)),0)
    ,NVL(SUM(nvl(ACCERTAMENTI_IMPEGNI_COMPE,0)),0)
    ,NVL(SUM(nvl(RISCOSSIONI_PAGAMENTI_TOTALE,0)),0)
    into n1,n2,n3
    from fin_t_consuntivo_excel
    where ANNO_CONSUNTIVO = p_anno
      and TIPO_CAPITOLO = 'E'
      and UTENTE = p_utente
      and substr(NB_LIVELLO1,1,1) = '5';

 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,n1,n2,n3,p_utente,riga); 
 commit;

-- riga 11 H) ENTRATE FINALI   (H=C+D+E+F+G)
 riga := 11;
 c1 := 'H) ENTRATE FINALI   (H=C+D+E+F+G)';
 n1 := 0;
 n2 := 0;
 n3 := 0;

  -- calcolo somma C+D+E+F+G
    SELECT nvl(SUM(nvl(num01,0)),0),nvl(SUM(nvl(num02,0)),0),nvl(SUM(nvl(num03,0)),0) 
    INTO n1,n2,n3
    FROM tmp_tabulati
    WHERE utente = p_utente
    and num_ord_riga in (4,7,8,9,10);

 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,n1,n2,n3,p_utente,riga); 
 commit; 


-- riga 12 I1) Titolo 1 - Spese correnti al netto del fondo pluriennale vincolato
 riga := 12;
 c1 := 'I1) Titolo 1 - Spese correnti al netto del fondo pluriennale vincolato';
 n1 := 0;
 n2 := 0;
 n3 := 0;

  select 
    NVL(SUM(nvl(previsioni_definitive_compe,0)),0)
    ,NVL(SUM(nvl(ACCERTAMENTI_IMPEGNI_COMPE,0)),0)
    ,NVL(SUM(nvl(RISCOSSIONI_PAGAMENTI_TOTALE,0)),0)
    into n1,n2,n3
    from fin_t_consuntivo_excel
    where ANNO_CONSUNTIVO = p_anno
      and TIPO_CAPITOLO = 'U'
      and UTENTE = p_utente
      and NB_TITOLO = '1';

 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,n1,n2,n3,p_utente,riga); 
 commit;

-- riga 13 I2) Fondo pluriennale vincolato di parte corrente
 riga := 13;
 c1 := 'I2) Fondo pluriennale vincolato di parte corrente';
 n1 := 0;
 n2 := 0;
 n3 := 0;

 -- calcolo n2 valore competenza
    select NVL(SUM(nvl(fpv,0)),0)
    into n2
     from fin_t_consuntivo_excel
    where ANNO_CONSUNTIVO = p_anno
      and TIPO_CAPITOLO = 'U'
      and UTENTE = p_utente
      and NB_TITOLO = '1';


 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,n1,n2,n3,p_utente,riga); 
 commit;

 -- riga 14 I3) Fondo crediti di dubbia esigibilità di parte corrente
 riga := 14;
 c1 := 'I3) Fondo crediti di dubbia esigibilità di parte corrente';
 n1 := 0;
 n2 := 0;
 n3 := 0;

 -- ricavo n1 previsione da fnd_reports_importi_man
  begin
   select nvl(importo,0)
   into n1
   from fnd_reports_importi_man
   where nome_campo_report = 'I3_n1'
   and valore_parametro_anno = p_anno
   and id_report = p_id_report;
   exception when no_data_found then n1 := 0;
  end;

 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,n1,n2,n3,p_utente,riga); 
 commit;

 -- riga 15 I4) Fondo contenzioso (destinato a confluire nel risultato di amministrazione)
 riga := 15;
 c1 := 'I4) Fondo contenzioso (destinato a confluire nel risultato di amministrazione)';
 n1 := 0;
 n2 := 0;
 n3 := 0;

 -- ricavo n1 previsione da fnd_reports_importi_man
  begin
   select nvl(importo,0)
   into n1
   from fnd_reports_importi_man
   where nome_campo_report = 'I4_n1'
   and valore_parametro_anno = p_anno
   and id_report = p_id_report;
  exception when no_data_found then n1 := 0;
  end;

 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,n1,n2,n3,p_utente,riga); 
 commit;

 -- riga 16 I5) Altri accantonamenti (destinati a confluire nel risultato di amministrazione)
 riga := 16;
 c1 := 'I5) Altri accantonamenti (destinati a confluire nel risultato di amministrazione)';
 n1 := 0;
 n2 := 0;
 n3 := 0;

 -- ricavo n1 previsione da fnd_reports_importi_man
  begin
   select nvl(importo,0)
   into n1
   from fnd_reports_importi_man
   where nome_campo_report = 'I5_n1'
   and valore_parametro_anno = p_anno
   and id_report = p_id_report;
  exception when no_data_found then n1 := 0;
  end;

 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,n1,n2,n3,p_utente,riga); 
 commit;


-- riga 17 I6) Impegni del perimetro sanitario del bilancio finanziati dagli utilizzi del risultato di amministrazione relativo alla gestione sanitaria formatosi nell'esercizio 2015 (art. 1, c. 712-ter, legge stabilità 2016)
 riga := 17;
 c1 := 'I6) Impegni del perimetro sanitario del bilancio finanziati dagli utilizzi del risultato di amministrazione relativo alla gestione sanitaria formatosi nell''esercizio '||(p_anno-1)||' (art. 1, c. 712-ter, legge stabilità 2016)';
 n1 := 0;
 n2 := 0;
 n3 := 0;


   -- ricavo n2 impegni da fnd_reports_importi_man
  begin
   select nvl(importo,0)
   into n2
   from fnd_reports_importi_man
   where nome_campo_report = 'I6_n2'
   and valore_parametro_anno = p_anno
   and id_report = p_id_report;
  exception when no_data_found then n1 := 0;
  end;



 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,n1,n2,n3,p_utente,riga); 
 commit;

 -- riga 18 I) Titolo 1 - Spese correnti valide ai fini dei saldi di finanza pubblica (I=I1+I2-I3-I4-I5-I6)
 riga := 18;
 c1 := 'I) Titolo 1 - Spese correnti valide ai fini dei saldi di finanza pubblica (I=I1+I2-I3-I4-I5-I6)';
 n1 := 0;
 n2 := 0;
 n3 := 0;

 v1 := 0;
 v2 := 0;
 v3 := 0;
 v4 := 0;
 v5 := 0;
 v6 := 0;

-- ricavo v1 previsione da tmp_tabulati riga 12
  begin 
   select nvl(num01,0)
   into v1
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 12;
   exception when no_data_found then v1 := 0;
  end; 

--************************************************************************************
-- da verificare se anche il campo I2 deve essere indicato nella colonna previsioni n1
--************************************************************************************

-- ricavo v2 previsione da tmp_tabulati riga 14
  begin
   select nvl(num01,0)
   into v2
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 14;
   exception when no_data_found then v2 := 0;
  end; 

-- ricavo v3 previsione da tmp_tabulati riga 15
  begin
   select nvl(num01,0)
   into v3
   FROM tmp_tabulati
   WHERE utente = p_utente

   and num_ord_riga = 15;
    exception when no_data_found then v3 := 0;
  end; 
-- ricavo v4 previsione da tmp_tabulati riga 16
  begin
   select nvl(num01,0)
   into v4
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 16;
   exception when no_data_found then v4 := 0;
  end; 

 n1 := v1 - v2 - v3 - v4; --***** da verificare se anche il campo I2 deve essere indicato nella colonna previsioni n1
 v1 := 0;
 v2 := 0;
 v3 := 0;
 v4 := 0;

-- ricavo v1 compe da tmp_tabulati riga 12
  begin 
   select nvl(num02,0)
   into v1
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 12;
   exception when no_data_found then v1 := 0;
  end; 

--************************************************************************************
-- da verificare se anche il campo I2 deve essere indicato nella colonna previsioni n1
--************************************************************************************

-- ricavo v2 compe da tmp_tabulati riga 13
  begin
   select nvl(num02,0)
   into v2
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 13;
   exception when no_data_found then v2 := 0;
  end; 

-- ricavo v3 compe da tmp_tabulati riga 17
  begin
   select nvl(num02,0)
   into v3
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 17;
   exception when no_data_found then v4 := 0;
  end; 

 n2 := v1 + v2 - v3; --***** da verificare se anche il campo I2 deve essere indicato nella colonna previsioni n1
 v1 := 0;
 v2 := 0;
 v3 := 0;

-- ricavo v1 compe da tmp_tabulati riga 12
  begin 
   select nvl(num03,0)
   into v1
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 12;
   exception when no_data_found then v1 := 0;
  end; 

n3 := v1;

INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
VALUES (c1,n1,n2,n3,p_utente,riga); 
commit;

-- riga 19 L1) Titolo 2 - Spese in c/ capitale al netto del fondo pluriennale vincolato
 riga := 19;
 c1 := 'L1) Titolo 2 - Spese in c/ capitale al netto del fondo pluriennale vincolato';
 n1 := 0;
 n2 := 0;
 n3 := 0;


    select 
    NVL(SUM(nvl(previsioni_definitive_compe,0)),0)
    ,NVL(SUM(nvl(ACCERTAMENTI_IMPEGNI_COMPE,0)),0)
    ,NVL(SUM(nvl(RISCOSSIONI_PAGAMENTI_TOTALE,0)),0)
    ,NVL(SUM(nvl(FPV,0)),0)
    into n1,n2,n3,fpv_u_capitale
    from fin_t_consuntivo_excel
    where ANNO_CONSUNTIVO = p_anno
      and TIPO_CAPITOLO = 'U'
      and UTENTE = p_utente
      and NB_TITOLO = '2';


 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,n1,(n2 - fpv_u_capitale),n3,p_utente,riga); 
 commit;

-- riga 20 L2) Fondo pluriennale vincolato in c/capitale al netto delle quote finanziate da debito
 riga := 20;
 c1 := 'L2) Fondo pluriennale vincolato in c/capitale al netto delle quote finanziate da debito';
 n1 := 0;
 n2 := fpv_u_capitale;
 n3 := 0;

-- n2 calcolata già con fpv_u_capitale


 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,n1,fpv_u_capitale,n3,p_utente,riga); 
 commit;

 -- riga 21 L3) Fondo crediti di dubbia esigibilità in c/capitale
 riga := 21;
 c1 := 'L3) Fondo crediti di dubbia esigibilità in c/capitale';
 n1 := 0;
 n2 := 0;
 n3 := 0;


    SELECT
    NVL(SUM(nvl(previsioni_definitive_compe,0)),0)
    into n1
    from fin_t_consuntivo_excel
    where ANNO_CONSUNTIVO = p_anno
      and TIPO_CAPITOLO = 'U'
      and UTENTE = p_utente
      and CAPITOLO = '66001';

 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,n1,n2,n3,p_utente,riga); 
 commit; 

-- riga 22 L4) Altri accantonamenti (destinati a confluire nel risultato di amministrazione)
 riga := 22;
 c1 := 'L4) Altri accantonamenti (destinati a confluire nel risultato di amministrazione)';
 n1 := 0;
 n2 := 0;
 n3 := 0;

 -- ricavo n1 previsione da fnd_reports_importi_man
  begin
   select nvl(importo,0)
   into n1
   from fnd_reports_importi_man
   where nome_campo_report = 'L4_n1'
   and valore_parametro_anno = p_anno
   and id_report = p_id_report;
  exception when no_data_found then n1 := 0;
  end;

 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,n1,n2,n3,p_utente,riga); 
 commit; 


 n1 := 0;
-- riga 23 L) Titolo 2 - Spese in c/capitale valide ai fini dei saldi di finanza pubblica  (L=L1+L2-L3-L4)
 riga := 23;
 c1 := 'L) Titolo 2 - Spese in c/capitale valide ai fini dei saldi di finanza pubblica  (L=L1+L2-L3-L4)';
 n2 := 0;
 n3 := 0;

 v1 := 0;
 v2 := 0;
 v3 := 0;
 v4 := 0;
 v5 := 0;
 v6 := 0;

-- ricavo v1 previsione da tmp_tabulati riga 19
  begin 
   select nvl(num01,0)
   into v1
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 19;
   exception when no_data_found then v1 := 0;
  end; 


-- ricavo v2 previsione da tmp_tabulati riga 20
  begin
   select nvl(num01,0)
   into v2
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 20;
   exception when no_data_found then v2 := 0;
  end; 

-- ricavo v3 previsione da tmp_tabulati riga 21
  begin
   select nvl(num01,0)
   into v3
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 21;
    exception when no_data_found then v3 := 0;
  end; 

-- ricavo v4 previsione da tmp_tabulati riga 22
  begin
   select nvl(num01,0)
   into v4
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 22;
   exception when no_data_found then v4 := 0;
  end; 

 n1 := v1 + v2 + v3 - v4; --***** da verificare se anche il campo I2 deve essere indicato nella colonna previsioni n1
 v1 := 0;
 v2 := 0;
 v3 := 0;
 v4 := 0;

-- ricavo v1 compe da tmp_tabulati riga 19
  begin 
   select nvl(num02,0)
   into v1
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 19;
   exception when no_data_found then v1 := 0;
  end; 



-- ricavo v2 compe da tmp_tabulati riga 20
  begin
   select nvl(num02,0)
   into v2
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 20;
   exception when no_data_found then v2 := 0;
  end; 


 n2 := v1 + v2; --***** da verificare se anche il campo I2 deve essere indicato nella colonna previsioni n1
 v1 := 0;
 v2 := 0;
 v3 := 0;

-- ricavo v1 compe da tmp_tabulati riga 19
  begin 
   select nvl(num03,0)
   into v1
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 19;
   exception when no_data_found then v1 := 0;
  end; 

n3 := v1;

INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
VALUES (c1,n1,n2,n3,p_utente,riga); 
commit;

-- riga 24 M) Titolo 3 - Spese per incremento di attività finanziaria
 riga := 24;
 c1 := 'M) Titolo 3 - Spese per incremento di attività finanziaria';
 n1 := 0;
 n2 := 0;
 n3 := 0;

 select 
    NVL(SUM(nvl(previsioni_definitive_compe,0)),0)
    ,NVL(SUM(nvl(ACCERTAMENTI_IMPEGNI_COMPE,0)),0)
    ,NVL(SUM(nvl(RISCOSSIONI_PAGAMENTI_TOTALE,0)),0)
    into n1,n2,n3
    from fin_t_consuntivo_excel
    where ANNO_CONSUNTIVO = p_anno
      and TIPO_CAPITOLO = 'U'
      and UTENTE = p_utente
      and NB_TITOLO = '3';



 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,n1,n2,n3,p_utente,riga); 
 commit;

-- riga 25 N) SPESE FINALI  (N=I+L+M)
 riga := 25;
 c1 := 'N) SPESE FINALI  (N=I+L+M)';
 n1 := 0;
 n2 := 0;
 n3 := 0;


-- ricavo n1 previsione da tmp_tabulati dalle righe 18,23,24
  begin 
   select nvl(sum(nvl(num01,0)),0)
   into n1
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga in (18,23,24);
   exception when no_data_found then n1 := 0;
  end; 

-- ricavo n2 compe da tmp_tabulati dalle righe 18,23,24
  begin 
   select nvl(sum(nvl(num02,0)),0)
   into n2
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga in (18,23,24);
   exception when no_data_found then n2 := 0;
  end; 

-- ricavo n3 cassa da tmp_tabulati dalle righe 18,23,24
  begin 
   select nvl(sum(nvl(num03,0)),0)
   into n3
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga in (18,23,24);
   exception when no_data_found then n3 := 0;
  end; 

INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
VALUES (c1,n1,n2,n3,p_utente,riga); 
commit;

-- riga 26 J) Saldo anticipazione finanziamento sanità ( anticip. sanità concessa -  le relative regolazioni contabili per i rimborsi anticipazione sanità effettuate nell'anno)
 n2 := 0;
 riga := 26;
 c1 := 'J) Saldo anticipazione finanziamento sanità ( anticip. sanità concessa -  le relative regolazioni contabili per i rimborsi anticipazione sanità effettuate nell''anno)';
 n1 := 0;
 n3 := 0;

 v1 := 0;
 v2 := 0;
 v3 := 0;

 -- calcolo n1 valore previsione come differenza dei capitoli E42190 e U71290

    /*
    SELECT NVL(previsione_definitiva(p_anno,a.eu||a.codice),0) 
    INTO v1
    FROM vw_nb_articoli a
    WHERE a.anno = p_anno AND
       nvl(a.abilitato,'N') = 'S' AND
       a.eu||a.codice = 'E42190';

    SELECT NVL(previsione_definitiva(p_anno,a.eu||a.codice),0) 
    INTO v2
    FROM vw_nb_articoli a
    WHERE a.anno = p_anno AND
       nvl(a.abilitato,'N') = 'S' AND
       a.eu||a.codice = 'U71290';

     n1 := v1-v2;
     v1 := 0;
     v2 := 0;
    */


  -- calcolo n2 valore accertamenti - valore impegni dei capitoli E42190 e U71290

   /*
    SELECT NVL(SUM(nvl(d.document_amount,0)),0) 
    INTO v1
    FROM fin_t_documenti d
    WHERE d.segment8 = p_anno AND
    d.doc_type = 'ACC' AND
    nvl(d.deletion_status_flag,'N') = 'N' AND
    d.segment2 = 'E42190';


    SELECT NVL(SUM(nvl(d.document_amount,0)),0) 
    INTO v2
    FROM fin_t_documenti d
    WHERE d.segment8 = p_anno AND
    d.doc_type like 'IMP%' AND
    nvl(d.deletion_status_flag,'N') = 'N' AND
    d.segment2 = 'U71290';

    n2 := v1-v2;
    v1 := 0;
    v2 := 0;
   */

  -- calcolo n3 valore reversali e mandati di competenza dei capitoli E42190 e U71290

    select 
    NVL(SUM(nvl(RISCOSSIONI_PAGAMENTI_TOTALE,0)),0)
    into v1
    from fin_t_consuntivo_excel
    where ANNO_CONSUNTIVO = p_anno
      and TIPO_CAPITOLO = 'E'
      and UTENTE = p_utente
      and CAPITOLO = '42190';


    select 
    NVL(SUM(nvl(RISCOSSIONI_PAGAMENTI_TOTALE,0)),0)
    into v1
    from fin_t_consuntivo_excel
    where ANNO_CONSUNTIVO = p_anno
      and TIPO_CAPITOLO = 'U'
      and UTENTE = p_utente
      and CAPITOLO = '71290';


   n3 := v1 - v2;

 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,n1,n2,n3,p_utente,riga); 
 commit;


-- riga 27 O) SALDO TRA ENTRATE E SPESE FINALI VALIDE AI FINI DEI SALDI DI FINANZA PUBBLICA (O=A+B+H-N+J) 
 riga := 27;
 c1 := 'O) SALDO TRA ENTRATE E SPESE FINALI VALIDE AI FINI DEI SALDI DI FINANZA PUBBLICA (O=A+B+H-N+J)';
 n1 := 0;
 n2 := 0;
 n3 := 0;

 v1 := 0;
 v2 := 0;
 v3 := 0;
 v4 := 0;
 v5 := 0;
 v6 := 0;

-- ricavo v1 previsione da tmp_tabulati riga 2
  begin 
   select nvl(num01,0)
   into v1
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 2;
   exception when no_data_found then v1 := 0;
  end; 


-- ricavo v2 previsione da tmp_tabulati riga 3
  begin
   select nvl(num01,0)
   into v2
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 3;
   exception when no_data_found then v2 := 0;
  end; 

-- ricavo v3 previsione da tmp_tabulati riga 11
  begin
   select nvl(num01,0)
   into v3
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 11;
    exception when no_data_found then v3 := 0;
  end; 

-- ricavo v4 previsione da tmp_tabulati riga 25
  begin
   select nvl(num01,0)
   into v4
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 25;
   exception when no_data_found then v4 := 0;
  end; 

-- ricavo v5 previsione da tmp_tabulati riga 26
  begin
   select nvl(num01,0)
   into v4
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 26;
   exception when no_data_found then v4 := 0;
  end; 

 n1 := v1 + v2 + v3 - v4 + v5; 
 v1 := 0;
 v2 := 0;
 v3 := 0;
 v4 := 0;
 v5 := 0;

-- ricavo v1 previsione da tmp_tabulati riga 2
  begin 
   select nvl(num02,0)
   into v1
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 2;
   exception when no_data_found then v1 := 0;
  end; 


-- ricavo v2 previsione da tmp_tabulati riga 3
  begin
   select nvl(num02,0)
   into v2
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 3;
   exception when no_data_found then v2 := 0;
  begin
  end; 

-- ricavo v3 previsione da tmp_tabulati riga 11
   select nvl(num02,0)
   into v3
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 11;
    exception when no_data_found then v3 := 0;
  end; 

-- ricavo v4 previsione da tmp_tabulati riga 25
  begin
   select nvl(num02,0)
   into v4
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 25;
   exception when no_data_found then v4 := 0;
  end; 

-- ricavo v5 previsione da tmp_tabulati riga 26
  begin
   select nvl(num02,0)
   into v4
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 26;
   exception when no_data_found then v4 := 0;
  end; 

 n2 := v1 + v2 + v3 - v4 + v5; 
 v1 := 0;
 v2 := 0;
 v3 := 0;
 v4 := 0;
 v5 := 0;

 -- ricavo v1 previsione da tmp_tabulati riga 2
  begin 
   select nvl(num03,0)
   into v1
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 2;
   exception when no_data_found then v1 := 0;
  end; 


-- ricavo v2 previsione da tmp_tabulati riga 3
  begin
   select nvl(num03,0)
   into v2
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 3;
   exception when no_data_found then v2 := 0;
  end; 

-- ricavo v3 previsione da tmp_tabulati riga 11
  begin
   select nvl(num03,0)
   into v3
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 11;
    exception when no_data_found then v3 := 0;
  end; 

-- ricavo v4 previsione da tmp_tabulati riga 25
  begin
   select nvl(num03,0)
   into v4
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 25;
   exception when no_data_found then v4 := 0;
  end; 

-- ricavo v5 previsione da tmp_tabulati riga 26
  begin
   select nvl(num03,0)
   into v4
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 26;
   exception when no_data_found then v4 := 0;
  end; 

 n3 := v1 + v2 + v3 - v4 + v5; 
 v1 := 0;
 v2 := 0;
 v3 := 0;
 v4 := 0;
 v5 := 0;

INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
VALUES (c1,n1,n2,n3,p_utente,riga); 
commit;

 n1 := 0;
-- riga 28 P) Spazi finanziari ceduti agli enti locali  (art. 1, comma 728, L. n. 208/2015)
 riga := 28;
 c1 := 'P) Spazi finanziari ceduti agli enti locali  (art. 1, comma 728, L. n. 208/2015)';
 n2 := 0;
 n3 := 0;


 -- ricavo n1 previsione da fnd_reports_importi_man
  begin 
   select nvl(importo,0)
   into n1
   from fnd_reports_importi_man
   where nome_campo_report = 'P_n1'
   and valore_parametro_anno = p_anno
   and id_report = p_id_report;
   exception when no_data_found then n1 := 0;
  end;


 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,n1,n2,n3,p_utente,riga); 
 commit;

 -- riga 29 Q) SALDO TRA ENTRATE E SPESE FINALI NETTO (Q=O-P) 
 riga := 29;
 c1 := 'Q) SALDO TRA ENTRATE E SPESE FINALI NETTO (Q=O-P)';
 n1 := 0;
 n2 := 0;
 n3 := 0;

 v1 := 0;
 v2 := 0;
 v3 := 0;
 v4 := 0;
 v5 := 0;
 v6 := 0;

-- ricavo v1 previsione da tmp_tabulati riga 27
  begin 
   select nvl(num01,0)
   into v1
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 27;
   exception when no_data_found then v1 := 0;
  end; 


-- ricavo v2 previsione da tmp_tabulati riga 28
  begin
   select nvl(num01,0)
   into v2
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 28;
   exception when no_data_found then v2 := 0;
  end; 

  n1 := v1 - v2;

-- ricavo n2 compe da tmp_tabulati riga 27
  begin
   select nvl(num02,0)
   into n2
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 27;
    exception when no_data_found then n2 := 0;
   end;

-- ricavo n3 compe da tmp_tabulati riga 27
  begin
   select nvl(num03,0)
   into n3
   FROM tmp_tabulati
   WHERE utente = p_utente
   and num_ord_riga = 27;
    exception when no_data_found then n3 := 0;
   end;

 INSERT INTO tmp_tabulati (car01,num01,num02,num03,utente,num_ord_riga) 
 VALUES (c1,n1,n2,n3,p_utente,riga); 
 commit;


 END;</pre>	</td></tr>
</table></div>