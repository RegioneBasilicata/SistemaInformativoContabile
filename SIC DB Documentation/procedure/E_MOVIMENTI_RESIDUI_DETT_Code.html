<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>E_MOVIMENTI_RESIDUI_DETT</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="E_MOVIMENTI_RESIDUI_DETT.html">Details</a></div></div>
<div class="tab"><div><a href="E_MOVIMENTI_RESIDUI_DETT_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="E_MOVIMENTI_RESIDUI_DETT_References.html">References</a></div></div>
<div class="tab"><div><a href="E_MOVIMENTI_RESIDUI_DETT_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="E_MOVIMENTI_RESIDUI_DETT_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
PROCEDURE E_MOVIMENTI_RESIDUI_DETT (w_anno in out number, w_capitolo in out varchar) is

doc_id_accertamento number;
doc_id_storno_accertamento number;
doc_id_reversale number;
incassi_competenza number(15,2);
incassi_residui number(15,2);

appoggio_residuo_accertamento number(15,2);
appoggio_maggiori_incassi number(15,2);

totale_storno_reversale number(15,2);
totale_correzione_storno_acc number(15,2);
totale_storno_accertamenti number(15,2);
totale_insussistenza number(15,2);
p_anz_1 number(15,2):=0;
p_anz_2 number(15,2):=0;
p_anz_3 number(15,2):=0;
p_anz_4 number(15,2):=0;
p_anz_5 number(15,2):=0;
p_anz_6 number(15,2):=0;
p_anz_7 number(15,2):=0;
w_residuo_consuntivo number(15,2) := 0;
w_man_rev_residui number(15,2) := 0;
w_variazioni_residui number(15,2) := 0;

cursor accertamenti is
select 	distinct
substr(bi.ind_cap,1,6)										 capitolo_accertamento,
nvl(jugd.document_amount,0) 								 importo_accertamento,
to_number(to_char(jugd.date_created,'yyyy')) anno_accertamento,
jugd.doc_id 												 doc_id_accertamento,
jugd.doc_sequence_value numero_acc,
jugd.description oggetto_acc
from
fin_t_documenti 	jugd,                                                               
bas_ind              	bi
where                                                                                                                              
jugd.doc_type = 'ACC'                  and                                                
upper(nvl(jugd.deletion_status_flag,'N')) &lt;> 'Y'          and                        
upper(nvl(jugd.proposal_status_flag,'Z'))||upper(nvl(jugd.auditing_status_flag,'Z'))='PI' and
jugd.gl_date is not null                  and
jugd.period_name is not null                  and        
jugd.date_created is not null                  and        
bi.doc_id = jugd.doc_id      and
bi.ind_anno = w_anno          and
bi.ind_cap  = substr(w_capitolo,1,6)      and        
jugd.segment8 &lt; w_anno;


cursor storno_accertamenti is
select    
nvl(jugd.document_amount,0)                                            importo_storno_accertamento,
to_number(to_char(jugd.date_created,'yyyy'))         anno_storno_accertamento,
jugd.doc_id                                                                            doc_id_storno_accertamento,
jugd.doc_type                                                                        tipo_storno_accertamento,
jugd.previous_doc_id                                                        previous_doc_id_acc
from    
fina_documenti  jugd
where    
jugd.doc_type  in ('ST-ACC','INSUS')                  and                                                
upper(nvl(jugd.deletion_status_flag,'N')) &lt;> 'Y'         and                        
upper(nvl(jugd.proposal_status_flag,'Z'))||upper(nvl(jugd.auditing_status_flag,'Z'))='PI' and
jugd.gl_date is not null                 and
jugd.period_name is not null                 and        
jugd.date_created is not null                 and  
--jugd.date_created &lt;= w_data_creazione and
jugd.segment8 &lt;= w_anno and
jugd.previous_doc_id = doc_id_accertamento;

cursor corr_storno_accertamenti is
select    
nvl(jugd.document_amount,0)                                         importo_corr_accertamento,
to_number(to_char(jugd.date_created,'yyyy'))         anno_corr_accertamento,
jugd.previous_doc_id                                                        previous_doc_id_corr_acc
from    
fina_documenti         jugd
where    
jugd.doc_type = 'CORR_AC'                          and                                                
upper(nvl(jugd.deletion_status_flag,'N')) &lt;> 'Y'              and                        
upper(nvl(jugd.proposal_status_flag,'Z'))||upper(nvl(jugd.auditing_status_flag,'Z'))='PI' and
jugd.gl_date is not null                        and
jugd.period_name is not null                     and        
jugd.date_created is not null                     and  
--jugd.date_created &lt;= w_data_creazione and
jugd.segment8 &lt;= w_anno and
jugd.previous_doc_id = doc_id_storno_accertamento;

cursor reversali is
select     
nvl(jugd1.document_amount,0)                                         importo_reversale,
jugd1.doc_id                                                                        doc_id_reversale,
to_number(to_char(jugd1.date_created,'yyyy'))      anno_reversale,
jugd1.previous_doc_id                                                        previous_doc_id_reversale
from    
fin_t_documenti         jugd1
where     
jugd1.doc_type = 'REV' and
jugd1.date_created is not null and
upper(nvl(jugd1.proposal_status_flag,'Z'))||upper(nvl(jugd1.auditing_status_flag,'Z'))='PI' and
upper(nvl(jugd1.deletion_status_flag,'N')) &lt;> 'Y' and
jugd1.segment8 &lt;= w_anno and
jugd1.previous_doc_id    = doc_id_accertamento;

cursor storno_reversali is
select    
nvl(jugd1.document_amount,0)                                     importo_storno_reversale,
jugd1.previous_doc_id                                                 previous_doc_id_storno_rev
from    
fina_documenti         jugd1
where    
jugd1.doc_type = 'ST-REV' and
upper(nvl(jugd1.proposal_status_flag,'Z'))||upper(nvl(jugd1.auditing_status_flag,'Z'))='PI' and
upper(nvl(jugd1.deletion_status_flag,'N')) &lt;> 'Y' and
jugd1.segment8 &lt;= w_anno and
jugd1.previous_doc_id = doc_id_reversale;

BEGIN
p_anz_1 :=0;
p_anz_2 :=0;
p_anz_3 :=0;
p_anz_4 :=0;
p_anz_5 :=0;
p_anz_6 :=0;
p_anz_7 :=0;

for a in accertamenti loop
 doc_id_accertamento := a.doc_id_accertamento;
 incassi_competenza := 0;
 incassi_residui := 0;
 
-- calcolo reversali 
 for r in reversali loop

  totale_storno_reversale := 0;
     doc_id_reversale := r.doc_id_reversale;

  for sr in storno_reversali loop
   totale_storno_reversale := totale_storno_reversale + nvl(sr.importo_storno_reversale,0);    
  end loop;

  if r.anno_reversale &lt; w_anno
       then incassi_residui := incassi_residui + (nvl(r.importo_reversale,0) - nvl(totale_storno_reversale,0));
       else incassi_competenza := incassi_competenza + (nvl(r.importo_reversale,0) - nvl(totale_storno_reversale,0));
  end if;

 end loop;
-- fine calcolo reversali

-- calcolo storno_accertamenti 
 totale_storno_accertamenti := 0;
 totale_insussistenza := 0;
 for sa in storno_accertamenti loop

  totale_correzione_storno_acc := 0;
     doc_id_storno_accertamento := sa.doc_id_storno_accertamento;

  for csa in corr_storno_accertamenti loop
   totale_correzione_storno_acc := totale_correzione_storno_acc + nvl(csa.importo_corr_accertamento,0);    
  end loop;

  if sa.anno_storno_accertamento &lt; w_anno
       then   totale_storno_accertamenti := totale_storno_accertamenti + (nvl(sa.importo_storno_accertamento,0) - nvl(totale_correzione_storno_acc,0));
       elsif sa.tipo_storno_accertamento = 'INSUS'
             then totale_insussistenza := totale_insussistenza + (nvl(sa.importo_storno_accertamento,0) - nvl(totale_correzione_storno_acc,0));
  end if;

 end loop;

-- fine calcolo storno accertamenti
  
  appoggio_maggiori_incassi := 0;
   
  appoggio_residuo_accertamento := (nvl(a.importo_accertamento,0) - nvl(totale_storno_accertamenti,0) - nvl(incassi_residui,0));
  
  if appoggio_residuo_accertamento  &lt;= 0                       
       then appoggio_residuo_accertamento := 0;
  end if;
  
  if nvl(incassi_competenza,0) > appoggio_residuo_accertamento
       then appoggio_maggiori_incassi := incassi_competenza - appoggio_residuo_accertamento;
--            incassi_competenza := appoggio_residuo_accertamento;
  end if;
  
  if a.anno_accertamento &lt;= w_anno - 7 
  	 then p_anz_1 := appoggio_residuo_accertamento - incassi_competenza + appoggio_maggiori_incassi + (nvl(totale_insussistenza,0)* -1);
  end if;
  if a.anno_accertamento = w_anno - 6 
  	 then p_anz_2 := appoggio_residuo_accertamento - incassi_competenza + appoggio_maggiori_incassi + (nvl(totale_insussistenza,0)* -1);
  end if;
  if a.anno_accertamento = w_anno - 5 
  	 then p_anz_3 := appoggio_residuo_accertamento - incassi_competenza + appoggio_maggiori_incassi + (nvl(totale_insussistenza,0)* -1);
  end if;
  if a.anno_accertamento = w_anno - 4 
  	 then p_anz_4 := appoggio_residuo_accertamento - incassi_competenza + appoggio_maggiori_incassi + (nvl(totale_insussistenza,0)* -1);
  end if;
  if a.anno_accertamento = w_anno - 3 
  	 then p_anz_5 := appoggio_residuo_accertamento - incassi_competenza + appoggio_maggiori_incassi + (nvl(totale_insussistenza,0)* -1);
  end if;
  if a.anno_accertamento = w_anno - 2 
  	 then p_anz_6 := appoggio_residuo_accertamento - incassi_competenza + appoggio_maggiori_incassi + (nvl(totale_insussistenza,0)* -1);
  end if;
  if a.anno_accertamento = w_anno - 1 
  	 then p_anz_7 := appoggio_residuo_accertamento - incassi_competenza + appoggio_maggiori_incassi + (nvl(totale_insussistenza,0)* -1);
  end if;
  
  w_residuo_consuntivo :=  nvl(appoggio_residuo_accertamento,0);

  w_man_rev_residui := nvl(incassi_competenza,0);
   
  w_variazioni_residui := nvl(appoggio_maggiori_incassi,0) + (nvl(totale_insussistenza,0)* -1); 
-- inserimento in TMP_ANZIANITA_RESIDUI_DETT
if (nvl(p_anz_1,0) + nvl(p_anz_2,0) + nvl(p_anz_3,0) + nvl(p_anz_4,0) + nvl(p_anz_5,0) + nvl(p_anz_6,0) + nvl(p_anz_7,0) + (nvl(w_residuo_consuntivo,0) - nvl(w_man_rev_residui,0) + nvl(w_variazioni_residui,0))) > 0
  then      
    insert into TMP_ANZIANITA_RESIDUI_DETT(ANNO
    ,CAPITOLO
    ,TIPO_DOC
    ,NUMERO_DOC
    ,OGGETTO_DOC
    ,RES_ANNO1
    ,RES_ANNO2
    ,RES_ANNO3
    ,RES_ANNO4
    ,RES_ANNO5
    ,RES_ANNO6
    ,RES_ANNO7
    ,RIMANENZA)
    values
    (w_anno,w_capitolo,'ACC',a.numero_acc,a.oggetto_acc
    ,nvl(p_anz_1,0)
    ,nvl(p_anz_2,0)
    ,nvl(p_anz_3,0)
    ,nvl(p_anz_4,0)
    ,nvl(p_anz_5,0)
    ,nvl(p_anz_6,0)
    ,nvl(p_anz_7,0)
    ,(nvl(w_residuo_consuntivo,0) - nvl(w_man_rev_residui,0) + nvl(w_variazioni_residui,0)));
    commit;
  end if; 
--azzeramento variabili
appoggio_residuo_accertamento :=0;
incassi_competenza :=0;
appoggio_maggiori_incassi :=0;
totale_insussistenza :=0;
w_residuo_consuntivo := 0;
w_man_rev_residui := 0;
w_variazioni_residui := 0;  
p_anz_1 :=0;
p_anz_2 :=0;
p_anz_3 :=0;
p_anz_4 :=0;
p_anz_5 :=0;
p_anz_6 :=0;
p_anz_7 :=0;                      
end loop;

END;</pre>	</td></tr>
</table></div>