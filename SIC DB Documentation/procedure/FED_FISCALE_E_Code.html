<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>FED_FISCALE_E</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="FED_FISCALE_E.html">Details</a></div></div>
<div class="tab"><div><a href="FED_FISCALE_E_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="FED_FISCALE_E_References.html">References</a></div></div>
<div class="tab"><div><a href="FED_FISCALE_E_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="FED_FISCALE_E_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
PROCEDURE        FED_FISCALE_E (p_anno in number, p_data in date) as
accertamenti number(15,2) := 0;
incassi number(15,2) := 0;
acc_gsa number(15,2) := 0;
inc_gsa number(15,2) := 0;
num_ord number := 1;
data_mov date := nvl(p_data,to_date('3112'||p_anno,'ddmmyyyy'));
--p_anno number := 2008;


cursor siope_bilancio is
select anno
,eu
,codice_bil1
,nvl(codice_bil2,0) codice_bil2
,nvl(codice_bil3,0) codice_bil3
,descrizione
,codice_gestionale
,nvl(visibile,'N') visibile
from fin_t_struttura_siope
where anno = p_anno
and eu = 'E'
--and codice_gestionale is null
order by 3,4,5,nvl(codice_gestionale,0);

begin
delete fin_t_importi_fed_fiscale where anno = p_anno and eu = 'E';
commit;
 for s in siope_bilancio loop
 num_ord := num_ord + 1;
 if s.codice_gestionale is not null and s.visibile = 'S'
 then
  
      select nvl(sum(nvl(d.document_amount,0)),0)
      into accertamenti
      from fin_t_documenti d
      ,fin_t_articoli a
      where a.anno = p_anno
      and a.eu = s.eu
      and decode(a.codice,'01065','10104','01240','10206','01241','10206','09486','40201','09487','40201','09488','40201','09801','40201','09606','40201','06068','30204','07162','30203',a.codice_bilancio_siope) 
      = nvl(s.codice_bil1,0)||nvl(s.codice_bil2,0)||nvl(s.codice_bil3,0) --richiesta Sarli per errata associazione del codice Bilancio SIOPE
      and decode(a.codice,'01065','1140','01240','1260','01241','1260','09486','4211','09487','4211','09488','4211','09801','4215','09606','4215','06068','3240','18210','2137',nvl(a.codice_gestionale_siope,s.codice_gestionale)) = s.codice_gestionale
      and d.doc_type = 'ACC'
      and nvl(d.deletion_status_flag,'N') = 'N'
      and d.segment8 = a.anno
      and d.segment2 = a.eu||a.codice
      and d.date_created &lt;= data_mov;
 
      select nvl(sum(nvl(t.amount,0)),0)
      into incassi
      from fin_t_documenti d
      ,fin_t_documenti_terze_parti t
      ,fin_t_siope x
      where d.segment8 = p_anno
      and d.doc_type = 'REV'
      and nvl(d.open_balance_proposed,0) > 0
      and d.date_created &lt;= data_mov
      and t.doc_id = d.doc_id
      and x.eu = 'E'
      and x.codice_gestionale = t.codice_gestionale_siope
      and x.codice_bilancio = nvl(s.codice_bil1,0)||nvl(s.codice_bil2,0)||nvl(s.codice_bil3,0)
      and t.codice_gestionale_siope = s.codice_gestionale;

      select nvl(sum(nvl(d.document_amount,0)),0)
      into acc_gsa
      from fin_t_documenti d
      ,fin_t_articoli a
      where a.anno = p_anno
      and a.eu = s.eu
      and decode(a.codice,'01065','10104','01240','10206','01241','10206','09486','40201','09487','40201','09488','40201','09801','40201','09606','40201','06068','30204','07162','30203',a.codice_bilancio_siope) 
      = nvl(s.codice_bil1,0)||nvl(s.codice_bil2,0)||nvl(s.codice_bil3,0) --richiesta Sarli per errata associazione del codice Bilancio SIOPE
      and decode(a.codice,'01065','1140','01240','1260','01241','1260','09486','4211','09487','4211','09488','4211','09801','4215','09606','4215','06068','3240','18210','2137',nvl(a.codice_gestionale_siope,s.codice_gestionale)) = s.codice_gestionale
      and nvl(a.sanita_sn,'N') = 'S'
      and d.doc_type = 'ACC'
      and nvl(d.deletion_status_flag,'N') = 'N'
      and d.segment8 = a.anno
      and d.segment2 = a.eu||a.codice
      and d.date_created &lt;= data_mov;
      
       select nvl(sum(nvl(t.amount,0)),0)
      into inc_gsa
      from fin_t_documenti d
      ,fin_t_documenti_terze_parti t
      ,fin_t_siope x
      ,fin_t_articoli a 
      where d.segment8 = p_anno
      and d.doc_type = 'REV'
      and nvl(d.open_balance_proposed,0) > 0
      and d.date_created &lt;= data_mov
      and t.doc_id = d.doc_id
      and x.eu = 'E'
      and x.codice_gestionale = t.codice_gestionale_siope
      and x.codice_bilancio = nvl(s.codice_bil1,0)||nvl(s.codice_bil2,0)||nvl(s.codice_bil3,0)
      and t.codice_gestionale_siope = s.codice_gestionale
      and a.anno = d.segment8
      and a.eu||a.codice = d.segment2
      and nvl(a.sanita_sn,'N') = 'S';

      insert into fin_t_importi_fed_fiscale (ANNO,EU,NUMERO_ORDINE,SIOPE1,SIOPE2,SIOPE3,SIOPE_DESCRIZIONE,COL1,COL2,COL3,COL4)
     values (
     p_anno
     ,s.eu
     ,num_ord
     ,s.codice_bil1
     ,s.codice_bil2
     ,s.codice_bil3
     ,s.descrizione
     ,nvl(accertamenti,0)
     ,nvl(incassi,0)
     ,nvl(acc_gsa,0)
     ,nvl(inc_gsa,0)
     );
     commit;
 elsif to_number(s.codice_bil2) > 0 and to_number(s.codice_bil3) = 0 and s.visibile = 'S'
 then -- se il codice bilancio ha solo 2 livelli movimentati es . 1 04
   
   select nvl(sum(nvl(d.document_amount,0)),0)
      into accertamenti
      from fin_t_documenti d
      ,fin_t_articoli a
      where a.anno = p_anno
      and a.eu = s.eu
      and substr(decode(a.codice,'01065','10104','01240','10206','01241','10206','09486','40201','09487','40201','09488','40201','09801','40201','09606','40201','06068','30204','07162','30203',a.codice_bilancio_siope),1,3) 
      = nvl(s.codice_bil1,0)||nvl(s.codice_bil2,0) --richiesta Sarli per errata associazione del codice Bilancio SIOPE
      and d.doc_type = 'ACC'
      and nvl(d.deletion_status_flag,'N') = 'N'
      and d.segment8 = a.anno
      and d.segment2 = a.eu||a.codice
      and d.date_created &lt;= data_mov;
     
  
   -- se il codice bilancio ha solo 2 livelli movimentati es . 1 04
    select nvl(sum(nvl(t.amount,0)),0)
    into incassi
    from fin_t_documenti d
    ,fin_t_documenti_terze_parti t
    ,fin_t_siope x
    where d.segment8 = p_anno
    and d.doc_type = 'REV'
    and nvl(d.open_balance_proposed,0) > 0
    and d.date_created &lt;= data_mov
    and t.doc_id = d.doc_id
    and x.eu = 'E'
    and x.codice_gestionale = t.codice_gestionale_siope
    and substr(x.codice_bilancio,1,3) = nvl(s.codice_bil1,0)||nvl(s.codice_bil2,0);
    
  select nvl(sum(nvl(d.document_amount,0)),0)
      into acc_gsa
      from fin_t_documenti d
      ,fin_t_articoli a
      where a.anno = p_anno
      and a.eu = s.eu
      and substr(decode(a.codice,'01065','10104','01240','10206','01241','10206','09486','40201','09487','40201','09488','40201','09801','40201','09606','40201','06068','30204','07162','30203',a.codice_bilancio_siope),1,3) 
      = nvl(s.codice_bil1,0)||nvl(s.codice_bil2,0) --richiesta Sarli per errata associazione del codice Bilancio SIOPE
      and nvl(a.sanita_sn,'N') = 'S'
      and d.doc_type = 'ACC'
      and nvl(d.deletion_status_flag,'N') = 'N'
      and d.segment8 = a.anno
      and d.segment2 = a.eu||a.codice
      and d.date_created &lt;= data_mov;
     
    select nvl(sum(nvl(t.amount,0)),0)
    into inc_gsa
    from fin_t_documenti d
    ,fin_t_documenti_terze_parti t
    ,fin_t_siope x
    ,fin_t_articoli a
    where d.segment8 = p_anno
    and d.doc_type = 'REV'
    and nvl(d.open_balance_proposed,0) > 0
    and d.date_created &lt;= data_mov
    and t.doc_id = d.doc_id
    and x.eu = 'E'
    and x.codice_gestionale = t.codice_gestionale_siope
    and substr(x.codice_bilancio,1,3) = nvl(s.codice_bil1,0)||nvl(s.codice_bil2,0)
    and a.anno = d.segment8
    and a.eu||a.codice = d.segment2
    and nvl(a.sanita_sn,'N') = 'S';
     
    
     
     insert into fin_t_importi_fed_fiscale (ANNO,EU,NUMERO_ORDINE,SIOPE1,SIOPE2,SIOPE3,SIOPE_DESCRIZIONE,COL1,COL2,COL3,COL4)
   values (
   p_anno
   ,s.eu
   ,num_ord
   ,s.codice_bil1
   ,s.codice_bil2
   ,s.codice_bil3
   ,s.descrizione
   ,nvl(accertamenti,0)
   ,nvl(incassi,0)
   ,nvl(acc_gsa,0)
   ,nvl(inc_gsa,0)
   );
   commit;
  elsif to_number(s.codice_bil2) > 0 and to_number(s.codice_bil3) > 0 and s.visibile = 'S'
  then
 -- se il codice bilancio ha solo 2 livelli movimentati es . 1 04 01 ma il codice gestionale è nullo
      select nvl(sum(nvl(d.document_amount,0)),0)
      into accertamenti
      from fin_t_documenti d
      ,fin_t_articoli a
      where a.anno = p_anno
      and a.eu = s.eu
      and decode(a.codice,'01065','10104','01240','10206','01241','10206','09486','40201','09487','40201','09488','40201','09801','40201','09606','40201','06068','30204','07162','30203',a.codice_bilancio_siope) 
      = nvl(s.codice_bil1,0)||nvl(s.codice_bil2,0)||nvl(s.codice_bil3,0) --richiesta Sarli per errata associazione del codice Bilancio SIOPE
      and d.doc_type = 'ACC'
      and nvl(d.deletion_status_flag,'N') = 'N'
      and d.segment8 = a.anno
      and d.segment2 = a.eu||a.codice
      and d.date_created &lt;= data_mov;

       select nvl(sum(nvl(t.amount,0)),0)
      into incassi
      from fin_t_documenti d
      ,fin_t_documenti_terze_parti t
      ,fin_t_siope x
      where d.segment8 = p_anno
      and d.doc_type = 'REV'
      and nvl(d.open_balance_proposed,0) > 0
      and d.date_created &lt;= data_mov
      and t.doc_id = d.doc_id
      and x.eu = 'E'
      and x.codice_bilancio = nvl(s.codice_bil1,0)||nvl(s.codice_bil2,0)||nvl(s.codice_bil3,0)
      and x.codice_gestionale = t.codice_gestionale_siope;
      
      select nvl(sum(nvl(d.document_amount,0)),0)
      into acc_gsa
      from fin_t_documenti d
      ,fin_t_articoli a
      where a.anno = p_anno
      and a.eu = s.eu
      and decode(a.codice,'01065','10104','01240','10206','01241','10206','09486','40201','09487','40201','09488','40201','09801','40201','09606','40201','06068','30204','07162','30203',a.codice_bilancio_siope) 
      = nvl(s.codice_bil1,0)||nvl(s.codice_bil2,0)||nvl(s.codice_bil3,0) --richiesta Sarli per errata associazione del codice Bilancio SIOPE
      and nvl(a.sanita_sn,'N') = 'S'
      and d.doc_type = 'ACC'
      and nvl(d.deletion_status_flag,'N') = 'N'
      and d.segment8 = a.anno
      and d.segment2 = a.eu||a.codice
      and d.date_created &lt;= data_mov;
      
      select nvl(sum(nvl(t.amount,0)),0)
      into inc_gsa
      from fin_t_documenti d
      ,fin_t_documenti_terze_parti t
      ,fin_t_siope x
      ,fin_t_articoli a
      where d.segment8 = p_anno
      and d.doc_type = 'REV'
      and nvl(d.open_balance_proposed,0) > 0
      and d.date_created &lt;= data_mov
      and t.doc_id = d.doc_id
      and x.eu = 'E'
      and x.codice_bilancio = nvl(s.codice_bil1,0)||nvl(s.codice_bil2,0)||nvl(s.codice_bil3,0)
      and x.codice_gestionale = t.codice_gestionale_siope
      and a.anno = d.segment8
      and a.eu||a.codice = d.segment2
      and nvl(a.sanita_sn,'N') = 'S';
     

     insert into fin_t_importi_fed_fiscale (ANNO,EU,NUMERO_ORDINE,SIOPE1,SIOPE2,SIOPE3,SIOPE_DESCRIZIONE,COL1,COL2,COL3,COL4)
   values (
   p_anno
   ,s.eu
   ,num_ord
   ,s.codice_bil1
   ,s.codice_bil2
   ,s.codice_bil3
   ,s.descrizione
   ,nvl(accertamenti,0)
   ,nvl(incassi,0)
   ,nvl(acc_gsa,0)
   ,nvl(inc_gsa,0)
   );
   commit;
   elsif to_number(s.codice_bil2) = 0 and s.visibile = 'S'
   then
   -- se il codice bilancio ha solo 1 livell0 movimentat es . 1 0 0
     select nvl(sum(nvl(d.document_amount,0)),0)
      into accertamenti
      from fin_t_documenti d
      ,fin_t_articoli a
      where a.anno = p_anno
      and a.eu = s.eu
      and substr(decode(a.codice,'01065','10104','01240','10206','01241','10206','09486','40201','09487','40201','09488','40201','09801','40201','09606','40201','06068','30204','07162','30203',a.codice_bilancio_siope),1,1) 
      = nvl(s.codice_bil1,0) --richiesta Sarli per errata associazione del codice Bilancio SIOPE
      and d.doc_type = 'ACC'
      and nvl(d.deletion_status_flag,'N') = 'N'
      and d.segment8 = a.anno
      and d.segment2 = a.eu||a.codice
      and d.date_created &lt;= data_mov;
          
     -- se il codice bilancio ha solo 1 livell0 movimentat es . 1 0 0
       select nvl(sum(nvl(t.amount,0)),0)
    into incassi
    from fin_t_documenti d
    ,fin_t_documenti_terze_parti t
    ,fin_t_siope x
    where d.segment8 = p_anno
    and d.doc_type = 'REV'
    and nvl(d.open_balance_proposed,0) > 0
    and d.date_created &lt;= data_mov
    and t.doc_id = d.doc_id
    and x.eu = 'E'
    and x.codice_gestionale = t.codice_gestionale_siope
    and substr(x.codice_bilancio,1,1) = nvl(s.codice_bil1,0);
   
    select nvl(sum(nvl(d.document_amount,0)),0)
      into acc_gsa
      from fin_t_documenti d
      ,fin_t_articoli a
      where a.anno = p_anno
      and a.eu = s.eu
      and substr(decode(a.codice,'01065','10104','01240','10206','01241','10206','09486','40201','09487','40201','09488','40201','09801','40201','09606','40201','06068','30204','07162','30203',a.codice_bilancio_siope),1,1) 
      = nvl(s.codice_bil1,0) --richiesta Sarli per errata associazione del codice Bilancio SIOPE
      and nvl(a.sanita_sn,'N') = 'S'
      and d.doc_type = 'ACC'
      and d.date_created &lt;= data_mov;
      and nvl(d.deletion_status_flag,'N') = 'N'
      and d.segment8 = a.anno
      and d.segment2 = a.eu||a.codice
      
        select nvl(sum(nvl(t.amount,0)),0)
    into inc_gsa
    from fin_t_documenti d
    ,fin_t_documenti_terze_parti t
    ,fin_t_siope x
    ,fin_t_articoli a
    where d.segment8 = p_anno
    and d.doc_type = 'REV'
    and nvl(d.open_balance_proposed,0) > 0
    and d.date_created &lt;= data_mov
    and t.doc_id = d.doc_id
    and x.eu = 'E'
    and x.codice_gestionale = t.codice_gestionale_siope
    and substr(x.codice_bilancio,1,1) = nvl(s.codice_bil1,0)
    and a.anno = d.segment8
    and a.eu||a.codice = d.segment2
    and nvl(a.sanita_sn,'N') = 'S';
 
     insert into fin_t_importi_fed_fiscale (ANNO,EU,NUMERO_ORDINE,SIOPE1,SIOPE2,SIOPE3,SIOPE_DESCRIZIONE,COL1,COL2,COL3,COL4)
   values (
   p_anno
   ,s.eu
   ,num_ord
   ,s.codice_bil1
   ,s.codice_bil2
   ,s.codice_bil3
   ,s.descrizione
   ,nvl(accertamenti,0)
   ,nvl(incassi,0)
   ,nvl(acc_gsa,0)
   ,nvl(inc_gsa,0)
   );
   commit;
    end if;
   accertamenti := 0;
   incassi :=0;
   end loop;
end;</pre>	</td></tr>
</table></div>