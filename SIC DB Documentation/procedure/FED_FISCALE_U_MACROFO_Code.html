<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>FED_FISCALE_U_MACROFO</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="FED_FISCALE_U_MACROFO.html">Details</a></div></div>
<div class="tab"><div><a href="FED_FISCALE_U_MACROFO_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="FED_FISCALE_U_MACROFO_References.html">References</a></div></div>
<div class="tab"><div><a href="FED_FISCALE_U_MACROFO_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="FED_FISCALE_U_MACROFO_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
procedure FED_FISCALE_U_MACROFO (p_anno in number) as
--declare
type vettore_34 is varray(34) of number(15,2);
colonna vettore_34 := vettore_34(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);
num_ord number := 2;
--p_anno number := 2008;
cod_bil_siope varchar2(10);
k number := 0;

cursor siope is
select anno
,eu
,codice_bil1
,nvl(codice_bil2,0) codice_bil2
,nvl(codice_bil3,0) codice_bil3
,descrizione
from fin_t_struttura_siope
where anno = p_anno
and eu = 'U'
order by 3,4,5;

cursor macrofo_imp is
select substr(a.categoria,1,2) macrofo
,substr(a.categoria,1,3) fo
,sum(nvl(b.impegni_accertamenti_compe,0)) tot_impegni
from fin_t_bilancio b,
fin_t_articoli a 
where b.anno = p_anno
and b.eu = 'U'
and a.anno = b.anno
and a.eu = b.eu
and a.codice = b.articolo
and substr(a.codice_meccanografico,9,2) is not null
and decode(a.codice,'28126','20203','35154','10603','36261','20801',a.codice_bilancio_siope) = cod_bil_siope
and to_number(substr(a.categoria,1,2)) &lt; 11
group by substr(a.categoria,1,2),substr(a.categoria,1,3)
order by 1,2;

cursor macrofo_mand is
select substr(a.categoria,1,2) macrofo
,substr(a.categoria,1,3) fo
,sum(nvl(b.mandati_reversali_compe,0) + nvl(b.mandati_reversali_res,0)) tot_mandati
from fin_t_bilancio b,
fin_t_articoli a 
where b.anno = p_anno
and b.eu = 'U'
and a.anno = b.anno
and a.eu = b.eu
and a.codice = b.articolo
and substr(a.codice_meccanografico,9,2) is not null
and decode(a.codice,'28126','20203','35154','10603','36261','20801',a.codice_bilancio_siope) = cod_bil_siope
and to_number(substr(a.categoria,1,2)) &lt; 11
group by substr(a.categoria,1,2),substr(a.categoria,1,3)
order by 1,2;

begin
delete fin_t_importi_fed_fiscale where anno = p_anno and eu = 'U' and nvl(cofog,'X') = 'M'; -- cancello solo i record relativi al tabulato per Settori
commit;
 for s in siope loop
 cod_bil_siope := s.codice_bil1||s.codice_bil2||s.codice_bil3;
 num_ord := num_ord + 1;
-- loop per gli impegni
  for i in 1..32 loop
  colonna(i) := 0;
  end loop;
 
  for mi in macrofo_imp loop
   -- valorizzo innanzitutto le colonne Macro (3,6,7,14)
   case 
   when mi.macrofo = '02' then colonna(3) := colonna(3) + nvl(mi.tot_impegni,0);
   when mi.macrofo = '05' then colonna(6) := colonna(6) + nvl(mi.tot_impegni,0);
   when mi.macrofo = '06' then colonna(7) := colonna(7) + nvl(mi.tot_impegni,0);
   when mi.macrofo = '08' then colonna(14) := colonna(14) + nvl(mi.tot_impegni,0);
   else null;
   end case;
   
   -- passo a valorizzare le colonne di dettaglio
   case
   -- macro FO 01
   when mi.fo = '018' then colonna(1) := colonna(1)+nvl(mi.tot_impegni,0);
   when mi.fo like '01%' and mi.fo &lt;> '018' then colonna(2) := colonna(2)+nvl(mi.tot_impegni,0);
   -- macro FO 04
   when mi.fo = '045' then colonna(4) := colonna(4)+nvl(mi.tot_impegni,0);
   when mi.fo like '04%' and mi.fo &lt;> '045' then colonna(5) := colonna(5) + nvl(mi.tot_impegni,0);
   -- macro FO 07
   when mi.fo like '071' then colonna(8) := colonna(8)+nvl(mi.tot_impegni,0);
   when mi.fo like '072' then colonna(9) := colonna(9)+nvl(mi.tot_impegni,0);
   when mi.fo like '073' then colonna(10) := colonna(10) + nvl(mi.tot_impegni,0);
   when mi.fo like '074' then colonna(11) := colonna(11) + nvl(mi.tot_impegni,0);
   when mi.fo like '075' then colonna(12) := colonna(12) + nvl(mi.tot_impegni,0);
   when mi.fo like '076' then colonna(13) := colonna(13) + nvl(mi.tot_impegni,0);
   -- macro FO 09                                        + 
   when mi.fo like '091' then colonna(15) := colonna(15) + nvl(mi.tot_impegni,0);
   when mi.fo like '092' then colonna(16) := colonna(16) + nvl(mi.tot_impegni,0);
   when mi.fo like '093' then colonna(17) := colonna(17) + nvl(mi.tot_impegni,0);
   when mi.fo like '094' then colonna(18) := colonna(18) + nvl(mi.tot_impegni,0);
   when mi.fo like '095' then colonna(19) := colonna(19) + nvl(mi.tot_impegni,0);
   when mi.fo like '096' then colonna(20) := colonna(20) + nvl(mi.tot_impegni,0);
   when mi.fo like '097' then colonna(21) := colonna(21) + nvl(mi.tot_impegni,0);
   when mi.fo like '098' then colonna(22) := colonna(22) + nvl(mi.tot_impegni,0);
   -- macro FO 10                                        + 
   when mi.fo like '101' then colonna(23) := colonna(23) + nvl(mi.tot_impegni,0);
   when mi.fo like '102' then colonna(24) := colonna(24) + nvl(mi.tot_impegni,0);
   when mi.fo like '103' then colonna(25) := colonna(25) + nvl(mi.tot_impegni,0);
   when mi.fo like '104' then colonna(26) := colonna(26) + nvl(mi.tot_impegni,0);
   when mi.fo like '105' then colonna(27) := colonna(27) + nvl(mi.tot_impegni,0);
   when mi.fo like '106' then colonna(28) := colonna(28) + nvl(mi.tot_impegni,0);
   when mi.fo like '107' then colonna(29) := colonna(29) + nvl(mi.tot_impegni,0);
   when mi.fo like '108' then colonna(30) := colonna(30) + nvl(mi.tot_impegni,0);
   when mi.fo like '109' then colonna(31) := colonna(31) + nvl(mi.tot_impegni,0);
   else NULL;
   end case;
  end loop;
   insert into fin_t_importi_fed_fiscale (ANNO,EU,TIPO_IMPORTI,NUMERO_ORDINE,SIOPE1,SIOPE2,SIOPE3,SIOPE_DESCRIZIONE,COL1,COL2,COL3
   ,COL4,COL5,COL6,COL7,COL8,COL9,COL10,COL11,COL12,COL13,COL14,COL15,COL16,COL17,COL18,COL19,COL20,COL21,COL22,COL23,COL24,COL25
,COL26,COL27,COL28,COL29,COL30,COL31,COFOG)
   values (
   p_anno,s.eu,'I',num_ord,s.codice_bil1,s.codice_bil2,s.codice_bil3,s.descrizione,colonna(1),colonna(2),colonna(3),colonna(4) 
  ,colonna(5),colonna(6),colonna(7),colonna(8),colonna(9),colonna(10),colonna(11),colonna(12),colonna(13),colonna(14),colonna(15)
  ,colonna(16),colonna(17),colonna(18),colonna(19),colonna(20),colonna(21),colonna(22),colonna(23),colonna(24),colonna(25),colonna(26)
  ,colonna(27),colonna(28),colonna(29),colonna(30),colonna(31),'M');
   commit;
-- FINE loop per gli impengi

-- loop per i Mandati
  for i in 1..32 loop
  colonna(i) := 0;
  end loop;
  for mm in macrofo_mand loop
    -- valorizzo innanzitutto le colonne Macro (3,6,7,14)
   case 
   when mm.macrofo = '02' then colonna(3) := colonna(3) + nvl(mm.tot_mandati,0);
   when mm.macrofo = '05' then colonna(6) := colonna(6) + nvl(mm.tot_mandati,0);
   when mm.macrofo = '06' then colonna(7) := colonna(7) + nvl(mm.tot_mandati,0);
   when mm.macrofo = '08' then colonna(14) := colonna(14) + nvl(mm.tot_mandati,0);
   else null;
   end case;
   
   -- passo a valorizzare le colonne di dettaglio
   case
   -- macro FO 01
   when mm.fo = '018' then colonna(1) := colonna(1) + nvl(mm.tot_mandati,0);
   when mm.fo like '01%' and mm.fo &lt;> '018' then colonna(2) := colonna(2) + nvl(mm.tot_mandati,0);
   -- macro FO 04
   when mm.fo = '045' then colonna(4) := colonna(4) + nvl(mm.tot_mandati,0);
   when mm.fo like '04%' and mm.fo &lt;> '045' then colonna(5) := colonna(5) + nvl(mm.tot_mandati,0);
   -- macro FO 07
   when mm.fo like '071' then colonna(8) := colonna(8) + nvl(mm.tot_mandati,0);
   when mm.fo like '072' then colonna(9) :=colonna(9) +  nvl(mm.tot_mandati,0);
      when mm.fo like '073' then colonna(10) := colonna(10) + nvl(mm.tot_mandati,0);
   when mm.fo like '074' then colonna(11) := colonna(11) + nvl(mm.tot_mandati,0);
   when mm.fo like '075' then colonna(12) := colonna(12) + nvl(mm.tot_mandati,0);
   when mm.fo like '076' then colonna(13) := colonna(13) + nvl(mm.tot_mandati,0);
   -- macro FO 09                                        + 
   when mm.fo like '091' then colonna(15) := colonna(15) + nvl(mm.tot_mandati,0);
   when mm.fo like '092' then colonna(16) := colonna(16) + nvl(mm.tot_mandati,0);
   when mm.fo like '093' then colonna(17) := colonna(17) + nvl(mm.tot_mandati,0);
   when mm.fo like '094' then colonna(18) := colonna(18) + nvl(mm.tot_mandati,0);
   when mm.fo like '095' then colonna(19) := colonna(19) + nvl(mm.tot_mandati,0);
   when mm.fo like '096' then colonna(20) := colonna(20) + nvl(mm.tot_mandati,0);
   when mm.fo like '097' then colonna(21) := colonna(21) + nvl(mm.tot_mandati,0);
   when mm.fo like '098' then colonna(22) := colonna(22) + nvl(mm.tot_mandati,0);
   -- macro FO 10                                        + 
   when mm.fo like '101' then colonna(23) := colonna(23) + nvl(mm.tot_mandati,0);
   when mm.fo like '102' then colonna(24) := colonna(24) + nvl(mm.tot_mandati,0);
   when mm.fo like '103' then colonna(25) := colonna(25) + nvl(mm.tot_mandati,0);
   when mm.fo like '104' then colonna(26) := colonna(26) + nvl(mm.tot_mandati,0);
   when mm.fo like '105' then colonna(27) := colonna(27) + nvl(mm.tot_mandati,0);
   when mm.fo like '106' then colonna(28) := colonna(28) + nvl(mm.tot_mandati,0);
   when mm.fo like '107' then colonna(29) := colonna(29) + nvl(mm.tot_mandati,0);
   when mm.fo like '108' then colonna(30) := colonna(30) + nvl(mm.tot_mandati,0);
   when mm.fo like '109' then colonna(31) := colonna(31) + nvl(mm.tot_mandati,0);
   else NULL;
   end case;
  end loop;
   insert into fin_t_importi_fed_fiscale (ANNO,EU,TIPO_IMPORTI,NUMERO_ORDINE,SIOPE1,SIOPE2,SIOPE3,SIOPE_DESCRIZIONE,COL1,COL2
,COL3,COL4,COL5,COL6,COL7,COL8,COL9,COL10,COL11,COL12,COL13,COL14,COL15,COL16,COL17,COL18,COL19,COL20,COL21,COL22,COL23,COL24,COL25
,COL26,COL27,COL28,COL29,COL30,COL31,COFOG)
   values (
   p_anno,s.eu,'M',num_ord,s.codice_bil1,s.codice_bil2,s.codice_bil3,s.descrizione,colonna(1),colonna(2),colonna(3),colonna(4) 
  ,colonna(5),colonna(6),colonna(7),colonna(8),colonna(9),colonna(10),colonna(11),colonna(12),colonna(13),colonna(14),colonna(15)
  ,colonna(16),colonna(17),colonna(18),colonna(19),colonna(20),colonna(21),colonna(22),colonna(23),colonna(24),colonna(25),colonna(26)
  ,colonna(27),colonna(28),colonna(29),colonna(30),colonna(31),'M');
   commit;
   cod_bil_siope := '';
   end loop;
end;
    
</pre>	</td></tr>
</table></div>