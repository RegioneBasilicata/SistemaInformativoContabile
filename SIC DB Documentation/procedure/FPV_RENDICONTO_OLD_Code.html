<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>FPV_RENDICONTO_OLD</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="FPV_RENDICONTO_OLD.html">Details</a></div></div>
<div class="tab"><div><a href="FPV_RENDICONTO_OLD_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="FPV_RENDICONTO_OLD_References.html">References</a></div></div>
<div class="tab"><div><a href="FPV_RENDICONTO_OLD_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="FPV_RENDICONTO_OLD_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
procedure       FPV_RENDICONTO_OLD(p_anno in number,p_utente in varchar2,p_capitolo in varchar2,p_fpv out number) as
--procedura per report "Allegato b) al Rendiconto  - Fondo Pluriennale Vincolato"
-- modificata il 06/03/2017 per velocizzare il consuntivo
capitolo       varchar2(6);
missione       varchar2(10);
desc_missione  varchar2(2000);
programma      varchar2(10);
desc_programma varchar2(2000);
nome_tabulato varchar2(2000) := 'Allegato b) al Rendiconto  - Fondo Pluriennale Vincolato';

colonna_a varchar2(2000); -- usata per il nome_tabulato
colonna_b varchar2(2000); -- usata per l'anno tabulato
colonna_c varchar2(2000); -- usata per il codice Missione
colonna_d varchar2(2000); -- usata per la descrione Missione
colonna_e varchar2(2000); -- usata per il codice Programma
colonna_f varchar2(2000); -- usata per la descrizione Programma
colonna_g varchar2(2000); -- usata per il codice Capitolo
colonna_h varchar2(2000); -- usata per la descrizione Capitolo

colonna_1 number(15,2) := 0; --FPV al 31/12/p_anno-1
colonna_2 number(15,2) := 0; --FPV liquidato (LIQ)
colonna_3 number(15,2) := 0; --economie di impegni riacc
colonna_4 number(15,2) := 0; --FPV residuo = (colonna_1 - colonna_2 - colonna3)
colonna_5 number(15,2) := 0; --Impegni pluriennali (p_anno+1) assunti in p_anno
colonna_6 number(15,2) := 0; --Impegni pluriennali (p_anno+2) assunti in p_anno
colonna_7 number(15,2) := 0; --Impegni p_anno riaccertati
colonna_8 number(15,2) := 0; --FPV al 31/12/p_anno = (colonna_4 + colonna_5 + colonna_6 + colonna_7)
colonna_9 number(15,2) := 0; --ordinamento righe
colonna_5_1 number(15,2) := 0; --Impegni pluriennali (p_anno+1) assunti in p_anno
colonna_6_1 number(15,2) := 0; --Impegni pluriennali (p_anno+2) assunti in p_anno
colonna_7_1 number(15,2) := 0; --Impegni p_anno riaccertati
colonna_8_1 number(15,2) := 0; --FPV al 31/12/p_anno = (colonna_4_1 + colonna_5_1 + colonna_6_1 + colonna_7_1)



b_impegni_plur number(15,2) := 0;
b_impegni_riacc number(15,2) := 0;

b_impegni_plur_liq number(15,2) := 0;
b_impegni_riacc_liq number(15,2) := 0;
b_impegni_no_riacc_liq number(15,2) := 0;
b_impegni_no_riacc_liq1 number(15,2) := 0;
b_impegni_riacc_parz number(15,2) := 0;

/*aggiunta lino
b_totale_liquidazioni number(15,2):=0;
b_totale_liquidabile number(15,2):=0;
b_totale_riaccertamento number(15,2):=0;
b_delta number(15,2):=0;
*/

x_riacc_elim number(15,2) := 0;
correttivo_col number(15,2) := 0;

c_impegni_plur1 number(15,2) := 0;
c_impegni_riacc1 number(15,2) := 0;
c_acc_riacc1 number(15,2) := 0;
elim_imp_plur1 number(15,2) := 0;

c_impegni_plur2 number(15,2) := 0;
c_impegni_riacc2 number(15,2) := 0;
c_acc_riacc2 number(15,2) := 0;
elim_imp_plur2 number(15,2) := 0;

c_impegni_plur3 number(15,2) := 0;
c_impegni_riacc3 number(15,2) := 0;
c_acc_riacc3 number(15,2) := 0;
elim_imp_plur3 number(15,2) := 0;

entrate_riaccx number(15,2) := 0;
entrate_riacc1 number(15,2) := 0;
entrate_riacc2 number(15,2) := 0;
entrate_riacc3 number(15,2) := 0;
corrx1 number(15,2) := 0;
corrx2 number(15,2) := 0;
corrx3 number(15,2) := 0;



cursor capitoli is
select  a.eu||a.codice capitolo
 ,a.desc_capitolo desc_capitolo
 ,nvl(a.liv1,'Da Def.') missione
 ,a.desc_liv1           desc_missione
 ,nvl(a.liv2,'Da Def.') programma
 ,a.desc_liv2           desc_programma
from 
 vw_nb_articoli a
 ,fin_t_bilancio b
where b.anno = p_anno
and   b.eu = 'U' 
and nvl(b.aiuti,0) > 0
and a.anno = b.anno
and b.eu||b.articolo = a.eu||a.codice
and a.eu||a.codice = nvl(p_capitolo,a.eu||a.codice)
;

cursor capitoli_plur1 is
select  a.eu||a.codice capitolo
 ,a.desc_capitolo desc_capitolo
 ,nvl(a.liv1,'Da Def.') missione
 ,a.desc_liv1           desc_missione
 ,nvl(a.liv2,'Da Def.') programma
 ,a.desc_liv2           desc_programma
from 
 vw_nb_articoli a
 ,fin_t_bilancio b
 ,fin_t_bilancio x
where a.anno = p_anno + 1
and a.eu||a.codice = nvl(p_capitolo,a.eu||a.codice)
and b.anno = a.anno
and b.eu = 'U' 
and nvl(b.aiuti,0) > 0
and b.eu||b.articolo = a.eu||a.codice
and x.anno = p_anno
and x.eu||x.articolo = a.codice_precedente
and nvl(x.aiuti,0) = 0;

cursor capitoli_plur2 is
select  a.eu||a.codice capitolo
 ,a.desc_capitolo desc_capitolo
 ,nvl(a.liv1,'Da Def.') missione
 ,a.desc_liv1           desc_missione
 ,nvl(a.liv2,'Da Def.') programma
 ,a.desc_liv2           desc_programma
from 
 vw_nb_articoli a
 ,fin_t_articoli a1
 ,fin_t_bilancio b
 ,fin_t_bilancio x
where a.anno = p_anno+2
and a.eu = 'U' 
and a.eu||a.codice = nvl(p_capitolo,a.eu||a.codice)
and a1.anno = p_anno + 1 
and a1.eu||a1.codice = a.CODICE_PRECEDENTE
and b.anno  = a.anno
and b.eu||b.articolo = a.eu||a.codice
and nvl(b.aiuti,0) > 0
and x.anno = p_anno
and x.eu||x.articolo = a1.codice_precedente
and nvl(x.aiuti,0) = 0;

cursor capitoli_plur3 is
select  b.anno
,a.eu||a.codice capitolo
 ,a.desc_capitolo desc_capitolo
 ,nvl(a.liv1,'Da Def.') missione
 ,a.desc_liv1           desc_missione
 ,nvl(a.liv2,'Da Def.') programma
 ,a.desc_liv2           desc_programma
from 
 vw_nb_articoli a
 ,fin_t_articoli a1
 ,fin_t_articoli a2
 ,fin_t_bilancio b
 ,fin_t_bilancio x
where a.anno = p_anno + 3
and a.eu = 'U' 
and a.eu||a.codice = nvl(p_capitolo,a.eu||a.codice)
and a1.anno = p_anno + 2 
and a1.eu||a1.codice = a.CODICE_PRECEDENTE
and a2.anno = p_anno + 1
and a2.eu||a2.codice = a1.CODICE_PRECEDENTE
and b.anno = a.anno
and b.eu||b.articolo = a.eu||a.codice
and nvl(b.aiuti,0) > 0
and x.anno = p_anno
and x.eu||x.articolo = a2.codice_precedente
and nvl(x.aiuti,0) = 0;

cursor imp_plur is
select  d.segment8 anno
,a.eu||a.codice capitolo
 ,a.desc_capitolo desc_capitolo
 ,nvl(a.liv1,'Da Def.') missione
 ,a.desc_liv1           desc_missione
 ,nvl(a.liv2,'Da Def.') programma
 ,a.desc_liv2           desc_programma
 ,d.segment8 anno_imp
 ,nvl(sum(nvl(d.CHECK_STOCK_ID,0)),0) importo
from 
fin_t_documenti d
 ,vw_nb_articoli a
 ,fin_t_bilancio b
where d.doc_type like 'IMP%'
and  d.segment8 > p_anno 
and nvl(d.deletion_status_flag,'N') = 'N'
and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
and substr(nvl(d.attribute38,'9999'),1,4) = p_anno
and instr(d.description,'Riacc') = 0
and nvl(d.attribute21,0) = 0
and nvl(d.CHECK_STOCK_ID,0) >= 0
and d.segment2 = nvl(p_capitolo,d.segment2)
and a.anno = d.segment8
and a.eu||a.codice = d.segment2
and b.anno = d.segment8
and b.eu||b.articolo = d.segment2
and nvl(b.aiuti,0) = 0
group by d.segment8
 ,a.eu||a.codice
 ,a.desc_capitolo
 ,nvl(a.liv1,'Da Def.')
 ,a.desc_liv1
 ,nvl(a.liv2,'Da Def.')
 ,a.desc_liv2; 

begin
 if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' 
 then
  delete tmp_tabulati where nvl(utente,'xxxx') = nvl(p_utente,'xxxx');-- and nvl(car01,'xxxx') = nome_tabulato and nvl(car02,'xxxx') = to_char(p_anno);
  commit;
end if;
  colonna_a := nome_tabulato; -- usata per il nome_tabulato
  colonna_b := p_anno; -- usata per l'anno tabulato
  colonna_9 := 0;
  for c in capitoli loop

  corrx1 := 0;
  corrx2 := 0;
  corrx3 := 0;

      colonna_1 := 0;
      colonna_2 := 0;
      colonna_3 := 0;
      colonna_4 := 0;
      colonna_5 := 0;
      colonna_6 := 0;
      colonna_7 := 0;
      colonna_8 := 0;

      P_FPV := 0;


      colonna_9 := colonna_9 + 1; -- indice per ordinamento righe


      colonna_c := c.missione; -- usata per il codice Missione
      colonna_d := c.desc_missione; -- usata per la descrione Missione
      colonna_e := c.programma; -- usata per il codice Programma
      colonna_f := c.desc_programma; -- usata per la descrizione Programma
      colonna_g := c.capitolo ; -- usata per il codice Capitolo
      colonna_h := c.desc_capitolo; -- usata per la descrizione Capitolo 
  -- determino importi per colonna_1 (a) del report
   begin
      select nvl(aiuti,0) into colonna_1
      from fin_t_bilancio
      where anno = p_anno
      and eu||articolo = c.capitolo
      and nvl(aiuti,0) > 0;
      exception when no_data_found then  colonna_1 := 0;
  end;

  -- determino l'importo della colonna_2 (b) del report

  -- prendo l'importo liquidato degli impegni plur (0101||p_anno) fatti nel p_anno - 1
     select nvl(sum(nvl(l.document_amount,0)),0) into b_impegni_plur_liq
      from 
       fin_t_documenti d
       ,fin_t_documenti l
      -- ,bas_ind b
      where d.doc_type in ('IMP','IMP-PER','IMP-DEF')
      and d.segment8 >= p_anno
      and nvl(d.deletion_status_flag,'N') = 'N'
      and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
      and d.attribute21 is null
      and substr(nvl(d.attribute38,'9999'),1,4) &lt;= (p_anno - 1)
      and d.segment2 = c.capitolo
      and l.doc_type = 'LIQ'
      and l.previous_doc_id = d.doc_id
      and nvl(l.deletion_status_flag,'N') = 'N'
      and l.segment8 = p_anno;
    --  and b.ind_anno = p_anno
     -- and b.doc_id = d.doc_id
    --  and b.ind_cap = c.capitolo; 

    -- prendo l'importo liquidato degli impegni plur (0101||p_anno)
    select nvl(sum(nvl(l.document_amount,0)),0) into b_impegni_riacc_liq
      from 
       fin_t_documenti d
       ,fin_t_documenti l
    --   ,fin_t_riaccertamenti r
      where upper(nvl(d.proposal_status_flag,'Z'))||upper(nvl(d.auditing_status_flag,'Z'))='PI' 
      and upper(nvl(d.deletion_status_flag,'N')) &lt;> 'Y'
      and d.doc_type in ('IMP','IMP-DEF','IMP-PER')
      and nvl(d.attribute21,0) > 0
      and nvl(d.segment8,0) = p_anno
      and d.segment2 = c.capitolo
      and l.doc_type = 'LIQ'
      and l.previous_doc_id = d.doc_id
      and nvl(l.deletion_status_flag,'N') = 'N'
      and l.segment8 = p_anno
     ; 
  -- prendo l'importo degli impegni finanziati nell'anno n-1 con FPV ma che nell'anno n rimangono a residuo (quindi vanno eliminati dall'FPV)  
    select sum(residuo) into b_impegni_no_riacc_liq
    from
         (select nvl(sum(OPEN_BALANCE_DATA(d.doc_id,to_date('3112'||p_anno,'ddmmyyyy'))),0) residuo
             from  
             fin_t_documenti d 
             where d.doc_type in ('IMP','IMP-PER','IMP-DEF')
            and d.segment8 = p_anno 
            and nvl(d.deletion_status_flag,'N') = 'N' 
            and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy') 
            and substr(nvl(d.attribute38,'9999'),1,4) &lt;= (p_anno - 1) 
            and nvl(d.attribute21,0) = 0
            and d.segment2 = c.capitolo
            and d.segment2 in (select b.eu||b.articolo
            from fin_t_bilancio b 
            where b.anno >= p_anno 
            and b.eu||b.articolo = d.segment2 
            and nvl(b.aiuti,0) > 0 )
            and residuo_imp_data(d.doc_id,to_date('3112'||p_anno,'ddmmyyyy')) > 0 
       UNION  
          select nvl(sum(OPEN_BALANCE_DATA(d.doc_id,to_date('3112'||p_anno,'ddmmyyyy'))),0) residuo 
           from  
             fin_t_documenti d 
          --   ,bas_ind i 
             ,fin_t_bilancio b 
            where d.doc_type in ('IMP','IMP-PER','IMP-DEF') 
            and d.segment8 >= p_anno 
            and nvl(d.deletion_status_flag,'N') = 'N' 
            and nvl(d.attribute21,0) > 0
            and d.segment2 = c.capitolo
           -- and upper(nvl(d.proposal_status_flag,'Z'))||upper(nvl(d.auditing_status_flag,'Z'))='PI' 
          --  and i.ind_anno = p_anno 
          --  and i.doc_id = d.doc_id 
          --  and i.ind_cap = c.capitolo
            and b.anno = p_anno 
            and b.eu||b.articolo = c.capitolo--i.ind_cap 
            and nvl(b.aiuti,0) > 0 
            and residuo_imp_data(d.doc_id,to_date('3112'||p_anno,'ddmmyyyy')) > 0);

   /* 
    --prendo la somma degli impegni dell'anno p_anno finanziati con FPV e con residuo ma non riaccertati 
    select  nvl(sum(residuo_imp_data(d.doc_id,to_date('3112'||p_anno,'ddmmyyyy'))),0) into b_impegni_no_riacc_liq
    from fin_t_riaccertamenti r
    ,fin_t_documenti d
    where r.anno_finanziario = p_anno 
    and r.capitolo = c.capitolo
    and r.anno_riaccertamento is null
    and d.doc_type like 'IMP%'
    and d.segment8 >= p_anno
    and nvl(d.deletion_status_flag,'N') = 'N'
    and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
    and substr(nvl(d.attribute38,'9999'),1,4) &lt;= (p_anno - 1)
    and d.doc_id = r.doc_id;

    select nvl(sum(residuo_imp_data(r.doc_id,to_date('3112'||p_anno,'ddmmyyyy'))),0) into b_impegni_no_riacc_liq1
      from fin_t_riaccertamenti r
      where r.anno_finanziario = p_anno
      and r.capitolo = c.capitolo
      and r.anno_riaccertamento is null
      and r.doc_id in (select doc_id_riaccertamento 
      from fin_t_riaccertamenti 
      where anno_finanziario &lt; p_anno
      and doc_id_riaccertamento is not null)
      and r.doc_id not in (
        select  d.doc_id
        from fin_t_riaccertamenti r
        ,fin_t_documenti d
        where r.anno_finanziario = p_anno 
        and r.capitolo = c.capitolo
        and r.anno_riaccertamento is null
        and d.doc_type like 'IMP%'
        and d.segment8 >= p_anno
        and nvl(d.deletion_status_flag,'N') = 'N'
        and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
        and substr(nvl(d.attribute38,'9999'),1,4) &lt;= (p_anno - 1)
        and d.doc_id = r.doc_id);
   */    
        -- serve per prendere la quotaparte di impegni riaccertati che sono stati liquidati nell'anno + 1
  -- ****** LA commento il 25/02/2017 perchè non dovrebbe più servire

  /*
   select  nvl(sum(nvl(r.residuo_lordo,0) - nvl(r.residuo,0)),0) into b_impegni_riacc_parz
    from fin_t_riaccertamenti r
    ,fin_t_documenti d
    where r.anno_finanziario = p_anno 
    and r.capitolo = c.capitolo
    and r.anno_riaccertamento is not null
    and nvl(r.residuo_lordo,0) &lt;> nvl(r.residuo,0)
    and d.doc_type like 'IMP%'
    and d.segment8 = p_anno
    and nvl(d.deletion_status_flag,'N') = 'N'
    and d.doc_id = r.doc_id;
  */

  -- *********** 


 -- per eventuali correttivi
    begin
      select (nvl(importo,0)*decode(UPPER(nvl(segno,'PIU')),'PIU',1,'MENO',-1)) into correttivo_col
      from fin_t_correttivi_fpv
      where anno = p_anno
      and capitolo = c.capitolo
      and upper(colonna) = 'B';
      exception when no_data_found then correttivo_col := 0;
    end;

 colonna_2 := b_impegni_plur_liq + b_impegni_riacc_liq + b_impegni_no_riacc_liq + nvl(correttivo_col,0); --  + b_impegni_riacc_parz;  + b_impegni_no_riacc_liq1  



 -- ********** determino correttivi per Entrate riaccertate da eliminare
  if p_anno &lt; 2015
   then
     select nvl(sum(nvl(importox,0)),0) into entrate_riaccx
      from fin_t_riaccertamenti_entrate
      where anno = p_anno
      and capitolo = c.capitolo;

      select nvl(sum(nvl(importo1,0)),0) into entrate_riacc1
      from fin_t_riaccertamenti_entrate
      where anno = p_anno
      and capitolo = c.capitolo;

      select nvl(sum(nvl(importo2,0)),0) into entrate_riacc2
      from fin_t_riaccertamenti_entrate
      where anno = p_anno
      and capitolo = c.capitolo;

       select nvl(sum(nvl(importo3,0)),0) into entrate_riacc3
       from fin_t_riaccertamenti_entrate
       where anno = p_anno
       and capitolo = c.capitolo;

      if entrate_riaccx &lt;= entrate_riacc1
       then corrx1 := entrate_riaccx;
            corrx2 := 0;
            corrx3 := 0; 
       elsif entrate_riaccx &lt;= entrate_riacc1 + entrate_riacc2
        then corrx1 := entrate_riacc1;
             corrx2 := entrate_riaccx - entrate_riacc1;
             corrx3 := 0;
       else  corrx1 := entrate_riacc1;
             corrx2 := entrate_riacc2;
             corrx3 := entrate_riaccx - entrate_riacc1 - entrate_riacc2;
      end if;

  end if;
 -- ** FINE correttivi per Entrate riaccertate


 --importi colonna_3 (x) del report
  select nvl(sum(nvl(importo_variazione,0)),0) into colonna_3
  from fin_t_variazioni_fpv
  where anno = p_anno
  and capitolo = c.capitolo
  ;--and instr(upper(descrizione_variazione),'RIACC')= 0;

  select nvl(sum(nvl(r.importo_riaccertamento,0)),0) into x_riacc_elim
      from fin_t_riaccertamenti r
      ,fin_t_documenti d
      where nvl(r.anno_riaccertamento,9999) = (p_anno + 1)
        -- aggiunta 13052015
    and nvl(r.flag_elimina,'P') not in ('E','P')
    and r.anno_bilancio_riaccertamento = p_anno + 1
    and r.tipo_documento&lt;> 'ACC'
    -- ****** fine aggiunta
      and r.capitolo = c.capitolo
      and d.doc_id = r.doc_id
      and d.attribute21 is not null;

  begin
  select (nvl(importo,0)*decode(UPPER(nvl(segno,'PIU')),'PIU',1,'MENO',-1)) into correttivo_col
  from fin_t_correttivi_fpv
  where anno = p_anno
  and capitolo = c.capitolo
  and upper(colonna) = 'X';
  exception when no_data_found then correttivo_col := 0;
 end;

  colonna_3 := colonna_3 + entrate_riaccx + x_riacc_elim + correttivo_col;

 -- **********
 -- **** RIDETERMINO la colonna_2
  if nvl(colonna_2,0) > (nvl(colonna_1,0) - nvl(colonna_3,0))
    then colonna_2 := (nvl(colonna_1,0) - nvl(colonna_3,0));
  end if;

 -- **** FINE

 -- importo colonna_4 (c) del report
 colonna_4 := nvl(colonna_1,0) -nvl(colonna_2,0) -nvl(colonna_3,0);
 -- ****

 -- importo colonna_5 (d) del report

    --************ Richiesta Pierro del 12/07/2017 "gli impegni pluriennali saranno dal 2016 in poi coperti sempre da Accertamenti pluriennali
     /* select 
       nvl(sum(nvl(d.document_amount,0)),0) into c_impegni_plur1
      from 
       fin_t_documenti d
     -- ,bas_ind b
      where d.doc_type = 'IMP-DEF'
      and d.segment8 = p_anno + 1
      and nvl(d.deletion_status_flag,'N') = 'N'
      and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
      and substr(nvl(d.attribute38,'9999'),1,4) = p_anno
      and instr(d.description,'Riacc') = 0
      and nvl(d.check_stock_id,0) >= 0
      and d.segment2 = c.capitolo;*/
    -- ************** Pierro del 12/07/2017


      select nvl(sum(nvl(r.importo_riaccertamento,0) - nvl(r.da_entrate,0)),0) into c_impegni_riacc1
      from fin_t_riaccertamenti r
      where nvl(r.anno_riaccertamento,9999) = (p_anno + 1)
        -- aggiunta 13052015
    and nvl(r.flag_elimina,'N') = 'N'
    and r.anno_bilancio_riaccertamento = p_anno + 1
    and r.tipo_documento&lt;> 'ACC'
    -- ****** fine aggiunta
      and r.capitolo_riaccertamento = c.capitolo
   ---- ***** eliminato il 13052015
      and r.doc_id not in (select doc_id_riaccertamento 
      from fin_t_riaccertamenti 
      where anno_bilancio_riaccertamento = p_anno--&lt; p_anno
      and doc_id_riaccertamento is not null
      and nvl(da_entrate,0) = 0)
      and r.doc_id not in (
      select 
       d.doc_id
      from 
       fin_t_documenti d
      where d.doc_type = 'IMP-DEF'
      and d.segment8 = p_anno 
    --  and nvl(d.deletion_status_flag,'N') = 'N'
      and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
      and substr(nvl(d.attribute38,'9999'),1,4) &lt; p_anno
      )
      ;

     --************ Richiesta Pierro del 12/07/2017 "gli impegni pluriennali saranno dal 2016 in poi coperti sempre da Accertamenti pluriennali

      --calcolo eventuali imp_plur1 eliminati in anni successivi
      --and f.importo_originario = f.importo_variazione
      /* select  nvl(sum(nvl(f.importo_variazione,0)),0) into elim_imp_plur1
      from FIN_T_VARIAZIONI_FPV f
      where f.anno > p_anno
      and f.doc_id in (select d.doc_id 
      from fin_t_documenti d
      ,fin_t_articoli a
      where d.doc_type like 'IMP%'
      --and nvl(d.deletion_status_flag,'N') = 'Y'
      and d.segment8 = p_anno+1
      and d.date_created = to_date('0101'||(p_anno+1),'ddmmyyyy')
      and substr(nvl(d.attribute38,'9999'),1,4) = p_anno
      and a.anno = d.segment8
      and a.eu||a.codice = d.segment2
      and a.codice_precedente = c.capitolo)
      and f.doc_id not in (select doc_id_riaccertamento 
      from fin_t_riaccertamenti 
      where anno_bilancio_riaccertamento = p_anno--&lt; p_anno
      and doc_id_riaccertamento is not null);
   -- eventuale correttivo
    begin
      select (nvl(importo,0)*decode(UPPER(nvl(segno,'PIU')),'PIU',1,'MENO',-1)) into correttivo_col
      from fin_t_correttivi_fpv
      where anno = p_anno
      and capitolo = c.capitolo
      and upper(colonna) = 'D';
      exception when no_data_found then correttivo_col := 0;
     end; */

      colonna_5 := nvl(c_impegni_plur1,0)+ nvl(elim_imp_plur1,0) + nvl(c_impegni_riacc1,0) - nvl(entrate_riacc1,0) + nvl(corrx1,0) + nvl(correttivo_col,0);--
       --**************
   --    insert into temp_fvp values (c.capitolo,nvl(c_impegni_plur1,0),nvl(elim_imp_plur1,0), nvl(c_impegni_riacc1,0),nvl(entrate_riacc1,0),nvl(corrx1,0));
   --    commit;
     --*********************
 -- *** fine colonna_5

     /* select 
 -- importo colonna_6 (e) del report
     --************ Richiesta Pierro del 12/07/2017 "gli impegni pluriennali saranno dal 2016 in poi coperti sempre da Accertamenti pluriennali

       nvl(sum(nvl(d.document_amount,0)),0) into c_impegni_plur2
      from 
       fin_t_documenti d
    --   ,bas_ind b
      where d.doc_type = 'IMP-DEF'
      and d.segment8 = p_anno + 2
      and nvl(d.deletion_status_flag,'N') = 'N'
      and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
      and substr(nvl(d.attribute38,'9999'),1,4) = p_anno
      and instr(d.description,'Riacc') = 0
      and nvl(d.check_stock_id,0) >= 0
      and d.segment2 = c.capitolo;*/
   -- *************** Fine PIERRO ****************

      select nvl(sum(nvl(r.importo_riaccertamento,0) - nvl(r.da_entrate,0)),0) into c_impegni_riacc2
      from fin_t_riaccertamenti r
      where nvl(r.anno_riaccertamento,9999) = (p_anno + 2)
      and r.capitolo_riaccertamento = c.capitolo
      -- aggiunta 13052015
      and r.tipo_documento&lt;> 'ACC'
      and nvl(r.flag_elimina,'N') = 'N'
      and r.anno_bilancio_riaccertamento = p_anno + 1
    -- ****** fine aggiunta
    ---- ***** eliminato il 13052015
      and r.doc_id not in (select doc_id_riaccertamento 
      from fin_t_riaccertamenti 
      where anno_bilancio_riaccertamento = p_anno--&lt; p_anno
      and doc_id_riaccertamento is not null)
      and r.doc_id not in (
      select 
       d.doc_id
      from 
       fin_t_documenti d
      where d.doc_type = 'IMP-DEF'
      and d.segment8 = p_anno 
    --  and nvl(d.deletion_status_flag,'N') = 'N'
      and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
      and substr(nvl(d.attribute38,'9999'),1,4) &lt; p_anno
      );

  --************ Richiesta Pierro del 12/07/2017 "gli impegni pluriennali saranno dal 2016 in poi coperti sempre da Accertamenti pluriennali

      --calcolo eventuali imp_plur2 eliminati in anni successivi
       /*  select nvl(sum(nvl(f.importo_variazione,0)),0) into elim_imp_plur2
        from FIN_T_VARIAZIONI_FPV f
        where f.anno > p_anno
        --and f.importo_originario = f.importo_variazione
        and f.doc_id in (select d.doc_id 
        from fin_t_documenti d
        ,fin_t_articoli a
        where d.doc_type like 'IMP%'
       -- and nvl(d.deletion_status_flag,'N') = 'Y'
        and d.segment8 = p_anno+2
        and d.date_created = to_date('0101'||(p_anno+2),'ddmmyyyy')
        and substr(nvl(d.attribute38,'9999'),1,4) = p_anno
        and a.anno = d.segment8
        and a.eu||a.codice = d.segment2
        and a.codice_precedente = c.capitolo);*/
  -- Fine PIERRO


       -- calcolo l'importo da eliminare perchè vegono riaccertate anche le entrate
      select nvl(sum(nvl(importo2,0)),0) into entrate_riacc2
      from fin_t_riaccertamenti_entrate
      where anno = p_anno
      and capitolo = c.capitolo;
    -- fine calcolo entrare riacc


      colonna_6 := nvl(c_impegni_plur2,0) + nvl(elim_imp_plur2,0) + nvl(c_impegni_riacc2,0)- nvl(entrate_riacc2,0) + nvl(corrx2,0); --

 -- *** fine colonna_6

 --************ Richiesta Pierro del 12/07/2017 "gli impegni pluriennali saranno dal 2016 in poi coperti sempre da Accertamenti pluriennali
  -- importo colonna_7 (f) del report
    /*  select 
       nvl(sum(nvl(d.document_amount,0)),0) into c_impegni_plur3
      from 
       fin_t_documenti d
     --  ,bas_ind b
      where d.doc_type = 'IMP-DEF'
      and d.segment8 = p_anno + 3
      and nvl(d.deletion_status_flag,'N') = 'N'
      and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
      and substr(nvl(d.attribute38,'9999'),1,4) = p_anno
      and nvl(d.check_stock_id,0) >= 0
      and d.segment2 = c.capitolo; */
  -- ***** Fine PIERRO *********************

      select nvl(sum(nvl(r.importo_riaccertamento,0) - nvl(r.da_entrate,0)),0) into c_impegni_riacc3
      from fin_t_riaccertamenti r
      where nvl(r.anno_riaccertamento,9999) = (p_anno + 3)
      and r.capitolo_riaccertamento = c.capitolo
      -- aggiunta 13052015
    and nvl(r.flag_elimina,'N') = 'N'
    and r.anno_bilancio_riaccertamento = p_anno + 1
    and r.tipo_documento&lt;> 'ACC'
    -- ****** fine aggiunta
      and r.doc_id not in (select doc_id_riaccertamento 
      from fin_t_riaccertamenti 
      where anno_bilancio_riaccertamento = p_anno--&lt; p_anno
      and doc_id_riaccertamento is not null)
      and r.doc_id not in (
      select 
       d.doc_id
      from 
       fin_t_documenti d
      where d.doc_type = 'IMP-DEF'
      and d.segment8 = p_anno 
    --  and nvl(d.deletion_status_flag,'N') = 'N'
      and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
      and substr(nvl(d.attribute38,'9999'),1,4) &lt; p_anno
      );


  -- calcolo l'importo da eliminare perchè vegono riaccertate anche le entrate
      select nvl(sum(nvl(importo3,0)),0) into entrate_riacc3
      from fin_t_riaccertamenti_entrate
      where anno = p_anno
      and capitolo = c.capitolo;
    -- fine calcolo entrare riacc

      colonna_7 := nvl(c_impegni_plur3,0)+ nvl(c_impegni_riacc3,0) - nvl(entrate_riacc3,0) + nvl(corrx3,0); --

 -- *** fine colonna_7

 -- importo colonna_8 (g) del report
 colonna_8 := colonna_4 + colonna_5 + colonna_6 + colonna_7;
 -- *** fine colonna_8
       (utente
   if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND (nvl(colonna_1,0) + nvl(colonna_2,0) + nvl(colonna_3,0) + nvl(colonna_4,0) + nvl(colonna_5,0) +nvl(colonna_6,0) + nvl(colonna_7,0) + nvl(colonna_8,0)) &lt;> 0 
    then 
     insert into tmp_tabulati
       ,num_ord_riga
       ,car01-- nome tabulato
       ,car02-- anno
       ,car03-- colonna_c
       ,car04-- colonna_d
       ,CAR05-- colonna_e
       ,CAR06-- colonna_f
       ,CAR07-- colonna_g
       ,CAR08-- colonna_h
       ,num01
       ,num02
       ,num03
       ,num04
       ,num05
       ,num06
       ,num07
       ,num08
       )
       values
       (p_utente
       ,colonna_9
       ,colonna_a
       ,colonna_b
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,colonna_1  
       ,colonna_2
       ,colonna_3
       ,colonna_4
       ,colonna_5
       ,colonna_6
       ,colonna_7
       ,colonna_8 
       );
     commit;
     end if;
    end loop;

   P_FPV := nvl(P_FPV,0) + nvl(colonna_8,0);
  -- *** prendo i riacc e i plur anno + 1 il cui capitolo  nell'anno n NON è finanziato da FPV ma nell'anno n+1 si
     -- importo colonna_5_1 (d) del report
     for c1 in capitoli_plur1 loop

      colonna_5_1 := 0;
      colonna_8_1 := 0;

      colonna_9 := colonna_9 + 1; -- indice per ordinamento righe

      colonna_c := c1.missione; -- usata per il codice Missione
      colonna_d := c1.desc_missione; -- usata per la descrione Missione
      colonna_e := c1.programma; -- usata per il codice Programma
      colonna_f := c1.desc_programma; -- usata per la descrizione Programma
      colonna_g := c1.capitolo ; -- usata per il codice Capitolo
      colonna_h := c1.desc_capitolo; -- usata per la descrizione Capitolo 

      select 
       nvl(sum(nvl(d.document_amount,0)),0) into c_impegni_plur1
      from 
       fin_t_documenti d
    --  ,bas_ind b
      where d.doc_type = 'IMP-DEF'
      and d.segment8 = p_anno + 1
      and nvl(d.deletion_status_flag,'N') = 'N'
      and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
      and substr(nvl(d.attribute38,'9999'),1,4) = p_anno
      and nvl(d.check_stock_id,0) >= 0
      and instr(d.description,'Riacc') = 0
      and d.segment2 = c1.capitolo;
   --   and b.ind_anno = p_anno + 1
   --   and b.doc_id = d.doc_id
   --   and b.ind_cap = c1.capitolo;

      select nvl(sum(nvl(r.importo_riaccertamento,0) - nvl(r.da_entrate,0)),0) into c_impegni_riacc1
      from fin_t_riaccertamenti r
      where nvl(r.anno_riaccertamento,9999) = (p_anno + 1)
        -- aggiunta 13052015
    and nvl(r.flag_elimina,'N') = 'N'
    and r.anno_bilancio_riaccertamento = p_anno + 1
    and r.tipo_documento&lt;> 'ACC'
    and r.doc_id_riaccertamento is not null
    -- ****** fine aggiunta
      and r.capitolo_riaccertamento = c1.capitolo
   ---- ***** eliminato il 13052015
    --  and r.doc_id not in (select doc_id_riaccertamento 
    --  from fin_t_riaccertamenti 
    --  where anno_bilancio_riaccertamento = p_anno--&lt; p_anno
    --  and doc_id_riaccertamento is not null)
      and r.doc_id not in (
      select 
       d.doc_id
      from 
       fin_t_documenti d
      where d.doc_type = 'IMP-DEF'
      and d.segment8 = p_anno 
    --  and nvl(d.deletion_status_flag,'N') = 'N'
      and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
      and substr(nvl(d.attribute38,'9999'),1,4) &lt; p_anno
      )
      ;

      --calcolo eventuali imp_plur1 eliminati in anni successivi
      select nvl(sum(nvl(f.importo_variazione,0)),0) into elim_imp_plur1
      from FIN_T_VARIAZIONI_FPV f
      where f.anno > p_anno
      --and f.importo_originario = f.importo_variazione
      and f.doc_id in (select d.doc_id 
      from fin_t_documenti d
      ,fin_t_articoli a
      where d.doc_type like 'IMP%'
      --and nvl(d.deletion_status_flag,'N') = 'Y'
      and d.segment8 = p_anno+1
      and d.date_created = to_date('0101'||(p_anno+1),'ddmmyyyy')
      and substr(nvl(d.attribute38,'9999'),1,4) = p_anno
      and nvl(d.check_stock_id,0) >= 0
      and a.anno = d.segment8
      and a.eu||a.codice = d.segment2
      and a.codice_precedente = c1.capitolo);

      begin
      select (nvl(importo,0)*decode(UPPER(nvl(segno,'PIU')),'PIU',1,'MENO',-1)) into correttivo_col
      from fin_t_correttivi_fpv
      where anno = p_anno
      and capitolo = c1.capitolo
      and upper(colonna) = 'D';
      exception when no_data_found then correttivo_col := 0;
     end;


      colonna_5_1 := nvl(c_impegni_plur1,0)+ nvl(elim_imp_plur1,0) + nvl(c_impegni_riacc1,0) - nvl(entrate_riacc1,0) + nvl(correttivo_col,0);--
       --**************
   --    insert into temp_fvp values (c.capitolo,nvl(c_impegni_plur1,0),nvl(elim_imp_plur1,0), nvl(c_impegni_riacc1,0),nvl(entrate_riacc1,0),nvl(corrx1,0));
   --    commit;
     --*********************
     -- importo colonna_8 (g) del report
  colonna_8_1 := colonna_5_1;
 -- *** fine colonna_8
   if  nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND nvl(colonna_5_1,0) &lt;> 0
    then 
     insert into tmp_tabulati
       ,car02-- anno
       (utente
       ,num_ord_riga
       ,car01-- nome tabulato
       ,car03-- colonna_c
       ,car04-- colonna_d
       ,CAR05-- colonna_e
       ,CAR06-- colonna_f
       ,CAR07-- colonna_g
       ,CAR08-- colonna_h
       ,num01
       ,num02
       ,num03
       ,num04
       ,num05
       ,num06
       ,num07
       ,num08
       )
       values
       (p_utente
       ,colonna_9
       ,colonna_a
       ,colonna_b
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,0  
       ,0
       ,0
       ,0
       ,colonna_5_1
       ,0
       ,0
       ,colonna_8_1 
       );
     commit;
   end if;
  end loop;   
 -- *** fine colonna_5_1
     P_FPV := nvl(P_FPV,0) + nvl(colonna_8_1 ,0);
       colonna_8_1 := 0;
  -- *** prendo i riacc e i plur anno + 2 il cui capitolo  nell'anno n NON è finanziato da FPV ma nell'anno n+2 si
     -- importo colonna_6_1 (e) del report
     for c2 in capitoli_plur2 loop

      colonna_6_1 := 0;


      colonna_9 := colonna_9 + 1; -- indice per ordinamento righe

      colonna_c := c2.missione; -- usata per il codice Missione
      colonna_d := c2.desc_missione; -- usata per la descrione Missione
      colonna_e := c2.programma; -- usata per il codice Programma
      colonna_f := c2.desc_programma; -- usata per la descrizione Programma
      colonna_g := c2.capitolo ; -- usata per il codice Capitolo
      colonna_h := c2.desc_capitolo; -- usata per la descrizione Capitolo 
      select 
       nvl(sum(nvl(d.document_amount,0)),0) into c_impegni_plur2
      from 
       fin_t_documenti d
      -- ,bas_ind b
      where d.doc_type = 'IMP-DEF'
      and d.segment8 = p_anno + 2
      and nvl(d.deletion_status_flag,'N') = 'N'
      and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
      and substr(nvl(d.attribute38,'9999'),1,4) = p_anno
      and nvl(d.check_stock_id,0) >= 0
      and instr(d.description,'Riacc') = 0
      and d.segment2 = c2.capitolo;


      select nvl(sum(nvl(r.importo_riaccertamento,0) - nvl(r.da_entrate,0)),0) into c_impegni_riacc2
      from fin_t_riaccertamenti r
      where nvl(r.anno_riaccertamento,9999) = (p_anno + 2)
      and r.capitolo_riaccertamento = c2.capitolo
      -- aggiunta 13052015
      and r.tipo_documento&lt;> 'ACC'
      and nvl(r.flag_elimina,'N') = 'N'
      and r.anno_bilancio_riaccertamento = p_anno + 1
      and r.doc_id_riaccertamento is not null
       and r.doc_id not in (
      select 
       d.doc_id
      from 
       fin_t_documenti d
      where d.doc_type = 'IMP-DEF'
      and d.segment8 = p_anno 
    --  and nvl(d.deletion_status_flag,'N') = 'N'
      and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
      and substr(nvl(d.attribute38,'9999'),1,4) &lt; p_anno
      );

      --calcolo eventuali imp_plur2 eliminati in anni successivi
        select nvl(sum(nvl(f.importo_variazione,0)),0) into elim_imp_plur2
        from FIN_T_VARIAZIONI_FPV f
        where f.anno > p_anno
        --and f.importo_originario = f.importo_variazione
        and f.doc_id in (select d.doc_id 
        from fin_t_documenti d
        ,fin_t_articoli a
        where d.doc_type like 'IMP%'
       -- and nvl(d.deletion_status_flag,'N') = 'Y'
        and d.segment8 = p_anno+2
        and d.date_created = to_date('0101'||(p_anno+2),'ddmmyyyy')
        and substr(nvl(d.attribute38,'9999'),1,4) = p_anno
        and a.anno = d.segment8
        and a.eu||a.codice = d.segment2
        and a.codice_precedente = c2.capitolo);

       -- calcolo l'importo da eliminare perchè vegono riaccertate anche le entrate
      select nvl(sum(nvl(importo2,0)),0) into entrate_riacc2
      from fin_t_riaccertamenti_entrate
      where anno = p_anno
      and capitolo = c2.capitolo;
    -- fine calcolo entrare riacc


      colonna_6_1 := nvl(c_impegni_plur2,0) + nvl(elim_imp_plur2,0) + nvl(c_impegni_riacc2,0)- nvl(entrate_riacc2,0); --

           --**************
   --    insert into temp_fvp values (c.capitolo,nvl(c_impegni_plur1,0),nvl(elim_imp_plur1,0), nvl(c_impegni_riacc1,0),nvl(entrate_riacc1,0),nvl(corrx1,0));
   --    commit;
     --*********************
     -- importo colonna_8_1 (g) del report
  colonna_8_1 := colonna_6_1;
 -- *** fine colonna_8
   if  nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND nvl(colonna_6_1,0) &lt;> 0
    then 
     insert into tmp_tabulati
       (utente
       ,num_ord_riga
       ,car01-- nome tabulato
       ,car02-- anno
       ,car03-- colonna_c
       ,car04-- colonna_d
       ,CAR05-- colonna_e
       ,CAR06-- colonna_f
       ,CAR07-- colonna_g
       ,CAR08-- colonna_h
       ,num01
       ,num02
       ,num03
       ,num04
       ,num05
       ,num06
       ,num07
       ,num08
       )
       values
       (p_utente
       ,colonna_9
       ,colonna_a
       ,colonna_b
       ,colonna_c
       ,colonna_d
       ,colonna_h
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,0  
       ,0
       ,0
       ,0
       ,0
       ,colonna_6_1
       ,0
       ,colonna_8_1 
       );
     commit;
   end if;
  end loop;   

 -- *** fine colonna_6_1
 P_FPV := nvl(P_FPV,0) + nvl(colonna_8_1 ,0);
   colonna_8_1 := 0;
 -- *** prendo i riacc e i plur anno + 3 il cui capitolo  nell'anno n NON è finanziato da FPV ma nell'anno n+3 si
     -- importo colonna_7_1 (f) del report
     for c3 in capitoli_plur3 loop

      colonna_7_1 := 0;


      colonna_9 := colonna_9 + 1; -- indice per ordinamento righe

      colonna_c := c3.missione; -- usata per il codice Missione
      colonna_d := c3.desc_missione; -- usata per la descrione Missione
      colonna_e := c3.programma; -- usata per il codice Programma
      colonna_f := c3.desc_programma; -- usata per la descrizione Programma
      colonna_g := c3.capitolo ; -- usata per il codice Capitolo
      colonna_h := c3.desc_capitolo; -- usata per la descrizione Capitolo 
      select 
       nvl(sum(nvl(d.document_amount,0)),0) into c_impegni_plur3
      from 
       fin_t_documenti d
      -- ,bas_ind b
      where d.doc_type = 'IMP-DEF'
      and d.segment8 = p_anno + 3
      and nvl(d.deletion_status_flag,'N') = 'N'
      and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
      and substr(nvl(d.attribute38,'9999'),1,4) = p_anno
      and nvl(d.check_stock_id,0) >= 0
      and d.segment2 = c3.capitolo;


      select nvl(sum(nvl(r.importo_riaccertamento,0) - nvl(r.da_entrate,0)),0) into c_impegni_riacc3
      from fin_t_riaccertamenti r
      where nvl(r.anno_riaccertamento,9999) = (p_anno + 3)
      and r.capitolo_riaccertamento = c3.capitolo
      -- aggiunta 13052015
    and nvl(r.flag_elimina,'N') = 'N'
    and r.anno_bilancio_riaccertamento = p_anno + 1
    and r.tipo_documento&lt;> 'ACC'
    and r.doc_id_riaccertamento is not null
    -- ****** fine aggiunta
   --   and r.doc_id not in (select doc_id_riaccertamento 
   --   from fin_t_riaccertamenti 
   --   where anno_bilancio_riaccertamento = p_anno--&lt; p_anno
   --   and doc_id_riaccertamento is not null)
    and r.doc_id not in (
      select 
       d.doc_id
      from 
       fin_t_documenti d
      where d.doc_type = 'IMP-DEF'
      and d.segment8 = p_anno 
    --  and nvl(d.deletion_status_flag,'N') = 'N'
      and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
      and substr(nvl(d.attribute38,'9999'),1,4) &lt; p_anno
      );


  -- calcolo l'importo da eliminare perchè vegono riaccertate anche le entrate
      select nvl(sum(nvl(importo3,0)),0) into entrate_riacc3
      from fin_t_riaccertamenti_entrate
      where anno = p_anno
      and capitolo = c3.capitolo;
    -- fine calcolo entrare riacc

      colonna_7_1 := nvl(c_impegni_plur3,0)+ nvl(c_impegni_riacc3,0) - nvl(entrate_riacc3,0) ; --
    --**************
   --    insert into temp_fvp values (c.capitolo,nvl(c_impegni_plur1,0),nvl(elim_imp_plur1,0), nvl(c_impegni_riacc1,0),nvl(entrate_riacc1,0),nvl(corrx1,0));
   --    commit;
     --*********************
     -- importo colonna_8_1 (g) del report
  colonna_8_1 := colonna_7_1;
 -- *** fine colonna_8
   if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND nvl(colonna_7_1,0) &lt;> 0
    then 
     insert into tmp_tabulati
       (utente
       ,num_ord_riga
       ,car01-- nome tabulato
       ,car02-- anno
       ,car03-- colonna_c
       ,car04-- colonna_d
       ,CAR05-- colonna_e
       ,CAR06-- colonna_f
       ,CAR07-- colonna_g
       ,CAR08-- colonna_h
       ,num01
       ,num02
       ,num03
       ,num04
       ,num05
       ,num06
       ,num07
       ,num08
       )
       values
       (p_utente
       ,colonna_9
       ,colonna_a
       ,colonna_b
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,0  
       ,0
       ,0
       ,0
       ,0
       ,0
       ,colonna_7_1
       ,colonna_8_1 
       );
     commit;
   end if;
  end loop; 
 -- *** fine colonna_7_1
  for i in imp_plur loop
 P_FPV := nvl(P_FPV,0) + nvl(colonna_8_1 ,0);
    colonna_8_1 := 0;
 -- prendo gli imp_plur che non hanno finanziamento FPV nell'anno di competenza ma sono finanziati comunque da FPV

      colonna_8_1 := nvl(colonna_8_1,0) + nvl(i.importo,0);
      colonna_9 := colonna_9 + 1; -- indice per ordinamento righe

      colonna_c := i.missione; -- usata per il codice Missione
      colonna_d := i.desc_missione; -- usata per la descrione Missione
      colonna_e := i.programma; -- usata per il codice Programma
      colonna_f := i.desc_programma; -- usata per la descrizione Programma
      colonna_g := i.capitolo ; -- usata per il codice Capitolo
      colonna_h := i.desc_capitolo; -- usata per la descrizione Capitolo 

    if nvl(p_utente,'X') &lt;> 'CONSUNTIVO'
    then
     insert into tmp_tabulati
       (utente
       ,num_ord_riga
       ,car01-- nome tabulato
       ,car02-- anno
       ,car03-- colonna_c
       ,car04-- colonna_d
       ,CAR05-- colonna_e
       ,CAR06-- colonna_f
       ,CAR07-- colonna_g
       ,CAR08-- colonna_h
       ,num01
       ,num02
       ,num03
       ,num04
       ,num05
       ,num06
       ,num07
       (p_utente
       ,num08
       )
       values
       ,colonna_9
       ,colonna_a
       ,colonna_b
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,0  
       ,0
       ,0
       ,0
       ,case when i.anno_imp = (p_anno + 1)  then i.importo else 0 end
       ,case when i.anno_imp = (p_anno + 2) then i.importo else 0 end
       ,case when i.anno_imp = (p_anno + 3) then i.importo else 0 end
       ,i.importo
       );
     commit;
     end if;
  end loop;

  P_FPV := nvl(P_FPV,0) + nvl(colonna_8_1 ,0);

end;</pre>	</td></tr>
</table></div>