<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>INDICATORI_BIL_PRE_USCITE</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="INDICATORI_BIL_PRE_USCITE.html">Details</a></div></div>
<div class="tab"><div><a href="INDICATORI_BIL_PRE_USCITE_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="INDICATORI_BIL_PRE_USCITE_References.html">References</a></div></div>
<div class="tab"><div><a href="INDICATORI_BIL_PRE_USCITE_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="INDICATORI_BIL_PRE_USCITE_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
procedure indicatori_bil_pre_Uscite (p_anno in number) is 

 -- *** per evitare di lavorare su bil previsione non fissato l'utente lo impostiamo di fisso
    p_utente varchar2 (20) := 'PREV'||p_anno;

	type vettore_10 is varray(10) of number;
    p_ord number := 0; -- per ordinamento righe tabella

	tot_prev_compe number := 0;  -- contiene il totale delle previsioni di competenza p_anno
	tot_prev_compea1 number := 0;  -- contiene il totale delle previsioni di competenza p_anno + 1
	tot_prev_compea2 number := 0;  -- contiene il totale delle previsioni di competenza p_anno + 2
	tot_fpv number := 0;  -- contiene il totale delle previsioni FPV p_anno
	tot_fpva1 number := 0;  -- contiene il totale delle previsioni FPV p_anno+1
	tot_fpva2 number := 0;  -- contiene il totale delle previsioni FPV p_anno+2
	tot_res_compe number := 0;  -- contiene il totale delle previsioni di competenza p_anno

	MEDIA_IMP number := 0; -- Media impegni missione
	TOT_IMP number := 0; -- media impegni totale

	MEDIA_FPV_REND number := 0; -- Media FPV Missione
	TOT_FPV_REND number := 0; -- Media FPV Rendiconto anni between p_anno - 2 and p_anno - 4

	MEDIA_RES_DEF number := 0; -- Media REsidui definitivi Missione
	TOT_RES_DEF number := 0; -- Media REsidui definitivi TOTALE Missioni

	MEDIA_PAG_TOT number := 0; -- media pagamenti compe+res  Missione


	i_missione vettore_10 := vettore_10(0,0,0,0,0,0,0,0,0,0);
	i_programma vettore_10 := vettore_10(0,0,0,0,0,0,0,0,0,0);
	i_totale_missioni vettore_10 := vettore_10(0,0,0,0,0,0,0,0,0,0);

	p_missione varchar2(3); -- valore missione nel loop

	cursor missioni is
	select distinct 'Missione'||' '||ETITOLO_UMISSIONE||' '||DESC_TITOLO_MISSIONE codice
	,ETITOLO_UMISSIONE cod_singolo
	from fin_t_previsione 
	where anno = p_anno
	and UTENTE = p_utente
	and eu = 'U'
	and ETITOLO_UMISSIONE &lt;> '0'
	order by 1; 

	cursor programmi is 
	select ETIPOLOGIA_UPROGRAMMA codice
	,DESC_TIPOLOGIA_PROGRAMMA descrizione
	,sum(nvl(COMPETENZA_ANNO0,0)) compe_anno0
	,sum(nvl(COMPETENZA_ANNO1,0)) compe_anno1
	,sum(nvl(COMPETENZA_ANNO2,0)) compe_anno2
	,sum(nvl(dicui_FPV_ANNO0,0)) dicui_FPV_anno0
	,sum(nvl(dicui_FPV_ANNO1,0)) dicui_FPV_anno1
	,sum(nvl(dicui_FPV_ANNO2,0)) dicui_FPV_anno2
	,sum(nvl(CASSA_ANNO0,0)) cassa_anno0
	,sum(nvl(residuo,0)) residui
	from fin_t_previsione 
	where anno = p_anno
	and UTENTE = p_utente
	and eu = 'U'
	and ETITOLO_UMISSIONE = p_missione
	group by ETIPOLOGIA_UPROGRAMMA,DESC_TIPOLOGIA_PROGRAMMA
	order by 1;

	begin

	-- pulisco la FIN_T_INDICATORI_BILANCIO per l'anno, l'utente e la tipologia di indicatore considerato
	delete FIN_T_INDICATORI_BILANCIO where anno = p_anno and utente = p_utente and TIPO_BILANCIO = 'P' and TIPO_INDICATORE = 'U';
		commit;
	-- ********************************************

	-- calcolo il totale della competenza
	select nvl(sum(nvl(competenza_anno0,0)),0),nvl(sum(nvl(competenza_anno1,0)),0),nvl(sum(nvl(competenza_anno2,0)),0),nvl(sum(nvl(dicui_FPV_ANNO0,0)),0)
	,nvl(sum(nvl(dicui_FPV_ANNO1,0)),0),nvl(sum(nvl(dicui_FPV_ANNO2,0)),0),nvl(sum(nvl(residuo,0)),0)
	into tot_prev_compe,tot_prev_compea1,tot_prev_compea2,tot_fpv,tot_fpva1,tot_fpva2 ,tot_res_compe
	from fin_t_previsione
	where ANNO = p_anno
	and UTENTE = p_utente
	and eu = 'U'
	and ETITOLO_UMISSIONE &lt;> '0';

	-- calcolo il totale impegni anni p_anno - 4 and p_anno - 2

	select round(sum(nvl(d.document_amount,0))/3,2) into TOT_IMP
	from fin_t_documenti d
	where d.doc_type like 'IMP%'
	and nvl(d.DELETION_STATUS_FLAG,'N') = 'N'
	and d.segment8 between (p_anno-4) and (p_anno - 2);


	-- calcolo la media dell'FPV totale anni p_anno - 4 and p_anno - 2

	select round(sum(nvl(FPV,0))/3,2) into TOT_FPV_REND
	from fin_t_consuntivo_excel
	where anno_consuntivo between (p_anno - 4) and (p_anno - 2)
	and utente = 'CONS'||ANNO_CONSUNTIVO
	and tipo_capitolo = 'U';

	-- calcolo media residui definitivi totale anni p_anno - 4 and p_anno - 2

	select round(sum(nvl(RESIDUI_FINALI,0))/3,2) into TOT_RES_DEF
	from fin_t_consuntivo_excel
	where anno_consuntivo between (p_anno - 4) and (p_anno - 2)
	and utente = 'CONS'||ANNO_CONSUNTIVO
	and tipo_capitolo = 'U';




	for m in missioni loop
	 p_missione := m.cod_singolo;
	 i_missione := vettore_10(0,0,0,0,0,0,0,0,0,0);


	 	for p in  programmi loop
        MEDIA_IMP := 0;
        MEDIA_FPV_REND := 0;

       	-- calolo media impegni p_anno - 4 and p_anno - 2 per missione e programma specifico

	 	/*select nvl(round(sum(nvl(d.document_amount,0))/3,2),0) into MEDIA_IMP
		from fin_t_documenti d
		,vw_nb_articoli a
		where d.doc_type like 'IMP%'
		and nvl(d.DELETION_STATUS_FLAG,'N') = 'N'
		and d.segment8 between (p_anno-4) and (p_anno - 2)
        and a.anno = d.segment8
		and a.eu||a.codice = d.segment2
		and a.liv1 = p_missione
		and a.liv2 = p.codice;*/

        select nvl(round(sum(nvl(ACCERTAMENTI_IMPEGNI_COMPE,0))/3,2),0) into MEDIA_IMP
		from fin_t_consuntivo_excel
		where anno_consuntivo between (p_anno - 4) and (p_anno - 2)
		and utente = 'CONS'||ANNO_CONSUNTIVO
		and tipo_capitolo = 'U'
		and nb_livello1 = p_missione
		and nb_livello2 = p.codice;

		-- calolo media FPV p_anno - 4 and p_anno - 2 per missione e programma specifico

		select nvl(round(sum(nvl(FPV,0))/3,2),0) into MEDIA_FPV_REND
		from fin_t_consuntivo_excel
		where anno_consuntivo between (p_anno - 4) and (p_anno - 2)
		and utente = 'CONS'||ANNO_CONSUNTIVO
		and tipo_capitolo = 'U'
		and nb_livello1 = p_missione
		and nb_livello2 = p.codice;

		-- calolo media PAGAMENTI TOT p_anno - 4 and p_anno - 2 per missione e programma specifico

		select nvl(round(sum(nvl(RISCOSSIONI_PAGAMENTI_TOTALE,0))/3,2),0) into MEDIA_PAG_TOT
		from fin_t_consuntivo_excel
		where anno_consuntivo between (p_anno - 4) and (p_anno - 2)
		and utente = 'CONS'||ANNO_CONSUNTIVO
		and tipo_capitolo = 'U'
		and nb_livello1 = p_missione
		and nb_livello2 = p.codice;

        if tot_prev_compe > 0
        then
		i_programma(1) := round(p.compe_anno0/tot_prev_compe*100,2);
		end if;

        if tot_fpv > 0
        then
        i_programma(2) := round(p.dicui_FPV_ANNO0/tot_fpv*100,2);
		end if;

        if (tot_prev_compe - tot_fpv + tot_res_compe) > 0
        then
        i_programma(3) := round(p.cassa_anno0/(tot_prev_compe - tot_fpv + tot_res_compe)*100,2);
		end if;

        --Modifica 28/05/2018
        if tot_prev_compea1>0
        then
        i_programma(4) := round(p.compe_anno1/tot_prev_compea1*100,2);
        end if;

        if tot_fpva1 > 0
        then i_programma(5) := round(p.dicui_FPV_ANNO1/tot_fpva1*100,2);
        end if;

        if  tot_prev_compea2 > 0
        then
        i_programma(6) := round(p.compe_anno2/tot_prev_compea2*100,2);
        end if;

        if tot_fpva2 > 0
        then i_programma(7) := round(p.dicui_FPV_ANNO2/tot_fpva2*100,2);
        end if;

        if (TOT_IMP+TOT_FPV_REND) > 0
        then
		i_programma(8) := round((MEDIA_IMP+MEDIA_FPV_REND)/(TOT_IMP+TOT_FPV_REND)*100,2);
        end if;

        if TOT_FPV_REND > 0
        then
		i_programma(9) := round(MEDIA_FPV_REND/TOT_FPV_REND*100,2);
        end if;

        if (TOT_IMP + TOT_RES_DEF) > 0
        then
        i_programma(10) := round(MEDIA_PAG_TOT/(TOT_IMP + TOT_RES_DEF)*100,2);
        end if;


		p_ord := p_ord + 1;

    		insert into fin_t_indicatori_bilancio (ANNO,UTENTE,ORD,TIPO_BILANCIO,TIPO_INDICATORE,CODICE_INDICATORE1,DESC_COD1,CODICE_INDICATORE2,DESC_COD2
    			,INC_MIS_PROG1,INC_FPV1,CAP_PAG1,INC_MIS_PROG2,INC_FPV2,INC_MIS_PROG3,INC_FPV3,INC_MIS_PROG_MEDIA,INC_FPV_MEDIA,CAP_PAG_MEDIA,DEFINIZIONE)
	    	values
	    	(p_anno,p_utente,p_ord,'P','U',p_missione,m.codice,p.codice,p.descrizione
	    	,i_programma(1),i_programma(2),i_programma(3),i_programma(4),i_programma(5),i_programma(6),i_programma(7),i_programma(8),i_programma(9),i_programma(10),p_missione||'.'||p.codice);
	    	commit;

	    i_missione(1) := i_missione(1) + nvl(i_programma(1),0);
		i_missione(2) := i_missione(2) + nvl(i_programma(2),0);
		i_missione(3) := i_missione(3) + nvl(i_programma(3),0);
		i_missione(4) := i_missione(4) + nvl(i_programma(4),0);
		i_missione(5) := i_missione(5) + nvl(i_programma(5),0);
		i_missione(6) := i_missione(6) + nvl(i_programma(6),0);
		i_missione(7) := i_missione(7) + nvl(i_programma(7),0);
		i_missione(8) := i_missione(8) + nvl(i_programma(8),0);
		i_missione(9) := i_missione(9) + nvl(i_programma(9),0);
        i_missione(10) := i_missione(10) + nvl(i_programma(10),0);


        end loop;

 	p_ord := p_ord + 1;

		insert into fin_t_indicatori_bilancio (ANNO,UTENTE,ORD,TIPO_BILANCIO,TIPO_INDICATORE,CODICE_INDICATORE1,DESC_COD1,DESC_COD2
			,INC_MIS_PROG1,INC_FPV1,CAP_PAG1,INC_MIS_PROG2,INC_FPV2,INC_MIS_PROG3,INC_FPV3,INC_MIS_PROG_MEDIA,INC_FPV_MEDIA,CAP_PAG_MEDIA,Definizione)
    	values
    	(p_anno,p_utente,p_ord,'P','U',p_missione,m.codice,'TOTALE '||m.codice
    	,i_missione(1),i_missione(2),i_missione(3),i_missione(4),i_missione(5),i_missione(6),i_missione(7),i_missione(8),i_missione(9),i_missione(10),p_missione);
    	commit;

    	i_totale_missioni(1) := i_totale_missioni(1) + i_missione(1);
		i_totale_missioni(2) := i_totale_missioni(2) + i_missione(2);
		i_totale_missioni(3) := i_totale_missioni(3) + i_missione(3);
        i_totale_missioni(4) := i_totale_missioni(4) + i_missione(4);
		i_totale_missioni(5) := i_totale_missioni(5) + i_missione(5);
		i_totale_missioni(6) := i_totale_missioni(6) + i_missione(6);
		i_totale_missioni(7) := i_totale_missioni(7) + i_missione(7);
		i_totale_missioni(8) := i_totale_missioni(8) + i_missione(8);
		i_totale_missioni(9) := i_totale_missioni(9) + i_missione(9);
        i_totale_missioni(10) := i_totale_missioni(10) + i_missione(10);


	end loop;

	p_ord := p_ord + 1;

    if i_totale_missioni(3) > 100
    then i_totale_missioni(3) := 100;
    end if;

		insert into fin_t_indicatori_bilancio (ANNO,UTENTE,ORD,TIPO_BILANCIO,TIPO_INDICATORE,DESC_COD2
			,INC_MIS_PROG1,INC_FPV1,CAP_PAG1,INC_MIS_PROG2,INC_FPV2,INC_MIS_PROG3,INC_FPV3,INC_MIS_PROG_MEDIA,INC_FPV_MEDIA,CAP_PAG_MEDIA)
    	values
    	(p_anno,p_utente,p_ord,'P','U','TOTALE MISSIONI'
    	,round(i_totale_missioni(1)),round(i_totale_missioni(2)),round(i_totale_missioni(3)),round(i_totale_missioni(4)),round(i_totale_missioni(5)),round(i_totale_missioni(6))
    	,round(i_totale_missioni(7)),round(i_totale_missioni(8)),round(i_totale_missioni(9)),round(i_totale_missioni(10)));
    	commit;

	end;</pre>	</td></tr>
</table></div>