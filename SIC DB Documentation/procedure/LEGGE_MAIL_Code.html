<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>LEGGE_MAIL</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="LEGGE_MAIL.html">Details</a></div></div>
<div class="tab"><div><a href="LEGGE_MAIL_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="LEGGE_MAIL_References.html">References</a></div></div>
<div class="tab"><div><a href="LEGGE_MAIL_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="LEGGE_MAIL_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
PROCEDURE legge_mail (
   username   VARCHAR2,
   PASSWORD   VARCHAR2 )
IS
   pop3_server   CONSTANT VARCHAR2 (100)     := '172.18.17.48';
   pop3_port     CONSTANT NUMBER             := 110;
   pop3_ok       CONSTANT VARCHAR2 (10)      := '+OK';
   e_pop3_error           EXCEPTION;
   socket                 UTL_TCP.connection;
   line                   VARCHAR2 (30000);
   riga_file              VARCHAR2 (30000);
   BYTES                  INTEGER;
   num_mail               number;
   msgnum                 number;
   errore                 varchar2(2000);
   x_da                   varchar2(2000);
   x_a                    varchar2(2000);
   x_data                 date;
   x_oggetto              varchar2(2000);
   x_inizio               varchar2(2000);
   x_mail                 number;
   x_progr                number;
   x_allegato             varchar2(200);
   corpo_letto            number;
   in_file UTL_FILE.FILE_TYPE;   
   in_mail UTL_FILE.FILE_TYPE;   
   riga                   varchar2(4000);
   v_blob                 blob;
   x_job                  number;
-- variabili per gestione ticket
   x_coda                 number;
   x_commento_sn          varchar2(1);
   x_ticket               number;
   x_nuovo_ticket         varchar2(1);
   x_da_email             varchar2(200);
   x_a_email              varchar2(200);
   x_marcatore            varchar2(200);
   x_chiusura             varchar2(20);
   x_tipo_utente          varchar2(1);
   x_utente               number;
   x_password             varchar2(8);
   x_nuovo_utente         varchar2(1);
   x_appoggio             varchar2(100);
   x_app_tipo_rich        varchar2(1);
   x_app_ut_rich          number;
   x_app_in_carico        number;
   x_app_risolto          date;
   
   -- send a POP3 command
   -- (we expect each command to respond with a +OK)
   FUNCTION writetopop (command VARCHAR2)
      RETURN VARCHAR2
   IS
      len    INTEGER;
      resp   VARCHAR2 (30000);
   BEGIN
      len := UTL_TCP.write_line (socket, command);
      UTL_TCP.FLUSH (socket);
      -- using a hack to check the popd response
      len := UTL_TCP.read_line (socket, resp);

      IF SUBSTR (resp, 1, 3) != pop3_ok
      THEN
         RAISE e_pop3_error;
      END IF;

      RETURN (resp);
   END;
BEGIN
   socket :=
      UTL_TCP.open_connection (remote_host      => pop3_server,
                               remote_port      => pop3_port,
                               --tx_timeout => POP3_TIMEOUT,
                               CHARSET          => 'US7ASCII'
                              );
   -- read the server banner/response from the pop3 daemon
   line:=UTL_TCP.get_line (socket);
   -- authenticate with the POP3 server using the USER and PASS commands
   line:=writetopop ('USER ' || username);
   line:=writetopop ('PASS ' || PASSWORD);
   -- numero mail presenti
   line:=writetopop ('STAT ');
   line:=substr(line,5,length(line)-5);
   num_mail:=to_number(substr(line,1,instr(line,' ')-1));
   x_job:=0;
   for ind_mail in 1..num_mail loop
    msgnum:=ind_mail;
    line:=writetopop ('RETR ' || msgnum);
    x_inizio:='&lt;>&lt;>';
    corpo_letto:=0;
    in_mail:=UTL_FILE.FOPEN('DIR_TMP','mail_appoggio','w');
   LOOP
      BYTES := UTL_TCP.available (socket);

      IF BYTES > 0
      THEN
         if line='--'||x_inizio and
            corpo_letto=1 then
            null;
         else
            BYTES := UTL_TCP.read_line (socket, line);
            UTL_FILE.PUT_LINE(in_mail,line);
            line := REPLACE (line, CHR (13) || CHR (10), '');
         end if;
         IF LENGTH (line) = 1 AND line = '.'
         THEN
            null;
         ELSE
            if substr(line,1,5)='From:' then
               --errore:=errore||'da';
               x_da:=replace(line,'From: ','');
               if instr(x_da,'&lt;')>0 then
                  x_da_email:=substr(x_da,instr(x_da,'&lt;')+1,instr(x_da,'>')-instr(x_da,'&lt;')-1);
               else
                  x_da_email:=x_da;
               end if;   
               x_tipo_utente:='U';
               x_utente:=null;
               x_nuovo_utente:='N';
               select min(user_id)
                  into x_utente
                  from fnd_user
                  where email_address=x_da_email;
               if x_utente is null then   
                 x_tipo_utente:='R';
                 select min(id)
                   into x_utente
                   from gsa_richiedenti
                   where email=x_da_email;
               end if;            
               if x_utente is null then      
               -- profila nuovo utente
                  x_tipo_utente:='R';
                  x_nuovo_utente:='S';
                  select nvl(max(id),0)+1
                    into x_utente
                    from gsa_richiedenti;
                  select lower(dbms_random.string('x', 8))
                    into x_password
                    from dual; 
                  insert into gsa_richiedenti
                    (id,nome,password,email)
                    values
                    (x_utente,x_da_email,x_password,x_da_email);
               end if;
            elsif substr(line,1,3)='To:' then
               --errore:=errore||'a';
               x_a:=replace(line,'To: ','');
               if instr(x_a,'&lt;')>0 then
                  x_a_email:=substr(x_a,instr(x_a,'&lt;')+1,instr(x_a,'>')-instr(x_a,'&lt;')-1);
               else
                  x_a_email:=x_a;
               end if;   
               x_commento_sn:='N';
               x_coda:=null;
               select min(id),min(marcatore),min(frase_per_chiusura)
                 into x_coda,x_marcatore,x_chiusura
                 from gsa_code
                 where mail_corrispondenza=x_a_email;
               if x_coda is null then
                  x_commento_sn:='S';
                  select min(id),min(marcatore)
                    into x_coda,x_marcatore
                    from gsa_code
                    where mail_commento=x_a_email;
               end if;  
            elsif substr(line,1,8)='Subject:' then
               --errore:=errore||'Oggetto';
               x_oggetto:=replace(line,'Subject: ','');
            elsif substr(line,1,5)='Date:' then
                  x_data:=to_date(upper(substr(line,12,20)),'dd MON yyyy hh24:mi:ss');
               --errore:=errore||'Data'||upper(substr(line,12,20));
            elsif instr(line,'boundary=')>0 and
                  x_inizio='&lt;>&lt;>' then
               --errore:=errore||'boundary';
                  if instr (line,'boundary="')>0 then
                     x_inizio:=substr(line,instr(line,'boundary="')+10,length(line)-(instr(line,'boundary="')+10));
                  else
                     x_inizio:=substr(line,instr(line,'boundary=')+9,length(line)-(instr(line,'boundary="')+9));
                  end if;
               --errore:=errore||x_inizio;
            elsif line='--'||x_inizio and
                  corpo_letto=0 then
                  --substr(line,1,2)='--' and 
               --errore:=errore||'scrivo';
             -- lettura corpo
                  select sq_mail.nextval into x_mail from dual;
                  if instr(x_oggetto,'['||x_marcatore||' #')=0 then
                     select seq_tickets.nextval into x_ticket from dual;
                     x_nuovo_ticket:='S';
                     insert into gsa_tickets
                      (ID,ID_EFFETTIVO,CODA,TIPO_UTENTE,UTENTE_RICHIEDENTE,
                       OGGETTO,ID_MAIL_INIZIO,STATO,DATA_ARRIVO,TIPO_CREATO_DA,CREATO_DA)
                       values
                      (x_ticket,x_ticket,x_coda,x_tipo_utente,x_utente,x_oggetto,
                       x_mail,1,sysdate,x_tipo_utente,x_utente);
                      x_oggetto:='['||x_marcatore||' #'||x_ticket||'] '||x_oggetto;
                  else
                     x_nuovo_ticket:='N';
                     x_ticket:=substr(x_oggetto,instr(x_oggetto,'#')+1,instr(x_oggetto,']')-instr(x_oggetto,'#')-1);
                     select id_effettivo
                       into x_ticket
                       from gsa_tickets
                       where id=x_ticket;
                  -- setta utente che prende in carico il ticket se questo non e' ancora stato preso in carica   
                     select tipo_utente,utente_richiedente,preso_in_carico_da,data_risolto
                       into x_app_tipo_rich,x_app_ut_rich,x_app_in_carico,x_app_risolto
                       from gsa_tickets
                       where id=x_ticket;    
                     if x_app_in_carico is null and
                        x_commento_sn='N' then
                        update gsa_tickets
                          set preso_in_carico_da=x_utente,
                              data_preso_in_carico=sysdate
                          where id=x_ticket;    
                     end if;  
                  -- cancella dati risoluzione ticket in caso di riapertura
                     if x_app_risolto is not null and
                        x_commento_sn='N' then
                        update gsa_tickets
                          set stato=4,
                              data_risolto=null
                          where id=x_ticket;    
                     end if;  
                  -- setta chiusura ticket se c'e' la frase di chiusura nell'oggetto
                     if x_chiusura is not null and
                        instr(x_oggetto,x_chiusura)>0 and
                        x_commento_sn='N' then
                        update gsa_tickets
                          set stato=2,
                              data_risolto=sysdate
                          where id=x_ticket;    
                        x_oggetto:=replace(x_oggetto,x_chiusura,''); 
                     end if;   
                  end if;        
                  insert into gsa_mail
                    (id,da,a,data,oggetto,ticket)
                    values 
                    (x_mail,x_da,x_a,x_data,x_oggetto,x_ticket);
                  BYTES := UTL_TCP.read_line (socket, line);
                  UTL_FILE.PUT_LINE(in_mail,line);
                  line := nvl(REPLACE (line, CHR (13) || CHR (10), ''),' ');
                  x_progr:=0;
              --  errore:=errore||'corpo';
              -- cerco inizio messaggio parte testo
                  while instr(line,'Content-Type: text/plain')=0 loop
                    BYTES := UTL_TCP.read_line (socket, line);
                    UTL_FILE.PUT_LINE(in_mail,line);
                    line := nvl(REPLACE (line, CHR (13) || CHR (10), ''),'##**');
                  end loop;
	                corpo_letto:=1;
                  while substr(line,1,2)&lt;>'--' and
                        instr(line,x_inizio)=0 loop
                    if instr(line,'Content-Transfer-Encoding')=0 and
                       instr(line,'charset=')=0 and
                       instr(line,'Content-Type:')=0 and
                       line &lt;> '##**' and
                       line &lt;> '=20' and
                       line &lt;> ' ' then
                       x_progr:=x_progr+1;
                       insert into gsa_mail_corpo
                         (id_mail,progr,riga_corpo)
                          values 
                         (x_mail,x_progr,line); 
                    end if;
                    BYTES := UTL_TCP.read_line (socket, line);
                    UTL_FILE.PUT_LINE(in_mail,line);
                    line := nvl(REPLACE (line, CHR (13) || CHR (10), ''),'##**');
                  end loop;
            elsif line='--'||x_inizio and
                  corpo_letto=1 then
                  --substr(line,1,2)='--' and 
                  in_file:=UTL_FILE.FOPEN('DIR_TMP','appoggio','w');
                  UTL_FILE.PUT_LINE(in_file,line);
                  BYTES := UTL_TCP.read_line (socket, line);
                  UTL_FILE.PUT_LINE(in_mail,line);
                  line := nvl(REPLACE (line, CHR (13) || CHR (10), ''),'&lt;>**');
                  while line&lt;>'--'||x_inizio||'--' loop
                      line:=replace(line,'&lt;>**','');
                      if instr(line,'name="')>0 and
                         instr(line,'filename="')=0 then
                -- allegati
                         x_allegato:=REPLACE(substr(line,instr(line,'name="')+6,length(line)-(instr(line,'name="')+6)),'"','');
                         line:=replace(line,x_allegato,x_mail||x_allegato);
                      end if;
                      UTL_FILE.PUT_LINE(in_file,line);
                      if line='--'||x_inizio and
                         x_allegato is not null then   
                         insert into gsa_mail_allegati
                           (id_mail,nome_file)
                           values
                           (x_mail,x_allegato);
                         UTL_FILE.FCLOSE(in_file);
                         utl_file.fcopy('DIR_TMP', 'appoggio', 'DIR_FILE', x_mail||x_allegato||'.all');
                         select OSexec('/bin/compatta.sh') into x_appoggio from dual;
                         in_file:=UTL_FILE.FOPEN('DIR_TMP','appoggio','w');
                      end if;
                      BYTES := UTL_TCP.read_line (socket, line);
                      UTL_FILE.PUT_LINE(in_mail,line);
                      line := nvl(REPLACE (line, CHR (13) || CHR (10), ''),'&lt;>**');
                  end loop;
                  UTL_FILE.PUT_LINE(in_file,line);
                  UTL_FILE.FCLOSE(in_file);
                  if x_allegato is not null then   
                     insert into gsa_mail_allegati
                     (id_mail,nome_file)
                      values
                     (x_mail,x_allegato);
                     utl_file.fcopy('DIR_TMP', 'appoggio', 'DIR_FILE', x_mail||x_allegato||'.all');
                     UTL_FILE.FCLOSE(in_file);
                     select OSexec('/bin/compatta.sh') into x_appoggio from dual;
                  end if;
                  BYTES := UTL_TCP.read_line (socket, line);
                  UTL_FILE.PUT_LINE(in_mail,line);
                  line := nvl(REPLACE (line, CHR (13) || CHR (10), ''),' ');
            end if;   
         END IF;
      END IF;
      EXIT WHEN LENGTH (line) = 1 AND line = '.';
   END LOOP;
   -- Cancella messaggio
    line:=writetopop ('DELE ' || msgnum);
    UTL_FILE.FCLOSE(in_mail);
    utl_file.fcopy('DIR_TMP', 'mail_appoggio', 'DIR_FILE', x_mail||'.eml');
-- gestione ticket
   commit;
   if x_nuovo_ticket='S' then
      if x_nuovo_utente='N' then
         invia_mail(x_mail,'R'); --invio mail risposta al richiedente
      else
         invia_mail(x_mail,'X'); --invio mail risposta al richiedente con assegnazione utente
      end if;   
      invia_mail(x_mail,'T'); --invio mail agli osservatori di coda per ticket
   end if;   
   if x_nuovo_ticket='N' then
      if x_commento_sn='N' then
         invia_mail(x_mail,'G'); --invio mail risposta (ticket gia' aperto) al richiedente e agli altri osservatori
      else
         invia_mail(x_mail,'C'); --invio mail agli osservatori di coda per ticket
      end if;   
   end if;   
   
   END LOOP;
   -- close connection
   line:=writetopop ('QUIT');
   UTL_TCP.close_connection (socket);
   errore:=errore||'tutto ok';
EXCEPTION
   WHEN e_pop3_error
   THEN
      errore:='errore lettura';
END;</pre>	</td></tr>
</table></div>