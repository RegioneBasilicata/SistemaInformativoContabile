<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>NEW_FPV_RENDICONTO</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="NEW_FPV_RENDICONTO.html">Details</a></div></div>
<div class="tab"><div><a href="NEW_FPV_RENDICONTO_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="NEW_FPV_RENDICONTO_References.html">References</a></div></div>
<div class="tab"><div><a href="NEW_FPV_RENDICONTO_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="NEW_FPV_RENDICONTO_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
procedure NEW_FPV_RENDICONTO(p_anno in number,p_utente in varchar2,x_capitolo in varchar2,p_fpv out number) as
--procedura per report "Allegato b) al Rendiconto  - Fondo Pluriennale Vincolato"
p_capitolo       varchar2(6);
missione       varchar2(10);
desc_missione  varchar2(2000);
programma      varchar2(10);
desc_programma varchar2(2000);

colonna_a varchar2(2000); -- usata per il nome_tabulato
colonna_b varchar2(2000); -- usata per l'anno tabulato
colonna_c varchar2(2000); -- usata per il codice Missione
colonna_d varchar2(2000); -- usata per la descrione Missione
colonna_e varchar2(2000); -- usata per il codice Programma
colonna_f varchar2(2000); -- usata per la descrizione Programma
colonna_g varchar2(2000); -- usata per il codice Capitolo
colonna_h varchar2(2000); -- usata per la descrizione Capitolo

cold1_da_riacc number := 0; -- per inserire l'importo del riaccertamento su capitolo con Aiuti > o nell'anno n+1
cold2_da_riacc number := 0; -- per inserire l'importo del riaccertamento su capitolo con Aiuti > o nell'anno n+2
cold3_da_riacc number := 0; -- per inserire l'importo del riaccertamento su capitolo con Aiuti > o nell'anno n+3

colonna_1 number(15,2) := 0; --FPV al 31/12/p_anno-1
colonna_2 number(15,2) := 0; --FPV liquidato (LIQ)
colonna_3 number(15,2) := 0; --economie di impegni riacc
colonna_4 number(15,2) := 0; --FPV residuo = (colonna_1 - colonna_2 - colonna3)
colonna_5 number(15,2) := 0; --Impegni pluriennali (p_anno+1) assunti in p_anno
colonna_6 number(15,2) := 0; --Impegni pluriennali (p_anno+2) assunti in p_anno
colonna_7 number(15,2) := 0; --Impegni p_anno riaccertati
colonna_8 number(15,2) := 0; --FPV al 31/12/p_anno = (colonna_4 + colonna_5 + colonna_6 + colonna_7)
colonna_9 number(15,2) := 0; --ordinamento righe
colonna_5_1 number(15,2) := 0; --Impegni pluriennali (p_anno+1) assunti in p_anno
colonna_6_1 number(15,2) := 0; --Impegni pluriennali (p_anno+2) assunti in p_anno
colonna_7_1 number(15,2) := 0; --Impegni pluriennali (p_anno+3) assunti in p_anno
colonna_8_1 number(15,2) := 0; --FPV al 31/12/p_anno = (colonna_5_1 + colonna_6_1 + colonna_7_1)

p_doc_id number := 0; --contiene (dove presente) il doc_id del documento coinvolto

colonna2_rid number := 0;
correttivo_col number(15,2) := 0;

importo_liq number := 0;
residuo_fpv number := 0;
importo_x number := 0;
importo_y number := 0;

riacc_entrate number := 0;



-- capitoli finanziati da fpv nell'anno n
cursor capitoli is
select  a.eu||a.codice capitolo
 ,a.desc_capitolo desc_capitolo
 ,nvl(a.liv1,'Da Def.') missione
 ,a.desc_liv1           desc_missione
 ,nvl(a.liv2,'Da Def.') programma
 ,a.desc_liv2           desc_programma
, nvl(b.aiuti,0) fpv
from 
 vw_nb_articoli a
 ,fin_t_bilancio b
where b.anno = p_anno
and   b.eu = 'U' 
and nvl(b.aiuti,0) > 0
and a.anno = b.anno
and a.eu||a.codice = b.eu||b.articolo 
and a.eu||a.codice = nvl(x_capitolo,a.eu||a.codice)
;

-- capitoli finanziati da fpv nell'anno n+1 e non nell'anno n
cursor capitoli_plur1 is
select  a.eu||a.codice capitolo
 ,a.desc_capitolo desc_capitolo
 ,nvl(a.liv1,'Da Def.') missione
 ,a.desc_liv1           desc_missione
 ,nvl(a.liv2,'Da Def.') programma
 ,a.desc_liv2           desc_programma
 ,nvl(b.aiuti,0) fpv_anno1
from 
 vw_nb_articoli a
 ,fin_t_bilancio b
 ,fin_t_bilancio x
where a.anno = p_anno + 1
and a.eu||a.codice = nvl(x_capitolo,a.eu||a.codice)
and b.anno = a.anno
and b.eu = 'U' 
and nvl(b.aiuti,0) > 0
and b.eu||b.articolo = a.eu||a.codice
and x.anno = p_anno
and x.eu||x.articolo = a.codice_precedente
and nvl(x.aiuti,0) = 0;

-- capitoli finanziati da fpv nell'anno n+2 e non nell'anno n
cursor capitoli_plur2 is
select  a.eu||a.codice capitolo
 ,a.desc_capitolo desc_capitolo
 ,nvl(a.liv1,'Da Def.') missione
 ,a.desc_liv1           desc_missione
 ,nvl(a.liv2,'Da Def.') programma
 ,a.desc_liv2           desc_programma
 ,nvl(b.aiuti,0) fpv_anno2
from 
 vw_nb_articoli a
 ,fin_t_articoli a1
 ,fin_t_bilancio b
 ,fin_t_bilancio x
where a.anno = p_anno+2
and a.eu = 'U' 
and a.eu||a.codice = nvl(x_capitolo,a.eu||a.codice)
and a1.anno = p_anno + 1 
and a1.eu||a1.codice = a.CODICE_PRECEDENTE
and b.anno = a.anno 
and b.eu||b.articolo = a.eu||a.codice
and nvl(b.aiuti,0) > 0
and x.anno = p_anno
and x.eu||x.articolo = a1.codice_precedente
and nvl(x.aiuti,0) = 0;

-- capitoli finanziati da fpv nell'anno n+3 e non nell'anno n
cursor capitoli_plur3 is
select  b.anno
,a.eu||a.codice capitolo
 ,a.desc_capitolo desc_capitolo
 ,nvl(a.liv1,'Da Def.') missione
 ,a.desc_liv1           desc_missione
 ,nvl(a.liv2,'Da Def.') programma
 ,a.desc_liv2           desc_programma
 ,nvl(b.aiuti,0) fpv_anno3
from 
 vw_nb_articoli a
 ,fin_t_articoli a1
 ,fin_t_articoli a2
 ,fin_t_bilancio b
 ,fin_t_bilancio x
where a.anno = p_anno + 3
and a.eu = 'U' 
and a.eu||a.codice = nvl(x_capitolo,a.eu||a.codice)
and a1.anno = p_anno + 2 
and a1.eu||a1.codice = a.CODICE_PRECEDENTE
and a2.anno = p_anno + 1
and a2.eu||a2.codice = a1.CODICE_PRECEDENTE
and b.anno = a.anno
and b.eu||b.articolo = a.eu||a.codice
and nvl(b.aiuti,0) > 0
and x.anno = p_anno
and x.eu||x.articolo = a2.codice_precedente
and nvl(x.aiuti,0) = 0;

cursor imp_plur is
select  d.segment8 anno
,a.eu||a.codice capitolo
 ,a.desc_capitolo desc_capitolo
 ,nvl(a.liv1,'Da Def.') missione
 ,a.desc_liv1           desc_missione
 ,nvl(a.liv2,'Da Def.') programma
 ,a.desc_liv2           desc_programma
 ,d.segment8 anno_imp
 ,nvl(sum(nvl(d.CHECK_STOCK_ID,0)),0) importo
from 
fin_t_documenti d
 ,vw_nb_articoli a
 ,fin_t_bilancio b
where d.doc_type like 'IMP%'
and  d.segment8 > p_anno 
and nvl(d.deletion_status_flag,'N') = 'N'
and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
and substr(nvl(d.attribute38,'9999'),1,4) = p_anno
and instr(upper(nvl(d.description,'X')),'Riacc') = 0
and nvl(d.attribute21,0) = 0
and nvl(d.CHECK_STOCK_ID,0) > 0
and d.segment2 = nvl(x_capitolo,d.segment2)
and a.anno = d.segment8
and a.eu||a.codice = d.segment2
and b.anno = d.segment8
and b.eu||b.articolo = d.segment2
and nvl(b.aiuti,0) = 0
group by d.segment8
 ,a.eu||a.codice
 ,a.desc_capitolo
 ,nvl(a.liv1,'Da Def.')
 ,a.desc_liv1
 ,nvl(a.liv2,'Da Def.')
 ,a.desc_liv2; 

 -- +++++++++++++++++++++++++++++++++++++++++++++
 --            cursori colonna b)
 -- +++++++++++++++++++++++++++++++++++++++++++++
 cursor  col_b1 is --imp_plur_liq
 -- prendo l'importo liquidato degli impegni plur (0101||p_anno) fatti nel p_anno - 1
  select l.previous_doc_id doc_id
  ,nvl(l.document_amount,0) importo
      from 
       fin_t_documenti d
       ,fin_t_documenti l
      where d.doc_type in ('IMP','IMP-PER','IMP-DEF')
      and d.segment8 >= p_anno
      and nvl(d.deletion_status_flag,'N') = 'N'
      and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
      and d.attribute21 is null
      and substr(nvl(d.attribute38,'9999'),1,4) &lt;= (p_anno - 1)
      and substr(nvl(d.attribute38,'9999'),1,4) &lt; 2016 -- dal 2016 tutti gli impegni pluriennali sono finanziati da avanzo
      and d.segment2 = p_capitolo
      and l.doc_type = 'LIQ'
      and l.previous_doc_id = d.doc_id
      and nvl(l.deletion_status_flag,'N') = 'N'
      and l.segment8 = p_anno;

   cursor col_b2 is 
     select l.previous_doc_id doc_id
      ,nvl(l.document_amount,0) importo
      ,nvl(r.da_fpv,0) importo_fpv
     from 
       fin_t_documenti d
       ,fin_t_documenti l
       ,fin_t_riaccertamenti r
      where upper(nvl(d.proposal_status_flag,'Z'))||upper(nvl(d.auditing_status_flag,'Z'))='PI' 
      and upper(nvl(d.deletion_status_flag,'N')) &lt;> 'Y'
      and d.doc_type in ('IMP','IMP-DEF','IMP-PER')
      and nvl(d.attribute21,0) > 0
      and nvl(d.segment8,0) = p_anno
      and d.segment2 = p_capitolo
      and r.doc_id_riaccertamento = d.doc_id
      and r.anno_riaccertamento = d.segment8
      and nvl(r.da_fpv,0) > 0
      and l.doc_type = 'LIQ'
      and l.previous_doc_id = d.doc_id
      and nvl(l.deletion_status_flag,'N') = 'N'
      and l.segment8 = p_anno
      ;


cursor col_b3 is --imp_no_riacc_liq 
         select 
         d.doc_id doc_id
        ,r.da_fpv importo_fpv
        ,OPEN_BALANCE_DATA(d.doc_id,to_date('3112'||p_anno,'ddmmyyyy')) residuo
        from fin_t_riaccertamenti r
        ,fin_t_documenti d
        where r.anno_riaccertamento = p_anno
        and nvl(r.da_fpv,0) > 0
        and r.doc_id_riaccertamento = d.doc_id
        and d.segment2 = p_capitolo
        and d.doc_type like 'IMP%'
        and nvl(d.deletion_status_flag,'N') = 'N'
        and residuo_imp_data(d.doc_id,to_date('3112'||p_anno,'ddmmyyyy')) > 0
        UNION
        select d.doc_id doc_id
          ,OPEN_BALANCE_DATA(d.doc_id,to_date('3112'||p_anno,'ddmmyyyy')) importo_fpv
          ,OPEN_BALANCE_DATA(d.doc_id,to_date('3112'||p_anno,'ddmmyyyy')) residuo
             from  
             fin_t_documenti d 
            where d.doc_type in ('IMP','IMP-PER','IMP-DEF')
            and d.segment8 = p_anno 
            and nvl(d.deletion_status_flag,'N') = 'N' 
            and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy') 
            and substr(nvl(d.attribute38,'9999'),1,4) &lt; 2016--= (p_anno - 1) dopo il 2016 gli imp-plur sono finanziati tutti con entrate
            and nvl(d.attribute21,0) = 0
            and d.segment2 = p_capitolo
          --  and d.segment8 &lt; 2017 -- DA VALUTARE LA GESTIONE DEGLI IMP PLURIENNALI con PIERRO
            and residuo_imp_data(d.doc_id,to_date('3112'||p_anno,'ddmmyyyy')) > 0 
        order by 1;

    cursor col_b4 is
     select r.doc_id,nvl(r.da_entrate,0) importo --into b_impegni_riacc_entrate
      from 
       fin_t_riaccertamenti r
      where r.anno_finanziario = p_anno
      and r.CAPITOLO_RIACCERTAMENTO = p_capitolo
      and r.anno_bilancio_riaccertamento = p_anno + 1
      and nvl(r.flag_elimina,'X') = 'X'
      and r.doc_id in (select p.doc_id_riaccertamento 
      from fin_t_riaccertamenti p
      where p.anno_bilancio_riaccertamento = p_anno--&lt; p_anno
      and p.doc_id_riaccertamento is not null
      and nvl(p.da_fpv,0) >= r.da_entrate); 

-- **********************************************

-- ++++++++++++++++++++++++++++++++++++++++++++++
--              cursori colonna x                
-- ++++++++++++++++++++++++++++++++++++++++++++++

cursor col_x1 is --variazioni
 select d.doc_id
 ,nvl(sum(nvl(v.importo_variazione,0)),0) importo
  from fin_t_variazioni_fpv v
  ,fin_t_documenti d
  where to_char(v.data_variazione,'yyyy') = p_anno
  and v.capitolo = p_capitolo
  and instr(upper(nvl(v.descrizione_variazione,'X')),'RIACC')= 0
  and d.doc_id = v.doc_id
  and d.attribute21 is not null 
  group by d.doc_id;

cursor col_x2 is --riacc_elim
select d.doc_id 
 ,nvl(sum(nvl(r.importo_riaccertamento,0)),0) importo
 from fin_t_riaccertamenti r
 ,fin_t_documenti d
 where nvl(r.anno_riaccertamento,9999) = (p_anno + 1)
  and nvl(r.flag_elimina,'P') not in ('E','P')
  and r.anno_bilancio_riaccertamento = p_anno + 1
  and r.tipo_documento&lt;> 'ACC'
  and r.capitolo = p_capitolo
  and d.doc_id = r.doc_id
  and d.attribute21 is not null
  group by d.doc_id;


/*select d.doc_id 
 ,nvl(sum(nvl(p.da_fpv,0)),0) importo
 from fin_t_riaccertamenti r
 ,fin_t_riaccertamenti p
 ,fin_t_documenti d
 where nvl(r.anno_riaccertamento,9999) = (p_anno + 1)
  and nvl(r.flag_elimina,'P') not in ('E','P')
  and r.anno_bilancio_riaccertamento = p_anno + 1
  and r.tipo_documento&lt;> 'ACC'
  and r.capitolo = p_capitolo
  and d.doc_id = r.doc_id
  and d.attribute21 is not null
  and p.doc_id_riaccertamento = d.doc_id
  and nvl(p.da_fpv,0) > 0
  group by d.doc_id;*/
  

 


-- ***********************************************

-- ++++++++++++++++++++++++++++++++++++++++++++++
--              cursore colonna y                
-- ++++++++++++++++++++++++++++++++++++++++++++++

cursor col_y is
  select d.doc_id
  ,nvl(sum(nvl(v.importo_variazione,0)),0) importo
  from fin_t_variazioni_fpv v
  ,fin_t_documenti d
  where v.anno = p_anno
  and v.capitolo = p_capitolo
  and instr(upper(nvl(v.descrizione_variazione,'X')),'RIACC')= 0
  and d.doc_id = v.doc_id
  and d.attribute21 is null
  and to_number(substr(d.attribute38,1,4)) &lt; 2016 -- dal 2016 gli impegni pluriennali saranno coperti da accertamenti pluriennali
  group by d.doc_id;


-- ***********************************************

-- +++++++++++++++++++++++++++++++++++++++++++++++
--              cursori colonna d
-- +++++++++++++++++++++++++++++++++++++++++++++++

    --************ Richiesta Pierro del 12/07/2017 "gli impegni pluriennali saranno dal 2016 in poi coperti sempre da Accertamenti pluriennali
     /* 
    cursor col_d1 is --impegni_plur1
       fin_t_documenti 
     select d.doc_id
       nvl(sum(nvl(d.document_amount,0)),0) 
      from 
      where d.doc_type = 'IMP-DEF'
      and d.segment8 = p_anno + 1
      and nvl(d.deletion_status_flag,'N') = 'N'
      and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
      and substr(nvl(d.attribute38,'9999'),1,4) = p_anno
      and instr(d.description,'Riacc') = 0
      and d.segment2 = capitolo;
      group by d.doc_id;*/
    -- ************** Pierro del 12/07/2017

     cursor col_d2 is --impegni_riacc1
      select r.doc_id_riaccertamento doc_id
      ,nvl(sum(nvl(r.importo_riaccertamento,0) - nvl(r.da_entrate,0)),0) importo
      from fin_t_riaccertamenti r
      where nvl(r.anno_riaccertamento,9999) = (p_anno + 1)
      and nvl(r.flag_elimina,'N') = 'N'
      and r.anno_bilancio_riaccertamento = p_anno + 1
      and r.tipo_documento&lt;> 'ACC'
      and r.capitolo = p_capitolo --PIERRO 16/05/2019 r.capitolo_riaccertamento
      and r.doc_id not in (select doc_id_riaccertamento 
        from fin_t_riaccertamenti 
        where anno_riaccertamento = p_anno--&lt; p_anno
        and doc_id_riaccertamento is not null
        and nvl(da_fpv,0) > 0)
      and r.doc_id not in (
        select 
         d.doc_id
        from 
         fin_t_documenti d
        where d.doc_type = 'IMP-DEF'
        and d.segment8 = p_anno 
      --  and nvl(d.deletion_status_flag,'N') = 'N'
        and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
       -- and substr(nvl(d.attribute38,'9999'),1,4) &lt; p_anno
        and substr(nvl(d.attribute38,'9999'),1,4) &lt; 2016 -- i pluriennali dal 2016 in poi sono finanziati da entrate quindi se riaccertati vanno presi
        --and d.attribute21 is null
        )
      group by r.doc_id_riaccertamento;

      --calcolo eventuali imp_plur1 eliminati in anni successivi
      cursor col_d3 is --d_riacc_piu
      select r.doc_id_riaccertamento doc_id,nvl(r.da_fpv,0) fpv,nvl(p.da_fpv,0) fpv_prec,nvl(r.IMPORTO_RIACCERTAMENTO,0) imp_riacc,nvl(p.IMPORTO_RIACCERTAMENTO,0) imp_riacc_prec
      from fin_t_riaccertamenti r
      ,fin_t_riaccertamenti p
      where nvl(r.anno_riaccertamento,9999) = (p_anno + 1)
        and nvl(r.flag_elimina,'N') = 'N'
        and r.anno_bilancio_riaccertamento = p_anno + 1
        and r.tipo_documento&lt;> 'ACC'
        and r.capitolo = p_capitolo --PIERRO 16/05/2019 r.capitolo_riaccertamento
        and nvl(p.doc_id_riaccertamento,0) = r.doc_id
        and p.anno_bilancio_riaccertamento = p_anno
        and nvl(p.da_fpv,0) > 0
        and nvl(p.DA_ENTRATE,0) > 0
        and nvl(r.da_fpv,0) > 0 
        and nvl(r.IMPORTO_RIACCERTAMENTO,0) &lt;= nvl(p.IMPORTO_RIACCERTAMENTO,0);


-- ***********************************************

-- +++++++++++++++++++++++++++++++++++++++++++++++
--              cursori colonna e
-- +++++++++++++++++++++++++++++++++++++++++++++++


    cursor col_e is --c_impegni_riacc2
      select r.doc_id_riaccertamento doc_id,(nvl(r.importo_riaccertamento,0) - nvl(r.da_entrate,0)) importo
      from fin_t_riaccertamenti r
      where nvl(r.anno_riaccertamento,9999) = (p_anno + 2)
      and r.capitolo = p_capitolo --PIERRO 16/05/2019 r.capitolo_riaccertamento
      and r.tipo_documento&lt;> 'ACC'
      and nvl(r.flag_elimina,'N') = 'N'
      and r.anno_bilancio_riaccertamento = p_anno + 1
      and r.doc_id not in (select doc_id_riaccertamento 
      from fin_t_riaccertamenti 
      where anno_riaccertamento = p_anno--&lt; p_anno
      and doc_id_riaccertamento is not null
      and nvl(da_fpv,0) > 0)
      and r.doc_id not in (
      select 
       d.doc_id
      from 
       fin_t_documenti d
      where d.doc_type = 'IMP-DEF'
      and d.segment8 = p_anno 
      and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
      and substr(nvl(d.attribute38,'9999'),1,4) &lt; 2016
      and attribute21 is null
      );   

-- ***********************************************

-- +++++++++++++++++++++++++++++++++++++++++++++++
--              cursori colonna f
-- +++++++++++++++++++++++++++++++++++++++++++++++

   cursor col_f is --into c_impegni_riacc3
   select r.doc_id_riaccertamento doc_id, (nvl(r.importo_riaccertamento,0) - nvl(r.da_entrate,0)) importo 
      from fin_t_riaccertamenti r
      where nvl(r.anno_riaccertamento,9999) = (p_anno + 3)
      and r.capitolo = p_capitolo --PIERRO 16/05/2019 r.capitolo_riaccertamento
    and nvl(r.flag_elimina,'N') = 'N'
    and r.anno_bilancio_riaccertamento = p_anno + 1
    and r.tipo_documento&lt;> 'ACC'
      and r.doc_id not in (select doc_id_riaccertamento 
      from fin_t_riaccertamenti 
      where anno_riaccertamento = p_anno--&lt; p_anno
      and doc_id_riaccertamento is not null
      and nvl(da_fpv,0) > 0)
      and r.doc_id not in (
      select 
       d.doc_id
      from 
      and d.date_created = to_date('0101'||d.segment8,'ddmmyyyy')
       fin_t_documenti d
      where d.doc_type = 'IMP-DEF'
      and d.segment8 = p_anno 
      and substr(nvl(d.attribute38,'9999'),1,4) &lt; 2016
      and attribute21 is null
      );

--- **********************************************



-- +++++++++++++++++++++++++++++++++++++++++++++++++++++++++
-- +++++++++++++++++++++++++++++++++++++++++++++++++++++++++
-- +++++++++++++++++++++++++++++++++++++++++++++++++++++++++


-- ****************** INIZIO PROCEDURA *******************

begin
 if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' 
 then
  delete fin_t_rendiconto_fpv where nvl(utente,'xxxx') = nvl(p_utente,'xxxx') and nvl(anno,9999) = p_anno;
  commit;
end if;


  colonna_9 := 0;

for c in capitoli loop
 p_capitolo := c.capitolo;


        colonna_1 := 0;
        colonna_2 := 0;
        colonna_3 := 0;
        colonna_4 := 0;
        colonna_5 := 0;
        colonna_6 := 0;
        colonna_7 := 0;
        colonna_8 := 0;

        colonna2_rid := 0;

        P_FPV := 0;

      colonna_c := c.missione; -- usata per il codice Missione
      colonna_d := c.desc_missione; -- usata per la descrione Missione
      colonna_e := c.programma; -- usata per il codice Programma
      colonna_f := c.desc_programma; -- usata per la descrizione Programma
      colonna_g := c.capitolo ; -- usata per il codice Capitolo
      colonna_h := c.desc_capitolo; -- usata per la descrizione Capitolo 


  -- inserisco la colonna a) per tutti i capitoli finanziati da FPV nell'anno n
  colonna_1 := c.fpv;
  if nvl(p_utente,'X') &lt;> 'CONSUNTIVO'
    then 
     colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
     insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_a
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,colonna_1  
       ,sysdate
       ,'Importo col a)'
       );
     commit;
     end if;

colonna_4 := colonna_4 + colonna_1;
--colonna_1 := 0;

  -- determino l'importo della colonna_2 (b) del report (liquidazione per liquidazione)
  for b1 in col_b1 loop

  colonna_2 := colonna_2 + nvl(b1.importo,0);

   if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND b1.importo &lt;> 0
   then
   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
   insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_b
       ,doc_id
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,b1.importo
       ,b1.doc_id  
       ,sysdate
       ,'I parte col b)'
       );
        commit;
     end if;
    end loop;




  for b2 in col_b2 loop

  if nvl(b2.importo,0) &lt;= nvl(b2.importo_fpv,0)
     then importo_liq := b2.importo;
     else importo_liq := b2.importo_fpv;
  end if;

  colonna_2 := colonna_2 + nvl(importo_liq,0);

   if  nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND importo_liq &lt;> 0
   then
   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
   insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_b
       ,doc_id
       ,data_generazione
       ,note
       )
       values
       ,colonna_c
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,importo_liq
       ,b2.doc_id  
       ,sysdate
       ,'II parte col b) liquidato'
       );
        commit;
     end if;
     importo_liq := 0;

  end loop;


  for b3 in col_b3 loop

   if nvl(b3.residuo,0) &lt;= nvl(b3.importo_fpv,0)
     then residuo_fpv := b3.residuo;
     else residuo_fpv := b3.importo_fpv;
   end if;


  colonna_2 := colonna_2 + nvl(residuo_fpv,0);
  if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND residuo_fpv &lt;> 0
   then

   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe

   insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_b
       ,doc_id
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,residuo_fpv
       ,b3.doc_id  
       ,sysdate
       ,'III parte col b) rimanenza a residuo'
       );
        commit;
     end if;
    residuo_fpv := 0;
   end loop;


 for b4 in col_b4 loop

     colonna_2 := colonna_2 + b4.importo;
     if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND b4.importo &lt;> 0 
   then
   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe

   insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_b
       ,doc_id
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,b4.importo
       ,b4.doc_id  
       ,sysdate
       ,'IV parte col b)'
       );
        commit;
     end if;

 end loop;

  -- *********** 




-- +++++++++++++++++++++++++++++++++++++++++++++++++
--       importi colonna_3 (x) del report
-- +++++++++++++++++++++++++++++++++++++++++++++++++

  for x1 in col_x1 loop




  -- prendo la quota riaccertata con FPV l'anno precedente
  residuo_fpv := 0;

  begin 
   select nvl(r.da_fpv,0) into residuo_fpv
   from fin_t_riaccertamenti r
   where r.anno_riaccertamento = p_anno
   and r.doc_id_riaccertamento = x1.doc_id;
   exception when no_data_found then residuo_fpv := 0;
  end;


   if x1.importo > residuo_fpv 
    then importo_x := residuo_fpv;
    else importo_x := x1.importo;
   end if;
 if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND importo_x &lt;> 0
   then
   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe+
  insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_x
       ,doc_id
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,importo_x
       ,x1.doc_id  
       ,sysdate
       ,'I parte col x)'
       );
        commit;
     end if;

    colonna_3 := colonna_3 + importo_x;
    residuo_fpv := 0;
    importo_x := 0;

    end loop;



   if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND x2.importo &lt;> 0
  for x2 in col_x2 loop


   then

   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
  insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_x
       ,doc_id
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,x2.importo
       ,x2.doc_id  
       ,sysdate
       ,'II parte col x)'
       );
        commit;
     end if;
    colonna_3 := colonna_3 + x2.importo;
   end loop;



  begin
  select (nvl(importo,0)*decode(UPPER(nvl(segno,'PIU')),'PIU',1,'MENO',-1)) into correttivo_col
  from fin_t_correttivi_fpv
  where anno = p_anno
  and capitolo = c.capitolo
  and upper(colonna) = 'X';
  exception when no_data_found then correttivo_col := 0;
 end;

  colonna_3 := colonna_3 + nvl(correttivo_col,0);

  if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND nvl(correttivo_col,0) &lt;> 0
   then

   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
   insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_x
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,nvl(correttivo_col,0)
       ,sysdate
       ,'Correttivo col x)'
       );
        commit;
     end if;


-- +++++++++++++++++++++++++++++++++++++++++++++++++
--       importi colonna_3_2 (y) del report
-- +++++++++++++++++++++++++++++++++++++++++++++++++

  for y in col_y loop

   colonna_3 := colonna_3 + nvl(y.importo,0);

   if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND y.importo &lt;> 0
   then
   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe

  insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_y
       ,doc_id
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,y.importo
       ,y.doc_id  
       ,sysdate
       ,'Importo col y)'
       );
        commit;
     end if;

    end loop;



  -- per eventuali correttivi      
  begin
  select (nvl(importo,0)*decode(UPPER(nvl(segno,'PIU')),'PIU',1,'MENO',-1)) into correttivo_col
  from fin_t_correttivi_fpv
  where anno = p_anno
  and capitolo = c.capitolo
  and upper(colonna) = 'Y';
  exception when no_data_found then correttivo_col := 0;
 end;

 colonna_3 := colonna_3 + nvl(correttivo_col,0);

  if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND  nvl(correttivo_col,0) &lt;> 0
   then

   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
   insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_y
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_g
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_h
       ,nvl(correttivo_col,0)
       ,sysdate
       ,'Correttivo col x)'
       );
        commit;
     end if;

  colonna_4 := colonna_4 - colonna_3;


 -- **********
 -- **** RIDETERMINO la colonna_2



  if nvl(colonna_2,0) > (nvl(colonna_1,0) - nvl(colonna_3,0))
    then colonna2_rid := (nvl(colonna_1,0) - nvl(colonna_3,0)) - nvl(colonna_2,0);
    if nvl(p_utente,'X') &lt;> 'CONSUNTIVO'
    then
    colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
       insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_b
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,nvl(colonna2_rid,0)
       ,sysdate
       ,'Correttivo per Ridefinizione col b)'
       );
        commit;
      end if;
     end if;

 -- per eventuali correttivi della colonna 2 (lo calcolo dopo la rideterminazione)

    begin
      select (nvl(importo,0)*decode(UPPER(nvl(segno,'PIU')),'PIU',1,'MENO',-1)) into correttivo_col
      from fin_t_correttivi_fpv
      where anno = p_anno
      and capitolo = c.capitolo
      and upper(colonna) = 'B';
      exception when no_data_found then correttivo_col := 0;
    end;

  colonna_2 := colonna_2 + nvl(correttivo_col,0);

  if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND nvl(correttivo_col,0) &lt;> 0
   then
   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe

   insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_b
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,nvl(correttivo_col,0)
       ,sysdate
       ,'Correttivo col b)'
       );
        commit;
     end if;

  colonna_4 := colonna_4 - (colonna_2 + colonna2_rid);




 -- **** FINE

 -- ++++++++++++++++++++++++++++++++++++++++++
 -- importo colonna_4 (c) del report
 -- **** potrebbe essere calcolata in fase di select

if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND nvl(colonna_4,0) &lt;> 0
   then
   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe

  insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_c
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,colonna_4
       ,sysdate
       ,'Importo col c)'
       );
        commit;
     end if;


colonna_8 := colonna_4;
colonna_4 := 0;

-- colonna_4 := nvl(colonna_1,0) - nvl(colonna_2,0) - nvl(colonna_3,0);
 -- ****
-- +++++++++++++++++++++++++++++++++++++++++++


-- ++++++++++++++++++++++++++++++++++++++++++
-- importo colonna_5 (d) del report
-- ++++++++++++++++++++++++++++++++++++++++++

 --************ Richiesta Pierro del 12/07/2017 "gli impegni pluriennali saranno dal 2016 in poi coperti sempre da Accertamenti pluriennali
     /* 

 for d1 in col_d1 loop
  if nvl(d1.importo,0) &lt;> 0
   then
   colonna_5 := d1.importo;
       ,utente
   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
  insert into fin_t_rendiconto_fpv
       (anno
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_d
       ,doc_id
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,colonna_5
       ,d1.doc_id  
       ,sysdate
       ,'I parte col d)'
       );
        commit;
     end if;
    end loop;
    colonna_5 := 0;
 */


 for d2 in col_d2 loop

 colonna_5 := d2.importo;

  if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND nvl(d2.importo,0) &lt;> 0
   then
   colonna_5 := d2.importo;
   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
  insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_d
       ,doc_id
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,colonna_5
       ,d2.doc_id  
       ,sysdate
       ,'I parte col d)'
       );
        commit;
     end if;
    colonna_8 := colonna_8 + colonna_5;
    colonna_5 := 0;
    end loop;




 for d3 in col_d3 loop

 if d3.fpv_prec &lt;= (d3.imp_riacc_prec - d3.imp_riacc)
 then
 colonna_5 := d3.fpv;

  if nvl(p_utente,'X') &lt;> 'CONSUNTIVO'
   then

   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
  insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_d
       ,doc_id
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,colonna_5
       ,d3.doc_id  
       ,sysdate
       ,'II parte col d)'
       );
        commit;
     end if;
  end if; 
    colonna_8 := colonna_8 + colonna_5;
    colonna_5 := 0;
    end loop;



-- per eventuali correttivi      
  begin
  select (nvl(importo,0)*decode(UPPER(nvl(segno,'PIU')),'PIU',1,'MENO',-1)) into correttivo_col
  from fin_t_correttivi_fpv
  where anno = p_anno
  and capitolo = c.capitolo
  and upper(colonna) = 'D';
  exception when no_data_found then correttivo_col := 0;
 end;

 colonna_5 := correttivo_col;

  if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND nvl(correttivo_col,0) &lt;> 0
   then

   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
   insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       )
       ,col_d
       ,data_generazione
       ,note
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,nvl(correttivo_col,0)
       ,sysdate
       ,'Correttivo col d)'
       );
        commit;
     end if;

     colonna_8 := colonna_8 + colonna_5;
      colonna_5 := 0;
      correttivo_col := 0;

-- colonna_5 := nvl(c_impegni_plur1,0)+ nvl(elim_imp_plur1,0) + nvl(c_impegni_riacc1,0) + nvl(corrx1,0);

-- ++++++++++++++++++++++++++++++++++++++++++
-- importo colonna_6 (e) del report
-- ++++++++++++++++++++++++++++++++++++++++++


 for e in col_e loop

colonna_6 := e.importo;

  if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND nvl(e.importo,0) &lt;> 0
   then

   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
  insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_e
       ,doc_id
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,colonna_6
       ,e.doc_id  
       ,sysdate
       ,'I parte col e)'
       );
        commit;
     end if;
    colonna_8 := colonna_8 + colonna_6;
    colonna_6 := 0;

    end loop;



  -- per eventuali correttivi      
  begin
  select (nvl(importo,0)*decode(UPPER(nvl(segno,'PIU')),'PIU',1,'MENO',-1)) into correttivo_col
  from fin_t_correttivi_fpv
  where anno = p_anno
  and capitolo = c.capitolo
  and upper(colonna) = 'E';
  exception when no_data_found then correttivo_col := 0;
 end;

 colonna_6 := correttivo_col;

  if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND nvl(correttivo_col,0) &lt;> 0
   then

   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
   insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_e
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,nvl(correttivo_col,0)
       ,sysdate
       ,'Correttivo col e)'
       );
        commit;
     end if;

     colonna_8 := colonna_8 + colonna_6;
     colonna_6 := 0;
     correttivo_col := 0;

-- ++++++++++++++++++++++++++++++++++++++++++
-- importo colonna_7 (f) del report
-- ++++++++++++++++++++++++++++++++++++++++++


 for f in col_f loop

 colonna_7 := f.importo;

  if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND nvl(f.importo,0) &lt;> 0
   then

   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
  insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_f
       ,doc_id
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,colonna_7
       ,f.doc_id  
        commit;
       ,sysdate
       ,'I parte col f)'
       );
     end if;
    colonna_8 := colonna_8 + colonna_7;
    colonna_7 := 0;

    end loop;



  -- per eventuali correttivi      
  begin
  select (nvl(importo,0)*decode(UPPER(nvl(segno,'PIU')),'PIU',1,'MENO',-1)) into correttivo_col
  from fin_t_correttivi_fpv
  where anno = p_anno
  and capitolo = c.capitolo
  and upper(colonna) = 'F';
  exception when no_data_found then correttivo_col := 0;
 end;

 colonna_7 := correttivo_col;

  if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND nvl(correttivo_col,0) &lt;> 0
   then

   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
   insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_f
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,nvl(correttivo_col,0)
       ,sysdate
       ,'Correttivo col f)'
       );
        commit;
     end if;

     colonna_8 := colonna_8 + colonna_7;
     colonna_7 := 0;
     correttivo_col := 0;

-- ++++++++++++++++++++++++++++++++++++++++++
-- importo colonna_8 (g) del report
-- ++++++++++++++++++++++++++++++++++++++++++

p_fpv := colonna_8;

if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND  nvl(p_fpv,0) &lt;> 0
   then

   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_g
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,p_fpv--colonna_8
       ,sysdate
       ,'Importo colonna g)'
       );
        commit;
end if;


end loop;

-- ****************************************************************
--         loop per capitoli con fpv > 0 anno n+1 ma = 0 anno n
-- ****************************************************************


colonna_8 := 0;

for c1 in capitoli_plur1 loop

 colonna_5_1 := 0;
 cold1_da_riacc := 0;


 colonna_9 := colonna_9 + 1; -- indice per ordinamento righe

 colonna_c := c1.missione; -- usata per il codice Missione
 colonna_d := c1.desc_missione; -- usata per la descrione Missione
 colonna_e := c1.programma; -- usata per il codice Programma

 colonna_f := c1.desc_programma; -- usata per la descrizione Programma
 colonna_g := c1.capitolo ; -- usata per il codice Capitolo
 colonna_h := c1.desc_capitolo; -- usata per la descrizione Capitolo 

 for dp1 in (select r.doc_id_riaccertamento doc_id,(nvl(r.importo_riaccertamento,0) - nvl(r.da_entrate,0)) importo--into c_impegni_riacc1
 from fin_t_riaccertamenti r
 where nvl(r.anno_riaccertamento,9999) = (p_anno + 1)
 and nvl(r.flag_elimina,'N') = 'N'
 and r.anno_bilancio_riaccertamento = p_anno + 1
 and r.tipo_documento&lt;> 'ACC'
 --********* FF 16/05/2019 aggiunta per riaccertamento senza documenti
 --and r.doc_id_riaccertamento is not null
 and nvl(r.da_fpv,0) > 0
 --********* FF 16/05/2019 aggiunta per riaccertamento senza documenti
 and r.capitolo = c1.capitolo --PIERRO 16/05/2019 r.capitolo_riaccertamento
 -- **** aggiunta 31/10/2018 per non riprendere imp riacc anno precedente anche su capitoli diversi 
 and r.doc_id not in (select doc_id_riaccertamento 
        from fin_t_riaccertamenti 
        where anno_riaccertamento = p_anno--&lt; p_anno
        and doc_id_riaccertamento is not null
        and nvl(da_fpv,0) > 0)
 -- **** FINE aggiunta 31/10/2018 per non riprendere imp riacc anno precedente anche su capitoli diversi 
        ) loop

 colonna_5_1 := dp1.importo;
 cold1_da_riacc :=  cold1_da_riacc + dp1.importo;

 if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND  nvl(dp1.importo,0) &lt;> 0
 then 
    colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_d
       ,doc_id
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,colonna_5_1
       ,dp1.doc_id
       ,sysdate
       ,'Importo anno n+1 col d)'
       );
        commit;
 end if;
 colonna_8 := colonna_8 + colonna_5_1;
 colonna_8_1 := colonna_8_1 + colonna_5_1;
end loop;


if nvl(c1.fpv_anno1,0) > nvl(cold1_da_riacc,0)
  then
  
    for dp1 in (select d.doc_id doc_id,d.document_amount importo--into c_impegni_riacc1
     from fin_t_documenti d
     where d.doc_type = 'IMP-DEF'
     and nvl(d.deletion_status_flag,'N') = 'N'
     and segment8 = p_anno + 1
     and substr(d.attribute38,1,4) = p_anno
     and d.attribute21 is null
     and d.segment2 = c1.capitolo
     ) loop

 colonna_5_1 := dp1.importo;
 
 if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND  nvl(dp1.importo,0) &lt;> 0
 then 
    colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_d
       ,doc_id
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,colonna_5_1
       ,dp1.doc_id
       ,sysdate
       ,'Importo anno n+1 col d) pluriennali'
       );
        commit;
 end if;
 colonna_8 := colonna_8 + colonna_5_1;
 colonna_8_1 := colonna_8_1 + colonna_5_1;
end loop;

 end if;

if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND  nvl(colonna_8_1,0) &lt;> 0
   then

   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_g
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,colonna_8_1
       ,sysdate
       ,'Importo anno n+1  colonna g)'
       );
        commit;
end if;
colonna_8_1 := 0;

colonna_5_1 := 0;
end loop;


-- ****************************************************************
--         loop per capitoli con fpv > 0 anno n+2 ma = 0 anno n
-- ****************************************************************


for c1 in capitoli_plur2 loop

 colonna_6_1 := 0;


 colonna_9 := colonna_9 + 1; -- indice per ordinamento righe

 colonna_c := c1.missione; -- usata per il codice Missione
 colonna_d := c1.desc_missione; -- usata per la descrione Missione
 colonna_e := c1.programma; -- usata per il codice Programma
 colonna_f := c1.desc_programma; -- usata per la descrizione Programma
 colonna_g := c1.capitolo ; -- usata per il codice Capitolo
 colonna_h := c1.desc_capitolo; -- usata per la descrizione Capitolo 


 for dp2 in (select r.doc_id_riaccertamento doc_id,(nvl(r.importo_riaccertamento,0) - nvl(r.da_entrate,0)) importo --into c_impegni_riacc2
      from fin_t_riaccertamenti r
      where nvl(r.anno_riaccertamento,9999) = (p_anno + 2)
      and r.capitolo = c1.capitolo --PIERRO 16/05/2019 r.capitolo_riaccertamento
      -- aggiunta 13052015
      and r.tipo_documento&lt;> 'ACC'
      and nvl(r.flag_elimina,'N') = 'N'
      and r.anno_bilancio_riaccertamento = p_anno + 1
     --********* FF 16/05/2019 aggiunta per riaccertamento senza documenti
 --and r.doc_id_riaccertamento is not null
    and nvl(r.da_fpv,0) > 0
 --********* FF 16/05/2019 aggiunta per riaccertamento senza documenti
    ) loop

 colonna_6_1 := dp2.importo;

if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND  nvl(dp2.importo,0) &lt;> 0
 then 
    colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_e
       ,doc_id
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,colonna_6_1
       ,dp2.doc_id
       ,sysdate
       ,'Importo anno n+2 col e)'
       );
        commit;
 end if;
 colonna_8 := colonna_8 + colonna_6_1;
 colonna_8_1 := colonna_8_1 + colonna_6_1;

end loop;
if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND  nvl(colonna_8_1,0) &lt;> 0
   then

   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
insert into fin_t_rendiconto_fpv
       ,missione      -- colonna_c
       (anno
       ,utente
       ,num_ord
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_g
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,colonna_8_1
       ,sysdate
       ,'Importo anno n+2 colonna g)'
       );
        commit;
end if;

colonna_8_1 := 0;
colonna_6_1 := 0;
end loop;



-- ****************************************************************
--         loop per capitoli con fpv > 0 anno n+2 ma = 0 anno n
-- ****************************************************************


for c1 in capitoli_plur3 loop

 colonna_7_1 := 0;


 colonna_9 := colonna_9 + 1; -- indice per ordinamento righe

 colonna_c := c1.missione; -- usata per il codice Missione
 colonna_d := c1.desc_missione; -- usata per la descrione Missione
 colonna_e := c1.programma; -- usata per il codice Programma
 colonna_f := c1.desc_programma; -- usata per la descrizione Programma
 colonna_g := c1.capitolo ; -- usata per il codice Capitolo
 colonna_h := c1.desc_capitolo; -- usata per la descrizione Capitolo 


 for dp3 in (select r.doc_id_riaccertamento doc_id,(nvl(r.importo_riaccertamento,0) - nvl(r.da_entrate,0)) importo --into c_impegni_riacc3
      from fin_t_riaccertamenti r
      where nvl(r.anno_riaccertamento,9999) = (p_anno + 3)
      and r.capitolo = c1.capitolo --PIERRO 16/05/2019 r.capitolo_riaccertamento
      -- aggiunta 13052015
      and r.tipo_documento&lt;> 'ACC'
      and nvl(r.flag_elimina,'N') = 'N'
      and r.anno_bilancio_riaccertamento = p_anno + 1
       --and r.doc_id_riaccertamento is not null
     and nvl(r.da_fpv,0) > 0
 --********* FF 16/05/2019 aggiunta per riaccertamento senza documenti
      ) loop

 colonna_7_1 := dp3.importo;

 if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND  nvl(dp3.importo,0) &lt;> 0
 then 
    colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_f
       ,doc_id
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,colonna_7_1
       ,dp3.doc_id
       ,sysdate
       ,'Importo anno n+3 col f)'
       );
        commit;
 end if;
 colonna_8 := colonna_8 + colonna_7_1;
 colonna_8_1 := colonna_8_1 + colonna_7_1;
end loop;

if nvl(p_utente,'X') &lt;> 'CONSUNTIVO' AND  nvl(colonna_8_1,0) &lt;> 0
   then

   colonna_9 := colonna_9 + 1; -- indice per ordinamento righe
insert into fin_t_rendiconto_fpv
       (anno
       ,utente
       ,num_ord
       ,missione      -- colonna_c
       ,desc_missione -- colonna_d
       ,programma     -- colonna_e
       ,desc_programma-- colonna_f
       ,capitolo      -- colonna_g
       ,desc_capitolo -- colonna_h
       ,col_g
       ,data_generazione
       ,note
       )
       values
       (p_anno
       ,p_utente
       ,colonna_9
       ,colonna_c
       ,colonna_d
       ,colonna_e
       ,colonna_f
       ,colonna_g
       ,colonna_h
       ,colonna_8_1
       ,sysdate
       ,'Importo anno n+3 colonna g)'
       );
        commit;
end if;
colonna_8_1 := 0;
colonna_7_1 := 0;
end loop;



-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
-- importo colonna_8 (g) del report per gli anni n+1, n+2, n+3
-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


p_fpv := nvl(p_fpv,0) + nvl(colonna_8,0);


end;</pre>	</td></tr>
</table></div>