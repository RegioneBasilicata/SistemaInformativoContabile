<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>NUOVO_CONSUNTIVO_USCITE</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="NUOVO_CONSUNTIVO_USCITE.html">Details</a></div></div>
<div class="tab"><div><a href="NUOVO_CONSUNTIVO_USCITE_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="NUOVO_CONSUNTIVO_USCITE_References.html">References</a></div></div>
<div class="tab"><div><a href="NUOVO_CONSUNTIVO_USCITE_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="NUOVO_CONSUNTIVO_USCITE_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
PROCEDURE  nuovo_consuntivo_uscite(p_anno in number,p_capitolo in varchar2,p_data_stampa in date,p_utente in varchar2) as

residui_iniziali number := 0;
residui_iniziali_per1 number := 0;
--residui_iniziali_per2 number := 0;
--residui_iniziali_per3 number := 0;
impegni_compe number := 0;
pagamenti_compe number := 0;
pagamenti_res number := 0;
var_residui number := 0;
rim_residui number := 0;
residui_compe number := 0;
residui_finali number := 0;



data_generazione date := trunc(nvl(p_data_stampa,to_date('3112'||p_anno,'ddmmyyyy')),'dd');
data_assestamento date;
anno_fin number := p_anno;
--correttivo number := 0;
--colonna_corr varchar2(10);
c1_corr number (15,2) := 0;
c2_corr number (15,2) := 0;
c3_corr number (15,2) := 0;
c4_corr number (15,2) := 0;
c5_corr number (15,2) := 0;
c6_corr number (15,2) := 0;
c7_corr number (15,2) := 0;
c8_corr number (15,2) := 0;
c9_corr number (15,2) := 0;
c10_corr number (15,2) := 0;
c11_corr number (15,2) := 0;
c12_corr number (15,2) := 0;
c13_corr number (15,2) := 0;

wcapitoli_totali number := 0;
wid number := 0;

-- riporter√† il valore della partita iva o codice fiscale dell'ente ai fini del consolidato per distinguere i movimenti.
pi_ente varchar2(16);


/*CM1 VARCHAR2(1);
CM2 VARCHAR2(1);
CM3 VARCHAR2(3);
CM4 VARCHAR2(1);
CM5 VARCHAR2(2);
CM6 VARCHAR2(2);*/
c1 number (15,2) := 0;
c2 number (15,2) := 0;
c3 number (15,2) := 0;
c4 number (15,2) := 0;
c5 number (15,2) := 0;
c6 number (15,2) := 0;
c7 number (15,2) := 0;
c8 number (15,2) := 0;
c9 number (15,2) := 0;
c10 number (15,2) := 0;
c11 number (15,2) := 0;
c12 number (15,2) := 0;
c13 number (15,2) := 0;

wcapitolo varchar2(6);
c_desc_capitolo varchar2(2000);
c_disavanzo_amministrazione number(15,2) := 0;
c_disavanzo_regionale number(15,2) := 0;
c_disavanzo_eff_anni_prec number(15,2) := 0;
wfpv number(15,2) := 0;
dis_eco number(15,2):=0;
perenzione number(15,2):=0;


 palienazione_beni number(15,2) := 0;
 pfpv_fonte number(15,2) := 0;
 pentrate_libere  number(15,2) := 0;
 pavanzo_vincolato number(15,2) := 0;
 pstato number(15,2) := 0;
 pue number(15,2) := 0;
 pregione_vincolato number(15,2) := 0;
 paltri_soggetti number(15,2) := 0;
 pmutui number(15,2) := 0;
 p_codice_risp number := 0;
 p_desc_risp varchar2(2000);

vcap_disavanzo_amm1 VARCHAR2(5);
vdesc_cap_disavanzo_amm1 VARCHAR2(1000);
vcap_disavanzo_amm2 VARCHAR2(5);
vdesc_cap_disavanzo_amm2 VARCHAR2(1000);

-- 12/09/2012 Nuove variabili introdotte da Simone Bruno per calcolo percentuale avanzamento processo
    rindex    BINARY_INTEGER;
    w_context VARCHAR(200);
    slno      BINARY_INTEGER;
    w_count NUMBER;
-- fine introduzione variabili Simone Bruno 


-- ******* definisco il data Type per la BULK COLLECT *****

-- TYPE CapitoliCons IS TABLE OF fin_t_consuntivo_excel.capitolo%TYPE INDEX BY BINARY_INTEGER;

-- RigaCons CapitoliCons;
-- ********************************************************


-- per tenere conto dei correttivi
cursor correttivi is
select importo_operazione*(decode(segno_operazione,'piu',1,'meno',-1,0)) correttivo
,colonna_consuntivo colonna_corr
from t_appoggio_consuntivo
where anno = p_anno
and cap = wcapitolo;
-- FINE correttivi




begin

 -- ***** Elimino righe relativo a stesso Utente e stesso anno

   delete fin_t_consuntivo_excel where anno_consuntivo = p_anno and utente = p_utente and tipo_capitolo = 'U' ;
   commit;

 -- *******

 -- **** Inserisco sulla Fin_t_consuntivo_excel le righe di base relative a tutti i capitoli dell'anno

         INSERT INTO FIN_T_CONSUNTIVO_EXCEL
          (
            TIPO_capitolo,
            ANNO_CONSUNTIVO,
            CODICE_REGIONALE,
            TITOLO,
            DESC_TITOLO,
            CATEGORIA_MACROFO,
            DESC_CATEGORIA_MACROFO,
            FUNZIONE_OBIETTIVO,
            DESC_FUNZ_OBIETTIVO,
            UPB,
            DESC_UPB,
            capitolo,
            DESC_capitolo,
            CM_GENERE_FUNZIONE,
            CM_TIPO_FUNZIONE,
            CM_TITOLO_CATEG_VOCEECONOMICA,
            CM_CODICE_AGGREGATI_ECONOMICI,
            CM_SEZIONE,
            CM_SETTORE,
            DATA_GENERAZIONE,
            UTENTE,
            CODICE_BILANCIO_SIOPE,
            CODICE_GESTIONALE_SIOPE,
            SANITA_SN,
            NOTE_SANITA,
            NB_PIANO_CONTI_FINA,
            NB_CODICE_TRANSAZIONE,
            NB_ENTRATA_RICORRENTE,
            NB_TITOLO,
            NB_MACROAGGREGATO,
            NB_COFOG_II_LIVELLO,
            NB_ID_PADRE,
            NB_PRU,
            CONTO_SANITA,
            NB_FPV,
            NB_capitolo_FPV,
            FONDO,
            VAR_COM_POS,
            VAR_COM_NEG,
            VAR_CAS_POS,
            VAR_CAS_NEG,
            ASS_COM_POS,
            ASS_COM_NEG,
            ASS_CAS_POS,
            ASS_CAS_NEG,
            NB_LIVELLO1,
            DESC_NB_LIVELLO1,
            NB_LIVELLO2,
            DESC_NB_LIVELLO2,
            DESC_NB_TITOLO,
            DESCR_SIOPE,
            DESCR_PCF,
            DESCR_MACRO_AGG,
            CF_PI_ENTE,
            RESIDUI_INIZIALI,
            PREVISIONI_DEFINITIVE_COMPE,
            PREVISIONI_DEFINITIVE_CASSA,
            ACCERTAMENTI_IMPEGNI_COMPE,
            RISCOSSIONI_PAGAMENTI_COMPE,
            RISCOSSIONI_PAGAMENTI_RES,
            RISCOSSIONI_PAGAMENTI_TOTALE,
            DIFFERENZA_PREVCOMPE_ACCERT,
            DIFFERENZA_PREVCOMPE_IMPEGNI,
            VARIAZIONE_RESIDUI,
            RIMANENZE_RESIDUI,
            RESIDUI_COMPETENZA,
            RESIDUI_FINALI,
            PREVISIONI_INIZIALI_RES,
            ECONOMIE_COMPETENZA, 
            FPV,
            RIACCERTAMENTO_RESIDUI,
            ELIMINAZIONE_PERENZIONE,
            TOTALE_VARIAZIONI_RESIDUI, 
            RES_PASS_PREC,
            RES_PASS_COMPE,
            TOT_RES_PASS_RIP,
            fpv_fonte,
            entrate_libere,
            avanzo_vincolato,
            stato,
            ue,
            REGIONE_VINCOLATO,
            ALTRI_SOGGETTI,
            MUTUI,
            ALIENAZIONE_BENI
          )
        select 
            ftb.eu tipo_capitolo,
            anno_fin anno_consuntivo,
            17 codice_regionale,
            bd.titolo                 titolo,
            bd.DESCRIZIONE_titolo            desc_titolo,
            bd.macro_fo                macro_fo,
            bd.descrizione_macro_fo            desc_macro_fo,
            bd.categoria                 fo,
            bd.descrizione_categoria            desc_fo,
            bd.upb    upb,
            bd.DESCRIZIONE_upb               desc_upb,
            bc.CODICE                 codice_capitolo,
            bc.DESC_capitolo                     desc_capitolo,
            SUBSTR(nvl(bc.CODICE_MECCANOGRAFICO,''),1,1) CM_GENERE_FUNZIONE,
            SUBSTR(nvl(bc.CODICE_MECCANOGRAFICO,''),2,1) CM_TIPO_FUNZIONE,
            SUBSTR(nvl(bc.CODICE_MECCANOGRAFICO,''),3,3) CM_TITOLO_CATEG_VOCEECONOMICA, 
            SUBSTR(nvl(bc.CODICE_MECCANOGRAFICO,''),6,1) CM_CODICE_AGGREGATI_ECONOMICI,
            SUBSTR(nvl(bc.CODICE_MECCANOGRAFICO,''),7,2) CM_SEZIONE,
            SUBSTR(nvl(bc.CODICE_MECCANOGRAFICO,''),9,2) CM_SETTORE,
            data_generazione,
            p_utente,
            bc.CODICE_BILANCIO_SIOPE                   siope_bil,
            bc.CODICE_GESTIONALE_SIOPE               siope_gest,
            bc.SANITA_SN,
            null NOTE_SANITA,
            bc.pcf NB_PIANO_CONTI_FINA,
            bc.NB_CODICE_TRANSAZIONE,
            bc.NB_ENTRATA_RICORRENTE,
            bc.NB_TITOLO,    
            bc.macro_agg nb_macroaggregato,
            bc.NB_COFOG_II_LIVELLO,
            bc.NB_ID_PADRE,
            bc.NB_PRU,
            bc.CONTO_SANITA,
            bc.NB_FPV,
            bc.NB_capitolo_FPV,
            bc.FONDO,
            nvl(ftb.VARIAZIONE_COMPETENZA_PIU,0) vcompos,
            nvl(ftb.VARIAZIONE_COMPETENZA_MENO,0) vcomneg,
            nvl(ftb.VARIAZIONE_CASSA_PIU,0) vcaspos,
            nvl(ftb.VARIAZIONE_CASSA_MENO,0) vcasneg,
            nvl(ftb.ASSESTAMENTO_COMPETENZA_PIU,0) acompos,
            nvl(ftb.ASSESTAMENTO_COMPETENZA_MENO,0) acomneg,
            nvl(ftb.ASSESTAMENTO_CASSA_PIU,0) acaspos,
            nvl(ftb.ASSESTAMENTO_CASSA_MENO,0) acasneg,
            nvl(bc.liv1,'Da Def.') Missione,
            bc.desc_liv1 Desc_Missione,
            nvl(bc.liv2,'Da Def.') Programma,
            bc.desc_liv2 Desc_Programma,
            bc.desc_nb_titolo nb_desc_titolo,
            siope.descrizione descr_siope,
            bc.desc_pcf descr_pcf,
            bc.desc_macro_agg DESCR_MACRO_AGG,
            pi_ente,
            ftb.residuo_consuntivo,
            nvl(previsione_definitiva(p_anno,ftb.eu||ftb.articolo),0),
            nvl(cassa_definitiva(p_anno,ftb.eu||ftb.articolo),0),
            ftb.impegni_accertamenti_compe,
            ftb.mandati_reversali_compe,
            ftb.mandati_reversali_res,
            ftb.mandati_reversali_compe + ftb.mandati_reversali_res,
            0,
            nvl(previsione_definitiva(p_anno,ftb.eu||ftb.articolo),0) - ftb.impegni_accertamenti_compe,
            ftb.variazioni,
            ftb.residuo_consuntivo - ftb.mandati_reversali_res - ftb.variazioni,
            ftb.impegni_accertamenti_compe - ftb.mandati_reversali_compe,
            (ftb.residuo_consuntivo - ftb.mandati_reversali_res - ftb.variazioni) + (ftb.impegni_accertamenti_compe - ftb.mandati_reversali_compe),
            nvl(residuo_iniziale(p_anno,ftb.eu||ftb.articolo),0),
            nvl(previsione_definitiva(p_anno,ftb.eu||ftb.articolo),0) - ftb.impegni_accertamenti_compe - ftb.liquidato,
            calcola_fpv(p_anno,ftb.eu||ftb.articolo), --fpv_rendiconto
            ftb.variazioni,
            0,
            ftb.variazioni,
            ftb.residuo_consuntivo - ftb.mandati_reversali_res - ftb.variazioni,
            ftb.impegni_accertamenti_compe - ftb.mandati_reversali_compe,
            (ftb.residuo_consuntivo - ftb.mandati_reversali_res - ftb.variazioni) + (ftb.impegni_accertamenti_compe - ftb.mandati_reversali_compe),
            ftb.aiuti,
            ftb.entrate,
            ftb.avanzi,
            ftb.stato,
            ftb.unione_europea,
            ftb.regione,
            ftb.altri_soggetti,
            ftb.mutui,
            ftb.ALIENAZIONE_BENI_IMMOBILI
        from    fin_t_bilancio ftb,
                vw_nb_articoli bc,
                fin_v_bilancio_determine bd,
                fin_t_siope siope        
        where    
          ftb.anno = anno_fin and 
          ftb.eu= 'U' and
          bc.anno = ftb.anno and
          bc.eu||bc.codice =ftb.eu||ftb.articolo and
          bc.eu||bc.codice = nvl(p_capitolo,bc.eu||bc.codice) and
          bc.liv1 &lt;> '0' and
          nvl(bc.abilitato,'S') = 'S' and
          bd.anno = ftb.anno and
          bd.EU = ftb.eu and 
          bd.capitolo = ftb.articolo       
                and siope.eu(+)= bc.eu
                and siope.codice_bilancio(+) = bc.codice_bilancio_siope
                and siope.codice_gestionale(+) = bc.codice_gestionale_siope
                order by     bc.eu||bc.codice;


      commit;



 -- ********** FINE INSERT

  /*  Modifica 15/04/2014 Nicola Radogna
   Utilizzo tabella TMP_CONSUNTIVI per mostare stato avanzamento generazione consuntivi
   1- Lettura numero totale capitoli da processare
   2- Lettura nuovo id istanza genero consuntivo
   3- Inserimento in TMP_CONSUNTIVI */


      select count(*)
      into    wcapitoli_totali
      from    fin_t_consuntivo_excel     
      where    ANNO_CONSUNTIVO = anno_fin and
      tipo_capitolo = 'U' and
      utente = p_utente;



      begin
        select nvl(max(id),0)+1
        into wid
        from tmp_consuntivi;
        exception when no_data_found then wid := 0;
      end;



    insert into tmp_consuntivi (id, data, operazione, sessione, capitoli_processati, capitoli_totali, username) 
    values (wid, p_data_stampa, 'CONSUNTIVO_USCITE_'||UPPER(p_utente), to_char(v('APP_SESSION')), 0, wcapitoli_totali, p_utente);
    commit;

/* 15/04/2014 Fine modifica Nicola Radogna TMP_CONSUNTIVI */



-- 12/09/2012 mod Simone Bruno per inizializzazione variabili utilizzate per calcolo percentuale
   rindex := dbms_application_info.set_session_longops_nohint;
   w_context := to_char(v('APP_SESSION'));
   w_count := 0;


-- fine mod simone bruno

    begin 
      select nvl(disavanzo_amministrazione,0),
             nvl(disavanzo_regionale,0),
             (nvl(DISAVANZO_EFFETTIVO_ANNI_PREC,0) + nvl(variazione_disavanzo_piu,0) - nvl(variazione_disavanzo_meno,0)),
             cap_disavanzo_amm1,
             desc_cap_disavanzo_amm1,
             cap_disavanzo_amm2,
             desc_cap_disavanzo_amm2,
             partita_iva,
             data_atto_assestamento
     into c_disavanzo_amministrazione,
          c_disavanzo_regionale,
          c_disavanzo_eff_anni_prec,
          vcap_disavanzo_amm1,
          vdesc_cap_disavanzo_amm1,
          vcap_disavanzo_amm2,
          vdesc_cap_disavanzo_amm2,
          pi_ente,
          data_assestamento
     from fin_t_dati_generali
     where anno_finanziario = p_anno;
     exception when no_data_found 
         then c_disavanzo_amministrazione := 0;
              c_disavanzo_regionale := 0;
              c_disavanzo_eff_anni_prec := 0;
    end;

-- DISAVANZO EFFETTIVO ANNI PREC
    TIPO_capitolo
  if nvl(c_disavanzo_eff_anni_prec,0) &lt;> 0 
   then
    insert into fin_t_consuntivo_excel(
    ,ANNO_CONSUNTIVO
    ,CODICE_REGIONALE
    ,TITOLO
    ,CATEGORIA_MACROFO
    ,FUNZIONE_OBIETTIVO
    ,UPB
    ,capitolo
    ,DESC_capitolo
    ,PREVISIONI_DEFINITIVE_COMPE
    ,DATA_GENERAZIONE
    ,COD_MECC_UTILIZZATO
    ,NB_LIVELLO1
    ,DESC_NB_LIVELLO1
    ,NB_LIVELLO2
    ,DESC_NB_LIVELLO2
    ,NB_LIVELLO3
    ,DESC_NB_LIVELLO3
    ,UTENTE
    ,CF_PI_ENTE)
    values
    ('U'
    ,p_anno
    ,'17'
    ,'0'
    ,'00'
    ,'0001'
    ,'0001.01'
    ,vcap_disavanzo_amm1 -- '00003' f.coretti 13/06/2013
    ,vdesc_cap_disavanzo_amm1
    ,nvl(c_disavanzo_eff_anni_prec,0)
    ,p_data_stampa
    ,'XXXXXXXXXX'
    ,'0'
    ,c_desc_capitolo
    ,'0'
    ,c_desc_capitolo
    ,'0'
    ,c_desc_capitolo
    ,p_utente
    ,PI_ENTE);
    commit;
    end if;
-- FINE DISAVANZO


--inserisco il record del DISAVANZO EFFETIVO di AMMINISTRAZIONE (U00002)

  if (nvl(c_disavanzo_amministrazione,0) +  nvl(c_disavanzo_regionale,0)) > 0
    then 
    insert into fin_t_consuntivo_excel(
    TIPO_capitolo
    ,ANNO_CONSUNTIVO
    ,CODICE_REGIONALE
    ,TITOLO
    ,CATEGORIA_MACROFO
    ,FUNZIONE_OBIETTIVO
    ,UPB
    ,capitolo
    ,DESC_capitolo
    ,PREVISIONI_DEFINITIVE_COMPE
    ,DIFFERENZA_PREVCOMPE_IMPEGNI
    ,DATA_GENERAZIONE
    ,COD_MECC_UTILIZZATO
    ,NB_LIVELLO1
    ,DESC_NB_LIVELLO1
    ,NB_LIVELLO2
    ,DESC_NB_LIVELLO2
    ,NB_LIVELLO3
    ,DESC_NB_LIVELLO3
    ,UTENTE
    ,CF_PI_ENTE)
    values
    ('U'
    ,p_anno
    ,'17'
    ,'0'
    ,'00'
    ,'0001'
    ,'0001.01'
    ,vcap_disavanzo_amm2 -- '00003' f.coretti 13/06/2013
    ,vdesc_cap_disavanzo_amm2
    ,(nvl(c_disavanzo_amministrazione,0) +  nvl(c_disavanzo_regionale,0))
  --  ,(nvl(c_disavanzo_amministrazione,0) +  nvl(c_disavanzo_regionale,0))
    ,0 -- modifica richiesta da Emilia il 10.05.2013 
    ,p_data_stampa
    ,'XXXXXXXXXX'
    ,'0'
    ,c_desc_capitolo
    ,'0'
    ,c_desc_capitolo
    ,'0'
    ,c_desc_capitolo
    ,p_utente
    ,PI_ENTE);
    commit;
  end if;
-- fine DISAVANZO  



  FOR c IN (select capitolo from fin_t_consuntivo_excel where ANNO_CONSUNTIVO = anno_fin and TIPO_CAPITOLO = 'U' and UTENTE = p_utente and nb_livello1 &lt;> '0') loop--1 .. RigaCons.COUNT loop

      wcapitolo := 'U'||c.capitolo;


      -- determino composizione USCITE

          genero_documenti_bilancio.leggo_composizione_uscita
          (
           p_anno,
           wcapitolo,
           palienazione_beni,
           pfpv_fonte,
           pentrate_libere,
           pavanzo_vincolato,
           pstato,
           pue,
           pregione_vincolato,
           paltri_soggetti,
           pmutui,
           p_codice_risp,
           p_desc_risp
          );



      for corr in correttivi loop
         if corr.colonna_corr = 'c1' 
          then c1_corr := nvl(corr.correttivo,0);
          elsif corr.colonna_corr = 'c2' 
          then c2_corr := nvl(corr.correttivo,0);
          elsif corr.colonna_corr = 'c3' 
          then c3_corr := nvl(corr.correttivo,0);
          elsif corr.colonna_corr = 'c4' 
          then c4_corr := nvl(corr.correttivo,0);
          elsif corr.colonna_corr = 'c5' 
          then c5_corr := nvl(corr.correttivo,0);
          elsif corr.colonna_corr = 'c6' 
          then c6_corr := nvl(corr.correttivo,0);
          elsif corr.colonna_corr = 'c7' 
          then c7_corr := nvl(corr.correttivo,0);
          elsif corr.colonna_corr = 'c8' 
          then c8_corr := nvl(corr.correttivo,0);
          elsif corr.colonna_corr = 'c9' 
          then c9_corr := nvl(corr.correttivo,0);
          elsif corr.colonna_corr = 'c10' 
          then c10_corr := nvl(corr.correttivo,0);
          elsif corr.colonna_corr = 'c11' 
          then c11_corr := nvl(corr.correttivo,0);
          elsif corr.colonna_corr = 'c12' 
          then c12_corr := nvl(corr.correttivo,0);
          elsif corr.colonna_corr = 'c13' 
          then c13_corr := nvl(corr.correttivo,0);
        end if; 
      end loop;





      -- ******** RESIDUI INIZIALI **************

     select nvl(residuo_consuntivo,0) into c1
     from fin_t_bilancio

     where anno = anno_fin
     and eu||articolo = wcapitolo;

      /*  select nvl(sum(nvl(r.RESIDUO_INIZIALE,0)),0) into residui_iniziali
        from fin_t_impegni_residui r
        where r.ANNO_FINANZIARIO = p_anno
        and nvl(r.RESIDUO_INIZIALE,0) > 0
        and nvl(r.perenzione,'N') = 'N'
        and r.capitolo_spesa_corrente = wcapitolo;

        select nvl(sum(residuo_imp_data(d.doc_id,to_date('3112'||(p_anno - 1),'ddmmyyyy')) - nvl(d.closed_amount_proposed,0)),0) into residui_iniziali_per1
        from fin_t_impegni_residui r
        ,fin_t_documenti d
        where r.ANNO_FINANZIARIO = p_anno
        and nvl(r.perenzione,'N') = 'S'
        and r.capitolo_spesa_corrente = wcapitolo
        and d.doc_id = r.DOC_ID_IMPEGNO
        and (residuo_imp_data(d.doc_id,to_date('3112'||(p_anno - 1),'ddmmyyyy')) - nvl(d.closed_amount_proposed,0)) > 0;*/


       /* select nvl(sum(r.residuo_iniziale - (residuo_imp_data(d.doc_id,to_date('3112'||(p_anno - 1),'ddmmyyyy')) - nvl(d.closed_amount_proposed,0))),0) into residui_iniziali_per2
        from fin_t_impegni_residui r
        ,fin_t_documenti d
        where r.ANNO_FINANZIARIO = p_anno
        and nvl(r.perenzione,'N') = 'S'
        and r.capitolo_spesa_corrente = wcapitolo
        and d.doc_id = r.DOC_ID_IMPEGNO
        and (residuo_imp_data(d.doc_id,to_date('3112'||(p_anno - 1),'ddmmyyyy')) - nvl(d.closed_amount_proposed,0)) > 0;--= 0;*/

       /* select nvl(sum(nvl(r.RESIDUO_INIZIALE,0)),0) into residui_iniziali_per3
        from fin_t_impegni_residui r
        ,fin_t_documenti d
        where r.ANNO_FINANZIARIO = p_anno
        and nvl(r.perenzione,'N') = 'S'
        and r.capitolo_spesa_corrente = wcapitolo
        and d.doc_id = r.DOC_ID_IMPEGNO
        and (residuo_imp_data(d.doc_id,to_date('3112'||(p_anno - 1),'ddmmyyyy')) - nvl(d.closed_amount_proposed,0)) &lt; 0
        and r.RESIDUO_INIZIALE > 0; */

      -- ****************************************
      c1 := c1 + nvl(c1_corr,0); --+ residui_iniziali_per2 + residui_iniziali_per3

      -- ***** PRE_DEF COMPE e PRE_DEF CASSA *****
     -- gi‡ calcolate nella INSERT dalla Fin_t_bilancio
      begin
       select nvl(PREVISIONI_DEFINITIVE_COMPE,0)
              ,nvl(PREVISIONI_DEFINITIVE_CASSA,0)
       into c2,c3
       from fin_t_consuntivo_excel
       where anno_consuntivo = p_anno
       and tipo_capitolo||capitolo = wcapitolo
       and utente = p_utente;
      exception when no_data_found then c2 := 0; c3 := 0;
      end;


     -- c2 := nvl(previsione_definitiva(p_anno,wcapitolo),0) + nvl(c2_corr,0); --nvl(cap.previsione_competenza_capitoli,0) + nvl(v_compe_ini,0) + nvl(v_compe,0)
     -- c3 := nvl(cassa_definitiva(p_anno,wcapitolo),0) + nvl(c3_corr,0); --nvl(cap.previsione_cassa_capitoli,0) + nvl(v_cassa,0)

      -- ******************************************

      begin
       select nvl(fpv,0)
       into wfpv
       from fin_t_consuntivo_excel
       where anno_consuntivo = p_anno
       and tipo_capitolo||capitolo = wcapitolo
       and utente = p_utente;
      exception when no_data_found then wfpv := 0;
      end;

       -- FPV
      --fpv := calcola_fpv(p_anno, wcapitolo);
      -- FINE calcolo FPV

      -- ***** IMPEGNI COMPE ****************

      select nvl(sum(nvl(document_amount,0)),0) into c7
      from FIN_T_DOCUMENTI
      where doc_type in ('IMP','IMP-PER','IMP-DEF')
      and nvl(deletion_status_flag,'N') = 'N'
      and segment8 = p_anno
      and segment2 = wcapitolo
      and date_created &lt;= data_generazione;

      c7 := c7 + nvl(c7_corr,0);
      -- ************************************

      -- **** PAGAMENTI COMPE *******

      select nvl(sum(nvl(m.open_balance_proposed,0)),0) into c5
      from fin_t_documenti m
      ,fin_t_documenti i
      where m.doc_type = 'MAND'
      and nvl(m.open_balance_proposed,0) > 0
      and m.segment8 = p_anno
      and m.segment2 = wcapitolo
      and m.date_created &lt;= data_generazione
      and i.doc_id = m.doc_id_capo_filiera
      and i.segment8 = m.segment8;

      c5 := c5 + nvl(c5_corr,0);
      -- ****************************

      -- **** PAGAMENTI RES *******

      select nvl(sum(nvl(m.open_balance_proposed,0)),0) into c4
      from fin_t_documenti m
      ,fin_t_documenti i
      where m.doc_type = 'MAND'
      and nvl(m.open_balance_proposed,0) > 0
      and m.segment8 = p_anno
      and m.segment2 = wcapitolo
      and m.date_created &lt;= data_generazione
      and i.doc_id = m.doc_id_capo_filiera
      and i.segment8 &lt; m.segment8;

      c4 := c4 + nvl(c5_corr,0);
      -- ****************************


      -- *** VARIAZIONI RESIDUI *****

      select nvl(sum(nvl(d.document_amount,0)),0) into c10
      from fin_t_documenti d
      ,fin_t_documenti i
      where d.doc_type in ('ECO','DIS')
      and nvl(d.deletion_status_flag,'N') = 'N'
      and i.doc_id = d.previous_doc_id
      and d.segment8 = p_anno
      and d.segment2 = wcapitolo
      and d.date_created &lt;= data_generazione
      and to_char(nvl(i.data_perenzione,to_date('3112'||p_anno+1,'ddmmyyyy')),'yyyy') > p_anno;

      c10 := c10 + nvl(c10_corr,0);
      -- ****************************


        -- ***** PAGAMENTI TOTALI *****

      c6 := c4 + c5 + nvl(c6_corr,0);

      -- *****************************

      -- **** DIFF PRE_COMPE - IMPEGNI ****

      c8 := c2 - c7 + nvl(c8_corr,0);

      -- **********************************

      -- **** DIFF PRE_CASSA - MANDATI ****

      c9 := c3 - c6 + nvl(c9_corr,0);

      -- **********************************


      -- **** RIMANENZE RESIDUI *****

      c11 := c1 - c4 - c10 + nvl(c11_corr,0);

      -- ****************************

      -- **** RESIDUI COMPETENZA ****

      c12 := c7 - c5 + nvl(c12_corr,0);

      -- ****************************


      -- *** RESIDUI FINALI ***

      c13 := c11 + c12 + nvl(c13_corr,0);

      -- ***********************

      UPDATE fin_t_consuntivo_excel c
           SET 
                  c.RESIDUI_INIZIALI = c1,
                  c.PREVISIONI_DEFINITIVE_COMPE = c2,
                  c.PREVISIONI_DEFINITIVE_CASSA = c3,
                  c.ACCERTAMENTI_IMPEGNI_COMPE = c7,
                  c.RISCOSSIONI_PAGAMENTI_COMPE = c5,
                  c.RISCOSSIONI_PAGAMENTI_RES = c4,
                  c.RISCOSSIONI_PAGAMENTI_TOTALE = c6,
                  c.DIFFERENZA_PREVCOMPE_IMPEGNI = c8,
                  c.VARIAZIONE_RESIDUI = c10,
                  c.RIMANENZE_RESIDUI = c11,
                  c.RESIDUI_COMPETENZA = c12,
                  c.RESIDUI_FINALI = c13,
                  c.PREVISIONI_INIZIALI_COMPE  = nvl(previsione_iniziale(p_anno,wcapitolo),0),
                  c.PREVISIONI_INIZIALI_CASSA = nvl(cassa_iniziale(p_anno,wcapitolo),0),
                  c.PREVISIONI_INIZIALI_RES = nvl(residuo_iniziale(p_anno,wcapitolo),0),
                  c.ECONOMIE_COMPETENZA = (c2 - c7 - wfpv), 
                 -- c.FPV = nvl(fpv,0),
                  c.RIACCERTAMENTO_RESIDUI = c10 + nvl(c10_corr,0),
                  c.ELIMINAZIONE_PERENZIONE = 0,
                  c.TOTALE_VARIAZIONI_RESIDUI = c10, 
                  c.RES_PASS_PREC = c11,
                  c.RES_PASS_COMPE = c12,
                  c.TOT_RES_PASS_RIP  = (c11 + c12),
                  c.fpv_fonte = pfpv_fonte,
                  c.entrate_libere = pentrate_libere,
                  c.avanzo_vincolato = pavanzo_vincolato,
                  c.stato = pstato,
                  c.ue = pue,
                  c.REGIONE_VINCOLATO = pregione_vincolato,
                  c.ALTRI_SOGGETTI = paltri_soggetti,
                  c.MUTUI = pmutui,
                  c.ALIENAZIONE_BENI = palienazione_beni
      WHERE c.tipo_capitolo||c.capitolo = wcapitolo
      AND c.anno_consuntivo = anno_fin
      AND c.UTENTE = p_utente;
      commit;

  /*  per VERIFICHE
  insert into tmp_tabulati(utente,num_ord_riga,CAR01,num01,num02,num03,num04) values (p_utente,w_count,wcapitolo,c1,c2,c3,fpv);
  commit;
  */

  update tmp_consuntivi set capitoli_processati = capitoli_processati + 1 where id = wid;
  commit;

      -- 12/09/2012 mod Simone Bruno per calcolare percentuale avanzamento
          w_count := w_count + 1;
          dbms_application_info.set_session_longops(rindex, slno,'CONSUNTIVO_USCITE_' || UPPER(nvl(v('APP_USER'),USER)), NULL, 0, w_count, wcapitoli_totali, w_context, 'Avanzamento Rigenerazione Consuntivo Uscite');
      --    insert into aaa_test values (w_context, w_count || ' su ' || wcapitoli_totali); 
          commit;   
      -- fine mod Simone Bruno

  end loop;   
end;</pre>	</td></tr>
</table></div>