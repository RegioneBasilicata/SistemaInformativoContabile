<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>PERENTI_SUCCESSIVI</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="PERENTI_SUCCESSIVI.html">Details</a></div></div>
<div class="tab"><div><a href="PERENTI_SUCCESSIVI_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="PERENTI_SUCCESSIVI_References.html">References</a></div></div>
<div class="tab"><div><a href="PERENTI_SUCCESSIVI_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="PERENTI_SUCCESSIVI_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
PROCEDURE PERENTI_SUCCESSIVI 
(w_anno in out number, w_doc_id in out number, w_residuo_consuntivo in out number, w_man_rev_residui in out number) IS
doc_id_impegno number;
doc_id_storno_impegno number;
doc_id_mandato number;
pagamenti_successivi number(15,2);

cursor impegni is
select  distinct
nvl(jugd.document_amount,0) pv_importo_impegno,
to_number(to_char(jugd.date_created,'yyyy')) pv_anno_impegno,
jugd.doc_type pv_tipo_impegno,
jugd.previous_doc_id pv_ndp_impegno,
jugd.doc_id pv_doc_id_impegno
from
fina_documenti jugd
where
jugd.doc_type in ('IMP','IMP-PER','IMP-DEF')
and upper(nvl(jugd.proposal_status_flag,'B'))	&lt;> 'B'
and upper(nvl(jugd.deletion_status_flag,'N')) &lt;> 'Y'
and jugd.auditing_status_flag in ('T' ,'B')
and jugd.DOC_ID = w_doc_id;


cursor mandati is
SELECT
jugd.document_amount pv_importo_documento_mandato,
to_number(to_char(jugd.date_created,'yyyy'))	pv_anno_mandato,
jugd1.doc_id pv_numero_documento_liq,
jugd2.doc_id  pv_numero_documento_impegno,
jugd3.date_created pv_data_storno_mandato
FROM
fina_documenti jugd,
fina_documenti 		jugd1, /* liquidazione */
fina_documenti 		jugd2, /* impegno */
fina_documenti 		jugd3 /* movimento_storno */
WHERE
upper(jugd.doc_type) 					             																										= 'MAND' and
upper(nvl(jugd.proposal_status_flag,'Z'))||upper(nvl(jugd.auditing_status_flag,'Z')) ='PI' and
upper(nvl(jugd.deletion_status_flag,'N'))  &lt;> 'Y' 	and
to_number(to_char(jugd.date_created,'yyyy')) = w_anno	and
jugd.previous_doc_id = jugd1.doc_id and
jugd1.previous_doc_id = jugd2.doc_id and
jugd2.doc_id = doc_id_impegno and
jugd.doc_id = jugd3.previous_doc_id(+)	and
upper(jugd3.doc_type(+)) = 'ST-MAND' and
upper(nvl(jugd3.proposal_status_flag(+),'Z'))||upper(nvl(jugd3.auditing_status_flag(+),'Z')) ='PI';


BEGIN

pagamenti_successivi := 0;
for i in impegni loop
 doc_id_impegno := i.pv_doc_id_impegno;

-- calcolo mandati
 for m in mandati loop
 	if m.pv_data_storno_mandato is null
     then pagamenti_successivi := nvl(pagamenti_successivi,0)  + nvl(m.pv_importo_documento_mandato,0);
 end if;
 end loop;
-- fine calcolo mandati
end loop;
   w_residuo_consuntivo := nvl(w_residuo_consuntivo,0) + nvl(pagamenti_successivi,0);
   w_man_rev_residui := nvl(w_man_rev_residui,0) + nvl(pagamenti_successivi,0);

END; 
</pre>	</td></tr>
</table></div>