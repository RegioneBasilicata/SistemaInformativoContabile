<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>RISORSE_DESTINATE</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="RISORSE_DESTINATE.html">Details</a></div></div>
<div class="tab"><div><a href="RISORSE_DESTINATE_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="RISORSE_DESTINATE_References.html">References</a></div></div>
<div class="tab"><div><a href="RISORSE_DESTINATE_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="RISORSE_DESTINATE_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
procedure risorse_destinate(p_anno in number, p_utente in varchar2, p_ricalcolo in number) as
-- p_anno rapprenseta l'anno del Rendiconto
-- p_utente contiene il nome dell'utente che lancia la procedura 
-- p_ricalcolo è un flag numerico (0,1) che se = 1 comporta il ricalcolo della sola colonna RIS_DEST_31_12 come col f) = a+b-c-d-e


verifica_anno number := 0; -- variabile per verificare se ci sono dati in tabella per l'anno p_anno


	-- cursore che recupera i dati iniziali (se presenti) dell'anno p_anno
	cursor capitoli is
	select CAP_E
    ,DESC_CAP_E
    ,CAP_U
    ,DESC_CAP_U
    ,RIS_DEST_1_1
    ,ENTRATE_ESERCIZIO
    ,IMPEGNI_ESERCIZIO
    ,FPV_31_12
    ,CANC_RESIDUI
	from TB_RISORSE_DESTINATE
	where ANNO = p_anno;



BEGIN
-- verifica la presenza di dati per l'anno in p_anno, nel caso non ce ne fossero si procede con una INSERT dei dati dell'anno p_anno - 1
 select count(*) into verifica_anno
 from TB_RISORSE_DESTINATE
 where ANNO = p_anno;

 if verifica_anno = 0 --se verificata si fa una INSERT dai dati dell'anno (p_anno-1)
  then 
  insert into TB_RISORSE_DESTINATE (ANNO
  ,CAP_E
  ,DESC_CAP_E
  ,CAP_U
  ,DESC_CAP_U
  ,RIS_DEST_1_1
  ,ENTRATE_ESERCIZIO
  ,IMPEGNI_ESERCIZIO
  ,FPV_31_12
  ,CANC_RESIDUI
  ,RIS_DEST_31_12
  ,UTENTE)
    select p_anno
  ,CAP_E
  ,DESC_CAP_E
  ,CAP_U
  ,DESC_CAP_U
  ,RIS_DEST_1_1
  ,ENTRATE_ESERCIZIO
  ,IMPEGNI_ESERCIZIO
  ,FPV_31_12
  ,CANC_RESIDUI
  ,RIS_DEST_31_12
  ,p_utente
	from TB_RISORSE_DESTINATE
	where ANNO = p_anno-1;
  end if;

  if p_ricalcolo = 1 -- il calolo della colonna RIS_DEST_31_12 viene rieseguito solo se p_ricalcolo è = 1
  then
  for cap in capitoli loop
-- calcolo la colonna RIS_DEST_31_12 come col f) = a+b-c-d-e

     update TB_RISORSE_DESTINATE 
     set RIS_DEST_31_12 = 
     (
     nvl(cap.RIS_DEST_1_1,0) + nvl(cap.ENTRATE_ESERCIZIO,0) 
     - nvl(IMPEGNI_ESERCIZIO,0) - nvl(FPV_31_12,0) - nvl(CANC_RESIDUI,0) 
     )
     where anno = p_anno and cap_e = cap.cap_e and cap_u = cap.cap_u;
     commit;


  end loop; 
  end if;


END;</pre>	</td></tr>
</table></div>