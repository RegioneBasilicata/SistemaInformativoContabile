<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>RISORSE_VINCOLATE</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="RISORSE_VINCOLATE.html">Details</a></div></div>
<div class="tab"><div><a href="RISORSE_VINCOLATE_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="RISORSE_VINCOLATE_References.html">References</a></div></div>
<div class="tab"><div><a href="RISORSE_VINCOLATE_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="RISORSE_VINCOLATE_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
procedure risorse_vincolate(p_anno in number, p_utente in varchar2, p_ricalcolo in number) as

fpv_ini number := 0;
fpv_fin number := 0;
imp_fpv1 number(15,2) := 0;
canc_fpv1 number(15,2) := 0;
nuovo_fpv1 number := 0;
nuovo_fpv2 number := 0;
nuovo_fpv3 number := 0;
fpv_ricalcolato number := 0;

eco_compe number := 0;
eco_canc number := 0;

accertato number := 0;
impegnato number := 0;

utilizzo_attribute25 number := 0;
utilizzo_perenti number := 0;

p_perc_vincolo number := 0;


cursor ris is
select TIPO_VINCOLO
,CAP_E
,DESC_CAP_E
,CAP_U
,DESC_CAP_U
,nvl(RIS_VINC_0101,0) ris_vinc_0101
,nvl(ACCERTAMENTI,0) accertamenti
,nvl(IMPEGNI,0) impegni
,nvl(DISIMPEGNI,0) disimpegni
,nvl(ELIMINAZIONE,0) eliminazione
from tb_risorse_vincolate
where anno = p_anno;

cursor entrate is
select distinct cap_e
,sum(nvl(RIS_VINC_0101,0)) ris_vinc_0101
--,sum(nvl(impegni_compe(p_anno,cap_u),0) - nvl(impegni,0)) impegni_netti
from tb_risorse_vincolate
where anno = p_anno
and substr(nvl(cap_e,'X'),1,1) = 'E'
and length(nvl(cap_e,'X')) = 6
group by cap_e;


begin

-- aggiorno i valori di FPV_0101 e FPV_3112 per i capitoli già esistenti

    for r in ris loop
    
     if substr(r.cap_u,1,1) = 'U'
      then      
         --p_capitolo := r.cap_u;
         
         select 
       -- sum(nvl(t.col_a,0)) num01
        --,
        sum(nvl(t.col_b,0)) num02
        ,sum(nvl(t.col_x,0)) num03
        ,sum(nvl(t.col_d,0)) num05
        ,sum(nvl(t.col_e,0)) num06
        ,sum(nvl(t.col_f,0)) num07
        ,sum(nvl(t.col_g,0)) num08
        into 
      --  fpv_ini
       -- ,
        imp_fpv1
        ,canc_fpv1
        ,nuovo_fpv1
        ,nuovo_fpv2
        ,nuovo_fpv3
        ,fpv_fin
         from fin_t_rendiconto_fpv t
         where t.anno = p_anno
         and t.utente = p_utente
         and substr(t.capitolo,1,6) = substr(r.cap_u,1,6)
        ;
     -- having (sum(nvl(t.col_a,0))+sum(nvl(t.col_g,0))) > 0;
     -- exception when no_data_found then fpv_ini := 0; fpv_fin := 0; imp_fpv := 0; canc_fpv := 0; nuovo_fpv := 0;
     -- end;
     
  -- per il momento si accantona il calola sulla % di vincolo
   /*
      begin
      select perc into p_perc_vincolo
      from vm_vincoli_perc
      where anno = p_anno
      and capitolo_entrata = r.cap_e
      and capitolo_uscita = r.cap_u;
      exception when no_data_found then p_perc_vincolo := 100;
      end;
   */   
      begin
      select nvl(aiuti,0) into fpv_ini
      from fin_t_bilancio
      where anno = p_anno
      and eu||articolo = r.cap_u;
      exception when no_data_found then fpv_ini := 0;
      end;
      
      
     
     
     
     if p_ricalcolo = 1 
     then 
     impegnato := impegni_compe(p_anno,r.cap_u) + impegni_riacc(p_anno,r.cap_u) +impegni_plur(p_anno,r.cap_u);
     update tb_risorse_vincolate v set
      v.impegni_totali = impegnato
     ,v.impegni_perenti = impegni_perenti(p_anno,r.cap_u)
     ,v.impegni_riacc = impegni_riacc(p_anno,r.cap_u)
     ,v.impegni_plur = impegni_plur(p_anno,r.cap_u)
     ,v.perc_vincolo = p_perc_vincolo
     where v.cap_u = r.cap_u
     and v.anno = p_anno;
     commit;
     
     -- per il momento si accantona il calola sulla % di vincolo 
    /*
    if p_perc_vincolo > 0 and substr(nvl(r.CAP_E,'X'),1,1) = 'E'
    then
     update tb_risorse_vincolate v set
      v.accertamenti = round((p_perc_vincolo*nvl(accertamenti(p_anno,r.cap_e),0)/100),2)
     where v.cap_u = r.cap_u
     and v.anno = p_anno;
     commit;
    end if;
    */

    
    
    if fpv_ini > impegnato
     then impegnato := 0;
     else impegnato := impegnato - nvl(fpv_ini,0);
    end if;
    
   
     update tb_risorse_vincolate v set
     v.impegni = impegnato --PIERRO 04/02/2020 
     where v.cap_u = r.cap_u
     and v.anno = p_anno;
     commit;
   
       
     utilizzo_attribute25 := previsione_definitiva_segment9(p_anno,r.cap_u,'AV_REG') + previsione_definitiva_segment9(p_anno,r.cap_u,'AVANZO');
     
-- ******************************
-- da utlizzare se sarà necessario disambiguare per chiave contabile (quando sarà utilizzata a tappeto)
    /* select  nvl(sum(decode(substr(d.doc_type,7,3),'NEG',(d.document_amount * -1),d.document_amount)),0) into utilizzo_attribute25
     from fin_t_documenti d
     --,fin_t_chiavi_contabili_attrib c
     where d.segment8 = p_anno
     and d.segment2 = r.cap_u
     and d.segment9 in ('AV_REG','AVANZO')
     and d.doc_type in 
     ('B_COM_POS'
     ,'V_COM_POS'
     ,'A_COM_POS'
     ,'B_PL1_POS'
     ,'V_PL1_POS'
     ,'A_PL1_POS'
     ,'B_PL2_POS'
     ,'V_PL2_POS'
     ,'A_PL2_POS'
     ,'B_COM_NEG'
     ,'V_COM_NEG'
     ,'A_COM_NEG'
     ,'B_PL1_NEG'
     ,'V_PL1_NEG'
     ,'A_PL1_NEG'
     ,'B_PL2_NEG'
     ,'V_PL2_NEG'
     ,'A_PL2_NEG'
     )
     ;--and c.id = d.attribute25;
     */
-- ******************************
      
    utilizzo_perenti := previsione_definitiva_segment9(p_anno,r.cap_u,'AV_RP');
        
     if nvl(utilizzo_attribute25,0) + nvl(utilizzo_perenti,0) &lt;> 0
     then
         update tb_risorse_vincolate v set
         v.utilizzo_avanzo = nvl(utilizzo_attribute25,0)
         ,v.variazioni_perenti = nvl(utilizzo_perenti,0)
         where v.cap_u = nvl(r.cap_u,'X')
         and v.anno = p_anno;
         commit;
     end if;
     
    end if;
     

             -- *** cancellazione competenza *****
            select 
             nvl(sum(nvl(r.importo_riaccertamento,0)),0) into eco_compe
            from fin_t_documenti d
            ,vw_nb_articoli a
            ,fin_t_riaccertamenti r
            where d.segment8 = p_anno
            and d.DOC_TYPE like 'IMP%'
            and nvl(d.DELETION_STATUS_FLAG,'N') = 'N'
            and d.segment2 = substr(r.cap_u,1,6)
            and a.ANNO =d.segment8
            and a.eu||a.codice = d.segment2
            and r.anno_bilancio_riaccertamento = d.segment8+1
            and nvl(r.flag_elimina,'X') = 'R'
            and r.doc_id = d.doc_id;
            
            -- *** cancellazione per cancellati *****
            select 
            nvl(sum(nvl(x.importo_riaccertamento,0)),0)
            into eco_canc
            from fin_t_documenti d
            ,vw_nb_articoli a
            ,fin_t_riaccertamenti x
            where d.segment8 = p_anno
            and d.DOC_TYPE like 'IMP%'
            and d.segment2 = substr(r.cap_u,1,6)
            and nvl(d.DELETION_STATUS_FLAG,'N') = 'Y'
            and nvl(x.anno_bilancio_riaccertamento,9999) = d.segment8 + 1
            and x.DOC_ID = d.DOC_ID
            and nvl(x.flag_elimina,'X') = 'C' 
            and a.ANNO = x.anno_riaccertamento
            and a.eu||a.codice = x.capitolo;
 
          update tb_risorse_vincolate v set 
          v.fpv_0101 = fpv_ini
          ,v.FVP_3112 = nvl(nuovo_fpv1,0) + nvl(nuovo_fpv2,0)+ nvl(nuovo_fpv3,0) 
          ,v.NUOVO_FPV = nvl(nuovo_fpv1,0) + nvl(nuovo_fpv2,0)+ nvl(nuovo_fpv3,0)
          ,v.IMP_FPV = nvl(imp_fpv1,0)
          ,v.ECO_FPV = nvl(canc_fpv1,0)
          ,v.ELIMINAZIONE = (eco_compe+eco_canc)
         where v.anno = p_anno and v.cap_u = r.cap_u;
          commit;
     --    end if;
     end if;

     end loop;
     
-- inserisco i capitolo finanziati da FPV o con FPV finale non presenti sulla TB_RISORSE_VINCOLATE

-- ****************** NOTA OPERATIVA per compilare la TABELLA *********
/*
se con la colonna FPV 31/12 nella colonna RISORSE VINCOLATE al 31/12 abbiamo un valore negativo vanno compensati prima 
con gli impegni sul vecchio avanzo e in caso di ulteriore valore negativo occorre inserire la differenza a pareggio nella colonna ACCERTAMENTI
*/
-- ********************************************************************
 -- prima ridetermino gli Accertamenti secondo il calcolo fornito da Sarli il 21/02/2019
 -- ACC(ric) = ACC - (Impegni TOTALI su tutti i capitoli collegati) - (Impegni coperti da AVANZO su tutti i capitoli collegati)


 if p_ricalcolo = 1
 then
  for e in entrate loop
 
   update tb_risorse_vincolate v set v.accertamenti = accertamenti_compe(p_anno,e.cap_e) + accertamenti_plur(p_anno,e.cap_e) + accertamenti_riacc(p_anno,e.cap_e)--to_number(decode(sign(accertamenti_compe(p_anno,e.cap_e) - e.impegni_netti),-1,0,(accertamenti_compe(p_anno,e.cap_e) - e.impegni_netti)))
   where v.anno = p_anno
   and nvl(v.cap_e,'X') = e.cap_e;
   commit;
 
  end loop;
  
 end if;

 
 update tb_risorse_vincolate set ris_vinc_3112 = 
 (  
    nvl(RIS_VINC_0101,0)
    +
    --NVL(UTILIZZO_ACCANTON,0) --  nvl(FPV_0101,0)
   -- +
    (nvl(ACCERTAMENTI,0)
    +
    nvl(DISIMPEGNI,0)
    -- NVL(ECO_FPV,0)) +
    - 
    nvl(IMPEGNI,0)
    - 
    nvl(FVP_3112,0)
    -   
    nvl(ELIMINAZIONE,0)
    )),
    ris_vinc_3112_bil = 
   (  
    NVL(UTILIZZO_ACCANTON,0) --  nvl(FPV_0101,0)
    +
    (nvl(ACCERTAMENTI,0)
    +
    nvl(DISIMPEGNI,0)
    -- NVL(ECO_FPV,0)) +
    - 
    nvl(IMPEGNI,0)
    - 
    nvl(FVP_3112,0)
    -   
    nvl(ELIMINAZIONE,0)
    ))
    ,
    acc_e_trasf = (nvl(ACCERTAMENTI,0)+
    nvl(DISIMPEGNI,0))

   where 
   anno = p_anno;
 commit;

end;</pre>	</td></tr>
</table></div>