<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>SPU29_E</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="SPU29_E.html">Details</a></div></div>
<div class="tab"><div><a href="SPU29_E_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="SPU29_E_References.html">References</a></div></div>
<div class="tab"><div><a href="SPU29_E_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="SPU29_E_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
procedure      SPU29_E(p_anno in number) is
-- f.coretti 10/05/2013
-- ho cambiato il nome della variabile maggiori_incassi in vmaggiori_incassi, perchè dopo aver cambiato gat2.maggiori_incassi in maggiori_incassi, atto dovuto,
-- nella creazione su parcomurgia c'era errore dato dalla confusione tra nome variabile e nome procedura

somme_riscosse number(15,2):=0;
insussistenze number(15,2):=0;
maggiori_incassi number(15,2):=0;
residui_da_riportare number(15,2):=0;
anno number;

cursor residui is
select	distinct
 	to_number(to_char(res.data_accertamento,'yyyy')) 	anno_acc,
	res.CAPITOLO_SPESA_CORRENTE			codice_capitolo_e_stampa,
	res.capitolo_spesa_originario		codice_capitolo_e,
	cap.descrizione             descr_cap_e,
    nvl(res.residuo_iniziale,0) residuo_iniziale,
    res.doc_id_accertamento  doc_id_acc
from	fin_t_accertamenti_residui res,    
	fina_articoli            cap 
where	res.anno_finanziario = p_anno and
        res.residuo_iniziale > 0 and
	    cap.anno = res.anno_finanziario and
		cap.eu||cap.codice = res.CAPITOLO_SPESA_CORRENTE
order by to_number(to_char(res.data_accertamento,'yyyy')),res.CAPITOLO_SPESA_CORRENTE;

begin
delete fin_t_spu29 where anno = p_anno and eu='E';
commit;
anno := p_anno;
for res in residui loop
 
  select nvl(sum(nvl(m.open_balance_proposed,0)),0) into somme_riscosse
  from fin_t_documenti m
  where m.segment8 = p_anno
  and m.doc_type = 'REV'
  and m.previous_doc_id = res.doc_id_acc
  and nvl(m.open_balance_proposed,0) > 0;
 
  select nvl(sum(nvl(m.document_amount,0)),0) into insussistenze
  from fin_t_documenti m
  where m.segment8 = p_anno
  and m.doc_type = 'INSUS'
  and m.previous_doc_id = res.doc_id_acc
  and nvl(m.deletion_status_flag,'N') = 'N';
 
  select -nvl(sum(residuo_acc_data(d.doc_id_accertamento,to_date('3112'||d.anno_finanziario,'ddmmyyyy'))),0) into maggiori_incassi
   from fin_t_accertamenti_residui d
   where d.doc_id_accertamento = res.doc_id_acc
   and d.anno_finanziario = p_anno
   and residuo_acc_data(d.doc_id_accertamento,to_date('3112'||d.anno_finanziario,'ddmmyyyy')) &lt; 0;
   
 residui_da_riportare := res.residuo_iniziale + maggiori_incassi - somme_riscosse - insussistenze;-- ; al momento lo togliamo perchè è una condizione non verificata in Regione
 
 insert into fin_t_spu29(ANNO,ANNO_RESIDUO,EU,CAPITOLO,DESCRIZIONE,RESIDUI_INIZIALI,SOMME_RISC_PAGATE,INSUSS_DIS_ECO,MAGG_ACC_PERENZIONE,RESIDUI_DA_RIPORTARE,DOC_ID) 
 values (p_anno,res.anno_acc,'E',res.codice_capitolo_e_stampa,res.descr_cap_e,res.residuo_iniziale,somme_riscosse,insussistenze,maggiori_incassi,residui_da_riportare,res.doc_id_acc);
 commit;
 
somme_riscosse :=0;
insussistenze :=0;
maggiori_incassi :=0;
residui_da_riportare :=0;
end loop;

-- ***** UPDATE per Vincoli *****
	update fin_t_spu29 r set r.CAPITOLI_VINCOLATI = 
		(SELECT LISTAGG(capitolo_uscita, ' - ') WITHIN GROUP (ORDER BY capitolo_uscita)
        FROM VW_VINCOLI_DEFINITIVI
        where anno = p_anno
        and 'E'||capitolo_entrata = r.capitolo)
        where r.anno = p_anno and substr(r.capitolo,1,1) = 'E';
    commit;
		
	-- ********

end;</pre>	</td></tr>
</table></div>