<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>SPU29_U</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="SPU29_U.html">Details</a></div></div>
<div class="tab"><div><a href="SPU29_U_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="SPU29_U_References.html">References</a></div></div>
<div class="tab"><div><a href="SPU29_U_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="SPU29_U_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
PROCEDURE      SPU29_U(p_anno in number) is

somme_pagate number(15,2):=0;
dis_eco number(15,2):=0;
perenzione number(15,2):=0;
residui_da_riportare number(15,2):=0;
anno number;

cursor residui is
select    distinct
    to_char(res.DATA_IMPEGNO,'yyyy')    anno_imp,
   res.CAPITOLO_SPESA_CORRENTE         codice_capitolo_u_stampa,
   res.CAPITOLO_SPESA_ORIGINARIO               codice_capitolo_u,
    cap.descrizione                        descr_cap_u,
    res.DOC_ID_IMPEGNO doc_id_imp
    ,nvl(res.residuo_iniziale,0) residuo_iniziale
from                                                                
    fina_articoli                cap,
    fin_t_impegni_residui res
where     res.anno_finanziario = p_anno and
        res.residuo_iniziale > 0 and
        nvl(res.perenzione,'X') = 'N' and
        cap.anno = p_anno and
    cap.eu||cap.codice = res.CAPITOLO_SPESA_CORRENTE 
order by to_char(res.DATA_IMPEGNO,'yyyy');

begin
 if p_anno &lt; 2017
  then SPU29_U_OLD(p_anno);
 else

delete fin_t_spu29 where anno = p_anno and eu='U';
commit;
anno := p_anno;
 for res in residui loop

  select nvl(sum(nvl(m.open_balance_proposed,0)),0) into somme_pagate
  from fin_t_documenti m
  where m.segment8 = p_anno
  and m.doc_type = 'MAND'
  and m.doc_id_capo_filiera = res.doc_id_imp
  and nvl(m.open_balance_proposed,0) > 0;

  perenzione := 0; -- dal 2015 la perenzione non è più utilizzata

  select nvl(sum(nvl(e.document_amount,0)),0) into dis_eco
  from fin_t_documenti e
  where e.segment8 = p_anno
  and e.doc_type in ('ECO','DIS')
  and e.previous_doc_id = res.doc_id_imp
  and nvl(e.deletion_status_flag,'N') = 'N';

  residui_da_riportare := res.residuo_iniziale - somme_pagate - dis_eco - perenzione;

  insert into fin_t_spu29 (ANNO,ANNO_RESIDUO,EU,CAPITOLO,DESCRIZIONE,RESIDUI_INIZIALI,SOMME_RISC_PAGATE,INSUSS_DIS_ECO,MAGG_ACC_PERENZIONE,RESIDUI_DA_RIPORTARE,DOC_ID)
  values (p_anno,res.anno_imp,'U',res.codice_capitolo_u_stampa,res.descr_cap_u,res.residuo_iniziale,somme_pagate,dis_eco,perenzione,residui_da_riportare,res.doc_id_imp);
  commit;

 end loop;

-- ***** UPDATE per Vincoli *****
	update fin_t_spu29 r set r.CAPITOLI_VINCOLATI = 
		(SELECT LISTAGG('E'||capitolo_entrata, ' - ') WITHIN GROUP (ORDER BY 'E'||capitolo_entrata)
        FROM VW_VINCOLI_DEFINITIVI
        where anno = p_anno
        and capitolo_uscita = r.capitolo)
        where r.anno = p_anno and substr(r.capitolo,1,1) = 'U';
    commit;

	-- ********
    end if;
end;</pre>	</td></tr>
</table></div>