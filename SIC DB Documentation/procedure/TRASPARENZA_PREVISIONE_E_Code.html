<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>TRASPARENZA_PREVISIONE_E</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="TRASPARENZA_PREVISIONE_E.html">Details</a></div></div>
<div class="tab"><div><a href="TRASPARENZA_PREVISIONE_E_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="TRASPARENZA_PREVISIONE_E_References.html">References</a></div></div>
<div class="tab"><div><a href="TRASPARENZA_PREVISIONE_E_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="TRASPARENZA_PREVISIONE_E_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
procedure trasparenza_previsione_e (panno in number, pplur in number) as

riga number;
vanno number;
vplur number;

vutente varchar2(100);
cambio_titolo varchar2(10);
cambio_titolo_desc varchar2(1000);

tot_titolo_competenza number(15,2);
tot_titolo_competenza_sanita number(15,2);
tot_titolo_cassa number(15,2);
tot_titolo_cassa_sanita number(15,2);

tot_titoli_competenza number(15,2):=0;
tot_titoli_competenza_sanita number(15,2):=0;
tot_titoli_cassa number(15,2):=0;
tot_titoli_cassa_sanita number(15,2):=0;

tot_finale_competenza number(15,2);
tot_finale_competenza_sanita number(15,2);
tot_finale_cassa number(15,2);
tot_finale_cassa_sanita number(15,2);


cursor entrate_previsionali is
select
 anno
,substr(etitolo_umissione,1,1) titolo
,desc_titolo_missione desc_titolo
,substr(etipologia_uprogramma,1,5) tipologia
,desc_tipologia_programma desc_tipologia
,nvl(sum(decode(nvl(sanita,'N'),'N',decode(vplur,anno,nvl(competenza_anno0,0),anno+1,nvl(competenza_anno1,0),nvl(competenza_anno2,0)))),0) competenza
,nvl(sum(decode(nvl(sanita,'N'),'S',decode(vplur,anno,nvl(competenza_anno0,0),anno+1,nvl(competenza_anno1,0),nvl(competenza_anno2,0)))),0) competenza_sanita
,nvl(sum(decode(nvl(sanita,'N'),'N',decode(vplur,anno,nvl(cassa_anno0,0),0))),0) cassa
,nvl(sum(decode(nvl(sanita,'N'),'S',decode(vplur,anno,nvl(cassa_anno0,0),0))),0) cassa_sanita
,utente
from fin_t_previsione
where anno = vanno
and utente='PREV'||anno
and eu='E'
and etipologia_uprogramma not in ('E00004','E00005')
group by anno
,utente
,substr(etitolo_umissione,1,1)
,desc_titolo_missione
,substr(etipologia_uprogramma,1,5)
,desc_tipologia_programma
,sanita
order by 2,4;--eliminato order by 3

begin

 delete tmp_tabulati where car04 = 'ENTRATE_PREVISIONALI';
 commit;

 cambio_titolo := '0';
 cambio_titolo_desc := null;

 riga:=0;
 tot_finale_competenza :=0;
 tot_finale_competenza_sanita:=0;
 tot_finale_cassa:=0;
 tot_finale_cassa_sanita:=0;
 vanno :=panno;
 vplur :=pplur;


 for a in entrate_previsionali loop
  vutente := a.utente;

  if a.titolo &lt;> cambio_titolo
     then
--scrivo totali per titolo     
     riga:=riga+1;
     insert into tmp_tabulati
     (UTENTE
     ,NUM_ORD_RIGA
     ,CAR01
     ,CAR02
     ,CAR03
     ,CAR04
     ,NUM01
     ,NUM02
     ,NUM03
     ,NUM04
     ,NUM05)
     values 
     (vutente
     ,riga
     ,'T'
     ,cambio_titolo||'0000'
     ,'Totale TITOLO '||cambio_titolo||':'||cambio_titolo_desc
     ,'ENTRATE_PREVISIONALI'
     ,vanno+vplur
     ,tot_titolo_competenza
     ,tot_titolo_competenza_sanita
     ,tot_titolo_cassa
     ,tot_titolo_cassa_sanita);

-- azzero totali     
     tot_titolo_competenza :=0;
     tot_titolo_competenza_sanita:=0;
     tot_titolo_cassa:=0;
     tot_titolo_cassa_sanita:=0;

-- inserisco testata nuovo titolo
     riga:=riga+1;
     cambio_titolo := a.titolo;
     cambio_titolo_desc := a.desc_titolo;

     insert into tmp_tabulati
     (UTENTE
     ,NUM_ORD_RIGA
     ,CAR01
     ,CAR02
     ,CAR03
     ,CAR04
     ,NUM01
     ,NUM02
     ,NUM03
     ,NUM04
     ,NUM05)
     values 
     (vutente
     ,riga
     ,'T'
     ,'TITOLO '||cambio_titolo
     ,cambio_titolo_desc
     ,'ENTRATE_PREVISIONALI'
     ,vanno+vplur
     ,null
     ,null
     ,null
     ,null);
  end if;

-- inserisco rigo_dettaglio
  riga:=riga+1;

  insert into tmp_tabulati
  (UTENTE
  ,NUM_ORD_RIGA
  ,CAR01
  ,CAR02
  ,CAR03
  ,CAR04
  ,NUM01
  ,NUM02
  ,NUM03
  ,NUM04
  ,NUM05)
  values 
  (vutente
  ,riga
  ,'D'
  ,a.tipologia
  ,decode(a.tipologia,'E0000',a.desc_tipologia,'Tipologia '||substr(a.tipologia,3)||': '||a.desc_tipologia)
  ,'ENTRATE_PREVISIONALI'
  ,vanno+vplur
  ,a.competenza
  ,a.competenza_sanita
  ,a.cassa
  ,a.cassa_sanita);

-- totalizzo per titolo  
  tot_titolo_competenza := tot_titolo_competenza + a.competenza;
  tot_titolo_competenza_sanita := tot_titolo_competenza_sanita + a.competenza_sanita;
  tot_titolo_cassa  := tot_titolo_cassa + a.cassa;
  tot_titolo_cassa_sanita := tot_titolo_cassa_sanita + a.cassa_sanita;

-- totalizzo per titoli complessivi  
  if a.titolo &lt;> '0'
     then
     tot_titoli_competenza := tot_titoli_competenza + a.competenza;
     tot_titoli_competenza_sanita := tot_titoli_competenza_sanita + a.competenza_sanita;
     tot_titoli_cassa  := tot_titoli_cassa + a.cassa;
     tot_titoli_cassa_sanita := tot_titoli_cassa_sanita + a.cassa_sanita;
     
  end if;

-- totalizzo per finale  
  tot_finale_competenza := tot_finale_competenza + a.competenza;
  tot_finale_competenza_sanita := tot_finale_competenza_sanita + a.competenza_sanita;
  tot_finale_cassa  := tot_finale_cassa + a.cassa;
  tot_finale_cassa_sanita := tot_finale_cassa_sanita + a.cassa_sanita;

 COMMIT;    

 end loop;

-- inserisco ultimo totale titolo.
 riga:=riga+1;
 insert into tmp_tabulati
 (UTENTE
 ,NUM_ORD_RIGA
 ,CAR01
 ,CAR02
 ,CAR03
 ,CAR04
 ,NUM01
 ,NUM02
 ,NUM03
 ,NUM04
 ,NUM05)
 values 
 (vutente
 ,riga
 ,'T'
 ,cambio_titolo||'0000'
 ,'Totale TITOLO '||cambio_titolo||':'||cambio_titolo_desc
 ,'ENTRATE_PREVISIONALI'
 ,vanno+vplur
 ,tot_titolo_competenza
 ,tot_titolo_competenza_sanita
 ,tot_titolo_cassa
 ,tot_titolo_cassa_sanita);


-- inserisco totale complessivo titoli
 riga:=riga+1;
 insert into tmp_tabulati
 (UTENTE
 ,NUM_ORD_RIGA
 ,CAR01
 ,CAR02
 ,CAR03
 ,CAR04
 ,NUM01
 ,NUM02
 ,NUM03
 ,NUM04
 ,NUM05)
 values 
 (vutente
 ,riga
 ,'T'
 ,'T'
 ,'TOTALE TITOLI'
 ,'ENTRATE_PREVISIONALI'
 ,vanno+vplur
 ,tot_titoli_competenza
 ,tot_titoli_competenza_sanita
 ,tot_titoli_cassa
 ,tot_titoli_cassa_sanita);


-- inserisco totale finale
 riga:=riga+1;
 insert into tmp_tabulati
 (UTENTE
 ,NUM_ORD_RIGA
 ,CAR01
 ,CAR02
 ,CAR03
 ,CAR04
 ,NUM01
 ,NUM02
 ,NUM03
 ,NUM04
 ,NUM05)
 values 
 (vutente
 ,riga
 ,'T'
 ,'T'
 ,'TOTALE GENERALE DELLE ENTRATE'
 ,'ENTRATE_PREVISIONALI'
 ,vanno+vplur
 ,tot_finale_competenza
 ,tot_finale_competenza_sanita
 ,tot_finale_cassa
 ,tot_finale_cassa_sanita);

commit;

end;</pre>	</td></tr>
</table></div>