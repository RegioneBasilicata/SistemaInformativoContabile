<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>U_MOVIMENTI_COMPETENZA_DETT</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="U_MOVIMENTI_COMPETENZA_DETT.html">Details</a></div></div>
<div class="tab"><div><a href="U_MOVIMENTI_COMPETENZA_DETT_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="U_MOVIMENTI_COMPETENZA_DETT_References.html">References</a></div></div>
<div class="tab"><div><a href="U_MOVIMENTI_COMPETENZA_DETT_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="U_MOVIMENTI_COMPETENZA_DETT_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
PROCEDURE U_MOVIMENTI_COMPETENZA_DETT
(w_anno in number,
w_capitolo in varchar,
w_uff in varchar2,
w_dipartimento in varchar2,
w_data_creazione in date) IS
doc_id_impegno number;
doc_id_storno_impegno number;
doc_id_mandato number;
pagamenti_competenza number(15,2);

totale_correzione_storno_imp number(15,2);
totale_storno_impegni number(15,2);

w_imp_acc_competenza number(15,2) := 0;
w_man_rev_competenza number(15,2) := 0;
conta_imp number := 0;

cursor impegni is
select distinct
nvl(jugd.document_amount,0)  r_importo_impegno,
to_number(to_char(jugd.date_created,'yyyy')) 	r_anno_impegno,
jugd.doc_type  r_tipo_impegno,
substr(bi.ind_cap,1,6) r_capitolo_spesa,
jugd.previous_doc_id r_ndp_impegno,
jugd.doc_id r_doc_id_impegno,
jugd.doc_sequence_value r_numero_doc,
jugd.description r_oggetto_doc
from
fina_documenti jugd,
bas_ind bi
where
jugd.doc_type in ('IMP','IMP-PER','IMP-DEF')
and upper(nvl(jugd.deletion_status_flag,'N')) &lt;> 'Y'
and upper(nvl(jugd.proposal_status_flag,'Z'))||upper(nvl(jugd.auditing_status_flag,'Z'))='PI'
and jugd.gl_date is not null
and jugd.period_name is not null
and jugd.date_created is not null
and jugd.segment8 = w_anno
and jugd.date_created &lt;= w_data_creazione
and decode(nvl(w_UFF,'N'),'S',decode(jugd.segment3
,null,'NA',jugd.segment3),'N',decode(jugd.segment3
,null,decode(jugd.attribute39,null,'NA',jugd.attribute39)
,'NA',decode(jugd.attribute39,null,'NA',jugd.attribute39)
,substr(jugd.segment3,1,2))) = nvl(w_dipartimento,'NA')
AND bi.ind_cap = w_capitolo
and bi.doc_id = jugd.doc_id
and bi.ind_anno = w_anno
UNION
-- PRENDO TUTTI GLI IMPEGNI IN PERENZIONE DOPO L'ANNO DI INTERROGAZIONE
select distinct
nvl(jugd.document_amount,0)  r_importo_impegno,
to_number(to_char(jugd.date_created,'yyyy')) r_anno_impegno,
jugd.doc_type  r_tipo_impegno,
substr(bi.ind_cap,1,6)	 r_capitolo_spesa,
jugd.previous_doc_id r_ndp_impegno,
jugd.doc_id r_doc_id_impegno,
jugd.doc_sequence_value r_numero_doc,
jugd.description r_oggetto_doc
from
fina_documenti  jugd,
bas_ind  bi
where
jugd.doc_type in ('IMP','IMP-DEF')
and upper(nvl(jugd.proposal_status_flag,'B'))	&lt;> 'B'
and upper(nvl(jugd.deletion_status_flag,'N')) &lt;> 'Y'
and jugd.auditing_status_flag in ('T' ,'B')
and jugd.gl_date is not null
and jugd.period_name is not null
and jugd.date_created is not null
and decode(nvl(w_UFF,'N'),'S',decode(jugd.segment3
,null,'NA',jugd.segment3),'N',decode(jugd.segment3
,null,decode(jugd.attribute39,null,'NA',jugd.attribute39)
,'NA',decode(jugd.attribute39,null,'NA',jugd.attribute39)
,substr(jugd.segment3,1,2))) = nvl(w_dipartimento,'NA')
and bi.doc_id = jugd.doc_id
and bi.ind_anno = w_anno
and jugd.segment8 = w_anno
and jugd.date_created &lt;= w_data_creazione
AND substr(bi.ind_cap,1,6) = w_capitolo
and to_char(jugd.data_perenzione,'yyyy') >  to_char(w_anno);


cursor mandati is
SELECT
jugd.document_amount r_importo_documento_mandato,
to_number(to_char(jugd.date_created,'yyyy')) r_anno_mandato,
jugd1.doc_id r_numero_documento_liq,
jugd2.doc_id r_numero_documento_impegno,
jugd3.date_created r_data_storno_mandato
FROM
fina_documenti 		jugd,
fina_documenti 		jugd1, /* liquidazione */
fina_documenti 		jugd2, /* impegno */
fina_documenti 		jugd3 /* movimento_storno */
WHERE
upper(jugd.doc_type) = 'MAND' and
upper(nvl(jugd.proposal_status_flag,'Z'))||upper(nvl(jugd.auditing_status_flag,'Z'))	='PI' and
upper(nvl(jugd.deletion_status_flag,'N')) &lt;> 'Y' and
jugd.segment8 = w_anno and
jugd.date_created &lt;= w_data_creazione and
jugd.previous_doc_id = jugd1.doc_id and
jugd1.previous_doc_id = jugd2.doc_id and
jugd2.doc_id = doc_id_impegno and
jugd.doc_id = jugd3.previous_doc_id(+) and
upper(jugd3.doc_type(+)) = 'ST-MAND' and
upper(nvl(jugd3.proposal_status_flag(+),'Z'))||upper(nvl(jugd3.auditing_status_flag(+),'Z'))	='PI';

cursor storno_impegni is
SELECT
jugd2.doc_id r_doc_id_storno,
upper(jugd2.doc_type) r_tipo_storno_imp,
nvl(jugd2.document_amount,0) r_importo_storno_imp,
jugd2.previous_doc_id r_ndp_storno
FROM
fina_documenti jugd2
WHERE
upper(jugd2.doc_type) in ('ST-IMP','ST-IMPDEF','ECO','DIS') 	and
upper(nvl(jugd2.proposal_status_flag,'Z'))||upper(nvl(jugd2.auditing_status_flag,'Z'))	='PI' and
upper(nvl(jugd2.deletion_status_flag,'N'))  &lt;> 'Y' 	and
jugd2.gl_date  is not null and
jugd2.period_name is not null and
jugd2.date_created is not null	and
jugd2.segment8 = w_anno and
jugd2.date_created &lt;= w_data_creazione and
jugd2.previous_doc_id = doc_id_impegno;


cursor corr_storno_impegni is
SELECT
jugd2.doc_id r_doc_id_storno_corr,
upper(jugd2.doc_type) r_tipo_storno_corr,
nvl(jugd2.document_amount,0) r_importo_storno_corr,
jugd2.previous_doc_id r_ndp_storno_corr
FROM
fina_documenti jugd2
WHERE
upper(jugd2.doc_type) in ('CORR','CORR-DIS') 		and
upper(nvl(jugd2.proposal_status_flag,'Z'))||upper(nvl(jugd2.auditing_status_flag,'Z'))	='PI' and
upper(nvl(jugd2.deletion_status_flag,'N')) &lt;> 'Y' and
jugd2.gl_date is not null and
jugd2.period_name is not null and
jugd2.date_created  is not null	and
jugd2.segment8 = w_anno and
jugd2.date_created &lt;= w_data_creazione and
jugd2.previous_doc_id = doc_id_storno_impegno;

BEGIN

for i in impegni loop
 doc_id_impegno := nvl(i.r_doc_id_impegno,0);
  -- calcolo mandati
 pagamenti_competenza := 0;
 if  doc_id_impegno > 0
 then
 for m in mandati loop
 	if m.r_data_storno_mandato is null
     then pagamenti_competenza := pagamenti_competenza + nvl(m.r_importo_documento_mandato,0);
  end if;
 end loop;
-- fine calcolo mandati

-- calcolo storno impegni
 totale_storno_impegni := 0;

 for si in storno_impegni loop

-- calcolo correzione storni impegni
  doc_id_storno_impegno := si.r_doc_id_storno;
  totale_correzione_storno_imp := 0;

  for csi in corr_storno_impegni loop
    totale_correzione_storno_imp := totale_correzione_storno_imp + nvl(csi.r_importo_storno_corr,0);
  end loop;
-- fine calcolo correzione storni impegni

  totale_storno_impegni := totale_storno_impegni + (nvl(si.r_importo_storno_imp,0) - nvl(totale_correzione_storno_imp,0));
 end loop;
 totale_correzione_storno_imp := 0;
-- fine calcolo storni impegni

  w_imp_acc_competenza := nvl(w_imp_acc_competenza,0) + (nvl(i.r_importo_impegno,0) - nvl(totale_storno_impegni,0));
  w_man_rev_competenza := nvl(w_man_rev_competenza,0) + nvl(pagamenti_competenza,0);

if (w_imp_acc_competenza - w_man_rev_competenza) > 0
  then
     select count(numero_doc) into conta_imp
     from TMP_ANZIANITA_RESIDUI_DETT
     where ANNO = w_anno
     and CAPITOLO = w_capitolo
     and TIPO_DOC = i.r_tipo_impegno
     and NUMERO_DOC = i.r_numero_doc;
 
     if conta_imp > 0
     then 
     update TMP_ANZIANITA_RESIDUI_DETT set RES_CORRENTI = (w_imp_acc_competenza - w_man_rev_competenza)
     where ANNO = w_anno
     and CAPITOLO = w_capitolo
     and TIPO_DOC = i.r_tipo_impegno
     and NUMERO_DOC = i.r_numero_doc;
     commit;
     else 
     insert into TMP_ANZIANITA_RESIDUI_DETT(ANNO
    ,CAPITOLO
    ,TIPO_DOC
    ,NUMERO_DOC
    ,OGGETTO_DOC
    ,RES_CORRENTI
    ,UFFICIO
    )
    values
    (w_anno,w_capitolo,i.r_tipo_impegno,i.r_numero_doc,i.r_oggetto_doc
    ,(w_imp_acc_competenza - w_man_rev_competenza)
    ,w_dipartimento);
    commit; 
    end if;
    pagamenti_competenza := 0;
    totale_storno_impegni := 0;
    w_imp_acc_competenza := 0;
    w_man_rev_competenza := 0;
 end if;
end if;
end loop;



END;</pre>	</td></tr>
</table></div>