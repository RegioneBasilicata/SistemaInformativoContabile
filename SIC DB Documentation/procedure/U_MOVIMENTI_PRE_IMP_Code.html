<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>U_MOVIMENTI_PRE_IMP</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="U_MOVIMENTI_PRE_IMP.html">Details</a></div></div>
<div class="tab"><div><a href="U_MOVIMENTI_PRE_IMP_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="U_MOVIMENTI_PRE_IMP_References.html">References</a></div></div>
<div class="tab"><div><a href="U_MOVIMENTI_PRE_IMP_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="U_MOVIMENTI_PRE_IMP_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
PROCEDURE "U_MOVIMENTI_PRE_IMP" (w_anno in out number, w_capitolo in out varchar2, w_pre_impegni in out number) IS 
doc_id_pre_impegno number;
doc_id_imp_definitivo number;

totale_storno_impegni_def  number(15,2);
totale_storno_pre_impegni number(15,2);
totale_impegni_definitivi number(15,2);

cursor pre_impegni is
select distinct	
nvl(jugd.document_amount,0) importo_pre_imp,
to_number(to_char(jugd.date_created,'yyyy')) anno_pre_imp,
jugd.doc_type tipo_pre_imp,
substr(jugd.segment2,1,6) capitolo_spesa_pre_imp,
jugd.previous_doc_id ndp_pre_imp,
jugd.doc_id doc_id_pre_imp
from	
fina_documenti jugd                                                 
where	
jugd.doc_type = 'PRE-IMP'  and   
upper(nvl(jugd.proposal_status_flag,'Z'))||upper(nvl(jugd.auditing_status_flag,'Z'))='PI' and
upper(nvl(jugd.deletion_status_flag,'N')) &lt;> 'Y' and                        
jugd.gl_date is not null and
jugd.period_name is not null and        
jugd.date_created is not null and        
jugd.segment8 = w_anno and
jugd.segment2 = w_capitolo;

cursor impegni_definitivi is
select distinct	
nvl(jugd.document_amount,0) importo_imp_def,
to_number(to_char(jugd.date_created,'yyyy')) anno_imp_def,
jugd.doc_type  tipo_imp_def,
substr(jugd.segment2,1,6) capitolo_spesa_imp_def,
jugd.previous_doc_id ndp_imp_def,
jugd.doc_id doc_id_imp_def
from	
fina_documenti jugd                                                  
where	
jugd.doc_type = 'IMP-DEF'  and   
upper(nvl(jugd.proposal_status_flag,'Z'))||upper(nvl(jugd.auditing_status_flag,'Z'))='PI' and
upper(nvl(jugd.deletion_status_flag,'N')) &lt;> 'Y' and                        
jugd.gl_date is not null and
jugd.period_name is not null and        
jugd.date_created is not null and        
jugd.segment8 = w_anno and
substr(jugd.segment2,1,6) = w_capitolo  and
jugd.previous_doc_id = doc_id_pre_impegno;

cursor storno_pre_impegni is
SELECT
jugd2.doc_id doc_id_storno_pre_imp,
upper(jugd2.doc_type) tipo_storno_pre_imp,
nvl(jugd2.document_amount,0) 	importo_storno_pre_imp,
jugd2.previous_doc_id ndp_storno_pre_imp
FROM
fina_documenti  jugd2
WHERE
upper(jugd2.doc_type) = 'ST-PRE' 	and
upper(nvl(jugd2.proposal_status_flag,'Z'))||upper(nvl(jugd2.auditing_status_flag,'Z'))	='PI' and
upper(nvl(jugd2.deletion_status_flag,'N')) &lt;> 'Y' 	and
jugd2.gl_date 																																					is not null and
jugd2.period_name  is not null and
jugd2.date_created is not null	and
jugd2.segment8 = w_anno and
jugd2.previous_doc_id = doc_id_pre_impegno;

cursor storno_impegni_definitivi is
SELECT
jugd2.doc_id doc_id_storno_imp_def,
upper(jugd2.doc_type) tipo_storno_imp_def,
nvl(jugd2.document_amount,0) importo_storno_imp_def,
jugd2.previous_doc_id ndp_storno_imp_def
FROM
fina_documenti jugd2
WHERE
upper(jugd2.doc_type) = 'ST-IMPDEF' 	and
upper(nvl(jugd2.proposal_status_flag,'Z'))||upper(nvl(jugd2.auditing_status_flag,'Z'))	='PI' and
upper(nvl(jugd2.deletion_status_flag,'N')) &lt;> 'Y' 	and
jugd2.gl_date is not null and
jugd2.period_name is not null and
jugd2.date_created is not null	and
jugd2.segment8 = w_anno and
jugd2.previous_doc_id = doc_id_imp_definitivo;

begin
	
for i in pre_impegni loop
 doc_id_pre_impegno := i.doc_id_pre_imp;
 
-- calcolo storno pre impegni
 totale_storno_pre_impegni := 0;
 
 for si in storno_pre_impegni loop
  totale_storno_pre_impegni := totale_storno_pre_impegni + nvl(si.importo_storno_pre_imp,0);
 end loop; 
-- fine calcolo storni pre impegni  


-- calcolo impegni  definitivi
  totale_impegni_definitivi := 0;
	for imd in impegni_definitivi loop
	 doc_id_imp_definitivo := imd.doc_id_imp_def;
	 
	-- calcolo storno imp_def
	 totale_storno_impegni_def := 0;
	 
	 for sid in storno_impegni_definitivi loop
	
	
	  totale_storno_impegni_def := totale_storno_impegni_def + nvl(sid.importo_storno_imp_def,0);
	 end loop; 
	-- fine calcolo storni impegni  definitivi
	
	 totale_impegni_definitivi := totale_impegni_definitivi + (nvl(imd.importo_imp_def,0) - nvl(totale_storno_impegni_def,0));
	end loop;
-- fine calcolo impegni  definitivi

	w_pre_impegni := nvl(w_pre_impegni,0) + (nvl(i.importo_pre_imp,0) - nvl(totale_storno_pre_impegni,0) - nvl(totale_impegni_definitivi,0));
end loop;

END;</pre>	</td></tr>
</table></div>