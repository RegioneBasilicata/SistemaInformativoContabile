<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>VARIAZIONE_USCITE_TESORIERE</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="VARIAZIONE_USCITE_TESORIERE.html">Details</a></div></div>
<div class="tab"><div><a href="VARIAZIONE_USCITE_TESORIERE_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="VARIAZIONE_USCITE_TESORIERE_References.html">References</a></div></div>
<div class="tab"><div><a href="VARIAZIONE_USCITE_TESORIERE_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="VARIAZIONE_USCITE_TESORIERE_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
procedure  variazione_uscite_tesoriere 
(p_anno in number
,p_anno_stampa in number
,p_da_data_movimento in date
,p_a_data_movimento in date
,p_residuo in varchar2
,p_utente in varchar2
,p_id in number) AS


cassa_prec number;
cassa_pos number;
cassa_neg number;
cassa_def number;

compe_prec number;
compe_pos number;
compe_neg number;
compe_def number;

cp_res_prec number;
cp_res_pos number;
cp_res_neg number;
cp_res_def number;

disavanzo_iniziale number;
disavanzo_var_piu number;
disavanzo_var_meno number;
disavanzo_effettivo number;

p_ord number;
max_riga number;--numero massimo riga
min_riga number;--numero minimo riga
max_riga_fin number; --numero max riga per else
conta_prog number;
conta_mis number;

cursor capitoli is 
select 
 a.eu||a.codice capitolo_bil
,decode(nvl(a.modificato_nuovo,'Z'),'M','(Modificato) ','N','(Nuovo) ',null)||a.descrizione desc_capitolo
,nvl(l1.codice,'0') Missione
,nvl(l2.codice,0) Programma
,nvl(l3.id,0) Titolo
,l1.descrizione desc_missione
,l2.descrizione desc_programma
,l3.descrizione desc_titolo
,a.codice_precedente cap_precs1
,a.codice_precedente2 cap_precs2
,a.codice_precedente3 cap_precs3
,a.codice_precedente4 cap_precs4
,a.codice_precedente5 cap_precs5
,nvl(a.modificato_nuovo,'Z') modificato_nuovo
,a.nb_piano_conti_fina pcf
from 
fin_t_articoli a,
nb_livello1 l1,
nb_livello2 l2,
nb_titoli_uscite l3
where a.anno=p_anno_stampa 
and a.abilitato = 'S'
and a.eu = 'U' 
and l2.id(+) = a.nb_id_padre 
and l1.id(+) = l2.id_livello1
and l3.anno(+) = a.anno
and l3.id(+) = a.nb_titolo
order by 3,4,5;

cursor tot_titoli is 
select
	utente
	,CAR01
	,CAR02
	,CAR03
	,CAR04
	,CAR05
	,CAR06
	,CAR07
    ,'T'
	,'VALORI'
	,CAR10
	,CAR11
    ,CAR13
	,sum(nvl(num01,0)) tot_tit_iniz
	,sum(nvl(num02,0)) tot_var_tit_piu
	,sum(nvl(num03,0)) tot_var_Tit_meno
	,sum(nvl(num04,0)) tot_tit_fin
	from tmp_tabulati2
	where car01='VARIAZIONE USCITE TESORIERE'
	and nvl(car12,'N')&lt;>'N'
 	group by
    utente
	,CAR01
	,CAR02
	,CAR03
	,CAR04
	,CAR05
	,CAR06
	,CAR07
    ,'T'
	,'VALORI'
	,CAR10
	,CAR11
    ,CAR13
    order by car03, car05, car02,CAR13;

cursor tot_programmi is 
select
	utente
	,CAR01
	,CAR03
	,CAR04
	,CAR05
	,CAR06
	,CAR07
    ,'T'
	,'VALORI'
	,CAR10
	,CAR11
    ,CAR13
    ,CAR15
	,sum(nvl(num01,0)) tot_progr_iniz
	,sum(nvl(num02,0)) tot_var_progr_piu
	,sum(nvl(num03,0)) tot_var_progr_meno
	,sum(nvl(num04,0)) tot_progr_fin
	from tmp_tabulati3
	where car01='VARIAZIONE USCITE TESORIERE'
	and nvl(car12,'N')='N'
    and nvl(car02,'N')&lt;>'N'
 	group by
    utente
	,CAR01
	,CAR03
	,CAR04
	,CAR05
	,CAR06
	,CAR07
    ,'T'
	,'VALORI'
	,CAR10
	,CAR11
    ,CAR13
    ,CAR15
    order by car03, car05, CAR13;

cursor tot_missioni is
select
	utente
	,CAR01
	,CAR03
	,CAR04
	,CAR07
    ,'T'
	,'VALORI'
	,CAR10
	,CAR11
    ,CAR13
    ,CAR15
	,sum(nvl(num01,0)) tot_mis_iniz
	,sum(nvl(num02,0)) tot_var_mis_piu
	,sum(nvl(num03,0)) tot_var_mis_meno
	,sum(nvl(num04,0)) tot_mis_fin
	from tmp_tabulati3
	where car01='VARIAZIONE USCITE TESORIERE'
	and nvl(car12,'N')='N'
    and nvl(car02,'N')='N'
    and nvl(car09,'N')='VALORI'
    group by
    utente
	,CAR01
	,CAR03
	,CAR04
	,CAR07
    ,'T'
	,'VALORI'
	,CAR10
	,CAR11
    ,CAR13
    ,CAR15
    order by car03, CAR13;


begin

delete tmp_tabulati2 where car01='VARIAZIONE USCITE TESORIERE';
 p_ord:=1;
	for c in capitoli loop



if p_anno-p_anno_stampa =0
	 then
	 variazione_competenza(p_anno_stampa,c.capitolo_bil,p_da_data_movimento,p_a_data_movimento,compe_prec,compe_pos,compe_neg,compe_def);
	 variazione_cassa(p_anno_stampa,c.capitolo_bil,p_da_data_movimento,p_a_data_movimento,cassa_prec,cassa_pos,cassa_neg,cassa_def);
     variazione_residuo(p_anno_stampa,c.capitolo_bil,p_utente,cp_res_prec,cp_res_pos,cp_res_neg,cp_res_def);
	 end if;

if p_anno_stampa-p_anno = 1
	 then
	 variazione_pluriennale1(p_anno_stampa,c.capitolo_bil,p_da_data_movimento,p_a_data_movimento,compe_prec,compe_pos,compe_neg,compe_def);
end if;	

if p_anno_stampa-p_anno = 2
	 then
	 variazione_pluriennale2(p_anno_stampa,c.capitolo_bil,p_da_data_movimento,p_a_data_movimento,compe_prec,compe_pos,compe_neg,compe_def);
end if;


insert into tmp_tabulati2 (
	UTENTE
	,NUM_ORD_RIGA
	,CAR01
	,CAR02
	,CAR03
	,CAR04
	,CAR05
	,CAR06
	,CAR07
    ,CAR08
	,CAR09
	,CAR10
	,CAR11
	,CAR12
    ,CAR13
	,NUM01
	,NUM02
	,NUM03
	,NUM04)
    values
	(p_utente
	,p_ord
	,'VARIAZIONE USCITE TESORIERE'
	,c.Titolo
	,c.missione
	,c.desc_missione
	,c.programma
	,c.desc_programma
	,'previsione di competenza'
    ,'T'
	,'VALORI'
	,p_id
	,p_anno_stampa
	,c.capitolo_bil
    ,'2'
	,compe_prec
	,compe_pos 
	,compe_neg
	,compe_def);

if p_anno-p_anno_stampa =0
then	
    if p_residuo='S'
    then
   	insert into tmp_tabulati2 (
	UTENTE
	,NUM_ORD_RIGA
	,CAR01
	,CAR02
	,CAR03
	,CAR04
	,CAR05
	,CAR06
	,CAR07
    ,CAR08
	,CAR09
	,CAR10
	,CAR11
	,CAR12
    ,CAR13
	,NUM01
	,NUM02
	,NUM03
	,NUM04)
	values
    (p_utente
	,p_ord-1
	,'VARIAZIONE USCITE TESORIERE'
	,c.Titolo
	,c.missione
	,c.desc_missione
	,c.programma
	,c.desc_programma
	,'residui presunti'
    ,'T'
	,'VALORI'
	,p_id
	,p_anno_stampa
	,c.capitolo_bil
    ,'1'
	,cp_res_prec
	,cp_res_pos
	,cp_res_neg
	,cp_res_def);
    else
   	insert into tmp_tabulati2 (
	UTENTE
	,NUM_ORD_RIGA
	,CAR01
	,CAR02
	,CAR03
	,CAR04
	,CAR05
	,CAR06
	,CAR07
    ,CAR08
	,CAR09
	,CAR10
	,CAR11
	,CAR12
    ,CAR13
	,NUM01
	,NUM02
	,NUM03
	,NUM04)
	values
    (p_utente
	,p_ord-1
	,'VARIAZIONE USCITE TESORIERE'
	,c.Titolo
	,c.missione
	,c.desc_missione
	,c.programma
	,c.desc_programma
	,'residui presunti'
    ,'T'
	,'VALORI'
	,p_id
	,p_anno_stampa
	,c.capitolo_bil
    ,'1'
	,cp_res_prec
	,0
	,0
	,cp_res_prec);
    end if;

p_ord:=p_ord+2;

	insert into tmp_tabulati2 (
	UTENTE
	,NUM_ORD_RIGA
	,CAR01
	,CAR02
	,CAR03
	,CAR04
	,CAR05
	,CAR06
	,CAR07
    ,CAR08
	,CAR09
	,CAR10
	,CAR11
	,CAR12
    ,CAR13
	,NUM01
	,NUM02
	,NUM03
	,NUM04)
	values
	(p_utente
	,p_ord
	,'VARIAZIONE USCITE TESORIERE'
	,c.Titolo
	,c.missione
	,c.desc_missione
	,c.programma
	,c.desc_programma
	,'previsione di cassa'
    ,'T'
	,'VALORI'
	,p_id
	,p_anno_stampa
	,c.capitolo_bil
    ,'3'
	,cassa_prec
	,cassa_pos 
	,cassa_neg
	,cassa_def);
end if;

p_ord:=p_ord+2;
end loop;
commit;


delete tmp_tabulati3 where car01='VARIAZIONE USCITE TESORIERE';

--Titolo
p_ord:=4;

    for t in tot_titoli loop


	insert into tmp_tabulati3 (
	UTENTE
	,NUM_ORD_RIGA
	,CAR01
	,CAR02
	,CAR03
	,CAR04
	,CAR05
	,CAR06
	,CAR07
    ,CAR08
	,CAR09
	,CAR10
	,CAR11
	,CAR13
    ,CAR15
	,NUM01
	,NUM02
	,NUM03
	,NUM04)
    values
    (t.utente
	,p_ord
	,t.CAR01
	,t.CAR02
	,t.CAR03
	,t.CAR04
	,t.CAR05
	,t.CAR06
	,t.CAR07
    ,null
	,'VALORI'
	,t.CAR10
	,t.CAR11
    ,t.CAR13
    ,p_anno
	,t.tot_tit_iniz
    ,t.tot_var_tit_piu
    ,t.tot_var_Tit_meno
    ,t.tot_tit_fin);

     p_ord:=p_ord+20;

end loop;
commit;

--Programma
min_riga:=0;
max_riga:=0;
max_riga_fin:=0;

for p in tot_programmi loop

conta_prog:=0;

    select min(num_ord_riga), max (num_ord_riga) into min_riga, max_riga
    from tmp_tabulati3
    where nvl(car03,'N')=p.car03
    and nvl(car05,'N')=p.car05;

    select count(car05) into conta_prog
    from tmp_tabulati3 
    where nvl(car03,'N')=p.car03
    and nvl(car05,'N')=p.car05
    and nvl(car02,'N')='N'
    and nvl(car08,'N')='N';

    if conta_prog=0
    then
    insert into tmp_tabulati3 (
	UTENTE
	,NUM_ORD_RIGA
	,CAR01
	,CAR02
	,CAR03
	,CAR04
	,CAR05
	,CAR06
	,CAR07
    ,CAR08
	,CAR09
	,CAR10
	,CAR11
	,CAR13
    ,CAR14
    ,CAR15
	,NUM01
	,NUM02
	,NUM03
	,NUM04)
    values
    (p.utente
	,min_riga-1
	,p.CAR01
	,null
	,p.CAR03
	,p.CAR04
	,p.CAR05
	,p.CAR06
	,null
    ,null
	,null
	,p.CAR10
	,p.CAR11
    ,null
    ,'P'
    ,p.CAR15
	,null
    ,null
    ,null
    ,null);

    insert into tmp_tabulati3 (
	UTENTE
	,NUM_ORD_RIGA
	,CAR01
	,CAR02
	,CAR03
	,CAR04
	,CAR05
	,CAR06
	,CAR07
    ,CAR08
	,CAR09
	,CAR10
	,CAR11
	,CAR13
    ,CAR14
    ,CAR15
	,NUM01
	,NUM02
	,NUM03
	,NUM04)
    values
    (p.utente
	,max_riga+1
	,p.CAR01
	,null
	,p.CAR03
	,p.CAR04
	,p.CAR05
	,p.CAR06
	,p.CAR07
    ,'T'
	,'VALORI'
	,p.CAR10
	,p.CAR11
    ,p.CAR13
    ,'P'
    ,p.CAR15
	,p.tot_progr_iniz
    ,p.tot_var_progr_piu
    ,p.tot_var_progr_meno
    ,p.tot_progr_fin);

    else

    select  max (num_ord_riga) into  max_riga_fin
    from tmp_tabulati3
    where nvl(car03,'N')=p.car03
    and nvl(car05,'N')=p.car05
    and nvl(car09,'N')='VALORI';


    insert into tmp_tabulati3 (
	UTENTE
	,NUM_ORD_RIGA
	,CAR01
	,CAR02
	,CAR03
	,CAR04
	,CAR05
	,CAR06
	,CAR07
    ,CAR08
	,CAR09
	,CAR10
	,CAR11
	,CAR13
    ,CAR14
    ,CAR15
	,NUM01
	,NUM02
	,NUM03
	,NUM04)
    values
    (p.utente
	,max_riga_fin+1
	,p.CAR01
	,null
	,p.CAR03
	,p.CAR04
	,p.CAR05
	,p.CAR06
	,p.CAR07
    ,'T'
	,'VALORI'
	,p.CAR10
	,p.CAR11
    ,p.CAR13
    ,'P'
    ,p.CAR15
	,p.tot_progr_iniz
    ,p.tot_var_progr_piu
    ,p.tot_var_progr_meno
    ,p.tot_progr_fin);
    end if;

    end loop;


--Missione
min_riga:=0;
max_riga:=0;
max_riga_fin:=0;

for m in tot_missioni loop

conta_mis:=0;

    select min(num_ord_riga), max (num_ord_riga) into min_riga, max_riga
    from tmp_tabulati3
    where nvl(car03,'N')=m.car03
    and nvl(car02,'N')='N';

    select count(car03) into conta_mis
    from tmp_tabulati3 
    where nvl(car03,'N')=m.car03
    and nvl(car02,'N')='N'
    and nvl(car05,'N')='N'
    and nvl(car08,'N')='N';

    if conta_mis=0
    then
    insert into tmp_tabulati3 (
	UTENTE
	,NUM_ORD_RIGA
	,CAR01
	,CAR02
	,CAR03
	,CAR04
	,CAR05
	,CAR06
	,CAR07
    ,CAR08
	,CAR09
	,CAR10
	,CAR11
	,CAR13
    ,CAR14
    ,CAR15
	,NUM01
	,NUM02
	,NUM03
	,NUM04)
    values
    (m.utente
	,min_riga-1
	,m.CAR01
	,null
	,m.CAR03
	,m.CAR04
	,null
	,null
	,null
    ,null
	,null
	,m.CAR10
    ,m.CAR15
	,m.CAR11
    ,null
    ,'M'
	,null
    ,null
    ,null
    ,null);

    insert into tmp_tabulati3 (
	UTENTE
	,NUM_ORD_RIGA
	,CAR01
	,CAR02
	,CAR03
	,CAR04
	,CAR05
	,CAR06
	,CAR07
    ,CAR08
	,CAR09
	,CAR10
	,CAR11
	,CAR13
    ,CAR14
    ,CAR15
	,NUM01
	,NUM02
	,NUM03
	,NUM04)
    values
    (m.utente
	,max_riga+1
	,m.CAR01
	,null
	,m.CAR03
	,m.CAR04
	,null
	,null
	,m.CAR07
    ,'T'
	,'VALORI'
	,m.CAR10
	,m.CAR11
    ,m.CAR13
    ,'M'
    ,m.CAR15
	,m.tot_mis_iniz
    ,m.tot_var_mis_piu
    ,m.tot_var_mis_meno
    ,m.tot_mis_fin);

    else

    select max (num_ord_riga) into max_riga_fin
    from tmp_tabulati3
    where nvl(car03,'N')=m.car03
    and nvl(car02,'N')='N'
    and nvl(car09,'N')='VALORI';

     insert into tmp_tabulati3 (
	UTENTE
	,NUM_ORD_RIGA
	,CAR01
	,CAR02
	,CAR03
	,CAR04
	,CAR05
	,CAR06
	,CAR07
    ,CAR08
	,CAR09
	,CAR10
	,CAR11
	,CAR13
    ,CAR14
    ,CAR15
	,NUM01
	,NUM02
	,NUM03
	,NUM04)
    values
    (m.utente
	,max_riga_fin+1
	,m.CAR01
	,null
	,m.CAR03
	,m.CAR04
	,null
	,null
	,m.CAR07
    ,'T'
	,'VALORI'
	,m.CAR10
	,m.CAR11
    ,m.CAR13
    ,'M'
    ,m.CAR15
	,m.tot_mis_iniz
    ,m.tot_var_mis_piu
    ,m.tot_var_mis_meno
    ,m.tot_mis_fin);
    end if;

    end loop;

commit;   

--Disavanzo

select
nvl(dg.disavanzo_effettivo_anni_prec,0) + nvl(dg.disavanzo_amministrazione,0),0,0, nvl(dg.disavanzo_effettivo_anni_prec,0) + nvl(dg.disavanzo_amministrazione,0) 
into disavanzo_iniziale, disavanzo_var_piu, disavanzo_var_meno, disavanzo_effettivo
from fina_dati_generali dg
where dg.anno_finanziario = p_anno_stampa;

min_riga:=0;

select min(num_ord_riga) into min_riga
from tmp_tabulati3
where nvl(car01,'N')='VARIAZIONE USCITE TESORIERE';


insert into tmp_tabulati3 (
	UTENTE
	,NUM_ORD_RIGA
	,CAR01
	,CAR02
	,CAR08
	,CAR09
	,CAR10
	,CAR11
    ,CAR14
    ,CAR15
	,NUM01
	,NUM02
	,NUM03
	,NUM04)
    values
    (p_utente
	,min_riga-1
	,'VARIAZIONE USCITE TESORIERE'
	,'DISAVANZO DI AMMINISTRAZIONE'
	,'T'
	,'VALORI'
	,p_id
	,p_anno_stampa
    ,'D'
    ,p_anno
    ,disavanzo_iniziale
    ,disavanzo_var_piu
    ,disavanzo_var_meno
    ,disavanzo_effettivo);

commit;
delete tmp_tabulati2 where car01='VARIAZIONE USCITE TESORIERE';


--Totale variazioni

max_riga:=0;

select max(num_ord_riga) into max_riga
from tmp_tabulati3
where nvl(car01,'N')='VARIAZIONE USCITE TESORIERE';

insert into tmp_tabulati3 (
	UTENTE
	,NUM_ORD_RIGA
	,CAR01
	,CAR02
    ,CAR07
	,CAR08
	,CAR09
	,CAR10
	,CAR11
    ,CAR13
    ,CAR14
    ,CAR15
	,NUM01
	,NUM02
	,NUM03
	,NUM04)
   (select
	utente
    ,max_riga+1
	,CAR01
    ,'TOTALE VARIAZIONI USCITE'
    ,CAR07
    ,CAR08
    ,CAR09
	,CAR10
	,CAR11
    ,CAR13
    ,'VT'
    ,CAR15
	,sum(nvl(num01,0)) 
	,sum(nvl(num02,0)) 
	,sum(nvl(num03,0)) 
	,sum(nvl(num04,0)) 
	from tmp_tabulati3
	where car01='VARIAZIONE USCITE TESORIERE'
	and nvl(car14,'N')='M'
    and nvl(car09,'N')='VALORI'
    and nvl(car07,'N')='residui presunti'
    group by
    utente
    ,max_riga+1
	,CAR01
    ,'TOTALE VARIAZIONI USCITE'
    ,CAR07
    ,CAR08
    ,CAR09
	,CAR10
	,CAR11
    ,CAR13
    ,'VT'
max_riga:=max_riga+2;
    ,CAR15)
	order by car13;



insert into tmp_tabulati3 (
	UTENTE
	,NUM_ORD_RIGA
	,CAR01
	,CAR02
    ,CAR07
	,CAR08
	,CAR09
	,CAR10
	,CAR11
    ,CAR13
    ,CAR14
    ,CAR15
	,NUM01
	,NUM02
	,NUM03
	,NUM04)
   (select
	utente
    ,max_riga
	,CAR01
    ,'TOTALE VARIAZIONI USCITE'
    ,CAR07
    ,CAR08
    ,CAR09
	,CAR10
	,CAR11
    ,CAR13
    ,'VT'
    ,CAR15
	,sum(nvl(num01,0)) 
	,sum(nvl(num02,0)) 
	,sum(nvl(num03,0)) 
	,sum(nvl(num04,0)) 
	from tmp_tabulati3
	where car01='VARIAZIONE USCITE TESORIERE'
	and nvl(car14,'N')='M'
    and nvl(car09,'N')='VALORI'
    and nvl(car07,'N')='previsione di competenza'
    group by
    utente
    ,max_riga+1
	,CAR01
    ,'TOTALE VARIAZIONI USCITE'
    ,CAR07
    ,CAR08
    ,CAR09
	,CAR10
	,CAR11
    ,CAR13
    ,'VT'
    ,CAR15)
	order by car13;

max_riga:=max_riga+1;

insert into tmp_tabulati3 (
	UTENTE
	,NUM_ORD_RIGA
	,CAR01
	,CAR02
    ,CAR07
	,CAR08
	,CAR09
	,CAR10
	,CAR11
    ,CAR13
    ,CAR14
    ,CAR15
	,NUM01
	,NUM02
	,NUM03
	,NUM04)
   (select
	utente
    ,max_riga
	,CAR01
    ,'TOTALE VARIAZIONI USCITE'
    ,CAR07
    ,CAR08
    ,CAR09
	,CAR10
	,CAR11
    ,CAR13
    ,'VT'
    ,CAR15
	,sum(nvl(num01,0)) 
	,sum(nvl(num02,0)) 
	,sum(nvl(num03,0)) 
	,sum(nvl(num04,0)) 
	from tmp_tabulati3
	where car01='VARIAZIONE USCITE TESORIERE'
	and nvl(car14,'N')='M'
    and nvl(car09,'N')='VALORI'
    and nvl(car07,'N')='previsione di cassa'
    group by
    utente
    ,max_riga+1
	,CAR01
    ,'TOTALE VARIAZIONI USCITE'
    ,CAR07
    ,CAR08
    ,CAR09
	,CAR10
	,CAR11
    ,CAR13
    ,'VT'
    ,CAR15)
	order by car13;

--TOTALE GENERALE
max_riga:=0;

select max(num_ord_riga) into max_riga
from tmp_tabulati3
where nvl(car01,'N')='VARIAZIONE USCITE TESORIERE';

insert into tmp_tabulati3 (
	UTENTE
	,NUM_ORD_RIGA
	,CAR01
	,CAR02
    ,CAR07
	,CAR08
	,CAR09
	,CAR10
	,CAR11
    ,CAR13
    ,CAR14
    ,CAR15
	,NUM01
	,NUM02
	,NUM03
	,NUM04)
   (select
	utente
    ,max_riga+1
	,CAR01
    ,'TOTALE GENERALE USCITE'
    ,CAR07
    ,CAR08
    ,CAR09
	,CAR10
	,CAR11
    ,CAR13
    ,'VT'
    ,CAR15
	,sum(nvl(num01,0)) 
	,sum(nvl(num02,0)) 
	,sum(nvl(num03,0)) 
	,sum(nvl(num04,0)) 
	from tmp_tabulati3
	where car01='VARIAZIONE USCITE TESORIERE'
	and nvl(car14,'N')='M'
    and nvl(car09,'N')='VALORI'
    and nvl(car07,'N')='residui presunti'
    group by
    utente
    ,max_riga+1
	,CAR01
    ,'TOTALE GENERALE USCITE'
    ,CAR07
    ,CAR08
    ,CAR09
	,CAR10
	,CAR11
    ,CAR13
    ,'VT'
    ,CAR15)
	order by car13;

max_riga:=max_riga+2;


insert into tmp_tabulati3 (
	UTENTE
	,NUM_ORD_RIGA
	,CAR01
	,CAR02
    ,CAR07
	,CAR08
	,CAR09
	,CAR10
	,CAR11
    ,CAR13
    ,CAR14
    ,CAR15
	,NUM01
	,NUM02
	,NUM03
	,NUM04)
   (select
	utente
    ,max_riga
	,CAR01
    ,'TOTALE GENERALE USCITE'
    ,'previsione di competenza'
    ,CAR08
    ,CAR09
	,CAR10
	,CAR11
    ,'2'
    ,'VT'
    ,CAR15
	,sum(nvl(num01,0)) 
	,sum(nvl(num02,0)) 
	,sum(nvl(num03,0)) 
	,sum(nvl(num04,0)) 
	from tmp_tabulati3
	where nvl(car01,'N')='VARIAZIONE USCITE TESORIERE'
    and ((nvl(car02,'N')='TOTALE VARIAZIONI USCITE'
	and nvl(car09,'N')='VALORI'
    and nvl(car07,'N')='previsione di competenza') or nvl(car14,'N')='D')
    group by
    utente
    ,max_riga
	,CAR01
    ,'TOTALE GENERALE USCITE'
    ,'previsione di competenza'
    ,CAR08
    ,CAR09
	,CAR10
	,CAR11
    ,'2'
    ,'VT'
    ,CAR15);

max_riga:=max_riga+1;


insert into tmp_tabulati3 (
	UTENTE
	,NUM_ORD_RIGA
	,CAR01
	,CAR02
    ,CAR07
	,CAR08
	,CAR09
	,CAR10
	,CAR11
    ,CAR13
    ,CAR14
    ,CAR15
	,NUM01
	,NUM02
	,NUM03
	,NUM04)
   (select
	utente
    ,max_riga
	,CAR01
    ,'TOTALE GENERALE USCITE'
    ,CAR07
    ,CAR08
    ,CAR09
	,CAR10
	,CAR11
    ,CAR13
    ,'VT'
    ,CAR15
	,sum(nvl(num01,0)) 
	,sum(nvl(num02,0)) 
	,sum(nvl(num03,0)) 
	,sum(nvl(num04,0)) 
	from tmp_tabulati3
	where car01='VARIAZIONE USCITE TESORIERE'
	and nvl(car14,'N')='M'
    and nvl(car09,'N')='VALORI'
    and nvl(car07,'N')='previsione di cassa'
    group by
    utente
    ,max_riga+1
	,CAR01
    ,'TOTALE GENERALE USCITE'
    ,CAR07
    ,CAR08
    ,CAR09
	,CAR10
	,CAR11
    ,CAR13
    ,'VT'
    ,CAR15)
	order by car13;
commit;
end;</pre>	</td></tr>
</table></div>