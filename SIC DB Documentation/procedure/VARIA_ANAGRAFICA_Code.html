<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>VARIA_ANAGRAFICA</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="VARIA_ANAGRAFICA.html">Details</a></div></div>
<div class="tab"><div><a href="VARIA_ANAGRAFICA_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="VARIA_ANAGRAFICA_References.html">References</a></div></div>
<div class="tab"><div><a href="VARIA_ANAGRAFICA_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="VARIA_ANAGRAFICA_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
PROCEDURE varia_anagrafica(
    PI_ID IN NUMBER,
    PI_TIPO_ANAGRAFICA IN VARCHAR2,                                                                                                            
    PI_PARTITA_IVA IN VARCHAR2,                                                                                                                
    PI_DENOMINAZIONE IN VARCHAR2,                                                                                                              
    PI_COGNOME_LR IN VARCHAR2,                                                                                                                 
    PI_NOME_LR IN VARCHAR2,                                                                                                                    
    PI_SESSO_LR IN VARCHAR2,                                                                                                                   
    PI_COMUNE_NS_LR IN VARCHAR2,                                                                                                               
    PI_DATA_NS_LR IN DATE,                                                                                                                     
    PI_INDIRIZZO_LR IN VARCHAR2,                                                                                                               
    PI_COMUNE_RES_LR IN VARCHAR2,                                                                                                              
    PI_CAP_RES_LR IN VARCHAR2,                                                                                                                 
    PI_CF_LR IN VARCHAR2,                                                                                                                      
    PI_CODICE_FISCALE IN VARCHAR2,                                                                                                             
    PI_COGNOME IN VARCHAR2,                                                                                                                    
    PI_NOME IN VARCHAR2,                                                                                                                       
    PI_ALTRI_NOMI IN VARCHAR2,                                                                                                                 
    PI_SESSO IN VARCHAR2,                                                                                                                      
    PI_DATA_NS IN DATE,                                                                                                                        
    PI_COMUNE_NS IN VARCHAR2,                                                                                                                  
    PI_PIGNORAMENTO IN VARCHAR2,                                                                                                               
    PI_NOTA_PIGNORAMENTO IN VARCHAR2,                                                                                                          
    PI_ESTERO IN VARCHAR2,                                                                                                                     
    PI_COMMISSIONI IN VARCHAR2,
    PI_COD_FISC_UTENTE IN VARCHAR2,
    PO_ID_ANAGRAFICA IN OUT NUMBER,                                                                                                               
    PO_CODICE_RISPOSTA IN OUT NUMBER,                                                                                                             
    PO_DESCRIZIONE_RISPOSTA IN OUT VARCHAR2)                                                                                                      
IS                                                                                                                                             
                                                                                                                                               
	conta number := 0;                                                                                                                           
  vid_com_ns number;                                                                                                                       
	id_com_ns_lr number;                                                                                                                    
  id_com_res_lr number;                                                                                                                   
	id_com_sede number;                                                                                                                          
	appoggio number := 0;                                                                                                                        
	--a number;                                                                                                                                    
	--s number;                                                                                                                                    
	PI varchar2(11);                                                                                                                             
	DEN varchar2(2000);                                                                                                                          
	CF_LR varchar2(16);                                                                                                                          
	CF varchar2(16);                                                                                                                             
	ana_id number;	                                                                                                                             
	SESSO varchar2(1);                                                                                                                           
	DATA_NS date;                                                                                                                                
	contatore	number := 0;                                                                                                                       
	err varchar2(1);                                                                                                                             
	num number;                                                                                                                                  
	PIGN varchar2(1);                                                                                                                            
	inattivo DATE;                                                                                                                               
  cc_si_no number := 0;                                                                                                                        
  abi_si_no number := 0;                                                                                                                       
  cab_si_no number := 0;                                                                                                                       
  id_agenzia number := 0;
  id_conto_corrente number := 0;
  nome_utente varchar2(240) := 'XX' ;  
  id_tipo_pagamento number := 0;
  val_iban varchar2(1) := '0';
  conta_piva number;
  verifica_denominazione varchar2(4000);
  
 COMMISSIONI varchar2(1); -- in attesa che l'XSD SicAnagraficaInterface sia aggiornata gestiamo qui la scomparsa dell'opzione N = "a Carico Beneficiario"
                                                                                                                                               
BEGIN                                                                                                                                          
PO_ID_ANAGRAFICA := 0;                                                                                                                         
PO_CODICE_RISPOSTA := 1;                                                                                                                       
PO_DESCRIZIONE_RISPOSTA := 'Operazione di variazione terminata con successo!';  

-- ***** in attesa che l'XSD SicAnagraficaInterface sia aggiornata gestiamo qui la scomparsa dell'opzione N = "a Carico Beneficiario"
if nvl(PI_COMMISSIONI,'E') = 'N'
 then COMMISSIONI := 'E';
 else COMMISSIONI := nvl(PI_COMMISSIONI,'E');
end if;

-- **** Fine
  -- ****************** VERIFICA UTENTE ************************                                                                               
  begin                                                                                                                                        
    select user_name into nome_utente                                                                                                              
    from fnd_user                                                                                                                              
    where upper(nvl(cod_fiscale,'')) = upper(PI_COD_FISC_UTENTE);                                                                                            
    exception when others then nome_utente := 'XX';                                                                                                 
  end;                                                                                                                                         
  if nome_utente = 'XX'                                                                                                                            
    then PO_CODICE_RISPOSTA := 0;                                                                                                              
    PO_DESCRIZIONE_RISPOSTA := 'Utente non presente o non autorizzato ad operare nel SIC!';                                                    
    return;                                                                                                                                      
  end if;                                                                                                                                      
   
  -- ******** Controlli da fare a prescindere che si tratti di PG o PF *******************
  
        
        -- ***** controllo il Comune di ns in caso di persona fisica ************
       if PI_TIPO_ANAGRAFICA = 'F'
         then
          begin                                                                                                                                
              select id into vid_com_ns from fin_t_comuni where upper(replace(descrizione,' ')) = upper(replace(PI_COMUNE_NS,' '));           
              exception when others then                                                                                                         
                PO_CODICE_RISPOSTA := 0;                                                                                                         
                PO_DESCRIZIONE_RISPOSTA := 'Il comune di nascita non esiste nella tabella Comuni.';                                              
                return;                                                                                                                            
          end; 
        end if;
          
        -- ***** FINE controllo il Comune di ns in caso di persona fisica ************
        
          -- *** controllo il campo COMMISSIONI ********
        if nvl(COMMISSIONI,'N') not in ('S','E')
          then PO_CODICE_RISPOSTA := 0;                                                                                                         
               PO_DESCRIZIONE_RISPOSTA := 'Il campo Commissioni può contenere solo i seguenti valori S = ESENTE, E = A CARICO ENTE';                                              
							return;      
        end if;
        -- *** fine controllo COMMISIIONI
                                                                                                                                              
      
  -- ******* FINE Controlli da fare a prescindere che si tratti di PG o PF **************
                                                                                                                                             
  -- *******************       PERSONA GIURIDICA ****************************                                                                  
 if PI_TIPO_ANAGRAFICA = 'G'  then  
      --Verifico che la partita iva e denominazione  non siano  nulli                                                                                            
			if nvl(PI_ESTERO,'N') = 'N'
       then 
        if (PI_PARTITA_IVA is null or pi_denominazione is null) 
          then                                                                                                         
		  PO_CODICE_RISPOSTA := 0;                                                                                                             
          PO_DESCRIZIONE_RISPOSTA := 'Per le persone giuridiche la Partita IVA e la Denominazione sono obbligatori!';                                               
          return;
          end if;
      end if;                                                                                                                                
	                
    begin
    select denominazione into verifica_denominazione
    from fin_t_anagrafica
    where partita_iva = PI_PARTITA_IVA
    and inattivo_dal is null;
    exception when no_data_found then verifica_denominazione := '';
 end;
  if verifica_denominazione = ''
   then 
        PO_CODICE_RISPOSTA := 0;                                                                                                             
        PO_DESCRIZIONE_RISPOSTA := 'Anagrafica non presente, variazione impossibile!'; 
    return;
    elsif verifica_denominazione &lt;> pi_denominazione
    then PO_CODICE_RISPOSTA := 0;                                                                                                             
        PO_DESCRIZIONE_RISPOSTA := 'Partita IVA già presente, non è possibile variare la Denominazione. Richiedere la disattivazione della attuale Denominazione'; 
    return;
  end if;
  
  	--Controllo la validità della Partita Iva 
   /* if nvl(PI_ESTERO,'N') = 'N'
    then
      err := '';
			CTRL_FORM_PI (PI_PARTITA_IVA, err);                                                                                                 
				if err = 'S'  then                                                                                                                     
					PO_CODICE_RISPOSTA := 0;                                                                                                             
          PO_DESCRIZIONE_RISPOSTA := 'La partita iva è errata!';                                         
					return;                                                                                                                                
				end if;    
     end if;         */                                                                                                                   
		--Fine controllo Partita Iva                                                                                                               
        then
                                                                                                                                               
    	--Controllo l'esistenza della Partita Iva  NON serve in variazione                                                                                              
	/*		if nvl(PI_ESTERO,'N') = 'N'
			  	BEGIN                                                                                                                                  
            select count(*) into conta_piva                                                                                                              
            from fin_t_anagrafica a                                                                                                               
            where nvl(a.PARTITA_IVA,'') = PI_PARTITA_IVA
            and inattivo_dal is null;                                                                                        
          exception                                                                                                                            
						when NO_DATA_FOUND THEN conta_piva := 0; 
          END; 
            if conta_piva > 0
              then PO_CODICE_RISPOSTA := 0;                                                                                                           
            PO_DESCRIZIONE_RISPOSTA := 'Ci sono già beneficiari con la stessa partita iva.';
            return;
            end if;
       end if;
       */
				--Fine Controllo esistenza Partita Iva                                                                                                 
       	--Controllo la correttezza del codice fiscale del legale rappresentante                                                                
					if (PI_CF_LR is not null)  then                                                                                                      
						if (length(PI_CF_LR) &lt; 16) or (length(PI_CF_LR) > 16) or (PI_CF_LR = '****************' ) then                                     
							err := 'S';                                                                                                                      
						else	
              err := '';
							CTRL_FORM_CF(upper(PI_CF_LR),err);                                                                                               
							begin                                                                                                                            
								select id into id_com_ns_lr from fin_t_comuni where upper(replace(descrizione,' ')) = upper(replace(PI_COMUNE_NS_LR,' '));      
								exception when others then                                                                                                     
								PO_CODICE_RISPOSTA := 0;                                                                                                       
                PO_DESCRIZIONE_RISPOSTA := 'Il comune di nascita del Rappresentante Legale non esiste nella tabella Comuni.';                  
								return;                                                                                                                          
							end;                                                                                                                             
              if PI_COMUNE_RES_LR is not null                                                                                                  
                then                                                                                                                           
                  begin                                                                                                                        
                    select id into id_com_res_lr from fin_t_comuni where upper(replace(descrizione,' ')) = upper(replace(PI_COMUNE_RES_LR,' '));
                    exception when others then                                                                                                 
                    PO_CODICE_RISPOSTA := 0;                                                                                                   
                    PO_DESCRIZIONE_RISPOSTA := 'Il comune di residenza del Rappresentante Legale non esiste nella tabella Comuni.';            
                    return;                                                                                                                      
                  end;                                                                                                                      
              end if;                                                                                                                          
						end if;                                                                                                                            
						if err = 'S'  then                                                                                                                 
                PO_CODICE_RISPOSTA := 0;                                                                                                       
                PO_DESCRIZIONE_RISPOSTA := 'Il codice fiscale del rappresentante legale è errato.';                                            
								return;                                                                                                                          
						end if;                                                                                                                            
					end if;                                                                                                                              
        	select (nvl(max(id),0)+1) into conta from fin_t_anagrafica;                                                                         
				--Fine Controllo del codice fiscale del legale rappresentante                                                                          

        -- UPDATE PERSONA GIURIDICA faccio la insert dell'anagrafica, della relativa sede e dell'eventuale conto corrente                      
         	UPDATE                                                                                                                                         
              fin_t_anagrafica a                                                                                                                
              set                                                                                                       
             --   a.TIPO_ANAGRAFICA= PI_TIPO_ANAGRAFICA,                                                                                                             
             --   a.PARTITA_IVA = PI_PARTITA_IVA,                                                                                                                   
             --   a.DENOMINAZIONE = PI_DENOMINAZIONE,                                                                                                                  
                a.COGNOME_LR = PI_COGNOME_LR,                                                                                                                      
                a.NOME_LR = PI_NOME_LR,                                                                                                                       
                a.SESSO_LR = PI_SESSO_LR,                                                                                                                      
                a.DATA_NS_LR = PI_DATA_NS_LR,                                                                                                                    
                a.INDIRIZZO_LR = PI_INDIRIZZO_LR,                                                                                                                                 
                a.CAP_RES_LR =  PI_CAP_RES_LR,                                                                                                                    
                a.CF_LR =  upper(PI_CF_LR),                                                                                                                         
             --   PIGNORAMENTO = PI_PIGNORAMENTO,                                                                                                                  
             --   NOTA_PIGNORAMENTO = PI_NOTA_PIGNORAMENTO,                                                                                                             
                a.UTENTE_AGGIORNAMENTO = NOME_UTENTE,                                                                                                          
                a.DATA_AGGIORNAMENTO =  sysdate,                                                                                                            
              --  a.ESTERO = PI_ESTERO,                                                                                                                        
                a.COMMISSIONI = nvl(COMMISSIONI,'E')
                where id = PI_ID;                                                                                                                             
            COMMIT;   
            PO_ID_ANAGRAFICA := PI_ID;                                                                                                                         
  end if;                                                                                                                               
  -- ********* FINE Persona Giuridica ****************  
  
  -- ******************* PERSONA FISICA ************************
  if PI_TIPO_ANAGRAFICA = 'F'  then
				--Verifico che il codice fiscale e gli altri dati obbligatori non sia nulli
    if PI_CODICE_FISCALE is null 
           or pi_cognome is null
           or pi_nome is null
           or pi_sesso is null
           or pi_data_ns is null
          then PO_CODICE_RISPOSTA := 0;                                                                                                             
          PO_DESCRIZIONE_RISPOSTA := 'Per le persone fisiche il Codice Fiscale, il Cognome, il Nome, il sesso, la data di nascita e il comune di nascita sono obbligatori!';                                               
          return;            
				end if;
									
				--Controllo la correttezza del codice fiscale
				if (length(PI_CODICE_FISCALE) &lt; 16) or (length(PI_CODICE_FISCALE) > 16) or (PI_CODICE_FISCALE = '****************' ) then
					err := 'S';
				else	
         CTRL_FORM_CF(upper(PI_CODICE_FISCALE),err);
				end if;
         if err = 'S'  then
          PO_CODICE_RISPOSTA := 0;                                                                                                             
          PO_DESCRIZIONE_RISPOSTA := 'Il codice fiscale è errato!';                                               
          return;
          end if;
          
           cf := '';  
           cf := REPLACE(GENERA_CF(PI_COGNOME,PI_NOME,PI_ALTRI_NOMI,PI_SESSO,trunc(PI_DATA_NS,'dd'),vid_com_ns),' '); 
          if upper(cf) &lt;> upper(PI_CODICE_FISCALE) then
          PO_CODICE_RISPOSTA := 0;                                                                                                             
          PO_DESCRIZIONE_RISPOSTA := 'Variazione non consentita, Codice Fiscale e dati anagrafici non compatibili!';                                               
          return;
          end if;
		
				--Fine Controllo del codice fiscale

        appoggio:=0;
				--Verifico l'esistenza del Codice Fiscale
         /*       
				BEGIN
					select count(*)
					INTO appoggio
                    and inattivo_dal is not null;
					from fin_t_anagrafica a
					where upper(a.CODICE_FISCALE) = upper(PI_CODICE_FISCALE)
                    and id &lt;> PI_ID
				END;
        if appoggio > 0
          then PO_CODICE_RISPOSTA := 0;                                                                                                             
          PO_DESCRIZIONE_RISPOSTA := 'Il Codice Fiscale è già presente in anagrafica';                                               
          return;
				end if;
        */
				--Fine Verifica dell'esistenza del Codice Fiscale
        
        -- ************ UPDATE anagrafica *************
    -- in caso di persona fisica la VARIAZIONE non è consentita sulle voci essenziali
        /*   
         	UPDATE
              fin_t_anagrafica a
              SET 
                a.TIPO_ANAGRAFICA = PI_TIPO_ANAGRAFICA,
                a.CODICE_FISCALE = PI_CODICE_FISCALE,
                a.COGNOME = PI_COGNOME,
                a.NOME = PI_NOME,
                a.ALTRI_NOMI = PI_ALTRI_NOMI,
                a.SESSO = PI_SESSO,
                a.DATA_NS = PI_DATA_NS,
                a.ID_COMUNE_NS = vid_com_ns,
              --  PIGNORAMENTO = PI_PIGNORAMENTO,
              --  NOTA_PIGNORAMENTO = pi_nota_pignoramento,
                a.UTENTE_AGGIORNAMENTO = NOME_UTENTE,
                a.DATA_AGGIORNAMENTO = SYSDATE,
                a.ESTERO = PI_ESTERO,
                a.COMMISSIONI = nvl(COMMISSIONI,'E')--decode(nvl(PI_COMMISSIONI,'B'),'N','B',nvl(PI_COMMISSIONI,'B'))
                WHERE ID = PI_ID;
            COMMIT;
            PO_ID_ANAGRAFICA := PI_ID;
            */
             PO_ID_ANAGRAFICA := PI_ID;
     end if;
        -- *********** FINE inserimento anagrafica *********
  
  -- **************** FINE Persona Fisica ********************** 
 
END;</pre>	</td></tr>
</table></div>