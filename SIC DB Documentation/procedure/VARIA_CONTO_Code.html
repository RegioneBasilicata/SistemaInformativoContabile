<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>VARIA_CONTO</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="VARIA_CONTO.html">Details</a></div></div>
<div class="tab"><div><a href="VARIA_CONTO_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="VARIA_CONTO_References.html">References</a></div></div>
<div class="tab"><div><a href="VARIA_CONTO_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="VARIA_CONTO_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
PROCEDURE varia_conto(
    PI_ID_ANAGRAFICA IN NUMBER,
    PI_ID_SEDE IN NUMBER,                                                                                                                  
    PI_ID_CONTO_CORRENTE IN VARCHAR2,                                                                                                             
    PI_MODALITA_PRINCIPALE_SN IN VARCHAR2,                                                                                                     
    PI_CONTO_CORRENTE IN VARCHAR2,                                                                                                           
    PI_CIN IN VARCHAR2,                                                                                                                        
    PI_IBAN IN VARCHAR2,                                                                                                                       
    PI_COD_FISC_UTENTE IN VARCHAR2,
    PO_ID_ANAGRAFICA IN OUT NUMBER,                                                                                                               
    PO_ID_SEDE IN OUT NUMBER,                                                                                                                     
    PO_ID_CONTO_CORRENTE IN OUT NUMBER,                                                                                                           
    PO_CODICE_RISPOSTA IN OUT NUMBER,                                                                                                             
    PO_DESCRIZIONE_RISPOSTA IN OUT VARCHAR2)                                                                                                      
IS                                                                                                                                             
                                                                                                                                               
	conta number := 0;                                                                                                                           
 -- id_com_ns number;                                                                                                                       
--	id_com_ns_lr number;                                                                                                                    
 -- id_com_res_lr number;                                                                                                                   
	id_com_sede number;                                                                                                                          
	appoggio number := 0;                                                                                                                        
	--a number;                                                                                                                                    
	--s number;                                                                                                                                    
--	PI varchar2(11);                                                                                                                             
--	DEN varchar2(2000);                                                                                                                          
--	CF_LR varchar2(16);                                                                                                                          
--	CF varchar2(16);                                                                                                                             
	ana_id number := 0;	    
  sede_id number := 0;	
--	SESSO varchar2(1);                                                                                                                           
--	DATA_NS date;                                                                                                                                
	contatore	number := 0;                                                                                                                       
	err varchar2(1);                                                                                                                             
	num number;                                                                                                                                  
--	PIGN varchar2(1);                                                                                                                            
--	inattivo DATE;                                                                                                                               
  cc_si_no number := 0;                                                                                                                        
  abi_si_no number := 0;                                                                                                                       
  cab_si_no number := 0;                                                                                                                       
  id_agenzia number := 0;
  id_conto_corrente number := 0;
  nome_utente varchar2(240) := 'XX' ;  
  id_tipo_pagamento number := 0;
  val_iban varchar2(1) := '0';
  modalita_principale varchar2(1);
                                                                                                                                               
BEGIN                                                                                                                                          
PO_ID_ANAGRAFICA := PI_ID_ANAGRAFICA;                                                                                                                         
PO_ID_SEDE := PI_ID_SEDE;                                                                                                                               
PO_ID_CONTO_CORRENTE := PI_ID_CONTO_CORRENTE;                                                                                                                     
PO_CODICE_RISPOSTA := 1;                                                                                                                       
PO_DESCRIZIONE_RISPOSTA := 'Operazione terminata con successo!';                                                                               
  -- ****************** VERIFICA UTENTE ************************                                                                               
  begin                                                                                                                                        
    select user_name into nome_utente                                                                                                              
    from fnd_user                                                                                                                              
    where upper(nvl(cod_fiscale,'')) = upper(PI_COD_FISC_UTENTE);                                                                                            
    exception when others then nome_utente := 'XX';                                                                                                 
  end;                                                                                                                                         
  if nome_utente = 'XX'                                                                                                                            
    then PO_CODICE_RISPOSTA := 0;                                                                                                              
    PO_DESCRIZIONE_RISPOSTA := 'Utente non presente o non autorizzato ad operare nel SIC!';                                                    
    return;                                                                                                                                      
  end if;    
  
  -- ************ Verifico che esiste l'ID_ANAGRAFICA ******************
    select count(*) into ana_id
    from fin_t_anagrafica
    where id = PI_ID_ANAGRAFICA;
    if ana_id = 0
      then PO_CODICE_RISPOSTA := 0;                                                                                                              
      PO_DESCRIZIONE_RISPOSTA := 'Anagrafica non presente! Impossibile creare il conto corrente!';                                                    
      return;                                                                                                                                      
    end if; 
  -- ************** FINE verifica ID_ANAGRAFICA ************************
   -- ************ Verifico che esiste l'ID_SEDE ******************
    select count(*) into sede_id
    from fin_t_ana_sedi
    where id_ana = PI_ID_ANAGRAFICA
    and id_sede = pi_id_sede;
    if sede_id = 0
      then PO_CODICE_RISPOSTA := 0;                                                                                                              
      PO_DESCRIZIONE_RISPOSTA := 'Sede non presente! Impossibile creare il conto corrente!';                                                    
      return;                                                                                                                                      
    end if; 
  -- ************** FINE verifica ID_SEDE ************************
   
  -- ******** Controlli GENERALI *******************
      
        -- Controlli per il conto corrente                                                                                                     
     /*                                                                                                          
             if length(nvl(PI_IBAN,'X')) &lt;> 27                                                                                                          
              then PO_CODICE_RISPOSTA := 0;                                                                                                    
              PO_DESCRIZIONE_RISPOSTA := 'L''IBAN deve contenere 27 caratteri.';                                                               
							return;                                                                                                                            
             end if;
      */
  -- ******* FINE Controlli GENERALI **************
  
  -- *********** update il CONTO CORRENTE ****
        val_iban := valida_iban(UPPER(PI_IBAN),'N');
        if val_iban &lt;> '0'
          then PO_CODICE_RISPOSTA := 2;                                                                                                                       
          PO_DESCRIZIONE_RISPOSTA := 'Operazione terminata con successo! Non è stato possibile validare l''IBAN';  
        end if;
        -- verifica la modalità principale su altri conti
        conta := 0;
        select count(*) into conta
        from fin_t_ana_conti_bancari
        where id_ana = pi_id_anagrafica
        and id_sede = pi_id_sede
        and nvl(modalita_principale_sn,'N') = 'S';
        
        if conta > 0 and nvl(PI_MODALITA_PRINCIPALE_SN,'N') = 'S'
          then update fin_t_ana_conti_bancari set modalita_principale_sn = 'N'
                where id_ana = pi_id_anagrafica
                and id_sede = pi_id_sede
                and nvl(modalita_principale_sn,'N') = 'S';
                commit;
        end if;
         if conta = 0 and nvl(PI_MODALITA_PRINCIPALE_SN,'N') &lt;> 'S'
          then modalita_principale := 'S';
        end if;
        -- FINE VERIFICA MOD_PRINC
         
        update fin_t_ana_conti_bancari 
        set
        CONTO_CORRENTE = nvl(PI_CONTO_CORRENTE,substr(UPPER(PI_IBAN),16)),
        MODALITA_PRINCIPALE_SN = nvl(modalita_principale,'N'),        
        CIN = nvl(PI_CIN,substr(UPPER(PI_IBAN),5,1)),                   
        IBAN = UPPER(PI_IBAN),                
        DATA_AGGIORNAMENTO = sysdate,   
        UTENTE_AGGIORNAMENTO =nome_utente
        where  ID = pi_id_conto_corrente                    
        and ID_ANA = pi_id_anagrafica              
        and ID_SEDE = pi_id_sede;    
        commit;
            -- **** FINE CONTO CORRENTE *******
  
END;</pre>	</td></tr>
</table></div>