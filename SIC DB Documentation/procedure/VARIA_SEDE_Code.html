<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>VARIA_SEDE</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="VARIA_SEDE.html">Details</a></div></div>
<div class="tab"><div><a href="VARIA_SEDE_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="VARIA_SEDE_References.html">References</a></div></div>
<div class="tab"><div><a href="VARIA_SEDE_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="VARIA_SEDE_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
PROCEDURE varia_sede(
    PI_ID_ANAGRAFICA IN NUMBER,
    PI_ID_SEDE IN NUMBER,
    PI_INDIRIZZO IN VARCHAR2,                                                                                                                  
    PI_COMUNE_SEDE IN VARCHAR2,                                                                                                                
    PI_CAP_SEDE IN VARCHAR2,                                                                                                                   
    PI_TELEFONO IN VARCHAR2,                                                                                                                   
    PI_E_MAIL IN VARCHAR2,                                                                                                                     
    PI_FAX IN VARCHAR2,                                                                                                                        
    PI_BOLLO IN VARCHAR2,   
    PI_TIPO_PAGAMENTO IN VARCHAR2,
    PI_COD_FISC_UTENTE IN VARCHAR2,
    PO_ID_ANAGRAFICA IN OUT NUMBER,                                                                                                               
    PO_ID_SEDE IN OUT NUMBER,  
    PO_ID_TIPO_PAGAMENTO IN OUT NUMBER,  
    PO_CODICE_RISPOSTA IN OUT NUMBER,                                                                                                             
    PO_DESCRIZIONE_RISPOSTA IN OUT VARCHAR2)                                                                                                      
IS                                                                                                                                             
                                                                                                                                               
	conta number := 0;                                                                                                                           
 -- id_com_ns number;                                                                                                                       
--	id_com_ns_lr number;                                                                                                                    
 -- id_com_res_lr number;                                                                                                                   
	vid_com_sede number;                                                                                                                          
	appoggio number := 0;                                                                                                                        
	--a number;                                                                                                                                    
	--s number;                                                                                                                                    
--	PI varchar2(11);                                                                                                                             
--	DEN varchar2(2000);                                                                                                                          
--	CF_LR varchar2(16);                                                                                                                          
--	CF varchar2(16);                                                                                                                             
	ana_id number := 0;	                                                                                                                             
--	SESSO varchar2(1);                                                                                                                           
--	DATA_NS date;                                                                                                                                
	contatore	number := 0;                                                                                                                       
	err varchar2(1);                                                                                                                             
	num number;                                                                                                                                  
--	PIGN varchar2(1);                                                                                                                            
--	inattivo DATE;                                                                                                                               
  cc_si_no number := 0;                                                                                                                        
  abi_si_no number := 0;                                                                                                                       
  cab_si_no number := 0;                                                                                                                       
  id_agenzia number := 0;
  id_conto_corrente number := 0;
  nome_utente varchar2(240) := 'XX' ;  
  vid_tipo_pagamento number := 0;
  val_iban varchar2(1) := '0';
                                                                                                                                               
BEGIN                                                                                                                                          
PO_ID_ANAGRAFICA := PI_ID_ANAGRAFICA;                                                                                                                         
PO_ID_SEDE := PI_ID_SEDE;  
PO_ID_TIPO_PAGAMENTO := 0;
PO_CODICE_RISPOSTA := 1;                                                                                                                       
PO_DESCRIZIONE_RISPOSTA := 'Operazione terminata con successo!';                                                                               
  -- ****************** VERIFICA UTENTE ************************                                                                               
  begin                                                                                                                                        
    select user_name into nome_utente                                                                                                              
    from fnd_user                                                                                                                              
    where upper(nvl(cod_fiscale,'')) = upper(PI_COD_FISC_UTENTE);                                                                                            
    exception when others then nome_utente := 'XX';                                                                                                 
  end;                                                                                                                                         
  if nome_utente = 'XX'                                                                                                                            
    then PO_CODICE_RISPOSTA := 0;                                                                                                              
    PO_DESCRIZIONE_RISPOSTA := 'Utente non presente o non autorizzato ad operare nel SIC!';                                                    
    return;                                                                                                                                      
  end if;    
  
  -- ************ Verifico che esiste l'ID_ANAGRAFICA ******************
    select count(*) into ana_id
    from fin_t_anagrafica
    where id = PI_ID_ANAGRAFICA;
    if ana_id = 0
      then PO_CODICE_RISPOSTA := 0;                                                                                                              
      PO_DESCRIZIONE_RISPOSTA := 'Anagrafica non presente! Impossibile variare la sede!';                                                    
      return;                                                                                                                                      
    end if; 
  -- ************** FINE verifica ID_ANAGRAFICA ************************
   -- *** controllo il Tipo Pagamento ***********
         begin                                                                                                                                
						select id into vid_tipo_pagamento 
            from fin_t_tipo_pagamenti 
           -- where upper(replace(descrizione,' ')) = upper(replace(PI_TIPO_PAGAMENTO,' '));           
						 where upper(replace(descrizione,' ')) = 
            upper(replace(decode(PI_TIPO_PAGAMENTO,'Accredito su c/c bancario','BONIFICO BANCARIO E POSTALE','Assegno circolare non trasferibile da inviare al beneficiario','ASSEGNO CIRCOLARE',PI_TIPO_PAGAMENTO),' '));
            exception when no_data_found then                                                                                                        
              PO_CODICE_RISPOSTA := 0;                                                                                                         
              PO_DESCRIZIONE_RISPOSTA := 'Il tipo pagamento non è tra quelli consentiti.';                                              
							return;                                                                                                                            
					end;  
        -- *** FIne controllo Tipo Pagamento *********
  -- ******** Controlli GENERALI *******************
   --	Controllo il comune della sede		                                                                                                 
					begin                                                                                                                                
						select id into vid_com_sede from fin_t_comuni where upper(replace(descrizione,' ')) = upper(replace(PI_COMUNE_SEDE,' '));           
						exception when others then                                                                                                         
              PO_CODICE_RISPOSTA := 0;                                                                                                         
              PO_DESCRIZIONE_RISPOSTA := 'Il comune della sede non esiste nella tabella Comuni.';                                              
							return;                                                                                                                            
					end;                                                                                                                                 
        -- FINE Controllo comune sede    
                                                                                              
        
  -- ******* FINE Controlli GENERALI **************
  
 
  -- ************** vario la SEDE **************
          UPDATE
              fin_t_ana_sedi
                set
                  INDIRIZZO = pi_indirizzo,
                  ID_COMUNE_SEDE = vid_com_sede,
                  CAP_SEDE = pi_cap_sede,
                  TELEFONO = pi_telefono,
                  E_MAIL = pi_e_mail,
                  FAX = pi_fax,
                  BOLLO = DECODE(PI_BOLLO,'Y','S','N'),
                  ID_TIPO_PAGAMENTO = vid_tipo_pagamento,
                  UTENTE_AGGIORNAMENTO = nome_utente,
                  DATA_AGGIORNAMENTO = sysdate
                where ID_ANA = pi_id_anagrafica
                and ID_SEDE = pi_id_sede;
              COMMIT;
              PO_ID_TIPO_PAGAMENTO := vid_tipo_pagamento;
             
  -- ************ FINE vario SEDE ************           
   
END;</pre>	</td></tr>
</table></div>