<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>TR_AGGIORNA_UTENTI</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="TR_AGGIORNA_UTENTI.html">Details</a></div></div>
<div class="tab"><div><a href="TR_AGGIORNA_UTENTI_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="TR_AGGIORNA_UTENTI_References.html">References</a></div></div>
<div class="tab"><div><a href="TR_AGGIORNA_UTENTI_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="TR_AGGIORNA_UTENTI_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
TRIGGER TR_AGGIORNA_UTENTI 
AFTER INSERT ON FIN_T_PIANTA_ORGANICA for each row
declare
matricola_si number := 0;
matricola_fnd number := 0;
codfisc_fnd number := 0;
c_user_name number := 0;
p_user_name varchar2(100);
p_userid number := 0;
BEGIN
  if nvl(:new.codserv,'X') = 'I'
  then
    begin
        select count(*) into matricola_si
        from ap_utenti
        where matricola = nvl(:new.matricola,0);
    end;
     begin
        select count(*) into matricola_fnd
        from fnd_user
        where nvl(matricola,999999999) = nvl(:new.matricola,0);
    end;
    begin
        select count(*) into codfisc_fnd
        from fnd_user
        where nvl(cod_fiscale,'ZZZ') = nvl(:new.codfisc,'XXX');
    end;
     begin
        select count(*) into c_user_name
        from fnd_user
        where upper(nvl(user_name,'ZZZ')) = upper(substr(replace(:new.NOME,' '),1,2)||substr(replace(:new.COGNOME,' '),1,6));
    end;
   if matricola_si = 0
      then
    insert into AP_UTENTI(MATRICOLA,COGNOME,NOME,COD_FISCALE,LIVELLO,UFFICIO,DATA_ASS,GUIDA_SN,
    AUTISTA_SN,
    ATTIVO_SN,TEL_UFFICIO,E_MAIL,dirigente_SN
    ,posizione_org_SN,dg_sn,codice_presidio,tipo_pos_org
    ,utente_aggiornamento
    ,data_aggiornamento) 
    values (:new.MATRICOLA
     ,:new.COGNOME
     ,:new.NOME
     ,:new.CODFISC
     ,:new.LIVELLO
     ,SUBSTR(:new.codarea,4,2)||SUBSTR(:new.coduff,4,2)
     ,:new.DATAASS
     ,'N'
     ,'N'
     ,'S'
     ,:new.NUMTEL
     ,:new.EMAIL
     ,decode(:new.livello,'00DIR','S','00RCP','S','N')
    ,decode(:new.posizioneorg,'Nessuna','N',null,'N','S')
    ,decode(:new.livello,'000DG','S','N')
    ,nvl(to_number(:new.ccodpresidio),0)
    ,:new.codposorg
    ,'PIANTA_ORGANICA'
    ,:new.data);
     --commit;
    else 
     update ap_utenti 
          set 
          COGNOME=:new.cognome
          ,NOME=:new.nome
          ,COD_FISCALE=:new.CODFISC
          ,LIVELLO=:new.livello
          ,UFFICIO=SUBSTR(:new.codarea,4,2)||SUBSTR(:new.coduff,4,2)
          ,DATA_ASS=:new.dataass
          ,TEL_UFFICIO=:new.numtel
          ,E_MAIL=:new.email
          ,dirigente_SN=decode(:new.livello,'00DIR','S','00RCP','S','N')
          ,posizione_org_SN=decode(:new.posizioneorg,'Nessuna','N',null,'N','S')
          ,dg_sn=decode(:new.livello,'000DG','S','N')
          ,codice_presidio=nvl(to_number(:new.ccodpresidio),0)
          ,tipo_pos_org=:new.codposorg
          ,utente_aggiornamento='PIANTA_ORGANICA'
          ,data_aggiornamento=sysdate
         WHERE MATRICOLA = :new.MATRICOLA;
       --  commit;
      end if;
      -- aggiunta per richiesta PETRIZZI ticket n.116962
      if matricola_fnd = 0 and codfisc_fnd = 0 and :NEW.ccodpresidio NOT IN ('00030','00298','00900','10005','02298') 
      then 
          begin
             select nvl(max(user_id),0) + 1 into p_userid
             from fnd_user;
           end;
          if nvl(c_user_name,0) > 0
            then p_user_name := upper(substr(replace(:new.NOME,' '),1,2)||substr(replace(:new.COGNOME,' '),1,6))||p_userid;
            else p_user_name := upper(substr(replace(:new.NOME,' '),1,2)||substr(replace(:new.COGNOME,' '),1,6));
          end if;
            insert into fnd_user (USER_ID, USER_NAME, CREATION_DATE, CREATED_BY, ENCRYPTED_USER_PASSWORD, 
            START_DATE, DESCRIPTION, EMAIL_ADDRESS, RUOLO, TIPO_CLIENT_DEFAULT, UFFICIO, 
            MATRICOLA, COD_FISCALE, COGNOME, NOME, CDG_SN, ACCESSO_SIC) 
          values (p_userid
           ,p_user_name--upper(substr(replace(:new.NOME,' '),1,2)||substr(replace(:new.COGNOME,' '),1,6))
           ,trunc(sysdate,'dd')
           ,1000
           ,lower(cripta_pwd(lower(substr(:new.NOME,1,2)||:new.COGNOME)))
           ,trunc(sysdate,'dd')
           ,:new.NOME||' '||:new.COGNOME
           ,:new.EMAIL
           ,'PERIFERIA'
           ,'J'
           ,SUBSTR(:new.codarea,4,2)||SUBSTR(:new.coduff,4,2)
           ,:new.MATRICOLA
           ,:new.CODFISC
           ,:new.COGNOME
           ,:new.NOME
           ,'S' --CDG_SN
           ,'S' --accesso SIC
           );
        elsif matricola_fnd = 0 and codfisc_fnd > 0 and :NEW.ccodpresidio NOT IN ('00030','00298','00900','10005','02298') 
        then update fnd_user set end_date = :new.DATACESS, matricola = :new.MATRICOLA where cod_fiscale = :new.CODFISC;
        elsif matricola_fnd > 0 and codfisc_fnd > 0 and :NEW.ccodpresidio NOT IN ('00030','00298','00900','10005','02298') 
        then 
         update fnd_user set end_date = :new.DATACESS 
          ,UFFICIO = SUBSTR(:new.codarea,4,2)||SUBSTR(:new.coduff,4,2)
          ,EMAIL_ADDRESS =:new.email
          ,last_updated_by = 0
          ,last_update_date= sysdate
         WHERE MATRICOLA = :new.MATRICOLA and cod_fiscale = :new.CODFISC;
      end if;
  elsif nvl(:new.codserv,'X') = 'M'
    then
    begin
        select count(*) into matricola_si
        from ap_utenti
        where matricola = nvl(:new.matricola,0);
    end;
     begin
        select count(*) into matricola_fnd
        from fnd_user
        where nvl(matricola,999999999) = nvl(:new.matricola,0);
    end;
    begin
        select count(*) into codfisc_fnd
        from fnd_user
        where nvl(cod_fiscale,'ZZZ') = nvl(:new.codfisc,'XXX');
    end;
     begin
        select count(*) into c_user_name
        from fnd_user
        where upper(nvl(user_name,'ZZZ')) = upper(substr(replace(:new.NOME,' '),1,2)||substr(replace(:new.COGNOME,' '),1,6));
    end;
      if matricola_si = 0
      then 
        insert into AP_UTENTI(MATRICOLA,COGNOME,NOME,COD_FISCALE,LIVELLO,UFFICIO,DATA_ASS,GUIDA_SN,
        AUTISTA_SN,
        ATTIVO_SN,TEL_UFFICIO,E_MAIL,dirigente_SN
        ,posizione_org_SN,dg_sn,codice_presidio,tipo_pos_org,utente_aggiornamento,data_aggiornamento) values (:new.MATRICOLA,:new.COGNOME,:new.NOME,:new.CODFISC,:new.LIVELLO,SUBSTR(:new.codarea,4,2)||SUBSTR(:new.coduff,4,2),:new.DATAASS,'N','N','S',:new.NUMTEL,:new.EMAIL,decode(:new.livello,'00DIR','S','00RCP','S','N')
        ,decode(:new.posizioneorg,'Nessuna','N',null,'N','S'),decode(:new.livello,'000DG','S','N'),nvl(to_number(:new.ccodpresidio),0),:new.codposorg,'PIANTA_ORGANICA',:new.data);
       --  commit;
      else
        update ap_utenti 
          set 
          COGNOME=:new.cognome
          ,NOME=:new.nome
          ,COD_FISCALE=:new.CODFISC
          ,LIVELLO=:new.livello
          ,UFFICIO=SUBSTR(:new.codarea,4,2)||SUBSTR(:new.coduff,4,2)
          ,DATA_ASS=:new.dataass
          ,TEL_UFFICIO=:new.numtel
          ,E_MAIL=:new.email
          ,dirigente_SN=decode(:new.livello,'00DIR','S','00RCP','S','N')
          ,posizione_org_SN=decode(:new.posizioneorg,'Nessuna','N',null,'N','S')
          ,dg_sn=decode(:new.livello,'000DG','S','N')
          ,codice_presidio=nvl(to_number(:new.ccodpresidio),0)
          ,tipo_pos_org=:new.codposorg
          ,utente_aggiornamento='PIANTA_ORGANICA'
          ,data_aggiornamento=sysdate
         WHERE MATRICOLA = :new.MATRICOLA;
       --  commit;
      end if;
      if matricola_fnd = 0 and codfisc_fnd = 0 and :NEW.ccodpresidio NOT IN ('00030','00298','00900','10005','02298') 
      then 
          begin
             select nvl(max(user_id),0) + 1 into p_userid
             from fnd_user;
           end;
          if nvl(c_user_name,0) > 0
            then p_user_name := upper(substr(replace(:new.NOME,' '),1,2)||substr(replace(:new.COGNOME,' '),1,6))||p_userid;
            else p_user_name := upper(substr(replace(:new.NOME,' '),1,2)||substr(replace(:new.COGNOME,' '),1,6));
          end if;
            insert into fnd_user (USER_ID, USER_NAME, CREATION_DATE, CREATED_BY, ENCRYPTED_USER_PASSWORD, 
            START_DATE, DESCRIPTION, EMAIL_ADDRESS, RUOLO, TIPO_CLIENT_DEFAULT, UFFICIO, 
            MATRICOLA, COD_FISCALE, COGNOME, NOME, CDG_SN, ACCESSO_SIC) 
          values (p_userid
           ,p_user_name--upper(substr(replace(:new.NOME,' '),1,2)||substr(replace(:new.COGNOME,' '),1,6))
           ,trunc(sysdate,'dd')
           ,1000
           ,lower(cripta_pwd(lower(substr(:new.NOME,1,2)||:new.COGNOME)))
           ,trunc(sysdate,'dd')
           ,:new.NOME||' '||:new.COGNOME
           ,:new.EMAIL
           ,'PERIFERIA'
           ,'J'
           ,SUBSTR(:new.codarea,4,2)||SUBSTR(:new.coduff,4,2)
           ,:new.MATRICOLA
           ,:new.CODFISC
           ,:new.COGNOME
           ,:new.NOME
           ,'S' --CDG_SN
           ,'S' --accesso SIC
           );
        elsif matricola_fnd = 0 and codfisc_fnd > 0 and :NEW.ccodpresidio NOT IN ('00030','00298','00900','10005','02298') 
        then update fnd_user set end_date = null, matricola = :new.MATRICOLA where cod_fiscale = :new.CODFISC;
        elsif matricola_fnd > 0 and codfisc_fnd > 0 and :NEW.ccodpresidio NOT IN ('00030','00298','00900','10005','02298') 
        then 
         update fnd_user set end_date = :new.DATACESS 
          ,UFFICIO = SUBSTR(:new.codarea,4,2)||SUBSTR(:new.coduff,4,2)
          ,EMAIL_ADDRESS =:new.email
          ,last_updated_by = 0
          ,last_update_date= sysdate
         WHERE MATRICOLA = :new.MATRICOLA and cod_fiscale = :new.CODFISC;
      end if;
    elsif nvl(:new.codserv,'X') = 'C'
      then
       delete ap_utenti where matricola = :new.matricola;
     --  commit;
       -- ELIMINO dalla FND_USER le matricole cessate
        update fnd_user set end_date = trunc(sysdate,'dd') where matricola = :new.matricola;
      --  commit;
     else null;
     end if;
        
    if nvl(:new.codserv,'X') &lt;> 'X'   
      then
      -- inserisco in mon_personale inquadramenti le matricole non presenti
          insert into mon_personale_inquadramenti select distinct a.matricola
          ,trunc(sysdate,'dd')
          ,substr(replace(decode(a.livello,'00CPS','00R','00RED','00R',a.livello),'.'),3,1)
          ,substr(replace(decode(a.livello,'00CPS','','00RED','',a.livello),'.'),4,1)
          ,decode(a.livello,'00CPS','00RED',a.livello) livello
          ,'TRACCIA'
          ,sysdate
          ,null
          ,null
          ,substr(a.tipo_pos_org,1,3)
          from ap_utenti a
          where a.ufficio is not null
          and substr(a.ufficio,1,2) &lt;> 78
          and a.matricola &lt; 200000
          from mon_personale_inquadramenti i);
          and ((substr(a.livello,3,1) in ('A','B','C','D','E')
          and substr(a.livello,5,1) in ('1','2','3','4','5','6','7','8','9')) or substr(a.livello,3,3) in ('CPS','RED')) 
          and a.matricola not in (select i.matricola
       --   commit;
          -- aggiorno le matricole già presenti in mon_personale_inquadramenti
          insert into mon_personale_inquadramenti select distinct i.matricola
          ,trunc(sysdate,'dd')
          ,substr(replace(decode(a.livello,'00CPS','00R','00RED','00R',a.livello),'.'),3,1)
          ,substr(replace(decode(a.livello,'00CPS','','00RED','',a.livello),'.'),4,1)
          ,decode(a.livello,'00CPS','00RED',a.livello) livello
          ,'TRACCIA'
          ,sysdate
          ,null
          ,null
          ,substr(a.tipo_pos_org,1,3)
          from mon_personale_inquadramenti i
          ,ap_utenti a
          where a.matricola = i.matricola(+)
          and decode(a.livello,'00CPS','00RED',a.livello) &lt;> decode(i.livello,'00CPS','00RED',i.livello)
          and i.data_dal = (select max(m.data_dal) from mon_personale_inquadramenti m where m.matricola = a.matricola);
      --    commit;
          -- AGGIORNO LA FND_USER
            UPDATE FND_USER U SET (U.UFFICIO,u.email_address) = 
            (SELECT
              A.UFFICIO,
              NVL(A.E_MAIL,u.email_address)
            FROM ap_utenti A
              WHERE U.MATRICOLA = A.MATRICOLA
              AND (U.UFFICIO &lt;> A.UFFICIO OR u.email_address &lt;> NVL(a.e_mail,u.email_address)))
             WHERE U.MATRICOLA IN 
             (SELECT
              A.MATRICOLA
              FROM ap_utenti A
              ,FND_USER F
              WHERE F.MATRICOLA = A.MATRICOLA
              AND (F.UFFICIO &lt;> A.UFFICIO OR F.email_address &lt;> NVL(a.e_mail,F.email_address)));
       --       COMMIT;
       delete personale_uffici;
       insert into personale_uffici
        select ufficio,count(*)
        from ap_utenti
        where ufficio is not null
        group by ufficio
        order by ufficio;
       insert into personale_uffici values ('118',28);
    end if;
    if nvl(:new.codarea,'X') = '00078'
    then 
    insert into sic_consiglio.fin_t_pianta_organica values (
    :new.DATA
    ,:new.MATRICOLA
    ,:new.COGNOME
    ,:new.NOME
    ,:new.CODFISC
    ,:new.CODAREA
    ,:new.CODUFF
    ,:new.CODSERV
    ,:new.CCODPRESIDIO
    ,:new.DESCRAREA
    ,:new.DESCRUFFICIO
    ,:new.DESCRSERV
    ,:new.DESCRPRESIDIO
    ,:new.DATAASS
    ,:new.LIVELLO
    ,:new.CODQUA
    ,:new.QUALIFICA
    ,:new.CODPOSORG
    ,:new.POSIZIONEORG
    ,:new.NUMTEL
    ,:new.DATACESS
    ,:new.EMAIL);
    end if;
    
END;</pre>	</td></tr>
</table></div>