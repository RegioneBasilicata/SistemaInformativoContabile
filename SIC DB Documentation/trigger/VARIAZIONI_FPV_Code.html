<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=Cp1252" />
<script src="../dbdoc.js" type="text/javascript"></script>
<link href="../dbdoc.css" type="text/css" rel="stylesheet">
</head>
<body class="object">
<div id="header"><h2>VARIAZIONI_FPV</h2>
<div class="tabs clearfix">

<div class="tab"><div><a href="VARIAZIONI_FPV.html">Details</a></div></div>
<div class="tab"><div><a href="VARIAZIONI_FPV_Grants.html">Grants</a></div></div>
<div class="tab"><div><a href="VARIAZIONI_FPV_References.html">References</a></div></div>
<div class="tab"><div><a href="VARIAZIONI_FPV_Dependencies.html">Dependencies</a></div></div>
<div class="tab" id="current"><div><a href="VARIAZIONI_FPV_Code.html">Code</a></div></div>
</div></div><br/>
<div class="tab-panes">
<div id="Code"> <table cellpadding="0" cellspacing="0" cellspacing="0" summary=""><tr>
	<th>TEXT</th>
</tr>
	<tr><td><pre>
TRIGGER VARIAZIONI_FPV
after update
on fin_t_documenti
for each row
declare
vimporto_originario number(15,2);
vimporto_variazione number(15,2);
vdescrizione_variazione varchar2(4000);

begin

 if (:old.doc_type = 'IMP' or
     :old.doc_type = 'IMP-DEF' or
     :old.doc_type = 'ACC') and
    (:new.document_amount &lt;> :old.document_amount or
     nvl(:new.deletion_status_flag,'N') = 'Y' ) and
    (to_char(:old.date_created,'ddmm')='0101' or :old.attribute21 is not null) 
     and :new.attribute23 is null -- se è NOT NULL vuol dire che trattasi di impegno pluriennale riaccertato e la variazione non va presa
     and :old.attribute23 is null -- se è NOT NULL vuol dire che trattasi di impegno pluriennale riaccertato e la variazione non va presa
     and nvl(:old.deletion_status_flag,'N') = 'N'
     then 
      if nvl(:new.deletion_status_flag,'N') = 'Y'
         then vimporto_originario := :old.document_amount;
              vimporto_variazione := :new.document_amount;
              vdescrizione_variazione := :new.deletion_reason;
         else vimporto_originario := :old.document_amount;
              vimporto_variazione := (:old.document_amount - :new.document_amount);
              vdescrizione_variazione := :new.revertion_reason; 
      end if;


 insert into fin_t_variazioni_fpv values 
 (to_char(:old.date_created,'yyyy') -- anno
 ,:new.doc_id             -- doc_id     
 ,:new.doc_sequence_value -- doc_sequence_value
 ,vimporto_originario     -- importo_originario
 ,vimporto_variazione     -- importo_variazione
 ,vdescrizione_variazione -- descrizione variazione
 ,trunc(sysdate,'dd')     -- data variazione
 ,:new.segment2           -- capitolo attuale
 );             

 end if;   

end;

--- ***********************************
--- FINE  ***** TRIGGER VARIAZIONI_FPV sulla FIN_T_DOCUMENTI ****
--- ***********************************</pre>	</td></tr>
</table></div>